<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" type="image/x-icon" href="images/favicon.ico">
<title>Functional Mock-up Interface Specification</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:30em;padding-right:0}
#toc.toc2{width:30em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

/* customizations */

body{
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
}

.toc-hidden {
  padding-left: 0 !important;
}

.imageblock {
  text-align: center;
}

.imageblock img {
  display: block;
  margin: auto;
}

.imageblock .title {
  display: inline-block;
  margin: auto;
}

.vertical-text {
	transform: rotate(-90deg) translate(-11em, 0);
	transform-origin: left top 0;
  float: left;
  display: inline-block;
  white-space: nowrap;
  width: 1em;
  height: 11em;
}

/* no alternating row colors */
table tr.even,table tr.alt,table tr:nth-of-type(even) {
  background:none
}

/* use parent text color for captions */
.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
  color: inherit;
}

a {
  text-decoration: none;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script>
// hide / show the Table of Contents (TOC)
function toggleTOC() {
  var toc = document.getElementById("toc");
  var body = document.getElementsByTagName("body")[0];

  if (toc.style.display === "none") {
      toc.style.display = "block";
      body.classList.remove("toc-hidden");
  } else {
      toc.style.display = "none";
      body.classList.add("toc-hidden");
  }
}

// toggle the TOC when "t" key is pressed
document.addEventListener('keydown', (event) => {
  if (event.key == 't') {
    toggleTOC();
  }
});
</script>

<!-- Generate a nice TOC -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js"></script>
<!-- We do not need the tocify CSS because the asciidoc CSS already provides most of what we neeed -->

<style>
.tocify-header {
    font-style: italic;
}

.tocify-subheader {
    font-style: normal;
    font-size: 90%;
}

.tocify ul {
    margin: 0;
 }

.tocify-focus {
    color: #7a2518;
    background-color: rgba(0, 0, 0, 0.1);
}

.tocify-focus > a {
    color: #7a2518;
}
</style>

<script type="text/javascript">
    $(function () {
        // Add a new container for the tocify toc into the existing toc so we can re-use its
        // styling
        $("#toc").append("<div id='generated-toc'></div>");
        $("#generated-toc").tocify({
            extendPage: true,
            context: "#content",
            highlightOnScroll: true,
            // don't hide the sections in the TOC
            showAndHide: false,
            hideEffect: "slideUp",
            // Use the IDs that asciidoc already provides so that TOC links and intra-document
            // links are the same. Anything else might confuse users when they create bookmarks.
            hashGenerator: function(text, element) {
                return $(element).attr("id");
            },
            // Smooth scrolling doesn't work properly if we use the asciidoc IDs
            smoothScroll: false,
            // Set to 'none' to use the tocify classes
            theme: "none",
            // Handle book (may contain h1) and article (only h2 deeper)
            selectors: $( "#content" ).has( "h1" ).size() > 0 ? "h1,h2,h3,h4,h5" : "h2,h3,h4,h5,h6",
            ignoreSelector: ".discrete"
        });

        // Switch between static asciidoc toc and dynamic tocify toc based on browser size
        // This is set to match the media selectors in the asciidoc CSS
        // Without this, we keep the dynamic toc even if it is moved from the side to preamble
        // position which will cause odd scrolling behavior
        var handleTocOnResize = function() {
            if ($(document).width() < 768) {
                $("#generated-toc").hide();
                $(".sectlevel0").show();
                $(".sectlevel1").show();
            }
            else {
                $("#generated-toc").show();
                $(".sectlevel0").hide();
                $(".sectlevel1").hide();
            }
        }

        $(window).resize(handleTocOnResize);
        handleTocOnResize();
    });
</script>

<img style="display: block; margin: 2em auto; width: 30em;" src="images/FMI_logo_horizontal.svg" alt="FMI logo">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Functional Mock-up Interface Specification</h1>
<div class="details">
<span id="revnumber">version 3.0-alpha.5,</span>
<span id="revdate">unreleased</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#fmi-whats-new">1.1. What is new in FMI 3.0</a></li>
<li><a href="#_overview">1.2. Overview</a>
<ul class="sectlevel3">
<li><a href="#_fmi_for_model_exchange_me">1.2.1. FMI for Model Exchange (ME)</a></li>
<li><a href="#_fmi_for_co_simulation_cs">1.2.2. FMI for Co-Simulation (CS)</a></li>
<li><a href="#_fmi_for_scheduled_execution_se">1.2.3. FMI for Scheduled Execution (SE)</a></li>
<li><a href="#_feature_overview_of_fmi_interface_types">1.2.4. Feature Overview of FMI Interface Types</a></li>
</ul>
</li>
<li><a href="#_properties_and_guiding_ideas">1.3. Properties and Guiding Ideas</a></li>
<li><a href="#_conventions_used_in_this_document">1.4. Conventions Used in This Document</a></li>
</ul>
</li>
<li><a href="#fmi-common-concepts">2. Common Concepts</a>
<ul class="sectlevel2">
<li><a href="#mathematical-definitions">2.1. Mathematical Definitions</a></li>
<li><a href="#general-mechanisms">2.2. General Mechanisms</a>
<ul class="sectlevel3">
<li><a href="#header-files-and-naming-of-functions">2.2.1. Header Files and Naming of Functions</a></li>
<li><a href="#_platform_dependent_definitions">2.2.2. Platform Dependent Definitions</a></li>
<li><a href="#status-returned-by-functions">2.2.3. Status Returned by Functions</a></li>
<li><a href="#inquire-version-number">2.2.4. Inquire Version Number of Header Files</a></li>
<li><a href="#get-and-set-variable-values">2.2.5. Getting and Setting Variable Values</a></li>
<li><a href="#advancing-time">2.2.6. Advancing Time</a></li>
<li><a href="#operation-on-clocks">2.2.7. Operation on Clocks</a>
<ul class="sectlevel4">
<li><a href="#SynchronousClocks">2.2.7.1. Synchronous Clocks</a></li>
<li><a href="#CommunicationPointClocks">2.2.7.2. Communication Point Clocks</a>
<ul class="sectlevel5">
<li><a href="#_clock_priority">2.2.7.2.1. Clock Priority</a></li>
</ul>
</li>
<li><a href="#outputClockVariant">2.2.7.3. Output Clocks</a></li>
<li><a href="#inputClockVariant">2.2.7.4. Input Clocks</a></li>
<li><a href="#clock-relationships-for-communication-point-clocks">2.2.7.5. Clock Unions</a></li>
<li><a href="#_dependent_output_clocks">2.2.7.6. Dependent Output Clocks</a></li>
<li><a href="#periodic-clock-ticks">2.2.7.7. Periodic Clock Ticks</a></li>
<li><a href="#connecting-clocked-fmus">2.2.7.8. Connecting Clocked FMUs</a></li>
<li><a href="#fmi-api-setting-getting-clock-activation-state">2.2.7.9. Setting and Getting Clock Activation State</a></li>
</ul>
</li>
<li><a href="#_getting_partial_derivatives">2.2.8. Getting Partial Derivatives</a>
<ul class="sectlevel4">
<li><a href="#_directional_derivatives">2.2.8.1. Directional Derivatives</a></li>
<li><a href="#_adjoint_derivatives">2.2.8.2. Adjoint Derivatives</a></li>
</ul>
</li>
<li><a href="#_getting_number_of_event_indicators">2.2.9. Getting Number of Event Indicators</a></li>
<li><a href="#_getting_number_of_states">2.2.10. Getting Number of States</a></li>
<li><a href="#_getting_number_of_variable_dependencies_and_variable_dependencies">2.2.11. Getting Number of Variable Dependencies and Variable Dependencies</a></li>
</ul>
</li>
<li><a href="#common-state-machine">2.3. State Machine and Semantics</a>
<ul class="sectlevel3">
<li><a href="#FMUStateSetable">2.3.1. Super State: FMU State Setable</a>
<ul class="sectlevel4">
<li><a href="#Instantiated">2.3.1.1. State: Instantiated</a></li>
<li><a href="#InitializationMode">2.3.1.2. State: Initialization Mode</a></li>
<li><a href="#ConfigurationMode">2.3.1.3. State: Configuration Mode</a></li>
<li><a href="#Terminated">2.3.1.4. State: Terminated</a></li>
</ul>
</li>
<li><a href="#Initialized">2.3.2. Super State: Initialized</a>
<ul class="sectlevel4">
<li><a href="#EventMode">2.3.2.1. State: Event Mode</a></li>
<li><a href="#ReconfigurationMode">2.3.2.2. State: Reconfiguration Mode</a></li>
</ul>
</li>
<li><a href="#IntermediateUpdateMode">2.3.3. State: Intermediate Update Mode</a></li>
</ul>
</li>
<li><a href="#fmi-description-schema">2.4. FMI Description Schema</a>
<ul class="sectlevel3">
<li><a href="#fmiModelDescription">2.4.1. Definition of an FMU</a></li>
<li><a href="#common-capability-flags">2.4.2. Definition of Capability Flags</a></li>
<li><a href="#_definition_of_units">2.4.3. Definition of Units</a></li>
<li><a href="#definition-of-types">2.4.4. Definition of Types</a>
<ul class="sectlevel4">
<li><a href="#clock-type-definition">2.4.4.1. Clock Type Definition</a></li>
</ul>
</li>
<li><a href="#definition-of-log-categories">2.4.5. Definition of Log Categories</a></li>
<li><a href="#DefaultExperiment">2.4.6. Definition of a Default Experiment</a></li>
<li><a href="#fmiTerminalsAndIcons">2.4.7. Definition of Terminals and Icons</a>
<ul class="sectlevel4">
<li><a href="#graphicalRepresentation">2.4.7.1. Definition of a Graphical Representation</a>
<ul class="sectlevel5">
<li><a href="#_overview_2">2.4.7.1.1. Overview</a></li>
<li><a href="#_coordinatesystem">2.4.7.1.2. CoordinateSystem</a></li>
<li><a href="#_icon">2.4.7.1.3. Icon</a></li>
<li><a href="#_placement_extent_and_painting_order_of_graphical_items">2.4.7.1.4. Placement, Extent, and Painting Order of Graphical Items</a></li>
</ul>
</li>
<li><a href="#_definition_of_terminals">2.4.7.2. Definition of Terminals</a>
<ul class="sectlevel5">
<li><a href="#_overview_3">2.4.7.2.1. Overview</a></li>
<li><a href="#section-terminals">2.4.7.2.2. Terminals</a></li>
<li><a href="#section-terminalvars">2.4.7.2.3. Terminal Member Variable</a></li>
<li><a href="#_terminal_stream_member_variable">2.4.7.2.4. Terminal Stream Member Variable</a></li>
<li><a href="#_terminal_graphical_representation">2.4.7.2.5. Terminal Graphical Representation</a></li>
<li><a href="#GeneralRemarkOnSignal">2.4.7.2.6. General Remark on Signal</a></li>
<li><a href="#_general_remark_on_inflow_and_outflow">2.4.7.2.7. General Remark on Inflow and Outflow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#definition-of-model-variables">2.4.8. Definition of Model Variables</a></li>
<li><a href="#ModelStructure">2.4.9. Definition of the Model Structure</a></li>
<li><a href="#variableNamingConvention">2.4.10. Variable Naming Conventions</a></li>
</ul>
</li>
<li><a href="#fmu-distribution">2.5. FMU Distribution</a>
<ul class="sectlevel3">
<li><a href="#structure-of-zip">2.5.1. Structure of the ZIP file</a></li>
<li><a href="#documentation-directory">2.5.2. Documentation Directory</a>
<ul class="sectlevel4">
<li><a href="#license-information">2.5.2.1. Licenses Subdirectory</a></li>
</ul>
</li>
<li><a href="#sources-directory">2.5.3. Sources Directory</a></li>
<li><a href="#binarie-directory">2.5.4. Binaries Directory</a>
<ul class="sectlevel4">
<li><a href="#platform-tupe-definition">2.5.4.1. Platform Tuple Definition</a></li>
<li><a href="#external-libraries">2.5.4.2. External Libraries</a></li>
<li><a href="#dependency-on-exteranl-tool">2.5.4.3. Dependency on Installed Tool</a></li>
<li><a href="#multiple-interface-types">2.5.4.4. Multiple Interface Types</a></li>
</ul>
</li>
<li><a href="#resources-directory">2.5.5. Resources Directory</a></li>
<li><a href="#extra-directory">2.5.6. Extra Directory</a></li>
<li><a href="#_supporting_multiple_interface_types_in_one_fmu">2.5.7. Supporting Multiple Interface Types in one FMU</a></li>
<li><a href="#_import_examples">2.5.8. Import Examples</a>
<ul class="sectlevel4">
<li><a href="#_accessing_fmi_functions_in_shared_libraries">2.5.8.1. Accessing FMI Functions in Shared Libraries</a></li>
<li><a href="#_accessing_fmi_functions_in_static_libraries_and_source_code">2.5.8.2. Accessing FMI Functions in Static Libraries and Source Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_definition_of_source_code">2.6. Definition of Source Code</a>
<ul class="sectlevel3">
<li><a href="#_sourcefileset">2.6.1. SourceFileSet</a>
<ul class="sectlevel4">
<li><a href="#_sourcefile">2.6.1.1. SourceFile</a></li>
<li><a href="#_preprocessordefinition">2.6.1.2. PreprocessorDefinition</a></li>
<li><a href="#_preprocessordefinitionoption">2.6.1.3. PreprocessorDefinition/Option</a></li>
<li><a href="#_includedirectory">2.6.1.4. IncludeDirectory</a></li>
</ul>
</li>
<li><a href="#_library">2.6.2. Library</a></li>
<li><a href="#_examples">2.6.3. Examples</a></li>
</ul>
</li>
<li><a href="#VersioningLayered">2.7. Versioning and Layered Standards</a></li>
</ul>
</li>
<li><a href="#fmi-for-model-exchange">3. FMI for Model Exchange</a>
<ul class="sectlevel2">
<li><a href="#math-model-exchange">3.1. Mathematical Description</a>
<ul class="sectlevel3">
<li><a href="#computation-modes-model-exchange">3.1.1. Computation Modes</a>
<ul class="sectlevel4">
<li><a href="#_initialization_mode">3.1.1.1. Initialization Mode</a></li>
<li><a href="#_continuous_time_mode">3.1.1.2. Continuous-Time Mode</a></li>
<li><a href="#_event_mode">3.1.1.3. Event Mode</a></li>
</ul>
</li>
<li><a href="#_model_evaluations_dependencies_and_call_sequence">3.1.2. Model Evaluations, Dependencies, and Call Sequence</a></li>
</ul>
</li>
<li><a href="#_application_programming_interface">3.2. Application Programming Interface</a>
<ul class="sectlevel3">
<li><a href="#providing-independent-variables-and-re-initialization">3.2.1. Providing Independent Variables and Re-initialization of Caching</a></li>
<li><a href="#evaluation-of-model-equations">3.2.2. Evaluation of Model Equations</a></li>
<li><a href="#state-machine-model-exchange">3.2.3. State Machine for Model Exchange</a>
<ul class="sectlevel4">
<li><a href="#_state_continuous_time_mode">3.2.3.1. State: Continuous-Time Mode</a></li>
</ul>
</li>
<li><a href="#_code_example">3.2.4. Code Example</a></li>
<li><a href="#_event_handling">3.2.5. Event Handling</a></li>
</ul>
</li>
<li><a href="#model-exchange-schema">3.3. Description Schema</a>
<ul class="sectlevel3">
<li><a href="#xml-example-model-exchange">3.3.1. Example XML Description File</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#fmi-for-co-simulation">4. FMI for Co-Simulation</a>
<ul class="sectlevel2">
<li><a href="#math-co-simulation">4.1. Mathematical Description</a>
<ul class="sectlevel3">
<li><a href="#_initialization_mode_2">4.1.1. Initialization Mode</a></li>
<li><a href="#_step_mode">4.1.2. Step Mode</a></li>
<li><a href="#smoothness">4.1.3. Smoothness, Continuity and Discontinuity</a></li>
</ul>
</li>
<li><a href="#co-simulation-api">4.2. Application Programming Interface</a>
<ul class="sectlevel3">
<li><a href="#transfer-of-input-output-and-parameters">4.2.1. Getting and Setting Variable Values</a></li>
<li><a href="#Computation-in-Co-Simulation">4.2.2. Computation in Co-Simulation</a></li>
<li><a href="#Communication-during-update">4.2.3. Communication of Event Time and Input and Output Values</a></li>
<li><a href="#early-return">4.2.4. Early Return</a></li>
<li><a href="#_handling_early_return_and_events">4.2.5. Handling Early Return and Events</a></li>
<li><a href="#api-clocked-co-simulation">4.2.6. Co-Simulation with Clock Support</a>
<ul class="sectlevel4">
<li><a href="#transfer-of-input-output-and-parameters-clocked-co-simulation">4.2.6.1. Transfer of Input and Output Values and Parameters</a></li>
<li><a href="#computation-clocked-co-simulation">4.2.6.2. Computation in Co-Simulation</a></li>
</ul>
</li>
<li><a href="#state-machine-co-simulation">4.2.7. State Machine for Co-Simulation</a>
<ul class="sectlevel4">
<li><a href="#state-step-mode-co-simulation">4.2.7.1. State: Step Mode</a></li>
</ul>
</li>
<li><a href="#_code_example_for_co_simulation">4.2.8. Code Example for Co-Simulation</a></li>
<li><a href="#code-example-clocked-co-simulation">4.2.9. Code Example for Clocks</a></li>
</ul>
</li>
<li><a href="#co-simulation-schema">4.3. Description Schema</a>
<ul class="sectlevel3">
<li><a href="#clocks-in-co-simulation">4.3.1. Clocks in Co-Simulation</a></li>
<li><a href="#_example_xml_description_file">4.3.2. Example XML Description File</a>
<ul class="sectlevel4">
<li><a href="#xml-example-co-simulation">4.3.2.1. Example XML Description File with Early Return</a></li>
<li><a href="#xml-example-clocked-co-simulation">4.3.2.2. Example XML Description File with Clocks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#fmi-for-scheduled-execution">5. FMI for Scheduled Execution</a>
<ul class="sectlevel2">
<li><a href="#math-scheduled-execution">5.1. Mathematical Description</a></li>
<li><a href="#scheduled-execution-api">5.2. Application Programming Interface</a>
<ul class="sectlevel3">
<li><a href="#state-machine-scheduled-execution">5.2.1. State Machine for Scheduled Execution</a>
<ul class="sectlevel4">
<li><a href="#Initialized-SE">5.2.1.1. Super State: Initialized</a></li>
<li><a href="#_state_clock_activation_mode">5.2.1.2. State: Clock Activation Mode</a></li>
<li><a href="#IntermediateUpdateModeSE">5.2.1.3. State: Intermediate Update Mode</a></li>
</ul>
</li>
<li><a href="#preemption-support">5.2.2. Preemption Support</a></li>
<li><a href="#example-scheduled-execution">5.2.3. Example for Scheduled Execution</a>
<ul class="sectlevel4">
<li><a href="#_description_schema">5.2.3.1. Description Schema</a></li>
<li><a href="#_simulation_algorithm_implementation">5.2.3.2. Simulation Algorithm Implementation</a></li>
<li><a href="#_fmu_implementation">5.2.3.3. FMU Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scheduled-execution-schema">5.3. Description Schema</a></li>
</ul>
</li>
<li><a href="#_references">References</a></li>
<li><a href="#glossary">Appendix A: Glossary</a></li>
<li><a href="#_acknowledgements">Appendix B: Acknowledgements</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Functional Mock-up Interface (FMI) is a free standard that defines a container and an interface to exchange dynamic models using a combination of XML files, binaries and C code, distributed as a ZIP file.
It is supported by <a href="https://fmi-standard.org/tools/">more than 100 tools</a> and maintained as a <a href="https://www.modelica.org/projects">Modelica Association Project</a>.
<a href="https://github.com/modelica/fmi-standard/releases">Releases</a> and <a href="https://github.com/modelica/fmi-standard/issues">issues</a> can be found on <a href="https://github.com/modelica/fmi-standard">github.com/modelica</a>.</p>
</div>
<div class="paragraph">
<p><br>
</p>
</div>
<div class="paragraph">
<p>Copyright &#169; 2008-2011 MODELISAR Consortium and 2012-2020 The Modelica Association Project FMI.</p>
</div>
<div class="paragraph">
<p>This document is licensed under the Attribution-ShareAlike 4.0 International license.
The code is released under the 2-Clause BSD License.
The licenses text can be found in the <a href="https://raw.githubusercontent.com/modelica/fmi-standard/master/LICENSE.txt">LICENSE.txt</a> file that accompanies this distribution.</p>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="fmi-whats-new">1.1. What is new in FMI 3.0</h3>
<div class="paragraph">
<p>The FMI Design Community has improved the FMI standard to react to new requirements from the system simulation community.</p>
</div>
<div class="paragraph">
<p>Especially the ability to package control code into FMUs required some workarounds in FMI 2.0.
With FMI 3.0, virtual electronic control units (vECUs) can be exported as FMU in a more natural way.
Concrete features to support vECU export are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>introduction of more integer types and a 32-bit float type (see <a href="#fmi-description-schema">Section 2.4</a>) to communicate native controller types to the outside,</p>
</li>
<li>
<p>introduction of two types of clocks to more exactly control timing of events and evaluation of model partitions across FMUs,</p>
</li>
<li>
<p>introduction of a binary type to support non-numeric data handling, such as complex sensor data interfaces,</p>
</li>
<li>
<p>extension of variables to arrays for more efficient and natural handling of non-scalar variables,</p>
</li>
<li>
<p>introduction of structural parameters that allow description and changing of array sizes, even during runtime to support advanced online calibration of control code, and</p>
</li>
<li>
<p>addition of the new interface type FMI for Scheduled Execution (see <a href="#fmi-for-scheduled-execution">Section 5</a>) that allows activation of individual model partitions (or tasks) from an external scheduler.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A second need of the simulation community was address by introducing the more advanced co-simulation interface <a href="#fmi-for-co-simulation">FMI for Co-Simulation</a>.
New features, like</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#early-return">early return</a> from a <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> call,</p>
</li>
<li>
<p>the <a href="#IntermediateUpdateMode">intermediate update</a>, or</p>
</li>
<li>
<p><a href="#connecting-clocked-fmus">clocked (synchronous) variables</a>,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>allow implementation of more robust and efficient co-simulation algorithms to handle the growing system simulations the community is facing.</p>
</div>
<div class="paragraph">
<p>Parallel to the new standard features, the FMI Design Community has worked on improving the standard quality by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>modernizing the development methodology (e.g. moving to github) and a text-based source format,</p>
</li>
<li>
<p>publishing the FMI Standard now primarily as html to support easier navigation within the document and viewing on a wider range of devices,</p>
</li>
<li>
<p>supplying a large set of continuously validated Reference FMUs, and</p>
</li>
<li>
<p>integrating within the FMI Standard only validated C-code, XML and XSD snippets to reduce redundancy and ensure correctness.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While a number of desirable features had to be postponed, the resulting FMI 3.0 is certainly a significant step forward towards meeting the most important requirements of the system simulation community for the years to come.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overview">1.2. Overview</h3>
<div class="paragraph">
<p>The FMI (Functional Mock-up Interface) defines an interface to be implemented by an executable called an FMU (Functional Mock-up Unit).
The FMI functions are used (called) by a simulation environment to create one or more instances of the FMU and to simulate them, typically together with other models.
An FMU may either have its own solvers (<a href="#fmi-for-co-simulation"><code>FMI for Co-Simulation</code></a>), or require the simulation environment to perform numerical integration (FMI for Model Exchange, <a href="#fmi-for-model-exchange">Section 3</a>), or require the simulation environment to trigger model partition execution (FMI for Scheduled Execution , <a href="#fmi-for-scheduled-execution">Section 5</a>).
The goal of this interface is that the calling of an FMU in a simulation environment is reasonably simple.
This document does not describe how to generate an FMU from a modeling environment.</p>
</div>
<div class="paragraph">
<p>The FMI for Model Exchange interface defines an interface to the model of a dynamic system described by differential, algebraic and discrete-time equations.
It provides an interface to evaluate these equations as needed in different simulation environments, as well as in embedded control systems, with explicit or implicit integrators, and fixed or variable step-size.
The interface is designed to allow the description of large models.</p>
</div>
<div class="paragraph">
<p>The FMI for Co-Simulation interface are designed both for the coupling of simulation tools, and the coupling of subsystem models (which have been exported by their simulators together with its solvers as runnable code).
The modular structure of these systems is exploited in all stages of the simulation process beginning with the separate model setup and pre-processing for the individual subsystems in different simulation tools.
During time integration, the simulation is again performed independently for all subsystems restricting the data exchange between subsystems to discrete communication points.
Finally, the visualization and post-processing of simulation data can be done individually for each subsystem in its own native simulation tool or by the simulation environment.</p>
</div>
<div class="paragraph">
<p><em>[TODO: add SE]</em></p>
</div>
<div class="paragraph">
<p>The interfaces have large parts in common, defined in <a href="#fmi-common-concepts">Section 2</a>.
In particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FMI Application Programming Interface (C)&#8201;&#8212;&#8201;<a href="#general-mechanisms">Section 2.2</a><br>
All required equations or tool coupling computations are evaluated by calling standardized C functions.
C is used because it is the most portable programming language today and is the only programming language that can be utilized in all embedded control systems.</p>
</li>
<li>
<p>FMI Description Schema (XML)&#8201;&#8212;&#8201;<a href="#fmi-description-schema">Section 2.4</a><br>
The schema defines the structure and content of an XML file generated by a modeling environment.
This XML file contains the definition of all variables of the FMU in a standardized way.
It is then possible to run the C code in an embedded system without the overhead of the variable definition (the alternative would be to store this information in the C code and access it via function calls, but this is neither practical for embedded systems nor for large models).
Furthermore, the variable definition is a complex data structure and tools should be free to determine how to represent this data structure in their programs.
The selected approach allows a tool to store and access the variable definitions (without any memory or efficiency overhead of standardized access functions) in the programming language of the simulation environment.</p>
</li>
<li>
<p>FMU Distribution (ZIP)&#8201;&#8212;&#8201;<a href="#fmu-distribution">Section 2.5</a><br>
An FMU is distributed in one ZIP file.
The ZIP file contains the FMI Description file (XML), the binaries and libraries required to execute the FMI functions (.dll or .so files), the sources of the FMI functions (optional), and other data used by the FMU (e.g., tables or maps).
It is possible for an FMU to hide the source code to secure the contained know-how or to allow a fully automatic import of the FMU in another simulation environment.
A schematic view of an FMU is shown in <a href="#figure-data-flow">Figure 1</a>.</p>
</li>
</ul>
</div>
<div id="figure-data-flow" class="imageblock text-center">
<div class="content">
<img src="images/enclosing_model.svg" alt="enclosing model" width="60%">
</div>
<div class="title">Figure 1. Data flow between the environment and an FMU. <span class="blue">Blue</span> arrows denote the information provided by the FMU, and the <span class="red">Red</span> arrows denote the information provided to the FMU.</div>
</div>
<div class="paragraph">
<p>Publications for FMI are available from <a href="https://fmi-standard.org/literature/" class="bare">https://fmi-standard.org/literature/</a>, especially <a href="#BOA11">[BOA11]</a> and <a href="#BOA12">[BOA12]</a>.</p>
</div>
<div class="paragraph">
<p>A growing set of tools supporting FMI can be found here <a href="https://www.fmi-standard.org/tools" class="bare">https://www.fmi-standard.org/tools</a>.</p>
</div>
<div class="sect3">
<h4 id="_fmi_for_model_exchange_me">1.2.1. FMI for Model Exchange (ME)</h4>
<div class="paragraph">
<p>The Model Exchange interface exposes an ODE to an external solver of an importing tool.
Models are described by differential, algebraic and discrete equations with time-, state- and step-events.
That integration algorithm of the importing tool, usually a DAE solver, is responsible for advancing time, setting states, handling events, etc.
(See <a href="#fmi-for-model-exchange">Section 3</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmi_for_co_simulation_cs">1.2.2. FMI for Co-Simulation (CS)</h4>
<div class="paragraph">
<p>The intention is to provide a standardized interface for coupling of simulation models or tools in a co-simulation environment.
The data exchange between FMUs is largely restricted to discrete communication points.
In the time between two communication points, the subsystems inside FMUs are solved independently by internal means.
Co-simulation algorithms control the data exchange and the synchronization between FMUs (see <a href="#fmi-for-co-simulation">Section 4</a>).</p>
</div>
<div class="paragraph">
<p>Note that the co-simulation algorithm itself is not part of the FMI standard.</p>
</div>
<div class="paragraph">
<p>The FMI 3.0 Co-Simulation interface adds a number of features compared to FMI 2.0 primarily to allow for more sophisticated co-simulation algorithms that aim at more efficient and robust simulations.
Such additional features are raising events between communication points using synchronous and asynchronous clocks or sharing values between communication points to allow for improved interpolation of data.
The co-simulation algorithm is responsible for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>advancing the overall simulation time,</p>
</li>
<li>
<p>triggering of periodic and aperiodic clocks, and</p>
</li>
<li>
<p>handling events (e.g. clock ticks) signaled by the FMUs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[TODO: is this the definition that a clock tick is an event]</em></p>
</div>
<div class="paragraph">
<p>For FMI for Co-Simulation the co-simulation algorithm is shielded from how the subsystem FMU advances time internally.
For example, FMUs containing ODEs and exposing either of the co-simulation interfaces require to include an ODE solver inside the FMU to internally advance time between the communication points.
As another example, for FMU that represent controller code, an internal scheduling algorithm will trigger tasks at the correct time and order while advancing time to the next communication point or event.
(See <a href="#fmi-for-co-simulation">Section 4</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmi_for_scheduled_execution_se">1.2.3. FMI for Scheduled Execution (SE)</h4>
<div class="paragraph">
<p>The Scheduled Execution interface exposes individual model partitions (e.g. tasks of a control algorithm), to be called by a scheduler that acts as external scheduler.
The scheduler is responsible for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>advancing the overall simulation time,</p>
</li>
<li>
<p>triggering of periodic and aperiodic clocks for all exposed model partitions of a set of FMUs, and</p>
</li>
<li>
<p>handling events (e.g. clock ticks) signaled by the FMUs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In many ways, the Scheduled Execution interface is the equivalent of the Model Exchange interface: the first externalizes a scheduling algorithm usually found in a controller algorithm and the second interface externalizes the ODE solver.
(See <a href="#fmi-for-scheduled-execution">Section 5</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_feature_overview_of_fmi_interface_types">1.2.4. Feature Overview of FMI Interface Types</h4>
<div class="imageblock text-center">
<div class="content">
<img src="images/fmi-types-overview.svg" alt="fmi types overview" width="50%">
</div>
</div>
<div class="paragraph">
<p><a href="#table-overview-features">Table 1</a> gives an overview of the features of the different interfaces.</p>
</div>
<table id="table-overview-features" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Overview of features per interface.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-center valign-top">Model Exchange</th>
<th class="tableblock halign-center valign-top">Co-Simulation</th>
<th class="tableblock halign-center valign-top">Scheduled Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advancing Time</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">call <a href="#fmi3SetTime"><code>fmi3SetTime</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">call <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> and monitor argument <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">call <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Solver Included</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduler Included</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Indicators</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#early-return">Early Return</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IntermediateUpdateMode">Intermediate Update</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#operation-on-clocks">Clocks</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Only <a href="#SynchronousClocks">Synchronous Clocks</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Only <a href="#SynchronousClocks">Synchronous Clocks</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Only <a href="#CommunicationPointClocks">Communication Point Clocks</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct Feedthrough</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">At events: <span class="icon"><i class="fa fa-check"></i></span><br>
Else: <span class="icon"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_properties_and_guiding_ideas">1.3. Properties and Guiding Ideas</h3>
<div class="paragraph">
<p>In this section, properties are listed and some principles are defined that guided the low-level design of the FMI.
This shall increase self consistency of the FMI functions.
The listed issues are sorted, starting from high-level properties to low-level implementation issues.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Expressivity</dt>
<dd>
<p>The FMI provides the necessary features to package models of different domains, such as multibody and virtual ECUs, into an FMU.</p>
</dd>
<dt class="hdlist1">Stability</dt>
<dd>
<p>The FMI is expected to be supported by many simulation tools worldwide.
Implementing such support is a major investment for tool vendors.
Stability and backwards compatibility of the FMI has therefore high priority.
To support this, the FMI defines "capability flags" that will be used by future versions of the FMI to extend and improve the FMI in a backwards compatible way, whenever feasible.</p>
</dd>
<dt class="hdlist1">Implementation</dt>
<dd>
<p>FMUs can be written manually or can be generated automatically from a modeling environment.
Existing manually coded models can be transformed manually to a model according to the FMI standard.</p>
</dd>
<dt class="hdlist1">Processor independence</dt>
<dd>
<p>It is possible to distribute an FMU without knowing the target processor.
This allows an FMU to run on a PC, a Hardware-in-the-Loop simulation platform or as part of the controller software of an ECU.
Keeping the FMU independent of the target processor increases the usability of the FMU.
To be processor independent, the FMU must include its C (or C++) sources.</p>
</dd>
<dt class="hdlist1">Simulator independence</dt>
<dd>
<p>It is possible to compile, link and distribute an FMU without knowing the environment in which the FMU will be loaded.</p>
<div class="paragraph">
<p>Reason: The standard would be much less attractive otherwise, unnecessarily restricting the later use of an FMU at compile time and forcing users to maintain simulator specific variants of an FMU.
To be simulator independent, the FMU must export its implementation in self-contained binary form.
This requires that the target operating system and processor be known.
Once exported with binaries, the FMU can be executed by any simulator running on the target platform (provided the necessary licenses are available, if required from the model or from the used run-time libraries).</p>
</div>
</dd>
<dt class="hdlist1">Semantic versioning</dt>
<dd>
<p>The FMI standard uses semantic version numbers, as defined in <a href="#PW13">[PW13]</a>, where the standard version consists of a triple of version numbers, consisting of major version, minor version, and patch version numbers, see <a href="#VersioningLayered">Section 2.7</a>.</p>
</dd>
<dt class="hdlist1">Version independence</dt>
<dd>
<p>FMUs with a specific major and minor version number are valid FMUs w.r.t. the same major version and any minor version because features of minor versions are optional and ignorable.</p>
<div class="paragraph">
<p>Reason: A tool can always export the greatest minor version it supports.
Such an FMU can be imported into all tools supporting this major version and arbitrary minor versions.
This achieves maximal longevity of FMUs protecting its value for users.</p>
</div>
</dd>
<dt class="hdlist1">Small run-time overhead</dt>
<dd>
<p>Communication between an FMU and an importer through the FMI does not introduce significant run-time overhead.
This can be achieved by enabling caching of the FMU outputs and by exchanging multiple quantities with one call.</p>
</dd>
<dt class="hdlist1">Small footprint</dt>
<dd>
<p>A compiled FMU binary requires little memory.</p>
<div class="paragraph">
<p>Reason: An FMU may run on an ECU (Electronic Control Unit, for example, a microprocessor), and ECUs have strong memory limitations.
This is achieved by storing signal attributes (<code>name</code>, <code>unit</code>, etc.) and all other static information not needed for model evaluation in a separate text file (= Model Description File) that is not needed on the microprocessor where the executable might run.</p>
</div>
</dd>
<dt class="hdlist1">Hide data structure</dt>
<dd>
<p>The FMI for Model Exchange does not prescribe a data structure (e.g., a C struct) to represent a model.</p>
<div class="paragraph">
<p>Reason: the FMI standard shall not unnecessarily restrict or prescribe a certain implementation of FMUs or simulators (whichever contains the model data) to ease implementation by different tool vendors.</p>
</div>
</dd>
<dt class="hdlist1">Support many and nested FMUs</dt>
<dd>
<p>A simulator may run many FMUs in a single simulation run and/or multiple instances of one FMU.
The inputs and outputs of these FMUs can be connected with direct feedthrough.
Moreover, an FMU may contain nested FMUs.</p>
</dd>
<dt class="hdlist1">Numerical Robustness</dt>
<dd>
<p>The FMI standard allows problems which are numerically critical (for example, <a href="#time-event"><code>time</code></a> and <a href="#state-event"><code>state events</code></a>, multiple sample rates, stiff problems) to be treated in a robust way.</p>
</dd>
<dt class="hdlist1">Hide cache</dt>
<dd>
<p>A typical FMU will cache computed results for later reuse.
To simplify usage and to reduce error possibilities by a simulator, the caching mechanism is hidden from the usage of the FMU.</p>
<div class="paragraph">
<p>Reason: First, the FMI should not force an FMU to implement a certain caching policy.
Second, this helps to keep the FMI simple.
To help implement this cache, the FMI provides explicit methods (called by the FMU environment) for setting properties that invalidate cached data.
An FMU that chooses to implement a cache may maintain a set of "dirty" flags, hidden from the simulator.
A get method, for example to a state, will then either trigger a computation, or return cached data, depending on the value of these flags.</p>
</div>
</dd>
<dt class="hdlist1">Support numerical solvers</dt>
<dd>
<p>A typical importer will use numerical solvers.
These solvers require vectors for <a href="#state"><code>states</code></a>, <a href="#derivative"><code>derivatives</code></a> and zero-crossing functions.
The FMU directly fills the values of such vectors provided by the solvers.</p>
<div class="paragraph">
<p>Reason: minimize execution time.
The exposure of these vectors conflicts somewhat with the "hide data structure" requirement, but the efficiency gain justifies this.</p>
</div>
</dd>
<dt class="hdlist1">Explicit signature</dt>
<dd>
<p>The intended operations, arguments, and return types are made explicit in the signature.
For example, an operator (such as <code>compute_derivatives</code>) is not passed as an int argument but a special function is called for this.
The <code>const</code> prefix is used for any pointer that should not be changed, including <code>const char*</code> instead of <code>char*</code>.</p>
<div class="paragraph">
<p>Reason: the correct use of the FMI can be checked at compile time and allows calling of the C code in a C++ environment (which is much stricter on <code>const</code> than C is).
This will help to develop FMUs that use the FMI in the intended way.</p>
</div>
</dd>
<dt class="hdlist1">Few functions</dt>
<dd>
<p>The FMI consists of a few, "orthogonal" functions, avoiding redundant functions that could be defined in terms of others.</p>
<div class="paragraph">
<p>Reason: This leads to a compact, easy-to-use, and hence attractive API with a compact documentation.</p>
</div>
</dd>
<dt class="hdlist1">Error handling</dt>
<dd>
<p>All FMI methods use a common set of methods to communicate errors.</p>
</dd>
<dt class="hdlist1">Allocator must free</dt>
<dd>
<p>All memory (and other resources) allocated by the FMU are freed (released) by the FMU.
Likewise, resources allocated by the importer are released by the importer.</p>
<div class="paragraph">
<p>Reason: this helps to prevent memory leaks and run-time errors due to incompatible run-time environments for different components.</p>
</div>
</dd>
<dt class="hdlist1">Immutable strings</dt>
<dd>
<p>All strings passed as arguments or returned are read-only and must not be modified by the receiver.</p>
<div class="paragraph">
<p>Reason: This eases the reuse of strings.</p>
</div>
</dd>
<dt class="hdlist1">Named list elements</dt>
<dd>
<p>All lists defined in the <code>fmi3ModelDescription.xsd</code> XML schema file have a string attribute <code>name</code> to a list element.
This attribute must be unique with respect to all other <code>name</code> attributes of the same list.</p>
</dd>
<dt class="hdlist1">Use C</dt>
<dd>
<p>The FMI is encoded using C, not C++.
Reasons: Avoid problems with compiler and linker dependent behavior, and run the FMU on embedded systems.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This version of the FMI standard does not have the following desirable properties.
They might be added in a future version.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The FMI for Model Exchange is for ordinary differential equations (ODEs) in state space form.
It is not for a general differential-algebraic equation system.
However, algebraic equation systems inside the FMU are supported (for example, the FMU can report to the environment to re-run the current step with a smaller step size since a solution could not be found for an algebraic equation system).</p>
</li>
<li>
<p>Special features that might be useful for multibody system programs are not included.</p>
</li>
<li>
<p>The interface is for simulation and for embedded systems.
Properties that might be additionally needed for trajectory optimization, for example, derivatives of the model with respect to parameters during continuous integration are not included.</p>
</li>
<li>
<p>No explicit definition of the variable hierarchy in the XML file.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conventions_used_in_this_document">1.4. Conventions Used in This Document</h3>
<div class="ulist">
<ul>
<li>
<p>Non-normative text is given in square brackets in italic font: <em>[Especially examples are defined in this style.]</em></p>
</li>
<li>
<p>The key words <strong>MUST</strong>, <strong>MUST NOT</strong>, <strong>REQUIRED</strong>, <strong>SHALL</strong>, <strong>SHALL NOT</strong>, <strong>SHOULD</strong>, <strong>SHOULD NOT</strong>, <strong>RECOMMENDED</strong>, <strong>NOT RECOMMENDED</strong>, <strong>MAY</strong>, and <strong>OPTIONAL</strong> in this document are to be interpreted as described in <a href="https://tools.ietf.org/html/rfc2119">RFC 2119</a>.</p>
</li>
<li>
<p><code>{VariableType}</code> is used as a placeholder for all variable type names without the <code>fmi3</code> prefix (e.g. <code>fmi3Get{VariableType}</code> stands for <code>fmi3GetUInt8</code>, <code>fmi3GetBoolean</code>, <code>fmi3GetFloat64</code>, etc.).</p>
</li>
<li>
<p>State machine states be formatted in <strong>bold</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fmi-common-concepts">2. Common Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The FMI defines the following interface types: FMI for Model Exchange, Co-Simulation, and Scheduled Execution.
The concepts defined in this chapter are common to at least two of these interface types.
The definitions that are specific to the particular cases are defined in <a href="#fmi-for-model-exchange">Section 3</a>, <a href="#fmi-for-co-simulation">Section 4</a>, and <a href="#fmi-for-scheduled-execution">Section 5</a>.</p>
</div>
<div class="paragraph">
<p>The term <em>FMU</em> (Functional Mock-up Unit) denotes an implementation (or any mix) of interface types.</p>
</div>
<div class="paragraph">
<p>In the following, we assume that the reader is familiar with the basics of the C programming language and the basics of numerical simulation.
Please refer to <a href="#glossary">Appendix A</a> for the most commonly used terms.</p>
</div>
<div class="sect2">
<h3 id="mathematical-definitions">2.1. Mathematical Definitions</h3>
<div class="paragraph">
<p>This section introduces the mathematical notation used throughout this document.
It is used to describe
 * ordinary differential equations in state-space representations with discontinuities (events),
 * algebraic equation systems,
 * discrete-time equations (sampled-data systems).</p>
</div>
<div class="paragraph">
<p>The <a href="#independent"><code>independent</code></a> variable \(t \in \mathbb{T}\) <em>[typically: time]</em> is a tuple \(t = (t_R,t_I)\), where \(t_R \in \mathbb{R},\ t_{I} \in \mathbb{N} = \{0, 1, 2, \ldots\}\).
The real part \(t_R\) of this tuple is the <a href="#independent"><code>independent</code></a> variable of the FMU for describing the continuous-time behavior of the model between events.
During continuous-time integration \(t_I = 0\).
The integer part \(t_I\) of this tuple is a counter to enumerate (and therefore distinguish) the events at the same continuous-time instant \(t_R\).
This time definition is also called "super-dense time" in literature, see, for example, <a href="#LZ07">[LZ07]</a>.
An ordering is defined on \(\mathbb{\text{T}}\) that leads to the notation in <a href="#table-model-exchange-math-notation">Table 2</a>.
<em>[The notation \(^{\bullet}t\) is from <a href="#BCP10">BCP10</a>, adapted from non-standard analysis to super-dense time, in order to precisely define the value from the previous event iteration.]</em></p>
</div>
<table id="table-model-exchange-math-notation" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Conventions and notation used.</caption>
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 58.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mathematical meaning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(t_1 &lt; t_2\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\((t_{\mathit{R1}},t_{\mathit{I1}}) &lt; (t_{\mathit{R2}}, t_{\mathit{I2}})\ \Leftrightarrow \ t_{\mathit{R1}} &lt; t_{\mathit{R2}}\ \textbf{or} \ t_{\mathit{R1}}= t_{\mathit{R2}} \ \textbf{and} \ t_{\mathit{I1}} &lt; t_{\mathit{I2}}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(t_1\) is before \(t_2\)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(t_1 = t_2\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\((t_{\mathit{R1}},t_{\mathit{I1}}) = (t_{\mathit{R2}},t_{\mathit{I2}}) \ \Leftrightarrow  t_{\mathit{R1}}= t_{\mathit{R2}}\ \textbf{and} \ t_{\mathit{I1}} = t_{\mathit{I2}}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(t_1\) is identical to \(t_2\)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(t^{+}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\({{(t}_{R},t_{I})}^{+} \Leftrightarrow (\lim_{\mathit{\epsilon \rightarrow 0}}{\left(t_{R} + \varepsilon \right),t_{\mathit{Imax}})}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">right limit at \(t\).
\(t_{\mathit{Imax}}\) is the largest occurring integer index of super-dense time</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(^-t\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(^{-}{{(t}_{R},t_{I})} \Leftrightarrow (\lim_{\mathit{\epsilon \rightarrow 0}}{\left( t_{R} - \varepsilon \right),0)}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">left limit at \(t\)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(^{\bullet}t\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(^{\bullet}{\left( t_{R},t_{I} \right)\ } \Leftrightarrow \left\{ \begin{matrix} ^-t \ &amp; \mathbf{if} \ t_I = 0 \\ (t_R, t_I - 1) \ &amp; \mathbf{if} \ t_I &gt; 0 \\ \end{matrix} \right.\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">previous time instant (= either left limit or previous event instant).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(v^+(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(v(t^+)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value at the right limit of \(t\)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(^{-}v(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(v(^-t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value at the left limit of \(t\)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">\(^{\bullet}v(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(v(^{\bullet}t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">previous value (= either left limit or value from the previous event)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Assume that an FMU has an event at \(t_R=2.1s\) and here a signal changes discontinuously.</em>
<em>If no event iteration occurs, the time instant when the event occurs is defined as (2.1, 0), and the time instant when the integration is restarted is defined as (2.1, 1).]</em></p>
</div>
<div class="paragraph">
<p>The hybrid differential equations exposed by FMI for Model Exchange or wrapped by FMI for Co-Simulation are described as piecewise continuous-time systems.
Discontinuities can occur at time instants \(t_0, t_1, \ldots, t_n\) where \(t_i &lt; t_{i+1}\).
These time instants are called <code>events</code>.
Events can be known before hand (= <a href="#time-event">time event</a>), or are defined implicitly (= <a href="#state-event"><code>state</code></a> and <a href="#step-event"><code>step events</code></a>), see below.
Between events, variables are either <a href="#continuous"><code>continuous</code></a> or do not change their value.
A variable is called discrete-time, if it changes its value only at an event instant.
Otherwise the variable is called continuous-time.
Only floating point variables can be continuous-time.
The following variable subscripts are used to describe the timing behavior of the corresponding variable (for example, \(v_d\) is a discrete-time variable):</p>
</div>
<div class="paragraph">
<p>A clock is a variable that communicates events across FMUs.
Clock variables are special discrete and discrete-time variables that are active (are ticking) only at event time instants.
Time-based clocks can only tick once per \(t_i\).
Other clocks might tick multiple times during super-dense time instants of one \(t_i\).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscript</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A continuous-time variable is a floating-point variable representing a continuous function of time inside each interval \(t_i^+ &lt; \ ^-t_{i+1}\).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A discrete-time variable changes its value only at an event instant \(t = (t_i,n)\).
Such a variable can change multiple times at the same continuous-time instant, but only at subsequent super-dense time instances \(n \in \mathbb{N} = \{0, 1, 2, \ldots\}\).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>k</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A clocked variable is a discrete-time variable associated with a <a href="#clock"><code>clock</code></a>.
Clocked variables are a subset of discrete-time variables.
It changes its value only when this clock is active.
<em>[Formally, a clocked variable has a value only when its associated clock is active.
However, <code>fmi3Get{VariableType}</code> will return the value computed at the last clock activation time.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>c</code>+<code>d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A set of continuous-time and discrete-time variables.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>u</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A set of continuous-time variables accessible in <strong>Intermediate Update Mode</strong>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>At every event instant \(t_i\), continuous-time variables might change discontinuously (see <a href="#figure-piecewise-continuous-variables">Figure 2</a>).</p>
</div>
<div id="figure-piecewise-continuous-variables" class="imageblock">
<div class="content">
<img src="images/PieceWiseContinuousVariables.svg" alt="PieceWiseContinuousVariables" width="60%">
</div>
<div class="title">Figure 2. Piecewise-continuous variables of an FMU: continuous-time (\(v_c\)) and discrete-time (\(v_d\)).</div>
</div>
<div class="paragraph">
<p>The mathematical description of an FMU uses the following variables:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(t\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#independent"><code>independent</code></a> variable <em>[typically: time]</em> \(\in \mathbb{T}\).
This variable is defined with <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a>.
All other variables are functions of this independent variable.</p>
<p class="tableblock">For Co-Simulation and Scheduled Execution:<br>
The i-th communication point is denoted as \(t_i\)<br>
The communication step size is denoted as \(h_i = t_{i+1} - t_i\)<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{v}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A vector of all exposed variables (all variables defined in element <code>&lt;ModelVariables&gt;</code>, see <a href="#definition-of-model-variables">Section 2.4.8</a>).
A subset of the variables is selected via a subscript.</p>
<p class="tableblock"><em>[Example:</em> \(\mathbf{v}_{\mathit{initial=exact}}\) <em>are variables defined with attribute <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> (see <a href="#definition-of-model-variables">Section 2.4.8</a>).</em>
<em>These are <a href="#parameter"><code>parameters</code></a> and <a href="#start"><code>start</code></a> values of other variables, such as initial values for <a href="#state"><code>states</code></a>, state derivatives or <a href="#output"><code>outputs</code></a>.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{p}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters.
The symbol without a subscript references <a href="#parameter"><code>parameters</code></a> (variables with <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a>).
A subset of the variables is selected via a subscript.</p>
<p class="tableblock"><em>[Example: Dependent <a href="#parameter"><code>parameters</code></a> (variables with <a href="#causality"><code>causality</code></a> = <a href="#calculatedParameter"><code>calculatedParameter</code></a>) are denoted as</em> \(\mathbf{p}_{\mathit{calculated}}\) <em>and <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> (variables with <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>) are denoted as</em> \(\mathbf{p}_{\mathit{tune}}\) <em>.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{u}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input variables.
The values of these variables are defined outside of the model.
Variables of this type are defined with attribute <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{y}\)<br>
\(\mathbf{y^{(j)}}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output variables.
The values of these variables are computed in the FMU and they are designed to be used outside the FMU.
Variables of this type are defined with attribute <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a>.
For CS and SE: Also j-th derivatives \(\mathbf{y}^{(j)}(t_{i+1})\) can be provided if supported by the FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{w}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local variables of the FMU that must not be used for FMU connections.
Variables of this type are defined with attribute <a href="#causality"><code>causality</code></a> = <a href="#local"><code>local</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{z}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A vector of floating point continuous-time variables representing the event indicators used to define <a href="#state-event"><code>state events</code></a> (see <a href="#figure-events">Figure 8</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{x}_c\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A vector of floating point continuous-time variables representing the continuous-time <a href="#state"><code>states</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{x}_d\)<br>
\(^{\bullet}\mathbf{x}_d\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{x}_d\) is a vector of (internal) discrete-time variables (of any type) representing the discrete-time states.<br>
\({}^{\bullet}\mathbf{x}_d\) is the value of \(\mathbf{x}_d\) at the previous super-dense time instant.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(T_{\mathit{next}}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At initialization or at an event instant, an FMU can define the next time instant \(T_{\mathit{next}}\), at which the next time event occurs (see also the definition of <a href="#EventMode">events</a>).
Every event removes automatically a previous definition of \(T_{\mathit{next}}\), and it must be explicitly defined again, even if a previously defined \(T_{\mathit{next}}\) was not yet reached (see <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\mathbf{r}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A vector of Boolean variables representing relations: \(r_{j} := z_{j} &gt; 0\).
When entering <strong>Continuous-Time Mode</strong> all relations reported via the event indicators \(\mathbf{z}\) are fixed and during this mode these relations are replaced by \(^{\bullet}\mathbf{r}\).
Only during <strong>Initialization Mode</strong> or <strong>Event Mode</strong> the domains \(z_{j} &gt; 0\) can change.
<em>[For more details, see <a href="#Remark3">Remark 3</a> below.]</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="general-mechanisms">2.2. General Mechanisms</h3>
<div class="paragraph">
<p>This section contains the common interface definitions that allow a C program to invoke the FMU functions.</p>
</div>
<div class="paragraph">
<p>Note that the following general properties hold for an FMU:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FMI functions of one instance do not need to be thread-safe.<br>
<em>[For example, if the functions of one instance of an FMU are accessed from more than one thread;
the multi-threaded simulation environment that uses the FMU must guarantee that there are no race conditions while invoking the FMI functions.
The FMU itself does not implement any services to support this.]</em></p>
</li>
<li>
<p>FMI functions must not change global settings which affect other processes/threads.
An FMI function may change settings of the thread in which it is called (such as floating point control registers), provided these changes are restored before leaving the function or before a callback function is called.<br>
<em>[This property ensures that functions of different FMU instances can be called safely in any order.</em>
<em>Additionally, they can be called in parallel provided the functions are called in different processes.</em>
<em>If an FMI function changes for example the floating point control word of the CPU, it must restore the previous value before return of the function.</em>
<em>For x86 CPUs, the floating point control word is set using the <code>fldcw</code> instruction.</em>
<em>This can be used to switch on additional exceptions such as floating point division by zero.</em>
<em>An FMU might temporarily change the floating point control word and get notified on floating point exceptions internally, but has to restore the flag and clear the floating point status word before return of the respective FMI function.]</em></p>
</li>
<li>
<p>In general, FMI function arguments are not allowed to be NULL, unless explicitly allowed by the standard document where NULL will be assigned a specific semantic.<br>
<em>[For an example of NULL being explicitly allowed see <a href="#resourceLocation"><code>resourceLocation</code></a>.</em>
<em>Careful implementations should still guard against NULL pointers.]</em></p>
</li>
<li>
<p>The FMI Standard does not provide a run-time platform or portability layer.
Access to operating system resources and services, such as memory and file system, must be implemented with special care because the availability of such resources and services is not guaranteed.
If some resource is required by the FMU but is not available, the FMU must log what resource failed and return with error.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="header-files-and-naming-of-functions">2.2.1. Header Files and Naming of Functions</h4>
<div class="paragraph">
<p>Three header files are provided that define the interface of an FMU.
In all header files the convention is used that all C function and type definitions start with the prefix <code>fmi3</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3PlatformTypes.h</code></dt>
<dd>
<p>contains the type definitions of the input and output arguments of the functions as well as some C preprocessor macro definitions for constants.
This header file must
be used both by the FMU and by the importer.
<em>[Example of a definition in this header file:</em></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef double fmi3Float64;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
</dd>
<dt class="hdlist1"><code>fmi3FunctionTypes.h</code></dt>
<dd>
<p>contains <code>typedef</code> definitions of all function prototypes of an FMU as well as enumerations for constants.
This header file includes <code>fmi3PlatformTypes.h</code>.
When dynamically loading an FMU, these definitions can be used to type-cast the function pointers to the respective function definition.
For simplicity, the function type for each function is composed of the function name itself with the suffix <code>TYPE</code>.</p>
<div class="paragraph">
<p><em>[Example of a definition in this header file:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetTimeTYPE(fmi3Instance, fmi3Float64);</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
</dd>
<dt class="hdlist1"><code>fmi3Functions.h</code></dt>
<dd>
<p>contains the function prototypes of an FMU that can be accessed in simulation environments.</p>
<div class="paragraph">
<p>This header file includes <code>fmi3PlatformTypes.h</code> and <code>fmi3FunctionTypes.h</code>.
The header file version number for which the model was compiled, can be inquired by the importer with <a href="#fmi3GetVersion"><code>fmi3GetVersion</code></a> (see <a href="#inquire-version-number">Section 2.2.4</a>).<br></p>
</div>
<div class="paragraph">
<p><em>[Example of a definition in this header file:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">FMI3_Export fmi3SetTimeTYPE fmi3SetTime;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>For Microsoft and Cygwin compilers <code>FMI3_Export</code> is defined as</em> <code>__declspec(dllexport)</code> <em>and for Gnu-Compilers as</em> <code>__attribute__ ( ( visibility("default") ) )</code> <em>in order to export the name for dynamic loading.</em>
<em>Otherwise it is an empty definition.]</em></p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The goal is that both source code and binary representations of FMUs are supported and that several FMUs might be present at the same time in an executable (for example, FMU A may use an FMU B).
In order for this to be possible, the names of the functions in different FMUs must be different, or function pointers must be used.
To support the source code representation of FMUs, macros are provided in <code>fmi3Functions.h</code> to build the actual function names by using a function prefix that depends on how the FMU is shipped.</p>
</div>
<div class="paragraph">
<p><em>[These macros can be defined differently in a target specific variant of <code>fmi3Functions.h</code> to adjust them to the requirements of the supported compilers and platforms of the importing tool.]</em></p>
</div>
<div class="paragraph">
<p>An FMU C-file must include at the beginning a <code>define</code> of <code>FMI3_FUNCTION_PREFIX</code> with the same value as the value of the <code>modelIdentifier</code> attribute defined in <code>&lt;fmiModelDescription&gt;&lt;ModelExchange&gt;</code>, <code>&lt;fmiModelDescription&gt;&lt;CoSimulation&gt;</code> or <code>&lt;fmiModelDescription&gt;&lt;ScheduledExecution&gt;</code> together with <code>_</code> at the end (see <a href="#model-exchange-schema">Section 3.3</a>, <a href="#co-simulation-schema">Section 4.3</a>, <a href="#scheduled-execution-schema">Section 5.3</a>).</p>
</div>
<div class="paragraph">
<p>This <code>define</code> must be directly followed with an <code>#include "fmi3Functions.h"</code> statement.</p>
</div>
<div class="paragraph">
<p>Typically, FMU functions are used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">// FMU is shipped with C source code, or with static link library
#define FMI3_FUNCTION_PREFIX MyModel_
#include "fmi3Functions.h"
&lt; usage of the FMU functions e.g. MyModel_fmi3SetTime &gt;

// FMU is shipped with DLL/SharedObject
#include "fmi3FunctionTypes.h"
fmi3SetTimeTYPE *myname_setTime = &lt; load symbol "fmi3SetTime" from DLL/SharedObject &gt;;
&lt; usage of the FMU function pointers, e.g. myname_setTime &gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A function that is defined as <code>fmi3GetFloat64</code> is changed by the macros to a function name as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the FMU is shipped with C source code or with static link library:<br>
The constructed function name is <code>MyModel_fmi3GetFloat64</code>.
In other words the function name is prefixed with the model name and an <code>_</code>.
A simulation environment can therefore construct the relevant function names by generating code for the actual function call.
In case of a static link library, the name of the library is <code>MyModel.lib</code> on Windows and <code>libMyModel.a</code> on Linux; in other words the <code>modelIdentifier</code> attribute is used to create the library name.</p>
</li>
<li>
<p>If the FMU is shipped with DLL/SharedObject:<br>
The constructed function name is <code>fmi3GetFloat64</code>, in other words, it is not changed.
<em>[This can be realized in the case of a source code FMU with a target-specific version of <code>fmi3Functions.h</code> that does not use FMI3_FUNCTION_PREFIX to construct the function names.]</em>
A simulation environment will then dynamically load this library and will explicitly import the function symbols by providing the FMI function names as strings.
The name of the library is <code>MyModel.dll</code> on Windows or <code>MyModel.so</code> on Linux; in other words the <code>modelIdentifier</code> attribute is used as library name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[An FMU can be optionally shipped so that it basically contains only the communication to another simulation tool (<code>needsExecutionTool = true</code>, see <a href="#fmi-for-co-simulation">Section 4</a>).</em>
<em>This is particularly common for co-simulation tasks.</em>
<em>In this tool coupling case one DLL/Shared Object can be used for all models due to no function prefixing.]</em></p>
</div>
<div class="paragraph">
<p>Since <code>modelIdentifier</code> is used as prefix of a C-function name it must fulfill the restrictions on C-function
names (only letters, digits and/or underscores are allowed).
<em>[For example, if <code>modelName = "A.B.C"</code>, then <code>modelIdentifier</code> might be "A_B_C".]</em>
Since <code>modelIdentifier</code> is also used as name in a file system, it must also fulfill the restrictions of the targeted operating system.
Basically, this means that it should be short.
These restrictions apply to all interface types and for binary and source-code FMUs.
<em>[For example, the Windows API only supports full path-names of a file up to 260 characters (see: <a href="http://msdn.microsoft.com/en-us/library/aa365247%28VS.85%29.aspx" class="bare">http://msdn.microsoft.com/en-us/library/aa365247%28VS.85%29.aspx</a>).]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_platform_dependent_definitions">2.2.2. Platform Dependent Definitions</h4>
<div class="paragraph">
<p>To simplify porting, no C types are used in the function interfaces, but the alias types are defined in this section.
All definitions in this section are provided in the header file <code>fmi3PlatformTypes.h</code>.
It is required to use this definition for all binary FMUs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void*           fmi3Instance;             /* Pointer to FMU instance */</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a pointer to an FMU specific data structure that contains the information needed to process the model equations or to process the co-simulation of the model/subsystem represented by the FMU.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void*           fmi3InstanceEnvironment;  /* Pointer to FMU environment */</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a pointer to a data structure in the importer.
Using this pointer, data can be transferred between the importer and callback functions it provides (see <a href="#FMUStateSetable">Section 2.3.1</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void*           fmi3FMUState;             /* Pointer to internal FMU state */</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a pointer to a data structure in the FMU that saves the internal FMU state of the actual or a previously saved time instant.
This allows to restart a simulation from a saved FMU state (see <a href="#get-set-fmu-state">[get-set-fmu-state]</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef unsigned int    fmi3ValueReference;       /* Handle to the value of a variable */</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a handle to a (base type) variable value of the model.
A <code>fmi3ValueReference</code> uniquely identifies the value and other properties of a variable, except for the variable name and the display unit that may differ for <a href="#alias"><code>alias</code></a> variable definitions.</p>
</div>
<div class="paragraph">
<p>Structured entities, such as records, must be flattened into a set of values (scalars or arrays) of type <code>fmi3Float64</code>, <code>fmi3Int32</code>, etc.
Arrays may be flattened into a set of scalars or represented directly as array values.
An <code>fmi3ValueReference</code> references one such value (scalar or array).
The coding of <code>fmi3ValueReferences</code> is a "secret" of the environment that generated the FMU.
The interface to the equations only provides access to variable values via <code>fmi3ValueReferences</code>.
Extracting concrete information about a variable can be done by reading the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> in which the <code>fmi3ValueReferences</code> are defined.
If a function in the following sections is called with a wrong <code>fmi3ValueReference</code> value <em>[for example, setting a constant with a call to <code>fmi3SetFloat64</code>]</em>, then the function must return with an error ( <a href="#fmi3Error"><code>fmi3Status == fmi3Error</code></a>, see <a href="#status-returned-by-functions">Section 2.2.3</a>).</p>
</div>
<div class="paragraph">
<p>Listing <a href="#code-base-types">Base types</a> shows the base types used in the interfaces of the C functions.</p>
</div>
<div id="code-base-types" class="listingblock">
<div class="title">Base types</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef           float fmi3Float32;  /* Single precision floating point (32-bit) */
typedef          double fmi3Float64;  /* Double precision floating point (64-bit) */
typedef          int8_t fmi3Int8;     /* 8-bit signed integer */
typedef         uint8_t fmi3UInt8;    /* 8-bit unsigned integer */
typedef         int16_t fmi3Int16;    /* 16-bit signed integer */
typedef        uint16_t fmi3UInt16;   /* 16-bit unsigned integer */
typedef         int32_t fmi3Int32;    /* 32-bit signed integer */
typedef        uint32_t fmi3UInt32;   /* 32-bit unsigned integer */
typedef         int64_t fmi3Int64;    /* 64-bit signed integer */
typedef        uint64_t fmi3UInt64;   /* 64-bit unsigned integer */
typedef            char fmi3Boolean;  /* Data type to be used with fmi3True and fmi3False */
typedef            char fmi3Char;     /* Data type for one character */
typedef const fmi3Char* fmi3String;   /* Data type for character strings
                                         ('\0' terminated, UTF-8 encoded) */
typedef            char fmi3Byte;     /* Smallest addressable unit of the machine
                                         (typically one byte) */
typedef const fmi3Byte* fmi3Binary;   /* Data type for binary data
                                         (out-of-band length terminated) */
typedef             int fmi3Clock ;   /* Data type to be used with fmi3ClockActive and
                                         fmi3ClockInactive */

/* Values for fmi3Boolean */
#define fmi3True  1
#define fmi3False 0

/* Values for fmi3Clock */
#define fmi3ClockActive   1
#define fmi3ClockInactive 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data types <code>fmi3Float32</code>, <code>fmi3Float64</code>, <code>fmi3Int8</code>, <code>fmi3UInt8</code>, <code>fmi3Int16</code>, <code>fmi3UInt16</code>, <code>fmi3Int32</code>, <code>fmi3UInt32</code>, <code>fmi3Int64</code>, <code>fmi3UInt64</code> and <code>fmi3Boolean</code> are called "numeric types" in the following.</p>
</div>
<div class="paragraph">
<p>If an <code>fmi3String</code> or an <code>fmi3Binary</code> variable is passed as <code>input</code> argument to an FMI function and the FMU needs to use the string/binary later,
the FMI function must copy the string/binary before it returns and store it in the internal FMU memory,
because there is no guarantee for the lifetime of the string/binary after the function has returned.</p>
</div>
<div class="paragraph">
<p>If an <code>fmi3String</code> or an <code>fmi3Binary</code> variable is passed as <code>output</code> argument from an FMI function and the string/binary shall be used in the target environment,
the target environment must copy the whole string/binary (not only the pointer).
The memory of this string/binary may be deallocated by the next call to any of the FMI functions (the string/binary memory might also be just a buffer, that is reused).</p>
</div>
</div>
<div class="sect3">
<h4 id="status-returned-by-functions">2.2.3. Status Returned by Functions</h4>
<div class="paragraph">
<p>This section defines the <code>status</code> flag (an enumeration of type <code>fmi3Status</code> defined in file <code>fmi3FunctionTypes.h</code> ) that is returned by all functions to indicate the success of the function call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef enum {
    fmi3OK,
    fmi3Warning,
    fmi3Discard,
    fmi3Error,
    fmi3Fatal,
} fmi3Status;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The status has the following meaning:</p>
</div>
<div id="fmi3OK" class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3OK</code></dt>
<dd>
<p>The call was successful.
The output argument values are defined.</p>
</dd>
</dl>
</div>
<div id="fmi3Warning" class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3Warning</code></dt>
<dd>
<p>A non-critical problem was detected, but the computation can continue.
The output argument values are defined.
Function <a href="#logMessage"><code>logMessage</code></a> was called by the FMU and the user is expected to handle the problem.
<em>[In certain applications, e.g. in a prototyping environment, warnings may be acceptable.</em>
<em>For production environments warnings should be treated like errors unless they can be safely ignored.]</em></p>
</dd>
</dl>
</div>
<div id="fmi3Discard" class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3Discard</code></dt>
<dd>
<p>The call was not successful and the FMU is in the same state as before the call.
The output argument values are not defined, but the computation can continue.
When debug logging is enabled (<code>loggingOn == fmi3True</code>) the function <a href="#logMessage"><code>logMessage</code></a> was called by the FMU.
Advanced simulation algorithms can try alternative approaches to drive the simulation by calling the function with different arguments or calling another function.
Otherwise the simulation algorithm has to treat this return code like <a href="#fmi3Error"><code>fmi3Error</code></a> and has to terminate the simulation.</p>
</dd>
</dl>
</div>
<div id="fmi3Error" class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3Error</code></dt>
<dd>
<p>The call failed.
The output argument values are undefined and the simulation cannot be continued.
Function <a href="#logMessage"><code>logMessage</code></a> was called by the FMU and the FMU is in state <strong>Terminated</strong>.
If a function returns <a href="#fmi3Error"><code>fmi3Error</code></a>, it is possible to restore a previously retrieved FMU state by calling <a href="#fmi3SetFMUState"><code>fmi3SetFMUState</code></a>.
Otherwise <a href="#fmi3FreeInstance"><code>fmi3FreeInstance</code></a> or <a href="#fmi3Reset"><code>fmi3Reset</code></a> must be called.
When detecting illegal arguments or a wrong function call at the current FMU state, the FMU must return <a href="#fmi3Error"><code>fmi3Error</code></a>.
Other instances of this FMU are not affected by the error.</p>
</dd>
</dl>
</div>
<div id="fmi3Fatal" class="dlist">
<dl>
<dt class="hdlist1"><code>fmi3Fatal</code></dt>
<dd>
<p>The state of all instances of the model is irreparably corrupted.
<em>[For example, due to a run-time exception such as access violation or integer division by zero during the execution of an FMI function.]</em>
Function <a href="#logMessage"><code>logMessage</code></a> was called by the FMU.
It is not allowed to call any other function for any instance of the FMU.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="inquire-version-number">2.2.4. Inquire Version Number of Header Files</h4>
<div id="fmi3GetVersion" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef const char* fmi3GetVersionTYPE(void);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns <code>fmi3Version</code> of the <code>fmi3Functions.h</code> header file which was used to compile the functions of the FMU.
This function call is allowed always and in all interface types.</p>
</div>
<div class="paragraph">
<p>The standard header file as documented in this specification has version <code>"3.0"</code>, so this function returns <code>"3.0"</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="get-and-set-variable-values">2.2.5. Getting and Setting Variable Values</h4>
<div class="paragraph">
<p>All variables of an FMU are identified with a handle called <a href="#valueReference">value reference</a>.
The handle is defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file as attribute <a href="#valueReference"><code>valueReference</code></a> in variable elements.
Each variable must have a unique <a href="#valueReference"><code>valueReference</code></a>.</p>
</div>
<div class="paragraph">
<p>A variable can be a scalar or an array.
When getting or setting the values of array variables, the serialization of array variable values used in C-API function calls, as well as in the XML <a href="#start"><code>start</code></a> attributes, is defined as row major - i.e. dimension order from left to right for the C-API (e.g. <code>array[dim1][dim2]&#8230;&#8203;[dimN]</code>), and the document order in the XML attributes for the respective dimensions.
For this serialization of array variables the sparsity pattern of the array is not taken into account.
All elements of the array, including structural zeros, are serialized.</p>
</div>
<div class="paragraph">
<p><em>[Example: A 2D matrix</em></p>
</div>
<div class="stemblock">
<div class="content">
\[A = \left( \begin{array}{cc} a_{11}&amp;a_{12}\\
                             a_{21}&amp;a_{22}\\
                             a_{31}&amp;a_{32}\\
            \end{array} \right)\]
</div>
</div>
<div class="paragraph">
<p><em>is serialized as follows:</em></p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[0][0]=a11</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[0][1]=a12</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A+1</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[1][0]=a21</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A+2</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[1][1]=a22</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A+3</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[2][0]=a31</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A+4</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A[2][1]=a32</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>memory  address: A+5</em></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>The actual values of the variables that are defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file can be inquired after calling <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a> with the following functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetFloat32TYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Float32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetFloat64TYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Float64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetInt8TYPE   (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Int8 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetUInt8TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3UInt8 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetInt16TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Int16 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetUInt16TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3UInt16 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetInt32TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Int32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetUInt32TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3UInt32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetInt64TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Int64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetUInt64TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3UInt64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetBooleanTYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3Boolean values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetStringTYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      fmi3String values[],
                                      size_t nValues);

typedef fmi3Status fmi3GetBinaryTYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      size_t sizes[],
                                      fmi3Binary values[],
                                      size_t nValues);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get actual values of variables by providing their variable references.
<em>[These functions are used to get the values of output variables if a model is connected with other models.
Since state derivatives are also variables, it is also possible to get the value of a state derivative.
Furthermore, the actual value of every variable defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file can be determined at the actually defined time instant (see <a href="#definition-of-model-variables">Section 2.4.8</a>).]</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>valueReferences</code> is a vector of <code>nValueReferences</code> value handles that define the variables that shall be inquired.</p>
</li>
<li>
<p><code>values</code> is a vector with the actual values of these variables.</p>
</li>
<li>
<p><code>sizes</code> is a vector with the actual sizes of the values for binary variables.</p>
</li>
<li>
<p><code>nValues</code> provides the number of values in the <code>values</code> vector (and <code>sizes</code> vector, where applicable) which is only equal to <code>nValueReferences</code> if all <a href="#valueReference"><code>valueReference</code></a>s point to scalar variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The strings returned by <code>fmi3GetString</code>, as well as the binary values returned by <code>fmi3GetBinary</code>, must be copied in the target environment because the allocated memory for these strings might be deallocated or overwritten by the next call to any of the FMI functions.</p>
</div>
<div class="paragraph">
<p>For Model Exchange: <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a> is possible for <code>fmi3GetFloat32</code> and <code>fmi3GetFloat64</code> only, but not for <code>fmi3Get*Int*</code>, <code>fmi3GetBoolean</code>, <code>fmi3GetString</code>, <code>fmi3GetBinary</code>, because these are discrete-time variables and their values can only change at an event instant where <a href="#fmi3Discard"><code>fmi3Discard</code></a> does not make sense.</p>
</div>
<div class="paragraph">
<p>It is also possible to set the values of certain variables at particular instants in time using the following functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetFloat32TYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Float32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetFloat64TYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Float64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetInt8TYPE   (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Int8 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetUInt8TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3UInt8 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetInt16TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Int16 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetUInt16TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3UInt16 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetInt32TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Int32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetUInt32TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3UInt32 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetInt64TYPE  (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Int64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetUInt64TYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3UInt64 values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetBooleanTYPE(fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3Boolean values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetStringTYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const fmi3String values[],
                                      size_t nValues);

typedef fmi3Status fmi3SetBinaryTYPE (fmi3Instance instance,
                                      const fmi3ValueReference valueReferences[],
                                      size_t nValueReferences,
                                      const size_t sizes[],
                                      const fmi3Binary values[],
                                      size_t nValues);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set <a href="#parameter"><code>parameters</code></a>, <a href="#input"><code>inputs</code></a>, and <a href="#start"><code>start</code></a> values, and re-initialize caching of variables that depend on these variables (see <a href="#definition-of-model-variables">Section 2.4.8</a> for the exact rules on which type of variables <code>fmi3Set{VariableType}</code> can be called, as well as <a href="#state-machine-model-exchange">Section 3.2.3</a> in case of Model Exchange, and <a href="#state-machine-co-simulation">Section 4.2.7</a> for Co-Simulation and <a href="#state-machine-scheduled-execution">Section 5.2.1</a> for Scheduled Execution).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>valueReferences</code> is a vector of <code>nValueReferences</code> value handles that define the variables that shall be set.</p>
</li>
<li>
<p><code>values</code> is a vector with the actual values of these variables.</p>
</li>
<li>
<p><code>sizes</code> is a vector with the actual sizes of the values of binary variables.</p>
</li>
<li>
<p><code>nValues</code> provides the number of values in the <code>values</code> vector (and <code>sizes</code> vector, where applicable) which is only equal to <code>nValueReferences</code> if all <a href="#valueReference"><code>valueReference</code></a>s point to scalar variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All strings passed as arguments to <code>fmi3SetString</code>, as well as all binary values passed as arguments to <code>fmi3SetBinary</code>, must be copied inside these functions, because there is no guarantee of the lifetime of strings or binary values, when these functions return.</p>
</div>
<div class="paragraph">
<p>Note, <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a> is possible for the <code>fmi3Set{VariableType}</code> functions.</p>
</div>
<div class="paragraph">
<p>The value of a variable may only be accessed with the respective <code>fmi3Get/Set{VariableType}</code> for its type.</p>
</div>
</div>
<div class="sect3">
<h4 id="advancing-time">2.2.6. Advancing Time</h4>
<div class="paragraph">
<p>This section highlights the differences of the concept of time (in general the independent variable) for the three different FMI types, ME, CS and SE.</p>
</div>
<div class="paragraph">
<p>In Model Exchange, time is under the sole control of the importer and its integration algorithm.
The model itself receives the current time to be used in its computation with <a href="#fmi3SetTime"><code>fmi3SetTime</code></a>.
In fact, time is not necessarily advancing linearly as solvers might need to find zero-crossing points or the importer uses the Model Exchange FMU to find points of optimal control.</p>
</div>
<div class="paragraph">
<p>In Co-Simulation, time advances in (possibly variable) steps negotiated between the co-simulation algorithm of the importer and the FMU.
The importer calls <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with the <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> and a target <a href="#communicationStepSize"><code>communicationStepSize</code></a> (required to be larger than 0.0).
During this <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>, both importer and FMU might encounter events that will reduce the <a href="#communicationStepSize"><code>communicationStepSize</code></a> (potentially even down to 0.0).
The FMU may use <a href="#earlyReturn"><code>earlyReturn</code></a> argument of the <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> function to tell the import that the FMU needs to return earlier, and the importer may use the callback <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> to signal the FMU that the later should return earlier.
This way both can determine if such a step-size reduction is required.
The output argument <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> allows the FMU to signal the importer its current internal time.</p>
</div>
<div class="paragraph">
<p>In Scheduled Execution, time has a more discrete form.
The scheduler of the importer activates specific tasks according to the time of the importer.
The time itself is communicated to the FMU as <a href="#activationTime"><code>activationTime</code></a> argument of <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>.</p>
</div>
<div class="paragraph">
<p>Depending on the instantiated FMI type, the importer is restricted in what functions it is allowed to call in order to drive the simulation.
The following chapters will focus on what mechanisms are relevant for the interface type at hand, without trying to constantly declare which functions not to use because they belong to the other interface type mechanisms.</p>
</div>
</div>
<div class="sect3">
<h4 id="operation-on-clocks">2.2.7. Operation on Clocks</h4>
<div class="paragraph">
<p>In the following section the operations on <a href="#clock"><code>clocks</code></a> are described.
Clocks are defined for the exact timing of evaluations of clocked model partitions and exact timing of event handling across FMUs.
<em>[In FMI 2.0 event detection in a system of FMUs was still done inside each of the FMUs individually with all the issues of floating point arithmetic.</em>
<em>Clocks offer a way to delegate event triggering to the importer to ensure that events meant to trigger at the exact same time will be synchronized across FMUs.]</em></p>
</div>
<div class="paragraph">
<p>Two types of <a href="#clock"><code>clocks</code></a> are available, designed to address similar use cases with differences in details.
The <a href="#clock"><code>clock</code></a> type "<a href="#SynchronousClocks">Synchronous Clocks</a>"" complies with the limitations imposed by the synchronous clock theory, the other clock type "<a href="#CommunicationPointClocks">Communication Point Clocks</a>" is a general purpose co-simulation clock for providing suitable communication points for the timed evaluation of model partitions.
The term <a href="#clock"><code>clock</code></a> is used for both <a href="#clock"><code>clock</code></a> types.</p>
</div>
<div class="sect4">
<h5 id="SynchronousClocks">2.2.7.1. Synchronous Clocks</h5>
<div class="paragraph">
<p><em>[The main use case of synchronous clocks is to facilitate the simulation of systems with:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>different components whose behavior is triggered at different times by events, and</em></p>
</li>
<li>
<p><em>the components that trigger the events are different than the components handling those events.</em>]</p>
</li>
</ul>
</div>
<div id="figure-synchronous-clock-example" class="imageblock text-center">
<div class="content">
<img src="images/synchronous-clock-example.svg" alt="synchronous clock example" width="80%">
</div>
<div class="title">Figure 3. Sample scenario showcasing use of synchronous clocks.</div>
</div>
<div class="paragraph">
<p><em>[Consider the system in <a href="#figure-synchronous-clock-example">Figure 3</a>:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>The controller samples the plant at some rate \(r\), and the plant is continuously affected by the actuator values between samples.</em></p>
</li>
<li>
<p><em>A supervisor adapts the controller behavior when some criteria on \(u\) is met.</em></p>
</li>
<li>
<p><em>When there is a new sample of \(x\), the equations in blue have to be executed synchronously (i.e., at the exact same time).</em></p>
</li>
<li>
<p><em>Similarly, when the supervisor decides to update the controller behavior, the equations in purple have to be executed synchronously.</em></p>
</li>
<li>
<p><em>\(previous(u_r)\) means the value of \(u_r\) computed at the previous sample by the controller.]</em></p>
</li>
</ul>
</div>
<div id="figure-synchronous-clock-example-plot" class="imageblock text-center">
<div class="content">
<img src="images/synchronous-clock-example-plot.svg" alt="synchronous clock example plot" width="30%">
</div>
<div class="title">Figure 4. Example plot of the scenario introduced in <a href="#figure-synchronous-clock-example">Figure 3</a>.</div>
</div>
<div class="paragraph">
<p><em>[<a href="#figure-synchronous-clock-example-plot">Figure 4</a> illustrates a potential behavior of this example.
Note that it is the supervisor that decides when to adapt the behavior of the controller, but the controller has to be executed when that happens.
Also note that the change in controller behavior should only be reflected on its output when the next sample of the plant is done.]</em></p>
</div>
<div id="figure-synchronous-clock-scenario" class="imageblock text-center">
<div class="content">
<img src="images/synchronous-clock-scenario.svg" alt="synchronous clock scenario" width="80%">
</div>
<div class="title">Figure 5. Realization of the system in <a href="#figure-synchronous-clock-example">Figure 3</a> using FMI 2.0 Model Exchange FMUs.</div>
</div>
<div class="paragraph">
<p><em>[In order to understand the problem that synchronous clocks are trying to solve, it helps to try to implement the above system with FMI 2.0 Model Exchange FMUs.
Such implementation is illustrated in <a href="#figure-synchronous-clock-scenario">Figure 5</a>.
In this implementation, time and state events can be used to mimic the behavior in <a href="#figure-synchronous-clock-example-plot">Figure 4</a> with the Sensor FMU or Supervisor FMU driving the simulation into event mode when the events happen.]</em></p>
</div>
<div class="paragraph">
<p><em>[However, this approach poses a big problem: since both Ctrl and Sensor FMUs have time events to sample with frequency \(x\), it is unclear how the importer will guarantee that the two are going to executed in the same event mode.</em>
<em>Due to floating point precision, it can happen that the importer takes both FMUs into event mode, but only one knows that it is entering event mode because it has to sample the signal.</em>
<em>It makes it unclear which equations should be executed.]</em></p>
</div>
<div class="paragraph">
<p><em>[This is the problem that synchronous clocks solve.</em>
<em>Getting back to the example in <a href="#figure-synchronous-clock-scenario">Figure 5</a>, by making Ctrl and Sensor share a clock, it will be clear which FMU is triggering the event, and it is easier for them to be executed at the same exact time.]</em></p>
</div>
<div id="figure-synchronous-clock-scenario-clocked" class="imageblock text-center">
<div class="content">
<img src="images/synchronous-clock-scenario-clocked.svg" alt="synchronous clock scenario clocked" width="80%">
</div>
<div class="title">Figure 6. Realization of the system in <a href="#figure-synchronous-clock-example">Figure 3</a> using synchronous clocks.</div>
</div>
<div class="paragraph">
<p><em>[<a href="#figure-synchronous-clock-scenario-clocked">Figure 6</a> illustrates one way to use clocks to realize the system introduced in <a href="#figure-synchronous-clock-example">Figure 3</a>.
The red lines denote clock connections.
The Ctrl FMU declares an output clock \(r\), and the Sensor and Actuator FMUs declare input clocks, connected to \(r\).
This way, the importer knows that when the Ctrl clock \(r\) ticks, then the Sensor and Actuator FMUs will be informed that the clock ticked and execute the corresponding equations.]</em></p>
</div>
<div class="paragraph">
<p><em>[In general:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>The ticking of an output clock is determined by the FMU that declares it.</em>
<em>So in <a href="#figure-synchronous-clock-scenario-clocked">Figure 6</a>, the Supervisor FMU determines the ticking of \(s\) and Ctrl FMU determines the ticking of \(r\).</em>
<em>The FMU Ctrl declared both an input clock and an outut clock, and the Sensor and Actuator FMUs both declare an input clock.</em></p>
</li>
<li>
<p><em>The ticking of an input clock is signaled by the importer, which in turn will find the source that determines the ticking of such clock.]</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A clocked partition is a set of equations that are associated to a <a href="#clock"><code>clock</code></a> and are executed when the corresponding <a href="#clock"><code>clock</code></a> is active.
A clocked partition is mathematically defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\[x_j=\begin{cases}
    x_{j-1} &amp; \text{if subactive}\\
    f_j(x_{j-1},u_j,t_j) &amp; \text{else}
    \end{cases}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[y_j=g_j(x_{j-1},u_j,t_j);\]
</div>
</div>
<div class="paragraph">
<p><em>[TODO: shouldn&#8217;t this be:
Claudio: rewrite this to make it clearer: the distinction between these two are just local vars and outputs.
Claudio: Also relate to the previous example.
Claudio: Also change the modelica sentence.
Claudio: Make it clear that clocks are just a way to implement numerically sound event having across different FMUs.
]</em></p>
</div>
<div class="stemblock">
<div class="content">
\[y_j=g_j(x_{j},u_j,t_j);\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\text{with } j=0,1,2,...;x_{-1}=x_{\mathit{start}}\]
</div>
</div>
<div class="paragraph">
<p>Variables \(x_j\) are called <code>states of a clocked partition</code>, or <code>discrete-time states</code> and \(j\) is the \(j+1\)th tick of the associated <a href="#clock"><code>clock</code></a>.
Variables \(u_j\) are the (external or <a href="#local"><code>local</code></a>) <a href="#input"><code>inputs</code></a> and \(y_j\) are the (external or <a href="#local"><code>local</code></a>) <a href="#output"><code>outputs</code></a> of a clocked partition.
A discrete-time state variable can be of any type (e.g. <code>fmi3Float64</code> or <code>fmi3Boolean</code>, but not of <a href="#clock"><code>clock</code></a> type).</p>
</div>
<div class="paragraph">
<p><em>[TODO: (external or local) is here very confusing]</em></p>
</div>
<div class="paragraph">
<p>A clocked partition is not executed during <strong>Initialization Mode</strong>, but it is executed the first time at its first <a href="#clock"><code>clock</code></a> tick.
The associated <a href="#clock"><code>clock</code></a> of the model partition is synchronous to its discrete-time states.</p>
</div>
<div class="paragraph">
<p>Discrete-time states are listed in the <code>&lt;ModelStructure&gt;</code>.
They can have initial values defined by XML attributes <a href="#initial"><code>initial</code></a> and <a href="#start"><code>start</code></a>, or the initial values are computed internally as a function of the parameters.</p>
</div>
<div class="paragraph">
<p>There are two kinds of evaluation modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Regular evaluation for an active <a href="#clock"><code>clock</code></a>: <a href="#state"><code>state</code></a> and <a href="#output"><code>output</code></a> equations are evaluated.
States get updated.
Current input values are taken into account.</p>
</li>
<li>
<p>Partial evaluation for a subactive <a href="#clock"><code>clock</code></a>: <a href="#state"><code>states</code></a> are left unmodified, only outputs are computed.
Current input values are taken into account.</p>
<div class="paragraph">
<p><em>[This mode can be used to compute partial derivatives</em> \(\partial y_j / \partial x_{j-1}\) <em>.]</em></p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="CommunicationPointClocks">2.2.7.2. Communication Point Clocks</h5>
<div class="paragraph">
<p>Communication Point Clocks, introduced here, are used to define the communication points of model partitions (defined below).
These <a href="#clock"><code>clocks</code></a> are not compatible with synchronous clock theory and must not be used together with <a href="#SynchronousClocks">Synchronous Clocks</a> in one model.</p>
</div>
<div class="paragraph">
<p>A model partition is mathematically defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\[x_j=f_j(x_{j-1},u_j,t_j)\]
</div>
</div>
<div class="paragraph">
<p><em>[TODO: why do we need y_j here? it is not mentioned afterwards]</em></p>
</div>
<div class="stemblock">
<div class="content">
\[y_j=g_j(x_{j-1},u_j,t_j)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\text{with } j=0,1,2,...;x_{-1}=x_{\mathit{start}}\]
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(x\) denotes the variables that are associated with the model partition.
These are the variables that are computed when the model partition is evaluated.
Each variable in \(x\) is associated with one, and only one, model partition.
Multiple model partitions, when evaluated, may read the value of a single variable, but only one will change it.</p>
</li>
<li>
<p>\(u_j\) denotes the variables that are read, but not changed, when the model partition is evaluated.</p>
</li>
<li>
<p>\(t_j\) denotes the time at which the model partition is evaluated.</p>
</li>
<li>
<p>\(x_{\mathit{start}}\) denotes the start value of the variables that are associated with the model partition.
This is the value that has been computed before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Communication Point Clocks can also be defined for continuous or piecewise continuous parts of the model.</p>
</div>
<div class="paragraph">
<p>Please refer to <a href="#example-scheduled-execution">Section 5.2.3</a> for an FMU example of scheduled execution.</p>
</div>
<div class="sect5">
<h6 id="_clock_priority">2.2.7.2.1. Clock Priority</h6>
<div class="paragraph">
<p>The <a href="#clock"><code>clocks</code></a> are ordered descending based on their priorities.
It is nevertheless possible to define multiple <a href="#clock"><code>clocks</code></a> with the same priority.
No ordering is defined for <a href="#clock"><code>clocks</code></a> of the same priority.
If a computational order information is needed, different priorities for <a href="#clock"><code>clocks</code></a> have to be defined.
The priority of a <a href="#clock"><code>clock</code></a> has to be defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> via the <a href="#clock"><code>clock</code></a> variable integer attribute <code>priority</code> - smaller values have a higher priority.</p>
</div>
<div class="paragraph">
<p><em>[For <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> it is recommended to derive the priorities based on a rate monotonic scheduling scheme (smallest period leads to highest priority, that is, has the smallest priority value.]</em></p>
</div>
<div class="paragraph">
<p><em>[The clock priorities are local to an FMU.
It is not possible for an FMU exporting tool to know in advance the priorities of other FMUs that will be connected to an FMU in a simulation setup.
It is the task of the simulation algorithm to derive a computational order for the computation of two or more distinct FMUs based on the local FMU clock priorities and input-output relationships of connected FMUs.]</em></p>
</div>
<div class="paragraph">
<p><em>[For real-time computation use cases (e.g., in Scheduled Execution), the priority information is used also for task preemption configurations.
It is therefore important to restrict the number of distinct priority levels for an FMU to available priority levels on the target platform and/or to avoid unnecessary computational overhead.
A common number of different priority levels is, e.g., 100 (0 to 99), as defined in Linux based operating systems.]</em></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="outputClockVariant">2.2.7.3. Output Clocks</h5>
<div class="paragraph">
<p>An <a href="#outputClock"><code>outputClock</code></a> is a general <a href="#clock"><code>clock</code></a> that ticks when a time-, state- or step-event occurs in the continuous-model partition of the FMU (for <a href="#CommunicationPointClocks">Communication Point Clocks</a> these <a href="#outputClock"><code>outputClock</code></a> activations can occur in all model partitions) and are identified based on their <a href="#valueReference"><code>valueReference</code></a>.
The clock can be <a href="#periodic"><code>periodic</code></a> or <a href="#periodic">aperiodic</a>.</p>
</div>
<div class="paragraph">
<p><em>[Example: If</em> \(b = x &gt; 0\) <em>, and a <a href="#state-event">state event</a> is defined when b changes from <code>false</code> to <code>true</code>, and b is defined as <a href="#outputClock"><code>outputClock</code></a>, then this <a href="#clock"><code>clock</code></a> is active whenever x changes from negative to positive values.]</em></p>
</div>
<div class="paragraph">
<p>Since <a href="#outputClock"><code>output clocks</code></a> are ticking based on model internal information, it is required in case of FMI for Co-Simulation to signal the ticking of an <a href="#outputClock"><code>outputClock</code></a> to the simulation environment during a <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> or <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> computation.
In most cases <em>[TODO: not all cases? which cases? if the time of the clock tick is a communication point already?]</em> the signaling of an <a href="#outputClock"><code>outputClock</code></a> tick requires creating a communication point for exchanging additional information (i.e. variable values) with the simulation environment.
Additional cases need to be handled if a <a href="#clock"><code>clock</code></a> tick is not associated to an event that requires the creation of a communication point for the model partition that generated the event. <em>[TODO: what?]</em></p>
</div>
<div class="paragraph">
<p><em>[Outside of the FMU it is not known in advance when this <a href="#clock"><code>clock</code></a> ticks.</em>
<em>Instead, only when the <a href="#clock"><code>clock</code></a> is activated by the FMU, then the environment is informed that the <a href="#clock"><code>clock</code></a> ticks at this time instant.</em>
<em>It is the task of the environment to handle the messaged events appropriately based on the <a href="#clockReference"><code>clockReference</code></a> information.</em>
<em>Example:</em>
<em>]</em></p>
</div>
<div class="paragraph">
<p><em>[TODO: local clocks should be introduced here too, they are just used afterwards.
Issue 1172 will address the definition of local variables (including local clocks).
Then we can introduce a section here on local clocks.
]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="inputClockVariant">2.2.7.4. Input Clocks</h5>
<div class="paragraph">
<p>An <a href="#inputClock"><code>inputClock</code></a> is a <a href="#periodic"><code>periodic</code></a> or <a href="#periodic">aperiodic</a> <a href="#clock"><code>clock</code></a> that is defined by a <a href="#clock"><code>clock</code></a> outside of the FMU.
I.e., only when the <a href="#clock"><code>clock</code></a> is activated by the environment of the FMU, then the FMU is informed that the <a href="#clock"><code>clock</code></a> ticks at this time instant.
An <a href="#inputClock">input clocks</a> must be independent to all other input clocks.
_[TODO: what does that mean?]
If dependent clocks exist, they can be exposed as <a href="#local"><code>local</code></a> or <a href="#output"><code>output</code></a> clocks.</p>
</div>
<div class="paragraph">
<p><em>[
TODO:
Claudio: Explain why we have periodic clocks: because of the numerical problems.
]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="clock-relationships-for-communication-point-clocks">2.2.7.5. Clock Unions</h5>
<div class="paragraph">
<p>It is possible for an <a href="#inputClock"><code>inputClock</code></a> to depend on an <a href="#outputClock"><code>outputClock</code></a> of the same FMU using the <a href="#triggeredBy"><code>triggeredBy</code></a> attribute of <a href="#inputClock"><code>inputClock</code></a> variables.
An <a href="#outputClock"><code>output clock</code></a> and the associated <a href="#inputClock"><code>input clocks</code></a> define a clocks union to indicate that the <a href="#outputClock"><code>outputClock</code></a> triggers the associated <a href="#inputClock"><code>input clocks</code></a> at the same time instant.
It is only meaningful to combine an <a href="#outputClock"><code>output clock</code></a> with an <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>inputClock</code></a>.
It is possible to define multiple unions of <a href="#clock"><code>clocks</code></a>.
An <a href="#inputClock"><code>input clock</code></a> may be contained in at most one clock union <em>[naturally limited by the single <a href="#triggeredBy"><code>triggeredBy</code></a> attribute]</em>.
An <a href="#outputClock"><code>output clock</code></a> can be part of multiple clock unions.</p>
</div>
<div class="paragraph">
<p>Clock unions are needed to allow for an external scheduler to achieve an optimal control of model partitions and are applicable to both <a href="#SynchronousClocks">Synchronous Clocks</a> and <a href="#CommunicationPointClocks">Communication Point Clocks</a> and therefore apply to ME, CS and SE.
<em>[TODO: ??? model partitions only belong to Communication point clocks, how can this be true??
Claudio:
- the FMU needs a mechanism to tell the importer that the FMU needs to go into event iteration when its own output clock ticks.
  It&#8217;s just a mechanism for the FMU to use its own output clocks as an input clock without having to rely on the master.
- The importer need to trigger explicitly that input clock (refer to input clock section) after the output clock ticks.
- Replace table by "Only aperiodic input clocks can be part of a union.".
]</em>
<em>[TODO: Does the importer have to activate the corresponding input clocks???]</em></p>
</div>
<div class="paragraph">
<p>The following table lists which <a href="#inputClock"><code>inputClock</code></a> variants can be combined with which <a href="#outputClock"><code>outputClock</code></a> variants:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input clock variant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output clock variant</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aperiodic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">aperiodic, periodic, strictly periodic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">periodic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">strictly periodic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div id="ExampleUseCase" class="imageblock">
<div class="content">
<img src="images/example_usecase.png" alt="example usecase">
</div>
</div>
<div class="paragraph">
<p>_[TODO: This example is given here out of context.
Shouldn&#8217;t this be at SE? The text of of the figure should be normal text and.
What is a Heider model?
Claudio: remove it.
]</p>
</div>
</div>
<div class="sect4">
<h5 id="_dependent_output_clocks">2.2.7.6. Dependent Output Clocks</h5>
<div class="paragraph">
<p>If an <a href="#outputClock"><code>outputClock</code></a> depends on an <a href="#inputClock"><code>inputClock</code></a>, the attribute <a href="#clockReference"><code>clockReference</code></a> is used to indicate that the <a href="#outputClock"><code>outputClock</code></a> may (but does not have to) tick if and only if the referenced <a href="#inputClock"><code>inputClock</code></a> ticks.
An <a href="#outputClock"><code>outputClock</code></a> may depend on other unknowns, see the attribute <a href="#dependencies"><code>dependencies</code></a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="periodic-clock-ticks">2.2.7.7. Periodic Clock Ticks</h5>
<div class="paragraph">
<p>Either <a href="#output"><code>output</code></a> or <a href="#input"><code>input</code></a>, a <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clock</code></a> ticks at equidistant sample time points that are known a priori (defined in <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>) or are alternatively determined by the environment in case of <a href="#inputClock"><code>input clocks</code></a>.</p>
</div>
<div class="paragraph">
<p><em>[TODO: A <a href="#periodic"><code>periodic</code></a> <a href="#output"><code>output</code></a> <a href="#clock"><code>clock</code></a> ticks at a priori equidistant time points.</em>
<em>The ticks of a <a href="#periodic"><code>periodic</code></a> <a href="#input"><code>input</code></a> <a href="#clock"><code>clock</code></a> are given by the importer.
FMI Design meeting: merge this sentence with the previous one.
Missing the relationship to strict clocks.]</em></p>
</div>
<div class="paragraph">
<p>Mathematically, the next <a href="#clock"><code>clock</code></a> tick at time instant \(t_i\) is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
t_0 &amp;:= t_{\mathit{start}} + t_{\mathit{offset}} \\
t_i &amp;:= t_{i-1} + \Delta T, i = 1,2,3,{...}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(t_0\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time instant in seconds at which the <a href="#clock"><code>clock</code></a> ticks the first time (= the base <a href="#clock"><code>clock</code></a> starts at the start of the simulation \(t_{\mathit{start}}\) or when the controller is switched on plus an offset time \(t_{\mathit{offset}}\) (xml-attributes <code>shiftCounter</code> and <code>resolution</code> in <a href="#clock-type-definition">Section 2.4.4.1</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(t_{i-1}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The previous time instant in seconds, where the <a href="#clock"><code>clock</code></a> ticked.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(\Delta T &gt; 0\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The constant time interval from the previous <a href="#clock"><code>clock</code></a> tick to the current <a href="#clock"><code>clock</code></a> tick.
It is defined as a rational number based on <code>intervalCounter</code> and <code>resolution</code> via <a href="#clock"><code>clock</code></a> variable attributes.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The interval \(\Delta T\) and \(t_{\mathit{offset}}\) must be defined for <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> in the XML file.
In case of <a href="#periodic"><code>periodic</code></a> <a href="#inputClock"><code>input clocks</code></a> these values are the start interval values if they are not given by the simulation algorithm.
<em>[This information can be used for emulating <a href="#periodic"><code>periodic</code></a> <a href="#inputClock"><code>input clocks</code></a> in FMI for Co-Simulation.]</em>.</p>
</div>
<div class="paragraph">
<p><em>[TODO: shouldn&#8217;t we use constant and fixed like for other variable variabilities (strictly periodic = constant periodic; periodic = fixed periodic; aperiodic = tunable periodic! TorstenBlochwitz will start an issue to collect use cases to clarify clock use.)</em>
<em>Does the importer have to call fmi3SetInterval for aperiodic clocks at each clock tick if the clock should tick with the same interval? Or will there be only one clock tick per fmi3SetInterval call?
FMI Design meeting: remark that set interval functions are informative to design model based controllers.
The environment is the one that will tick.
]</em></p>
</div>
<div class="paragraph">
<p>A <a href="#clock"><code>clock</code></a> is <a href="#strict">strictly</a> <a href="#periodic"><code>periodic</code></a> if \(\Delta T\) is fixed for an FMU and cannot be changed.
The <a href="#clock"><code>clock</code></a> is periodic, if \(\Delta T\) can be defined before calling <code>fmi3EnterInitializationMode</code> via <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> or <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a>.
The <a href="#clock"><code>clock</code></a> is <a href="#periodic">aperiodic</a> if \(\Delta T\) is not constant during a simulation run (<a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> or <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a> can be called for that <a href="#clock"><code>clock</code></a> during <strong>Event Mode</strong>).</p>
</div>
</div>
<div class="sect4">
<h5 id="connecting-clocked-fmus">2.2.7.8. Connecting Clocked FMUs</h5>
<div class="paragraph">
<p>When connecting imported FMUs, <a href="#input"><code>input</code></a> and <a href="#output"><code>output</code></a> variables can readily be connected only when they are defined on a <a href="#clock"><code>clock</code></a> with identical properties.
If this is not possible, an explicit cast of one <a href="#clock"><code>clock</code></a> to another <a href="#clock"><code>clock</code></a> is typically defined in the environment.</p>
</div>
<div class="paragraph">
<p><em>[TODO: What is a clock cast? If a clock cast can be done by the environment anyway, why mention which inputs/outputs can be connected?</em>
<em>Remove the entire section: we do not want to say: don&#8217;t be stupid.]</em></p>
</div>
<div class="paragraph">
<p>The environment can evaluate required <a href="#clock"><code>clock</code></a> casts for connections using the information on the <a href="#clockReference"><code>clockReference</code></a> attribute of assigned variables <em>[i.e. the variables that are assigned to a <a href="#clock"><code>clock</code></a> based on <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> information]</em>.</p>
</div>
<div class="paragraph">
<p><em>[Example: Elementary blocks like a PI controller will have all variables on an <a href="#inputClock"><code>inputClock</code></a> with identical properties.</em>
<em>Connecting such blocks together will therefore be possible without computationally expensive clock cast operations (and the environment can readily do the computation of assigned variables of the connected blocks based on the same <a href="#clock"><code>clock</code></a>).]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="fmi-api-setting-getting-clock-activation-state">2.2.7.9. Setting and Getting Clock Activation State</h5>
<div class="paragraph">
<p>A <a href="#clock"><code>clock</code></a> is activated by the environment for the current time instant by the function <a href="#fmi3SetClock"><code>fmi3SetClock</code></a>, and the status of a <a href="#clock"><code>clock</code></a> can be inquired with the function <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>:</p>
</div>
<div id="fmi3SetClock" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetClockTYPE(fmi3Instance instance,
                                    const fmi3ValueReference valueReferences[],
                                    size_t nValueReferences,
                                    const fmi3Clock values[],
                                    const fmi3Boolean subactive[],
                                    size_t nValues);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sets <a href="#clock"><code>clocks</code></a> activation status by providing the value references of the corresponding <a href="#clock"><code>clock</code></a> variables and their values.
Note that <a href="#clock"><code>clock</code></a> variables, like any other variables can be scalar or array variables.
When getting or setting the values of array variables, the serialization of array variable values used in C-API function calls is defined as row major - i.e. dimension order from left to right for the C-API (e.g. <code>array[dim1][dim2]&#8230;&#8203;[dimN]</code>).</p>
</div>
<div class="paragraph">
<p><em>[TODO: the array serialization should be defined once and only referenced here.]</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>valueReferences</code> is a vector of <code>nValueReferences</code> value handles that define the clock variables that shall be set.</p>
</li>
<li>
<p><code>values</code> is a vector with the actual activation values of the clock variables, <code>fmi3ClockActive</code> specifying that the clock is activated, otherwise it is deactivated.</p>
</li>
<li>
<p><code>subactive</code> requires evaluation of a clocked partition in subactive mode (only output equations, no states change) if the argument subactive is not a null pointer and <code>subactive[i] = fmi3True</code>.
<code>subactive[i]</code> has no meaning for <a href="#CommunicationPointClocks">Communication Point Clocks</a> and is ignored for such <a href="#clock"><code>clocks</code></a>.</p>
</li>
<li>
<p><code>nValues</code> provides the number of values in the <code>values</code> and <code>subactive</code> (if not null) vectors, which is only equal to <code>nValueReferences</code> if all <a href="#valueReference"><code>valueReferences</code></a> point to scalar clock variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is not allowed to call this function within the callback function <a href="#intermediateUpdate"><code>intermediateUpdate</code></a>.</p>
</div>
<div id="fmi3GetClock" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetClockTYPE(fmi3Instance instance,
                                    const fmi3ValueReference valueReferences[],
                                    size_t nValueReferences,
                                    fmi3Clock values[],
                                    size_t nValues);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inquires whether a set of <a href="#clock"><code>clocks</code></a> is active by providing the value references of the corresponding <a href="#clock"><code>clock</code></a> variables.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>valueReferences</code> is a vector of <code>nValueReferences</code> value handles that define the clock variables that shall be inquired.</p>
</li>
<li>
<p><code>values</code> will return the activation status at the current time instant of the <a href="#clock"><code>clocks</code></a> referenced by <code>valueReferences[]</code>.
If <code>values[i] == fmi3ClockActive</code> the <a href="#clock"><code>clock</code></a> is currently active, otherwise the <a href="#clock"><code>clock</code></a> is not active.</p>
</li>
<li>
<p><code>nValues</code> provides the number of values in the <code>values</code> vector, which is only equal to <code>nValueReferences</code> if all <a href="#valueReference"><code>valueReferences</code></a> point to scalar clock variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is required for an FMU to directly internally set back the activation <a href="#state"><code>state</code></a> of an output <a href="#clock">clock[i]</a> to <code>fmi3ClockInactive</code>, if the function <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> is called for a <a href="#clock"><code>clock[i]</code></a> and the interface is Scheduled Execution.
<em>[This is required to allow preemption.]</em></p>
</div>
<div class="paragraph">
<p><em>[TODO: WHAT?</em>
<em>Separate issue to discuss needs of preemption.</em>
<em>Link to example.</em>
<em>This is necessary but nor sufficient requirement for preemption.</em>
<em>Pick better name for the Getting to show that the clock is auto-reset.</em>
<em>]</em></p>
</div>
<div class="paragraph">
<p>A <a href="#clock"><code>clock</code></a> interval is set by the environment for the current time instant by the function <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> or <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a>, and it can be inquired with the function <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> or <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a>:</p>
</div>
<div id="fmi3SetIntervalDecimal" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetIntervalDecimalTYPE(fmi3Instance instance,
                                              const fmi3ValueReference valueReferences[],
                                              size_t nValueReferences,
                                              const fmi3Float64 interval[],
                                              size_t nValues);</code></pre>
</div>
</div>
<div id="fmi3SetIntervalFraction" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetIntervalFractionTYPE(fmi3Instance instance,
                                               const fmi3ValueReference valueReferences[],
                                               size_t nValueReferences,
                                               const fmi3UInt64 intervalCounter[],
                                               const fmi3UInt64 resolution[],
                                               size_t nValues);</code></pre>
</div>
</div>
<div id="fmi3GetIntervalDecimal" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetIntervalDecimalTYPE(fmi3Instance instance,
                                              const fmi3ValueReference valueReferences[],
                                              size_t nValueReferences,
                                              fmi3Float64 interval[],
                                              size_t nValues);</code></pre>
</div>
</div>
<div id="fmi3GetIntervalFraction" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetIntervalFractionTYPE(fmi3Instance instance,
                                               const fmi3ValueReference valueReferences[],
                                               size_t nValueReferences,
                                               fmi3UInt64 intervalCounter[],
                                               fmi3UInt64 resolution[],
                                               size_t nValues);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both functions inquire the interval value for the provided <a href="#clock"><code>clocks</code></a> (<a href="#periodic"><code>periodic</code></a> or <a href="#periodic">aperiodic</a>).
If the <a href="#clock"><code>clocks</code></a> are aperiodic, the interval has to be inquired at every <a href="#clock"><code>clock</code></a> tick, to define the follow-up <a href="#clock"><code>clock</code></a> tick.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the use of the API functions by the environment for different kinds of <a href="#clock"><code>clocks</code></a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#outputClock"><code>Output clocks</code> and <code>Local clocks</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#inputClock"><code>Input clocks</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3GetClock</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call during <strong>Event Mode</strong> and only in SE in <strong>Intermediate Update Mode</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3SetClock</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call after entering <strong>Event Mode</strong>.
Repeated calls if recomputations of clock state are needed during <strong>Event Mode</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3GetIntervalDecimal</code> <code>fmi3GetIntervalFraction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call during <strong>Event Mode</strong> and only in SE in <strong>Intermediate Update Mode</strong>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3SetIntervalDecimal</code> <code>fmi3SetIntervalFraction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call after first <a href="#clock"><code>clock</code></a> activation.
(only for <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getting_partial_derivatives">2.2.8. Getting Partial Derivatives</h4>
<div class="paragraph">
<p>It is optionally possible to provide evaluation of partial derivatives for an FMU.
For Model Exchange, this means computing the partial derivatives at any time instant, whereas for Co-Simulation, this means computing the partial derivatives at a communication point.</p>
</div>
<div class="paragraph">
<p>An FMU has different states and in every state an FMU might be described by different equations and different unknowns.
The precise definitions are given in the mathematical descriptions of Model Exchange (<a href="#math-model-exchange">Section 3.1</a>) and Co-Simulation (<a href="#math-co-simulation">Section 4.1</a>).
In every state, the general form of the FMU equations are:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{v}_{\mathit{unknown}} = \mathbf{h}(\mathbf{v}_{\mathit{known}}, \mathbf{v}_{\mathit{rest}}),\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(\mathbf{v}_{\mathit{unknonwn}}\) is the vector of unknown floating point variables computed in the actual state:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Initialization Mode</strong>: The exposed unknowns listed as elements <code>&lt;ModelStructure&gt;&lt;InitialUnknown&gt;</code> that have a floating point type.</p>
</li>
<li>
<p><strong>Continuous-Time Mode</strong> (Model Exchange): The continuous-time outputs and state derivatives (= the variables listed as elements <code>&lt;ModelStructure&gt;&lt;Output&gt;</code> with a floating point type and <a href="#variability"><code>variability</code></a> = <a href="#continuous"><code>continuous</code></a> and the variables listed as elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>).</p>
</li>
<li>
<p><strong>Event Mode</strong> (Model Exchange): The same variables as in the <strong>Continuous-Time Mode</strong> and additionally variables listed as elements <code>&lt;ModelStructure&gt;&lt;Output&gt;</code> with a floating point type and <a href="#variability"><code>variability</code></a> = <a href="#discrete"><code>discrete</code></a>.</p>
</li>
<li>
<p><strong>Step Mode</strong> (Co-Simulation): The variables listed as elements <code>&lt;ModelStructure&gt;&lt;Output&gt;</code> with a floating point type and <a href="#variability"><code>variability</code></a> = <a href="#continuous"><code>continuous</code></a> or <a href="#discrete"><code>discrete</code></a>.
Each state derivative variable listed as elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>, if present.</p>
</li>
</ul>
</div>
</li>
<li>
<p>\(\mathbf{v}_{\mathit{known}}\) is the vector of known floating point <a href="#input"><code>input</code></a> variables of function <strong>h</strong> that changes its value in the actual state.
Details about which variables are in \(\mathbf{v}_{\mathit{known}}\) are given in the description of element <a href="#dependencies"><code>dependencies</code></a> in <a href="#ModelStructure">Section 2.4.9</a>.</p>
</li>
<li>
<p>\({\mathbf{v}_{\mathit{rest}}}\) is the set of <a href="#input"><code>input</code></a> variables of function <strong>h</strong> that either changes its value in the actual state but are non-floating point variables, or do not change their values in this state, but change their values in other states <em>[for example, discrete-time <a href="#input"><code>inputs</code></a> in <strong>Continuous-Time Mode</strong>]</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[The variable relationships are different in different states.</em>
<em>For example, during <strong>Continuous-Time Mode</strong>, a continuous-time output y does not depend on discrete-time <a href="#input"><code>inputs</code></a> (because they are held constant between events).</em>
<em>However, at <strong>Event Mode</strong>, y depends on discrete-time <a href="#input"><code>inputs</code></a>.</em>
<em>The function may compute the directional derivatives by numerical differentiation taking into account the sparseness of the equation system, or (preferred) by analytic derivatives.]</em></p>
</div>
<div class="paragraph">
<p>There are two access functions for partial derivatives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> to compute the directional derivatives \(\mathbf{v}_{\mathit{sensitivity}} = \mathbf{J} \cdot \mathbf{v}_{\mathit{seed}}\), and</p>
</li>
<li>
<p><a href="#fmi3GetAdjointDerivative"><code>fmi3GetAdjointDerivative</code></a> to calculate the adjoint derivatives \(\mathbf{v}_{\mathit{sensitivity}}^T = \mathbf{v}_{\mathit{seed}}^T \cdot \mathbf{J}\)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>with the Jacobian</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{J}
=
\begin{bmatrix}
\frac{\partial h_1}{\partial v_{\mathit{known},1}} &amp; \cdots &amp; \frac{\partial h_1}{\partial v_{\mathit{known},n}} \\
\vdots &amp; \ddots &amp; \vdots \\
\frac{\partial h_m}{\partial v_{\mathit{known},1}} &amp; \cdots &amp; \frac{\partial h_m}{\partial v_{\mathit{known},n}}
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>where \(\mathbf{v}_{\mathit{known}}\) are the \(n\) knowns, and \(\mathbf{h}\) are the \(m\) functions to calculate the \(m\) unknwon variables \(\mathbf{v}_{\mathit{unknwon}}\)  from the knowns.</p>
</div>
<div class="paragraph">
<p>Both functions can also be used to construct the partial derivative matrices.
The functions may only be called if their availability is indicated by the attributes <code>providesDirectionalDerivatives</code> and <code>providesAdjointDerivatives</code> respectively.</p>
</div>
<div id="fmi3GetDirectionalDerivative" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetDirectionalDerivativeTYPE(fmi3Instance instance,
                                                    const fmi3ValueReference unknowns[],
                                                    size_t nUnknowns,
                                                    const fmi3ValueReference knowns[],
                                                    size_t nKnowns,
                                                    const fmi3Float64 seed[],
                                                    size_t nSeed,
                                                    fmi3Float64 sensitivity[],
                                                    size_t nSensitivity);</code></pre>
</div>
</div>
<div id="fmi3GetAdjointDerivative" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetAdjointDerivativeTYPE(fmi3Instance instance,
                                                const fmi3ValueReference unknowns[],
                                                size_t nUnknowns,
                                                const fmi3ValueReference knowns[],
                                                size_t nKnowns,
                                                const fmi3Float64 seed[],
                                                size_t nSeed,
                                                fmi3Float64 sensitivity[],
                                                size_t nSensitivity);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both functions have the same arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unknowns</code> contains value references to the unknowns.</p>
</li>
<li>
<p><code>nUnknowns</code> contains the length of argument <code>unknowns</code>.</p>
</li>
<li>
<p><code>knowns</code> contains value references of the knowns.</p>
</li>
<li>
<p><code>nKnowns</code> contains the length of argument <code>knowns</code>.</p>
</li>
<li>
<p><code>seed</code> contains the components of the seed vector.</p>
</li>
<li>
<p><code>nSeed</code> contains the length of <code>seed</code>.</p>
</li>
<li>
<p><code>sensitivity</code> contains the components of the sensitivity vector.</p>
</li>
<li>
<p><code>nSensitivity</code> contains the length of <code>sensitivity</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[Note that array variables will be serialized, so <code>nSeed</code> is only equal to <code>nKnowns</code> in the case of directional derivatives (resp., equal to <code>nUnknowns</code> in the case of adjoint derivatives), if all value references of <code>knowns</code> (resp., <code>unknowns</code>) point to scalar variables.</em>
<em>Likewise <code>nSensitivity</code> is only equal to <code>nUnknowns</code> (resp., <code>nKnowns</code>) if all value references of <code>unknowns</code> (resp., <code>knowns</code>) point to scalar variables.]</em></p>
</div>
<div class="sect4">
<h5 id="_directional_derivatives">2.2.8.1. Directional Derivatives</h5>
<div id="example-directional-derivatives" class="paragraph">
<p><em>[Example:</em><br>
<em>Assume an FMU has the output equations</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
y_1
\\
y_2
\end{bmatrix}
=
\begin{bmatrix}
g_1(x, u_1, u_3, u_4)
\\
g_2(x, u_1)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p><em>and this FMU is connected, so that \({y_1, u_1, u_3}\) appear in an algebraic loop.</em>
<em>Then the nonlinear solver needs a Jacobian and this Jacobian can be computed (without numerical differentiation) provided the partial derivative of \({y_1}\) with respect to \({u_1}\) and \({u_3}\) is available.</em>
<em>Depending on the environment where the FMUs are connected, these <a href="#derivative"><code>derivatives</code></a> can be provided:</em></p>
</div>
<div class="paragraph">
<p>(a) <em>with one wrapper function around function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> to compute the directional derivatives with respect to these two variables (in other words, \({v_{\mathit{unknown}} = y_1}\), \({v_{\mathit{known}} = \left \{ u_1, u_3 \right \}}\)), and then the environment calls this wrapper function with \({v_{\mathit{seed}} = \left \{ 1, 0 \right \}}\) to compute the partial derivative with respect to \({u_1}\) and \({v_{\mathit{seed}} = \left \{ 0, 1 \right \}}\) to compute the partial derivative with respect to \({u_3}\), or</em></p>
</div>
<div class="paragraph">
<p>(b) <em>with two direct function calls of <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> (in other words, \({v_{\mathit{unknown}} = y_1, v_{\mathit{known}} = u_1, v_{\mathit{seed}} = 1}\); and \({v_{\mathit{unknown}} = y_1, v_{\mathit{known}} = u_3, v_{\mathit{seed}} = 1}\)).</em></p>
</div>
<div class="paragraph">
<p><em>Note that a direct implementation of this function with analytic derivatives:</em></p>
</div>
<div class="paragraph">
<p>(a) <em>Provides the directional derivative for all <a href="#input"><code>input</code></a> variables; so in the <a href="#example-directional-derivatives">above example</a>: \({\Delta y_1 = \frac{\partial g_1}{\partial x} \cdot \Delta x + \frac{\partial g_1}{\partial u_1} \cdot \Delta u_1 + \frac{\partial g_1}{\partial u_3} \cdot \Delta u_3 + \frac{\partial g_1}{\partial u_4} \cdot \Delta u_4}\)</em></p>
</div>
<div class="paragraph">
<p>(b) <em>Initializes all seed-values to zero; so in the <a href="#example-directional-derivatives">above example</a>: \({\Delta x = \Delta u_1 = \Delta u_3 = \Delta u_4 = 0}\)</em></p>
</div>
<div class="paragraph">
<p>(c) <em>Computes the directional derivative with the seed-values provided in the function arguments; so in the <a href="#example-directional-derivatives">above example</a>: \({v_{\mathit{sensitivity}} = \Delta y_1 (\Delta x = 0, \Delta u_1 = 1, \Delta u_3 = 0, \Delta u_4 = 0)}\)] and \({v_{\mathit{sensitivity}} = \Delta y_1 (\Delta x = 0, \Delta u_1 = 0, \Delta u_3 = 1, \Delta u_4 = 0)}\)]</em></p>
</div>
<div class="paragraph">
<p><em>[Note, function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> can be utilized for the following purposes:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Numerical integrators of stiff methods need matrix \({\frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\).</em></p>
</li>
<li>
<p><em>If the FMU is connected with other FMUs, the partial derivatives of the state derivatives and outputs with respect to the continuous states and the <a href="#input"><code>inputs</code></a> are needed in order to compute the Jacobian for the system of the connected FMUs.</em></p>
</li>
<li>
<p><em>If the FMU shall be linearized, the same <a href="#derivative"><code>derivatives</code></a> as in the previous item are needed.</em></p>
</li>
<li>
<p><em>If the FMU is used as the model for an extended Kalman filter, \({\frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) and \({\frac{\partial \mathbf{g}}{\partial \mathbf{x}}}\) are needed.</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>If a dense matrix shall be computed, the columns of the matrix can be easily constructed by successive calls of <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a>.</em>
<em>For example, constructing the system Jacobian \({\mathbf{A} = \frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) as dense matrix can be performed in the following way:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">    //   c[]      column vector

    // set time, states and inputs
    CHECK_STATUS(fmi3SetTime(m, time))
    CHECK_STATUS(fmi3SetContinuousStates(m, x, nx))
    // fmi3Set{VariableType}(m, ...)

    // if required at this step, compute the Jacobian as a dense matrix
    for (i = 0; i &lt; nx; i++) {
        // construct the Jacobian matrix column wise
        CHECK_STATUS(fmi3GetDirectionalDerivative(m, vr_dx, nx, &amp;vr_x[i], 1, &amp;dk, 1, c, nx))
        for (j = 0; j &lt; nx; j++) {
            J[j][i] = c[j];
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>If the sparsity of a matrix shall be taken into account, then the matrix can be constructed in the following way:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>The incidence information of the matrix (whether an element is zero or not zero) is extracted from the XML file from element <code>&lt;ModelStructure&gt;</code>.</em></p>
</li>
<li>
<p><em>A so called graph coloring algorithm is employed to determine the columns of the matrix that can be computed by one call of <code>fmi3GetDirectionalDerivative</code>.</em>
<em>Efficient graph coloring algorithms are freely available, such as library <a href="https://cscapes.cs.purdue.edu/coloringpage/">ColPack</a> written in C/C++ (LGPL), or the routines by <a href="#CGM84">[CGM84]</a>.</em>
<em>See e.g. <a href="http://www.netlib.org/toms/618" class="bare">http://www.netlib.org/toms/618</a>.</em></p>
</li>
<li>
<p><em>For the columns determined in (2), one call to <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> is made.</em>
<em>After each such call, the elements of the resulting directional derivative vector are copied into their correct locations of the partial derivative matrix.</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>More details and implementational notes are available from <a href="#ABL12">[ABL12]</a>.</em></p>
</div>
<div class="paragraph">
<p><em>Example:</em></p>
</div>
<div class="paragraph">
<p><em>Directional derivatives for higher dimension variables are almost treated in the same way.
Consider, for example, an FMU which calculates its output \({Y}\) by multiplying its 2x2 input \({U}\) with a 3x2 constant gain \({K}\), with</em></p>
</div>
<div class="stemblock">
<div class="content">
\[K=
\begin{bmatrix}
a, b
\\
c, d
\\
e, f
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p><em>The output \({Y=K U}\) is a matrix of size 3x2.</em>
<em>The directional derivative of an output element \({Y(i,j)}\) with respect to the input \({U}\) and the seed \({\Delta U}\) is:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\Delta Y(i,j) =
\frac{\partial Y(i,j)}{\partial U(1,1)} \cdot \Delta U(1,1) +
\frac{\partial Y(i,j)}{\partial U(1,2)} \cdot \Delta U(1,2) +
\frac{\partial Y(i,j)}{\partial U(2,1)} \cdot \Delta U(2,1) +
\frac{\partial Y(i,j)}{\partial U(2,2)} \cdot \Delta U(2,2)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\Delta \mathbf{Y} =
\begin{bmatrix}
a \Delta U(1,1)+b \Delta U(2,1), a \Delta U(1,2)+ b \Delta U(2,2)
\\
c \Delta U(1,1)+d \Delta U(2,1), c \Delta U(1,2)+ d \Delta U(2,2)
\\
e \Delta U(1,1)+f \Delta U(2,1), e \Delta U(1,2)+ f \Delta U(2,2)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p><em>To get the directional derivative of \({Y}\) with respect to \({U(2,1)}\) the command <code>fmi3GetDirectionalDerivative(m, vr_Y, 1, vr_U, 1, {0.0, 0.0, 1.0, 0.0}, 4, dd, 6)</code> can be used where <code>vr_Y</code> and <code>vr_U</code> are references of the variable \({Y}\) and \({U}\), respectively.</em>
<em>Note that in order to get the directional derivative of \({Y}\) with respect to \({U(2,1)}\), the seed value <code>{0, 0, 1.0, 0}</code> has been used.</em>
<em>The retrieved directional derivative <code>dd</code> is stored in a matrix of size 3x2, so <code>nSensitivity</code> is 6.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_adjoint_derivatives">2.2.8.2. Adjoint Derivatives</h5>
<div class="paragraph">
<p><em>[Adjoint derivatives are beneficial in several contexts:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>in artificial intelligence (AI) frameworks the adjoint derivatives are called "vector gradient products" (VJPs).</em>
<em>There adjoint derivatives are used in the backpropagation process to perform gradient-based optimization of parameters using reverse mode automatic differentiation (AD), see, e.g., <a href="#BPRS15">[BPRS15]</a>.</em></p>
</li>
<li>
<p><em>in parameter estimation (see <a href="#BKF17">[BKF17]</a>)</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Typically, reverse mode automatic differentiation (AD) is more efficient for these use cases than forward mode AD, as explained in the cited references.</em></p>
</div>
<div class="paragraph">
<p><em>If one would like to construct the full Jacobian matrix, one can use either <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> (to column-wise construct it) or <a href="#fmi3GetAdjointDerivative"><code>fmi3GetAdjointDerivative</code></a> (to row-wise construct it, possibly improved with coloring methods as mentioned above).</em>
<em>However in the applications motivating the adjoint derivatives, one does not need the full Jacobian matrix \(\mathbf{J}\), but vector  \(\mathbf{v}^T\) multiplied from the left to the Jacobian, i.e. \(\mathbf{v}^T\mathbf{J}\).</em>
<em>For computing the full Jacobian matrix, the column-wise construct is generally more efficient.]</em></p>
</div>
<div class="paragraph">
<p><em>Example:</em><br>
<em>Assume an FMU has the output equations</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
y_1
\\
y_2
\end{bmatrix}
=
\begin{bmatrix}
h_1(u_1, u_2)
\\
h_2(u_1, u_2)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p><em>and \(\left( w_1,  w_2 \right)^T \cdot \mathbf{ \frac{\partial h}{\partial u} }\) for some vector \(\left( w_1,  w_2 \right)^T\) is needed.</em>
<em>Then one can get this with one function call of <a href="#fmi3GetAdjointDerivative"><code>fmi3GetAdjointDerivative</code></a> (with arguments</em> \(\mathbf{v}_{\mathit{unknown}} = \text{valueReferences of} \left \{ y_1, y_2 \right \},  \mathbf{v}_{\mathit{known}} = \text{valueReferences of} \left \{ u_1, u_2 \right \},  \mathbf{v}_{\mathit{seed}} = \left( w_1, w_2 \right)^T\) <em>), while with <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a> at least two calls would be necessary to first construct the Jacobian column-wise and then multiplying from the right with</em> \(\left( w_1,  w_2 \right)^T\) <em>.</em></p>
</div>
<div class="paragraph">
<p><em>If a dense matrix shall be computed, the rows of the matrix can be easily constructed by successive calls of <a href="#fmi3GetAdjointDerivative"><code>fmi3GetAdjointDerivative</code></a>.</em>
<em>For example, constructing the system Jacobian \({\mathbf{A} = \frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) as a dense matrix can be performed in the following way:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">    for (i = 0; i &lt; nx; i++) {
        // construct the Jacobian matrix column wise
        CHECK_STATUS(fmi3GetAdjointDerivative(m, &amp;vr_dx[i], 1, vr_x, nx, &amp;dk, 1, &amp;J[i][0], nx))
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getting_number_of_event_indicators">2.2.9. Getting Number of Event Indicators</h4>
<div class="paragraph">
<p>The number of event indicators can change during simulation if it depends on one or more <a href="#tunable"><code>tunable</code></a> <a href="#structuralParameter"><code>structural parameters</code></a> and can be retrieved after instantiating the FMU by calling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetNumberOfEventIndicatorsTYPE(fmi3Instance instance,
                                                      size_t* nEventIndicators);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns the number of event indicators.
The dependency of the number of event indicators on <a href="#structuralParameter"><code>structural parameters</code></a> is implicitly given in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file.
<em>[All event indicator variables are listed as elements <code>&lt;EventIndicator&gt;</code> in <code>&lt;ModelStructure&gt;</code>.</em>
<em>If the event indicator variable is an array variable and the <code>&lt;Dimension&gt;</code> element maps to a dependent variable, then this dependent variable is a dependency for the number of event indicators.]</em>
If all <a href="#structuralParameter"><code>structural parameters</code></a> are unchanged then this dependency information can be used to calculate the initial number of states just using information given in the XML file without the need to call this C-API function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Argument <code>nEventIndicators</code> points to the <code>size_t</code> variable that will receive the number of event indicators.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_getting_number_of_states">2.2.10. Getting Number of States</h4>
<div class="paragraph">
<p>The number of <a href="#state"><code>states</code></a> can change during simulation if it depends on one or more <a href="#tunable"><code>tunable</code></a> <a href="#structuralParameter"><code>structural parameters</code></a> and can be retrieved after instantiating the FMU by calling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetNumberOfContinuousStatesTYPE(fmi3Instance instance,
                                                       size_t* nContinuousStates);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns the number of <a href="#state"><code>continuous states</code></a>.
The dependency of the number of states on <a href="#structuralParameter"><code>structural parameters</code></a> is implicitly given in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file.
<em>[All state derivative variables are listed as elements <code>&lt;Derivative&gt;</code> in <code>&lt;ModelStructure&gt;</code>.</em>
<em>Each state derivative variable maps to the corresponding state variable by the <code>derivative</code> attribute.</em>
<em>If the state variable is an array variable and the <code>&lt;Dimension&gt;</code> element maps to a dependent variable, then this dependent variable is a dependency for the number of states.]</em>
If all <a href="#structuralParameter"><code>structural parameters</code></a> are unchanged then this dependency information can be used to calculate the initial number of states just using information given in the XML file without the need to call this C-API function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Argument <code>nContinuousStates</code> points to the <code>size_t</code> variable that will receive the number of <a href="#state"><code>states</code></a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_getting_number_of_variable_dependencies_and_variable_dependencies">2.2.11. Getting Number of Variable Dependencies and Variable Dependencies</h4>
<div class="paragraph">
<p>The sparseness information within arrays is not given in the xml description.
The sparseness muss be retrieved during run-time using the C-API functions.
Zeros in the Jacobian are not necessarily due to the structure of the model.
Zero in the Jacobian might be due to the current operating point (current <a href="#state"><code>state</code></a>, current <a href="#input"><code>inputs</code></a>) and not due to a structural independence.</p>
</div>
<div class="paragraph">
<p>The variable dependency information in the XML description does not resolve to dependencies of individual array elements, nor does it take into account changing dependencies due to resizing of arrays via <a href="#structuralParameter"><code>structural parameters</code></a>.
An FMU can indicate via the <code>providesPerElementDependencies</code> capability flag that it is able to provide detailed dependency information at runtime through the following C-API.
Note that these functions are only defined if the capability flag <code>providesPerElementDependencies = true</code>.</p>
</div>
<div class="paragraph">
<p>The number of dependencies of a given variable, which may change if <a href="#structuralParameter"><code>structural parameters</code></a> are changed, can be retrieved by calling the following function:</p>
</div>
<div id="fmi3GetNumberOfVariableDependencies" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetNumberOfVariableDependenciesTYPE(fmi3Instance instance,
                                                           fmi3ValueReference valueReference,
                                                           size_t* nDependencies);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns the number of <a href="#dependencies"><code>dependencies</code></a> for a given variable.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>valueReference</code> specifies the <a href="#valueReference"><code>valueReference</code></a> of the variable for which the number of <a href="#dependencies"><code>dependencies</code></a> should be returned.</p>
</li>
<li>
<p><code>nDependencies</code> points to the <code>size_t</code> variable that will receive the number of <a href="#dependencies"><code>dependencies</code></a>.</p>
</li>
</ul>
</div>
<div id="fmi3GetVariableDependencies" class="paragraph">
<p>The actual <a href="#dependencies"><code>dependencies</code></a> (of type <code>fmi3DependencyKind</code>) can be retrieved by calling the function <code>fmi3GetVariableDependencies</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef enum {
    /* fmi3Independent = 0, not needed but reserved for future use */
    fmi3Constant  = 1,
    fmi3Fixed     = 2,
    fmi3Tunable   = 3,
    fmi3Discrete  = 4,
    fmi3Dependent = 5
} fmi3DependencyKind;

typedef fmi3Status fmi3GetVariableDependenciesTYPE(fmi3Instance instance,
                                                   fmi3ValueReference dependent,
                                                   size_t elementIndicesOfDependent[],
                                                   fmi3ValueReference independents[],
                                                   size_t elementIndicesOfIndependents[],
                                                   fmi3DependencyKind dependencyKinds[],
                                                   size_t nDependencies);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns the dependency information for a single variable.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dependent</code> specifies the <a href="#valueReference"><code>valueReference</code></a> of the variable for which the dependencies should be returned.</p>
</li>
<li>
<p><code>nDependencies</code> specifies the number of dependencies that the calling environment allocated space for in the result buffers, and should correspond to value obtained by calling <a href="#fmi3GetNumberOfVariableDependencies"><code>fmi3GetNumberOfVariableDependencies</code></a>.</p>
</li>
<li>
<p><code>elementIndicesOfDependent</code> must point to a buffer of <code>size_t</code> values of size <code>nDependencies</code> allocated by the calling environment.
It is filled in by this function with the element index of the dependent variable that dependency information is provided for.
The element indices start with 1. Using the element index 0 means all elements of the variable.
(Note: If an array has more than one dimension the indices are serialized in the same order as defined for values).</p>
</li>
<li>
<p><code>independents</code> must point to a buffer of <code>fmi3ValueReference</code> values of size <code>nDependencies</code> allocated by the calling environment.
It is filled in by this function with the value reference of the <a href="#independent"><code>independent</code></a> variable that this dependency entry is dependent upon.</p>
</li>
<li>
<p><code>elementIndicesIndependents</code> must point to a buffer of <code>size_t</code> values of size <code>nDependencies</code> allocated by the calling environment.
It is filled in by this function with the element index of the <a href="#independent"><code>independent</code></a> variable that this dependency entry is dependent upon.
The element indices start with 1.
Using the element index 0 means all elements of the variable.
(Note: If an array has more than one dimension the indices are serialized in the same order as defined for values).</p>
</li>
<li>
<p><code>dependencyKinds</code> must point to a buffer of <code>fmi3DependencyKind</code> values of size <code>nDependencies</code> allocated by the calling environment.
It is filled in by this function with the enumeration value describing the dependency of this dependency entry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this function is called before the <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> call, it returns the initial dependencies.
If this function is called after the <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> call, it returns the run-time dependencies.
The retrieved dependency information of one variable becomes invalid as soon as a <a href="#structuralParameter"><code>structural parameter</code></a> linked to the variable or to any of its depending variables are set.
As a consequence, if you change <a href="#structuralParameter"><code>structural parameters</code></a> affecting B or A, the dependency of B becomes invalid.
The dependency information must change only if <a href="#structuralParameter"><code>structural parameters</code></a> are changed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common-state-machine">2.3. State Machine and Semantics</h3>
<div class="paragraph">
<p>All FMI interface types share a number of states in their respective state machines.
This chapter describes these common modes.
FMI specific state-machine modes will be described in their respective chapters.</p>
</div>
<div id="figure-common-state-machine" class="imageblock text-center">
<div class="content">
<img src="images/state-machines-common-states.svg" alt="state machines common states" width="80%">
</div>
<div class="title">Figure 7. Common calling sequence for C functions of common states for all three FMI types.</div>
</div>
<div class="sect3">
<h4 id="FMUStateSetable">2.3.1. Super State: FMU State Setable</h4>
<div class="paragraph">
<p>The description of the super state <strong>FMU State Setable</strong> generally describes functions that deal with instantiation, destruction and logging of FMUs.</p>
</div>
<div class="paragraph">
<p>This state is entered when any of the following functions is called: <a href="#fmi3InstantiateModelExchange"><code>fmi3InstantiateModelExchange</code></a>, <a href="#fmi3InstantiateCoSimulation"><code>fmi3InstantiateCoSimulation</code></a> and <a href="#fmi3InstantiateScheduledExecution"><code>fmi3InstantiateScheduledExecution</code></a>.
The state is left by either calling <a href="#fmi3FreeInstance"><code>fmi3FreeInstance</code></a> or when any of the functions called during <strong>FMU State Setable</strong> returns <a href="#fmi3Fatal"><code>fmi3Fatal</code></a>.
If any function called in super state <strong>FMU State Setable</strong> returns <a href="#fmi3Error"><code>fmi3Error</code></a>, the FMU enters state <strong>Terminated</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
</dl>
</div>
<div id="fmi3InstantiateModelExchange" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3InstantiateModelExchange</code></dt>
<dd>
<p>FMU with initialization and events; between events, the simulation of continuous systems is performed with external integrators from the environment (see <a href="#fmi-for-model-exchange">Section 3</a>).
The <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> has to include a <code>&lt;ModelExchange&gt;</code> element to allow calling <code>fmi3InstantiateModelExchange</code>.</p>
</dd>
</dl>
</div>
<div id="fmi3InstantiateCoSimulation" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3InstantiateCoSimulation</code></dt>
<dd>
<p>Black box interface for Co-Simulation (see <a href="#fmi-for-co-simulation">Section 4</a>).
The <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> has to include a <code>&lt;CoSimulation&gt;</code> element to allow calling <code>fmi3InstantiateCoSimulation</code>.</p>
</dd>
</dl>
</div>
<div id="fmi3InstantiateScheduledExecution" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3InstantiateScheduledExecution</code></dt>
<dd>
<p>Black box interface for Scheduled Execution (see <a href="#fmi-for-scheduled-execution">Section 5</a>).
The <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> has to include a <code>&lt;ScheduledExecution&gt;</code> element to allow calling <code>fmi3InstantiateScheduledExecution</code>.</p>
</dd>
</dl>
</div>
<div id="fmi3Instantiate" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Instance fmi3InstantiateModelExchangeTYPE(
    fmi3String                 instanceName,
    fmi3String                 instantiationToken,
    fmi3String                 resourceLocation,
    fmi3Boolean                visible,
    fmi3Boolean                loggingOn,
    fmi3InstanceEnvironment    instanceEnvironment,
    fmi3CallbackLogMessage     logMessage);

typedef fmi3Instance fmi3InstantiateCoSimulationTYPE(
    fmi3String                     instanceName,
    fmi3String                     instantiationToken,
    fmi3String                     resourceLocation,
    fmi3Boolean                    visible,
    fmi3Boolean                    loggingOn,
    fmi3Boolean                    eventModeUsed,
    const fmi3ValueReference       requiredIntermediateVariables[],
    size_t                         nRequiredIntermediateVariables,
    fmi3InstanceEnvironment        instanceEnvironment,
    fmi3CallbackLogMessage         logMessage,
    fmi3CallbackIntermediateUpdate intermediateUpdate);

typedef fmi3Instance fmi3InstantiateScheduledExecutionTYPE(
    fmi3String                     instanceName,
    fmi3String                     instantiationToken,
    fmi3String                     resourceLocation,
    fmi3Boolean                    visible,
    fmi3Boolean                    loggingOn,
    const fmi3ValueReference       requiredIntermediateVariables[],
    size_t                         nRequiredIntermediateVariables,
    fmi3InstanceEnvironment        instanceEnvironment,
    fmi3CallbackLogMessage         logMessage,
    fmi3CallbackIntermediateUpdate intermediateUpdate,
    fmi3CallbackLockPreemption     lockPreemption,
    fmi3CallbackUnlockPreemption   unlockPreemption);</code></pre>
</div>
</div>
<div class="paragraph">
<p>These functions return a new instance of an FMU with the respective interface type.
If a null pointer is returned, then instantiation failed.
In that case, <a href="#logMessage"><code>logMessage</code></a> is called with detailed information about the reason.
An FMU can be instantiated many times (provided capability flag <code>canBeInstantiatedOnlyOncePerProcess = false</code>).</p>
</div>
<div class="paragraph">
<p>The arguments of the instantiation functions are detailed as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>instanceName</code> is a unique identifier for the FMU instance.
It is used to name the instance, for example, in error or information messages generated by one of the <code>fmi3XXX</code> functions.
The argument <code>instanceName</code> must be a non empty string (in other words, must have at least one character that is not a white space).
<em>[If only one FMU is simulated, as <code>instanceName</code> attribute <code>modelName</code> or <code>&lt;ModelExchange|CoSimulation|ScheduledExecution modelIdentifier=".."&gt;</code> from the XML schema <code>fmi3ModelDescription</code> might be used.]</em></p>
</li>
<li>
<p><code>instantiationToken</code> can be used by the FMU to check that the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file (see <a href="#fmu-distribution">Section 2.5</a>) is compatible with the implementation of the FMU.
It is an opaque string generated by the FMU exporter that is stored in the xml file as mandatory attribute <code>instantiationToken</code> (see <a href="#fmiModelDescription">Section 2.4.1</a>).
It must be passed unchanged to the FMU.
This argument must not be a null pointer.</p>
</li>
</ul>
</div>
<div id="resourceLocation" class="ulist">
<ul>
<li>
<p><code>resourceLocation</code> is a URI according to the <a href="http://datatracker.ietf.org/doc/rfc3986/">IETF RFC3986</a> syntax to indicate the location to the <code>resources</code> directory of the unzipped FMU archive.
The following schemes must be understood by the FMU:</p>
<div class="ulist">
<ul>
<li>
<p>Mandatory&#8201;&#8212;&#8201;<code>file</code> with absolute path (either including or omitting the authority component);<br></p>
</li>
<li>
<p>Optional&#8201;&#8212;&#8201;<code>http</code>, <code>https</code>, <code>ftp</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[Example: An FMU is unzipped in directory <code>C:\temp\MyFMU</code>, then <a href="#resourceLocation"><code>resourceLocation</code></a> = <code><a href="file:///C:/temp/MyFMU/resources" class="bare">file:///C:/temp/MyFMU/resources</a></code> or <code>file:/C:/temp/MyFMU/resources</code>.</em><br>
<em>The <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a> functions are then able to read all needed resources from this directory, for example maps or tables used by the FMU.]</em><br>
A NULL pointer is supplied for <a href="#resourceLocation"><code>resourceLocation</code></a>, if no resource location can be provided to the FMU, which may occur</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the FMU does not contain a resources folder, or</p>
</li>
<li>
<p>if the environment is not able to provide an URI to the resources folder <em>[e.g., if the environment does not have a file system.</em>
<em>If the FMU in such a case cannot be simulated, as it depends on the resources folder, it shall terminate with an error.]</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>visible == fmi3False</code> defines that the interaction with the user should be reduced to a minimum (no application window, no plotting, no animation, etc.).
In other words, the FMU is executed in batch mode.
If <code>visible == fmi3True</code>, the FMU is executed in interactive mode, and the FMU might require to explicitly acknowledge start of simulation / instantiation / initialization (acknowledgment is non-blocking).</p>
</li>
<li>
<p>If <code>loggingOn == fmi3False</code>, then any logging is disabled and the <a href="#logMessage"><code>logMessage</code></a> callback function is not called by the FMU.
If <code>loggingOn == fmi3True</code>, the FMU enables a vendor defined set of <code>&lt;LogCategories&gt;</code>.
This set should typically contain categories for messages that explain execution errors, like <a href="#fmi3Discard"><code>fmi3Discard</code></a>, <a href="#fmi3Error"><code>fmi3Error</code></a> and <a href="#fmi3Fatal"><code>fmi3Fatal</code></a>.
The function <a href="#fmi3SetDebugLogging"><code>fmi3SetDebugLogging</code></a> gives more detailed control about required <code>&lt;LogCategories&gt;</code> (see <a href="#definition-of-log-categories">Section 2.4.5</a>).</p>
</li>
<li>
<p>If <code>eventModeUsed == fmi3True</code> the simulation algorithm can handle events, otherwise <code>fmi3EnterEventMode</code> must not be called.
The flag may only be <code>fmi3True</code>, if <code>hasEventMode == true</code>, otherwise the FMU must raise an error.
For FMUs that have synchronous clocks, <code>eventModeUsed == fmi3True</code> is required.</p>
</li>
<li>
<p><code>instanceEnvironment</code> is a pointer that can be passed to the <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> function in order that the simulation environment can provide an efficient way to identify the FMU that called <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.</p>
</li>
</ul>
</div>
<div id="requiredIntermediateVariables" class="ulist">
<ul>
<li>
<p><code>requiredIntermediateVariables</code> is an array of the value references of all <a href="#input"><code>input</code></a> variables that the simulation algorithm intends to set and all <a href="#output"><code>output</code></a> variables it intends to get during intermediate updates.
This set may be empty (<a href="#nRequiredIntermediateVariables"><code>nRequiredIntermediateVariables</code></a> == 0) when the simulation algorithm does not intend to use intermediate update.
All variables referenced in this set must be marked with the attribute <a href="#intermediateUpdate"><code>intermediateUpdate = "true"</code></a> in the model description.
Only the variables in <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> may be accessed by the simulation algorithm using <code>fmi3Set{VariableType}</code> and <code>fmi3Get{VariableType}</code> during <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> callbacks.</p>
</li>
</ul>
</div>
<div id="nRequiredIntermediateVariables" class="ulist">
<ul>
<li>
<p><code>nRequiredIntermediateVariables</code> gives the number of entries in <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a>.
If <a href="#nRequiredIntermediateVariables"><code>nRequiredIntermediateVariables</code></a> is zero <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> is not defined.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The arguments <a href="#logMessage"><code>logMessage</code></a>, <a href="#intermediateUpdate"><code>intermediateUpdate</code></a>, <a href="#preemption-support"><code>lockPreemption</code></a>, and <a href="#preemption-support"><code>unlockPreemption</code></a>, are function pointers provided by the simulation environment to be used by the FMU.
It is not allowed to change these functions between <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a> and <a href="#fmi3Terminate"><code>fmi3Terminate</code></a> calls.
Additionally, a pointer to the environment is provided (<code>instanceEnvironment</code>) that needs to be passed to all of the callback functions, in order that those functions can utilize data from the environment, such as mapping a <a href="#valueReference"><code>valueReference</code></a> to a string, or assigning memory to a certain FMU instance.</p>
</div>
<div class="paragraph">
<p>In the default <code>fmi3FunctionTypes.h</code> file, typedefs for the function definitions are present to simplify the usage; this is non-normative.
These callback functions are defined below.</p>
</div>
<div id="logMessage" class="dlist">
<dl>
<dt class="hdlist1">Callback function <code>logMessage</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void  (*fmi3CallbackLogMessage)     (fmi3InstanceEnvironment instanceEnvironment,
                                             fmi3String instanceName,
                                             fmi3Status status,
                                             fmi3String category,
                                             fmi3String message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pointer to a function that is called in the FMU <em>[usually if an <code>fmi3XXX</code> function does not behave as desired]</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>instanceName</code> is the instance name of the model that calls this function.</p>
</li>
<li>
<p><code>status</code> contains the severity of the message, see <code>fmi3Status</code>.
If <a href="#logMessage"><code>logMessage</code></a> is called with <a href="#fmi3OK"><code>status == fmi3OK</code></a>, then the message is a pure information message.</p>
</li>
<li>
<p><code>category</code> is the category of the message.
The meaning of <code>category</code> is defined by the modeling environment that generated the FMU.
Depending on this modeling environment, none, some, or all, allowed values of <code>category</code> for this FMU are defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file via element <code>&lt;fmiModelDescription&gt;&lt;LogCategories&gt;</code>, see <a href="#definition-of-log-categories">Section 2.4.5</a>.
Only messages are provided by function <a href="#logMessage"><code>logMessage</code></a> that have a category according to a call to <a href="#fmi3SetDebugLogging"><code>fmi3SetDebugLogging</code></a>.</p>
</li>
<li>
<p><code>message</code> is a string that contains the message.
<em>[Typically, this function prints the message and stores it optionally in a log file.]</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All string-valued arguments passed by the FMU to the <a href="#logMessage"><code>logMessage</code></a> may be deallocated by the FMU directly after function <a href="#logMessage"><code>logMessage</code></a> returns.
The simulation environment must therefore create copies of these strings if it needs to access these strings later.<br>
The <a href="#logMessage"><code>logMessage</code></a> function will append a line break to each message when writing messages after each other to a terminal or a file (the messages may also be shown in other ways, for example, as separate text-boxes in a GUI).
The caller may include line-breaks (using "\n") within the message, but should avoid trailing line breaks.<br>
Variables can be referenced in a message with <code>#&lt;ValueReference&gt;#</code>.
If the character <code>#</code> shall be included in the message, it has to be prefixed with <code>#</code>, so <code>#</code> is an escape character.</p>
</div>
<div class="paragraph">
<p><em>[Example: The message <code>#1365# must be larger than zero (used in IO channel ##4)</code> might be changed by the <a href="#logMessage"><code>logMessage</code></a> function to <code>body.m must be larger than zero (used in IO channel #4)</code> if <code>body.m</code> is the name of the variable with value reference 1365.]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Callback function <code>intermediateUpdate</code></dt>
<dd>
<p>See <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> for details.</p>
</dd>
<dt class="hdlist1">Callback function <code>lockPreemption</code> and <code>unlockPreemption</code></dt>
<dd>
<p>See <a href="#preemption-support">Section 5.2.2</a> for details.</p>
</dd>
</dl>
</div>
<div id="fmi3SetDebugLogging" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3SetDebugLogging</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status  fmi3SetDebugLoggingTYPE(fmi3Instance instance,
                                            fmi3Boolean loggingOn,
                                            size_t nCategories,
                                            const fmi3String categories[]);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function controls debug logging that is output via the <a href="#logMessage"><code>logMessage</code></a> callback function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>loggingOn == fmi3True</code>, debug logging is enabled, otherwise it is switched off.</p>
</li>
<li>
<p><code>nCategories</code> defines the length of the next argument <code>categories</code>
If <code>loggingOn == fmi3True</code> and <code>nCategories == 0</code>, then all debug messages shall be output.
If <code>loggingOn == fmi3True</code> and <code>nCategories &gt; 0</code>, then only debug messages according to the <code>categories</code> argument shall be printed via the <a href="#logMessage"><code>logMessage</code></a> function.</p>
</li>
<li>
<p><code>categories</code> is a vector with <code>nCategories</code> elements.
The allowed values of <code>categories</code> are defined by the modeling environment that generated the FMU.
Depending on the generating modeling environment, none, some or all allowed values for <code>categories</code> for this FMU are defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file via element <code>&lt;fmiModelDescription&gt;&lt;LogCategories&gt;</code>, see <a href="#definition-of-log-categories">Section 2.4.5</a>.</p>
</li>
</ul>
</div>
<div id="fmi3Reset" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3Reset</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3ResetTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Is called by the environment to reset the FMU after a simulation run.
The FMU goes into the same state as if <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a> would have been called.
All variables have their default values.
Before starting a new run <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a> has to be called.</p>
</div>
<div id="fmi3Terminate" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3Terminate</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3TerminateTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes state to <strong>Terminated</strong>.
After calling this function, the final values of all variables can be inquired with the <code>fmi3Get{VariableType}</code> functions.
It is not allowed to call this function after one of the functions returned with a status flag of <a href="#fmi3Error"><code>fmi3Error</code></a> or <a href="#fmi3Fatal"><code>fmi3Fatal</code></a>.</p>
</div>
<div id="fmi3FreeInstance" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3FreeInstance</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void fmi3FreeInstanceTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Disposes the given instance, unloads the loaded model, and frees all the allocated memory and other resources that have been allocated by the functions of the FMU interface.
If a null pointer is provided for argument <code>instance</code>, the function call is ignored (does not have an effect).</p>
</div>
<div id="get-set-fmu-state" class="dlist">
<dl>
<dt class="hdlist1">Getting and Setting the Complete FMU State</dt>
</dl>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The FMU has an internal state consisting of all values that are needed to continue a simulation.
This internal state consists especially of the values of the continuous-time states, iteration variables, <a href="#parameter"><code>parameter</code></a> values, <a href="#input"><code>input</code></a> values, delay buffers, file identifiers, and FMU internal status information.
With the functions of this section, the internal FMU state can be copied and the pointer to this copy is returned to the environment.
The FMU state copy can be set as actual FMU state, in order to continue the simulation from it.</p>
</div>
<div class="paragraph">
<p><em>[Examples for using this feature:</em></p>
</div>
<div class="paragraph">
<p><em>For variable step-size control of co-simulation algorithms (get the FMU state for every accepted communication step; if the follow-up step is not accepted, restart co-simulation from this FMU state).</em></p>
</div>
<div class="paragraph">
<p><em>For nonlinear Kalman filters (get the FMU state just before initialization; in every sample period, set new continuous states from the Kalman filter algorithm based on measured values; integrate to the next sample instant and inquire the predicted continuous states that are used in the Kalman filter algorithm as basis to set new continuous states).</em></p>
</div>
<div class="paragraph">
<p><em>For nonlinear model predictive control (get the FMU state just before initialization; in every sample period, set new continuous states from an observer, initialize and get the FMU state after initialization.</em>
<em>From this state, perform many simulations that are restarted after the initialization with new input signals proposed by the optimizer).]</em></p>
</div>
<div class="paragraph">
<p>Furthermore, the FMU state can be serialized and copied in a byte vector.
<em>[This can be, for example, used to perform an expensive steady-state initialization, copy the received FMU state in a byte vector and store this vector on file.</em>
<em>Whenever needed, the byte vector can be loaded from file and deserialized, and the simulation can be restarted from this FMU state, in other words, from the steady-state initialization.]</em></p>
</div>
<div id="fmi3GetFMUState" class="dlist">
<dl>
<dt class="hdlist1">Functions <a href="#fmi3GetFMUState"><code>fmi3GetFMUState</code></a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetFMUStateTYPE (fmi3Instance instance, fmi3FMUState* FMUState);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function makes a copy of the internal FMU state and returns a pointer to this copy (<code>FMUState</code>).
If on entry <code>*FMUState == NULL</code>, a new allocation is required.
If <code>*FMUState != NULL</code>, then <code>*FMUState</code> points to a previously returned <code>FMUState</code> that has not been modified since.
In particular, <a href="#fmi3FreeFMUState"><code>fmi3FreeFMUState</code></a> had not been called with this <code>FMUState</code> as an argument.
<em>[Function <a href="#fmi3GetFMUState"><code>fmi3GetFMUState</code></a> typically reuses the memory of this <code>FMUState</code> in this case and returns the same pointer to it, but with the actual <code>FMUState</code>.]</em></p>
</div>
<div id="fmi3SetFMUState" class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3SetFMUState"><code>fmi3SetFMUState</code></a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetFMUStateTYPE (fmi3Instance instance, fmi3FMUState  FMUState);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function copies the content of the previously copied <code>FMUState</code> back and uses it as actual new FMU state.
The <code>FMUState</code> copy still exists.
<em>[The simulation is restarted at this state, when calling <a href="#fmi3SetFMUState"><code>fmi3SetFMUState</code></a> with <code>FMUState</code>.]</em></p>
</div>
<div id="fmi3FreeFMUState" class="dlist">
<dl>
<dt class="hdlist1"><a href="#fmi3FreeFMUState"><code>fmi3FreeFMUState</code></a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3FreeFMUStateTYPE(fmi3Instance instance, fmi3FMUState* FMUState);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function frees all memory and other resources allocated with the <a href="#fmi3GetFMUState"><code>fmi3GetFMUState</code></a> call for this <code>FMUState</code>.
The argument to this function is the <code>FMUState</code> to be freed.
If a null pointer is provided, the call is ignored.
The function returns a null pointer in argument <code>FMUState</code>.</p>
</div>
<div class="paragraph">
<p>These functions can be called, if the optional capability flag <a href="#canGetAndSetFMUState"><code>canGetAndSetFMUState</code></a> is set to <code>true</code>.</p>
</div>
<div id="fmi3SerializedFMUStateSize" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3SerializedFMUStateSize</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SerializedFMUStateSizeTYPE(fmi3Instance instance,
                                                  fmi3FMUState  FMUState,
                                                  size_t* size);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function returns the <code>size</code> of the byte vector, in order that <code>FMUState</code> can be stored in it.
With this information, the environment has to allocate an <code>fmi3Byte</code> vector of the required length <code>size</code>.</p>
</div>
<div id="fmi3SerializeFMUState" class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3SerializeFMUState"><code>fmi3SerializeFMUState</code></a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SerializeFMUStateTYPE     (fmi3Instance instance,
                                                  fmi3FMUState  FMUState,
                                                  fmi3Byte serializedState[],
                                                  size_t size);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function serializes the data which is referenced by pointer <code>FMUState</code> and copies this data in to the byte vector <code>serializedState</code> of length <code>size</code>, that must be provided by the environment.</p>
</div>
<div id="fmi3DeSerializeFMUState" class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3DeSerializeFMUState"><code>fmi3DeSerializeFMUState</code></a></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3DeSerializeFMUStateTYPE   (fmi3Instance instance,
                                                  const fmi3Byte serializedState[],
                                                  size_t size,
                                                  fmi3FMUState* FMUState);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function deserializes the byte vector <code>serializedState</code> of length <code>size</code>, constructs a copy of the FMU state and returns <code>FMUState</code>, the pointer to this copy.</p>
</div>
<div class="paragraph">
<p>These functions are only supported by the FMU, if the optional capability flags <code>canGetAndSetFMUState</code> and <code>canSerializeFMUState</code> in <code>&lt;fmiModelDescription&gt;&lt;ModelExchange|CoSimulation|ScheduledExecution&gt;</code> in the XML file are explicitly set to <code>true</code> (see <a href="#fmi-for-model-exchange">Section 3</a>, <a href="#fmi-for-co-simulation">Section 4</a>, <a href="#fmi-for-scheduled-execution">Section 5</a>).</p>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Functions <a href="#get-and-set-variable-values"><code>fmi3Get{VariableType}</code></a></dt>
<dd>
<p>See <a href="#get-and-set-variable-values">Section 2.2.5</a> for the general mechanism to get variable values.
Getting variable might trigger computations.
<em>[If <strong>Terminated</strong> is entered because of an <code>fmi3Error</code> return value, retrieved values should only be used for debugging purposes.]</em></p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="Instantiated">2.3.1.1. State: Instantiated</h5>
<div class="paragraph">
<p>In this state the FMU can do one-time initializations and allocate memory.
This state is entered after <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a> returned successfully.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
</dl>
</div>
<div id="fmi3EnterConfigurationMode" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3EnterConfigurationMode</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterConfigurationModeTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes state to <strong>Configuration Mode</strong>.</p>
</div>
<div id="fmi3EnterInitializationMode" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3EnterInitializationMode</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterInitializationModeTYPE(fmi3Instance instance,
                                                   fmi3Boolean toleranceDefined,
                                                   fmi3Float64 tolerance,
                                                   fmi3Float64 startTime,
                                                   fmi3Boolean stopTimeDefined,
                                                   fmi3Float64 stopTime);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes state to <strong>Initialization Mode</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>toleranceDefined</code> and <code>tolerance</code> depend on the interface type:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Model Exchange</dt>
<dd>
<p>If <code>toleranceDefined == fmi3True</code>, then the model is called with a numerical integration scheme where the step size is controlled by using <code>tolerance</code> for error estimation (usually as relative tolerance).
In such a case all numerical algorithms used inside the model (for example, to solve non-linear algebraic equations) should also operate with an error estimation of an appropriate smaller relative tolerance.</p>
</dd>
<dt class="hdlist1">Co-Simulation</dt>
<dd>
<p>If <code>toleranceDefined == fmi3True</code>, then the communication step size of the FMU is controlled by error estimation.
In case the FMU utilizes a numerical integrator with variable step size and error estimation, it is suggested to use <code>tolerance</code> for the error estimation of the integrator (usually as relative tolerance).<br>
An FMU for Co-Simulation might ignore this argument.</p>
</dd>
</dl>
</div>
</li>
<li>
<p><code>startTime</code> and <code>stopTime</code> can be used to check whether the model is valid within the given boundaries, or to allocate the necessary memory for storing results.
<code>startTime</code> is the <a href="#fixed"><code>fixed</code></a> <a href="#initial"><code>initial</code></a> value of the <a href="#independent"><code>independent</code></a> variable and inherits its unit.</p>
<div class="paragraph">
<p><em>[It is defined with <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a> in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.</em>
<em>If the <a href="#independent"><code>independent</code></a> variable is <code>time</code>, <code>startTime</code> is the starting time of initialization.]</em></p>
</div>
</li>
<li>
<p>If <code>stopTimeDefined == fmi3True</code>, then <code>stopTime</code> is the final value of the <a href="#independent"><code>independent</code></a> variable and inherits its unit.
If the environment tries to compute past <code>stopTime</code>, the FMU has to return <a href="#fmi3Error"><code>fmi3Status == fmi3Error</code></a>.
If <code>stopTimeDefined == fmi3False</code>, then no final value of the <a href="#independent"><code>independent</code></a> variable is defined and argument <code>stopTime</code> is meaningless.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>This function can be called for variables with <a href="#variability"><code>variability</code></a> \(\neq\) <a href="#constant"><code>constant</code></a> and with <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> or <a href="#approx"><code>approx</code></a>.
The intention is to set <a href="#start"><code>start</code></a> and guess values for these variables.</p>
</dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="InitializationMode">2.3.1.2. State: Initialization Mode</h5>
<div class="paragraph">
<p>This mode is used by the simulation algorithm to compute consistent initial conditions for overall system.
Equations are active to determine the initial FMU state, as well as all <a href="#output"><code>outputs</code></a> (and optionally other variables exposed by the exporting tool).
Artificial or real algebraic loops over connected FMUs in <strong>Initialization Mode</strong> may be handled by using appropriate numerical algorithms.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
</dl>
</div>
<div id="fmi3ExitInitializationMode" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3ExitInitializationMode</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3ExitInitializationModeTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes the state to <strong>Event Mode</strong> (ME), <strong>Step Mode</strong> (CS) or <strong>Clock Activation Mode</strong> (SE).
<em>[This function switches off all initialization equations.]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a></dt>
<dd>
<p>See <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a>.</p>
</dd>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>For variables with:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#variability"><code>variability</code></a> \(\neq\) <a href="#constant"><code>constant</code></a> that have <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a>, or</p>
</li>
<li>
<p><a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, or</p>
</li>
<li>
<p><a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Function <code>fmi3Get{VariableType}</code></dt>
<dd>
<p>The variables that can be retrieved by <code>fmi3Get{VariableType}</code> calls are defined in the XML file as elements <code>&lt;ModelStructure&gt;&lt;InitialUnknown&gt;</code>.
For variables with <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> or continuous-time <a href="#state"><code>states</code></a> or state derivatives.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ConfigurationMode">2.3.1.3. State: Configuration Mode</h5>
<div class="paragraph">
<p>In this state <a href="#structuralParameter"><code>structural parameters</code></a> with <a href="#variability"><code>variability</code></a> = <a href="#fixed"><code>fixed</code></a> or <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a> can be changed.
No other variables can be changed during <strong>Configuration Mode</strong>.
This state is entered from state <strong>Instantiated</strong> by calling <a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a> and left back to <strong>Instantiated</strong> by calling <a href="#fmi3ExitConfigurationMode"><code>fmi3ExitConfigurationMode</code></a>.
<a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a> can only be called if the FMU contains at least one <a href="#structuralParameter"><code>structural parameter</code></a></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
</dl>
</div>
<div id="fmi3ExitConfigurationMode" class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3ExitConfigurationMode</code></dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3ExitConfigurationModeTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exits the <strong>Configuration Mode</strong> and returns to state <strong>Instantiated</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>Only for variables with <a href="#causality"><code>causality</code></a> = <a href="#structuralParameter"><code>structuralParameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#fixed"><code>fixed</code></a> or <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Terminated">2.3.1.4. State: Terminated</h5>
<div class="paragraph">
<p>In this state, the solution at the final time of a simulation can be retrieved.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a></dt>
<dd>
<p>No restrictions.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3GetOutputDerivatives"><code>fmi3GetOutputDerivatives</code></a></dt>
<dd>
<p>No restrictions.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Initialized">2.3.2. Super State: Initialized</h4>
<div class="paragraph">
<p>This super state is entered by the FMU when <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called.
If the function <a href="#fmi3Terminate"><code>fmi3Terminate</code></a> is called, the FMU enters state <strong>Terminated</strong> from all states of this super state.
If any function returns <a href="#fmi3Error"><code>fmi3Error</code></a> in <strong>Initialized</strong>, the FMU switches to state <strong>Terminated</strong>.</p>
</div>
<div class="paragraph">
<p>The states of this super state differ between the FMI types and will be described in detail in their respective chapters.</p>
</div>
<div class="sect4">
<h5 id="EventMode">2.3.2.1. State: Event Mode</h5>
<div class="paragraph">
<p>_[TODO: add <strong>Event Mode</strong> description after clocks/event clarification&#8230;&#8203;]</p>
</div>
<div class="paragraph">
<p>The next event instant \(t_{i+1}\) is defined by the earliest occurrence of one of the following conditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The environment of the FMU triggers an event at the current time instant because at least one discrete-time <a href="#input"><code>input</code></a> changes its value, a continuous-time <a href="#input"><code>input</code></a> has a discontinuous change, or a <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a> changes its value.
<em>[Note that if an FMU A is connected to an FMU B, and an event is triggered for A, then potentially all <a href="#output"><code>outputs</code></a> of A will be discontinuous at this time instant.</em>
<em>It is therefore advisable to move B into <strong>Event Mode</strong> at this time instant too if an <a href="#output"><code>output</code></a> of A is connected to B.</em>
<em>This means to call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> on B.]</em><br></p>
<div class="paragraph">
<p>All the following events are internal events:</p>
</div>
</li>
<li>
<p>At a predefined time instant \(t_i=T_{\mathit{next}}(t_{i-1}, 0)\) that was defined at the previous event instant \(t_{i-1}\) by the FMU.
Such an event is called <a href="#time-event">time event</a>.</p>
</li>
<li>
<p>At a time instant, where an event indicator \(z_j(t)\) changes its domain from \(z_j &gt; 0\) to \(z_j \leq 0\) or from \(z_j \leq 0\) to \(z_j &gt; 0\) (see <a href="#figure-events">Figure 8</a>).
More precisely: An event \(t = t_i\) occurs at the smallest time instant \(t\) with \(t&gt;t_{i-1}\) where \((z_j(t)&gt;0) \neq (z_j(t_{i-1}) &gt;0)\).
Such an event is called <a href="#state-event">state event</a>.
<em>[This definition is slightly different from the standard definition of <a href="#state-event"><code>state events</code></a>: _ \(z_j(t) \cdot z_j(t_{i-1}) \leq 0\) _.</em>
<em>This often used definition has the severe drawback that</em> \(z_j(t_{i-1}) \neq 0\) <em>is required in order to be well-defined and this condition cannot be guaranteed.].</em>
All event indicators are piecewise continuous and are collected together in one vector of floating point numbers \(\mathbf{z(t)}\).<br></p>
</li>
</ol>
</div>
<div id="figure-events" class="imageblock text-center">
<div class="content">
<img src="images/Event.svg" alt="Event" width="60%">
</div>
<div class="title">Figure 8. An event occurs when the event indicator changes its domain from \(z&gt;0\) to \(z\leq 0\) or vice versa.</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>At every completed step of an integrator, <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> must be called (provided the capability flag <code>completedIntegratorStepNotNeeded</code> of <code>&lt;fmiModelDescription&gt;</code> is <code>false</code>).
An event occurs at this time instant, if indicated by the return argument <code>enterEventMode == fmi3True</code>.
Such an event is called <a href="#step-event">step event</a>.
<em>[<a href="#step-event"><code>Step events</code></a> are, for example, used to dynamically change the (continuous) <a href="#state"><code>states</code></a> of a model internally in the FMU, because the previous states are no longer suited numerically.]</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this mode all continuous-time and discrete-time equations are active and the unknowns at an event can be computed and retrieved.
The event time of a <a href="#state-event">state event</a> may be determined if a domain change of at least one event indicator is detected at the end of a completed integrator step.</p>
</div>
<div class="paragraph">
<p><strong>Event Mode</strong> is entered by calling <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>, if an event is triggered in <strong>Continuous-Time Mode</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a></dt>
<dd>
<p>When the <strong>Initialization Mode</strong> is terminated with <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a>, then <strong>Event Mode</strong> is directly entered, and the continuous-time and discrete-time variables at the initial time are computed based on the initial continuous-time states determined in the <strong>Initialization Mode</strong>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The co-simulation algorithm and the FMU enter this state when the co-simulation algorithm calls <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> in state <strong>Step Mode</strong>, in order to handle discrete events and <a href="#clock"><code>clock</code></a> ticks.
If the co-simulation algorithm signals <code>eventModeUsed == fmi3False</code> during instantiation, the co-simulation algorithm is not allowed to call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a></dt>
<dd>
<p>In order to handle discrete events <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> is called.
When the output argument <code>newDiscreteStatesNeeded == fmi3True</code>, the FMU should stay in <strong>Event Mode</strong> and another call to <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> is required.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3EnterContinuousTimeMode"><code>fmi3EnterContinuousTimeMode</code></a></dt>
</dl>
</div>
<div id="fmi3EnterContinuousTimeMode" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterContinuousTimeModeTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO only in ME</p>
</div>
<div class="paragraph">
<p>The model enters <strong>Continuous-Time Mode</strong> and all discrete-time equations become inactive and all relations are "frozen".<br>
This function has to be called when changing from <strong>Event Mode</strong> (after the global event iteration in <strong>Event Mode</strong> over all involved FMUs and other models has converged) into <strong>Continuous-Time Mode</strong>.<br></p>
</div>
<div class="paragraph">
<p><em>[This function might be used additionally for the following purposes:</em>
* <em>If the FMU stores results internally on file, then the results after the initialization and/or the event has been processed can be stored.</em>
* <em>If the FMU contains dynamically changing states, then a new state selection might be performed with this function.]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a></dt>
<dd>
<p>TODO only in CS</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Once all events are handled and <code>newDiscreteStatesNeeded == fmi3False</code>, the FMU should be pushed to <strong>Step Mode</strong> by calling <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a>, unless it requests to terminate the Co-Simulation by setting  &lt;&lt;terminateSimulation,<code>terminateSimulation</code>&gt; to <code>fmi3True</code>.
In this case, a new step can be started from the current communication point time.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#fmi3GetClock"><code>fmi3GetClock</code></a></dt>
<dd>
<p>The status of <a href="#outputClock"><code>output clocks</code></a> and <a href="#localClock"><code>local clocks</code></a> can be inquired by this function during <strong>Event Mode</strong> and <strong>Intermediate Update Mode</strong>.</p>
</dd>
<dt class="hdlist1"><a href="#fmi3SetClock"><code>fmi3SetClock</code></a></dt>
<dd>
<p>For <a href="#inputClock"><code>input clocks</code></a>, <a href="#fmi3SetClock"><code>fmi3SetClock</code></a> is called after entering <strong>Event Mode</strong> to set the activation status of <a href="#clock"><code>clocks</code></a>.
This function can be called several times, only if re-computations of clock state are needed during <strong>Event Mode</strong>.</p>
</dd>
<dt class="hdlist1"><a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> &amp; <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a></dt>
<dd>
<p>For <a href="#outputClock"><code>output clocks</code></a> and <a href="#localClock"><code>local clocks</code></a> it is allowed to call these functions during <strong>Event Mode</strong> and <strong>Intermediate Update Mode</strong>.
These functions can be called only at the first activation of <a href="#periodic"><code>periodic</code></a> <a href="#outputClock"><code>output clocks</code></a>.
For <a href="#periodic"><code>aperiodic</code></a> <a href="#outputClock"><code>output clocks</code></a>, these functions must be called at every activation <em>[to inquire when triggered <a href="#inputClock"><code>input clocks</code></a> must tick]</em>.</p>
</dd>
<dt class="hdlist1"><a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> &amp; <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a></dt>
<dd>
<p>These functions can be called only at the first activation of <a href="#periodic"><code>periodic</code></a> <a href="#inputClock"><code>input clocks</code></a>.
These functions can be called for every activation of <a href="#periodic"><code>aperiodic</code></a> <a href="#inputClock"><code>input clocks</code></a>.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a></dt>
<dd>
<p>See <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ReconfigurationMode">2.3.2.2. State: Reconfiguration Mode</h5>
<div class="paragraph">
<p>This state is entered from state <strong>Event Mode</strong> (ME), <strong>Step Mode</strong> (CS) or <strong>Clock Activation Mode</strong> (SE) by calling <a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a>.
<a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a> can only be called if the FMU contains at least one <a href="#structuralParameter"><code>structural parameter</code></a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <a href="#fmi3ExitConfigurationMode"><code>fmi3ExitConfigurationMode</code></a></dt>
<dd>
<p>Returns back to <strong>Event Mode</strong> (ME), <strong>Step Mode</strong> (CS) or <strong>Clock Activation Mode</strong> (SE).</p>
</dd>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>Only for variables with <a href="#causality"><code>causality</code></a> = <a href="#structuralParameter"><code>structuralParameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>.
No other variables can be changed during <strong>Reconfiguration Mode</strong>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="IntermediateUpdateMode">2.3.3. State: Intermediate Update Mode</h4>
<div class="paragraph">
<p>This state is only available in Co-Simulation and Scheduled Execution.
The following use cases are enabled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>improve the input accuracy in CS between communication points, when the importer sets intermediate input values extracted with the same mechanism from another FMU as output values (see below for details and <a href="#Communication-during-update">Section 4.2.3</a>),</p>
</li>
<li>
<p>allow FMUs to inform the importer of an event, which occurs during an <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> in case of CS or <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> in case of SE (see <a href="#co-simulation-api">Section 4.2</a>, <a href="#Communication-during-update">Section 4.2.3</a> and <a href="#IntermediateUpdateModeSE">Section 5.2.1.3</a>),</p>
</li>
<li>
<p>allow the importer in CS to request an early return from FMUs calling <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> with <a href="#canReturnEarly"><code>canReturnEarly == fmi3True</code></a>, because of any event between communication points (see <a href="#early-return">Section 4.2.4</a> and <a href="#Computation-in-Co-Simulation">Section 4.2.2</a>).
This also enables cooperative multitasking of FMUs in CS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the call to <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> and thus entering the <strong>Intermediate Update Mode</strong> can only be triggered by the FMU itself.
The importer cannot actively trigger this and hence for some use cases (e.g. cooperative multitasking and setting of intermediate input values) it relies on the callbacks from the FMUs to be able to realize these use cases properly.</p>
</div>
<div class="paragraph">
<p>A Co-Simulation FMU can provide values for its <a href="#output"><code>output</code></a> variables at intermediate points between two consecutive communication points, and is able to accept new values for <a href="#input"><code>input</code></a> variables at these intermediate points.
This is typically required when the FMU uses a numerical solver to integrate the FMU&#8217;s internal state between communication points in <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.
This numerical solver assumes that the inputs are continuous in the integration interval, dictated by <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.
In FMI 2.0 Co-simulation, the intermediate inputs are provided by the use of extrapolations.
The intermediate update functions allow FMUs to receive inputs, and provide outputs, directly to the co-simulation algorithm, in those intermediate time points.</p>
</div>
<div class="paragraph">
<p>Due to the way numerical solvers estimate and correct the approximation error, these intermediate <a href="#output"><code>output</code></a> values may be tentative or may be final.
It is possible for the FMU to inform the co-simulation algorithm whether the internal solver is in a tentative state, meaning that the output values computed from that state are also tentative, or if the internal solver has successfully completed the integration step, meaning that the FMU&#8217;s internal state is final, and will never be changed in the current execution of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.
If the internal integration step has been successfully completed, the co-simulation algorithm can forward intermediate outputs to other FMUs, where they can be used, for e.g., for extrapolation, interpolation, filtering or asynchronous co-simulation.
<em>[For tentative output values, the co-simulation algorithm must keep in mind that these values may change for the same time point.]</em></p>
</div>
<div class="paragraph">
<p>The FMU requests updated intermediate <a href="#input"><code>input</code></a> values for continuous variables every time they are required by the internal solver.
This can be either at tentative solver states or after successful integration steps.</p>
</div>
<div class="paragraph">
<p>Access to intermediate variables enables advanced Co-Simulation with interpolation/extrapolation techniques (such as polynomial extrapolation, TLM co-simulation, anti-alias filtering, smoothing of input among others)<br>
Moreover, this enables the same input approximation that was possible in FMI 2.0 with <code>fmi2SetInputDerivatives</code>, by evaluating the approximation polynomial and not within the FMU as in FMI 2.0.</p>
</div>
<div class="paragraph">
<p><a href="#figure-IntermediateUpdateMode">Figure 9</a> summarizes the above description.
It illustrates multiple intermediate internal solver steps, distinguishing between the final ones (with black-filled circles) and tentative ones (with white-filled circles).
It distinguishes the level of trust that can be placed in the tentative outputs (with dashed arrows) and in final outputs (with solid arrows).</p>
</div>
<div id="figure-IntermediateUpdateMode" class="imageblock text-center">
<div class="content">
<img src="images/intermediateupdate.svg" alt="intermediateupdate" width="65%">
</div>
<div class="title">Figure 9. Overview of solver states and intermediate update during a communication step</div>
</div>
<div class="paragraph">
<p>The FMU signals the support of <strong>Intermediate Update Mode</strong> via the capability flag <code>providesIntermediateUpdate</code>.
The co-simulation algorithm signals the support for <strong>Intermediate Update Mode</strong> by providing a non-NULL callback-function pointer for <a href="#fmi3CallbackIntermediateUpdate"><code>intermediateUpdate</code></a>.</p>
</div>
<div class="paragraph">
<p>The FMU enters <strong>Intermediate Update Mode</strong> by calling <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> within <strong>Step Mode</strong> (CS) or <strong>Clock Activation Mode</strong> (SE) and leaves the state towards <strong>Step Mode</strong> (CS) or <strong>Clock Activation Mode</strong> (SE) if the function returns <a href="#fmi3OK"><code>fmi3OK</code></a> or <a href="#fmi3Warning"><code>fmi3Warning</code></a>.
If the function returns <a href="#fmi3Error"><code>fmi3Error</code></a> the FMU enters state <strong>Terminated</strong>.
If the function returns <a href="#fmi3Fatal"><code>fmi3Fatal</code></a> the FMU enters the terminal state.</p>
</div>
<div id="fmi3CallbackIntermediateUpdate" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void (*fmi3CallbackIntermediateUpdate) (
    fmi3InstanceEnvironment instanceEnvironment,
    fmi3Float64 intermediateUpdateTime,
    fmi3Boolean clocksTicked,
    fmi3Boolean intermediateVariableSetRequested,
    fmi3Boolean intermediateVariableGetAllowed,
    fmi3Boolean intermediateStepFinished,
    fmi3Boolean canReturnEarly,
    fmi3Boolean *earlyReturnRequested,
    fmi3Float64 *earlyReturnTime);</code></pre>
</div>
</div>
<div id="intermediateUpdateTime" class="ulist">
<ul>
<li>
<p><a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> is the internal value of the <a href="#independent"><code>independent</code></a> variable <em>[typically simulation time]</em> of the FMU at which the callback has been called.
If an event happens or an <a href="#outputClock"><code>outputClock</code></a> ticks, <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> is the time of event or <a href="#outputClock"><code>outputClock</code></a> tick.
If the FMU returns with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a> from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> then <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> is the internal simulation time of the FMU of the last <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> call that signaled <a href="#canReturnEarly"><code>canReturnEarly == fmi3True</code></a>.
<a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> is also the value of the <a href="#independent"><code>independent</code></a> variable of intermediate steps of the internal FMU solver.
The FMU must not call the callback function <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> with an <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> that is smaller than the <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> given in a previous call of <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> with <code>intermediateStepFinished == fmi3True</code>.</p>
</li>
</ul>
</div>
<div id="clocksTickedIA" class="ulist">
<ul>
<li>
<p>The <a href="#clocksTickedIA"><code>clocksTicked</code></a> parameter is only used in Scheduled Execution and is ignored in Co-Simulation.
When <a href="#clocksTickedIA"><code>clocksTicked == fmi3True</code></a>, it means that <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> function must be called for gathering all <a href="#clock"><code>clock</code></a> related information about ticking <a href="#outputClock"><code>output clocks</code></a> at <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> and then activate the given model partitions accordingly.</p>
</li>
</ul>
</div>
<div id="intermediateVariableSetRequested" class="ulist">
<ul>
<li>
<p>If <a href="#intermediateVariableSetRequested"><code>intermediateVariableSetRequested == fmi3True</code></a>, the co-simulation algorithm should provide intermediate <a href="#input"><code>input</code></a> variables by calling <code>fmi3Set{VariableType}</code> for continuous variables with <a href="#intermediateUpdate"><code>intermediateUpdate = true</code></a>.
The set of variables for which the co-simulation algorithm can provide intermediate values is supplied through the <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> argument to <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a>.
Note that if a co-simulation algorithm does not provide a new value for any of the variables contained in the set it registered, the last set value will be deemed to be the new value.</p>
</li>
</ul>
</div>
<div id="intermediateVariableGetAllowed" class="ulist">
<ul>
<li>
<p>If <a href="#intermediateVariableGetAllowed"><code>intermediateVariableGetAllowed == fmi3True</code></a>, the co-simulation algorithm may collect intermediate output variables by calling <code>fmi3Get{VariableType}</code> for variables with <a href="#intermediateUpdate"><code>intermediateUpdate = true</code></a>.
The set of variables for which the co-simulation algorithm can get values is supplied through the <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> argument to <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a>.</p>
</li>
</ul>
</div>
<div id="intermediateStepFinished" class="ulist">
<ul>
<li>
<p>If <a href="#intermediateStepFinished"><code>intermediateStepFinished == fmi3False</code></a>, the intermediate outputs of the FMU that the co-simulation algorithm inquires with <code>fmi3Get{VariableTypes}</code> resulting from tentative interval solver states and may still change for the same <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> (e.g., if the solver deems the tentative state to cause a too high approximation error, it may go back in time and try to re-estimate the state using smaller internal time steps).
<em>[These outputs shall for example not be communicated to other connected FMUs.</em>
<em>The use case for this is to let the co-simulation algorithm do some calculations for the FMU even for unfinished solver steps.</em>
<em>This is beneficial for example for Transmission Line (TLM) co-simulation, where this helps to keep the interface cleaner.</em>
<em>Instead of FMUs exchanging hard-to-understand variables such as "wave variable" and "characteristic impedance", they can exchange intuitive variables like "force" and "speed".]</em></p>
</li>
<li>
<p>If <a href="#intermediateStepFinished"><code>intermediateStepFinished == fmi3True</code></a>, intermediate outputs inquired by the co-simulation algorithm with <code>fmi3Get{VariableTypes}</code> correspond to accepted internal solver steps and will not change (if the co-simulation algorithm does not rollback the FMU). <br>
<em>[So the co-simulation algorithm could for example</em></p>
<div class="ulist">
<ul>
<li>
<p><em>use the values obtained with <code>fmi3Get{VariableTypes}</code> with <a href="#intermediateStepFinished"><code>intermediateStepFinished == fmi3True</code></a> to create an interpolation for the intermediate inputs of other FMUs.</em></p>
</li>
<li>
<p><em>use this information for plotting.]</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="canReturnEarly" class="ulist">
<ul>
<li>
<p>When <a href="#canReturnEarly"><code>canReturnEarly == fmi3True</code></a> the co-simulation algorithm can request the FMU to return early at the current <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a> time instant by returning with <a href="#earlyReturnRequested"><code>earlyReturnRequested == fmi3True</code></a> from the callback function <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.
If <a href="#canReturnEarly"><code>canReturnEarly == fmi3False</code></a> the FMU will not do the early return, regardless of the co-simulation algorithm request.</p>
</li>
</ul>
</div>
<div id="earlyReturnRequested" class="ulist">
<ul>
<li>
<p><code>earlyReturnRequested == fmi3True</code> requests the FMU to end the <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> at a Newtonian time instant and return early.
This is only allowed if <a href="#canReturnEarly"><code>canReturnEarly == fmi3True</code></a>.</p>
</li>
</ul>
</div>
<div id="earlyReturnTime" class="ulist">
<ul>
<li>
<p><code>earlyReturnTime</code> is used to tell the FMU at what time to return early from the current <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> (at the earliest), if the return value of <a href="#earlyReturnRequested"><code>earlyReturnRequested</code></a> of <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> is <code>fmi3True</code>.
If the <a href="#earlyReturnTime"><code>earlyReturnTime</code></a> is greater than the last signaled <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a>, the FMU may integrate up to the time instant <a href="#earlyReturnTime"><code>earlyReturnTime</code></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When providing intermediate inputs to the FMU, it is important that the co-simulation algorithm provides the same input value for the same variable, at the same <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a>.
In other words, it is required that the calculation of inputs to the FMU be deterministic.
This is assumed by the internal solver.
If an input value changes for the same <a href="#intermediateUpdateTime"><code>intermediateUpdateTime</code></a>, the internal numerical solver may deem that re-estimate a state multiple times, without ever being able to decrease the approximation error.</p>
</div>
<div class="paragraph">
<p>Because the FMU intermediate outputs may be trusted when <a href="#intermediateStepFinished"><code>intermediateStepFinished == fmi3True</code></a>, the FMU is not allowed to call <a href="#intermediateUpdate"><code>intermediateUpdate</code></a> for a simulation time point prior to or equal to a previous call whose argument <a href="#intermediateStepFinished"><code>intermediateStepFinished == fmi3True</code></a>.</p>
</div>
<div class="paragraph">
<p>If the early return is conducted successfully by the FMU it must return with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a> from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>, indicating the current FMU time with <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a>.</p>
</div>
<div class="paragraph">
<p>The co-simulation algorithm can decide if a rollback of the FMU to reach the <a href="#earlyReturnTime"><code>earlyReturnTime</code></a> time is required or it may continue the simulation from <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> for that FMU.
Note that <strong>Event Mode</strong> is not supported in Scheduled Execution.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <code>fmi3Get{VariableType}</code></dt>
<dd>
<p>If <a href="#intermediateVariableGetAllowed"><code>intermediateVariableGetAllowed == fmi3True</code></a>, the value of intermediate variables can be retrieved.
Intermediate variables are variables that are marked with attribute <a href="#intermediateUpdate"><code>intermediateUpdate = true</code></a> in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> and have been included in the <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> argument to <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a>.</p>
</dd>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>If <a href="#intermediateVariableSetRequested"><code>intermediateVariableSetRequested == fmi3True</code></a>, the value of intermediate, continuous variables should be set.
Intermediate variables are variables that are marked with attribute <a href="#intermediateUpdate"><code>intermediateUpdate = true</code></a> in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> and have been included in the <a href="#requiredIntermediateVariables"><code>requiredIntermediateVariables</code></a> argument to <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>There is a defined order of calling these functions: first all <code>fmi3Get{VariableType}</code> calls must be performed, then <code>fmi3Set{VariableType}</code> may be called.<br>
<em>[This is analogous to the calling sequence of of</em> <code>fmi3Get{VariableType}</code> <em>and</em> <code>fmi3Set{VariableType}</code> <em>calls at communication points.]</em></p>
</div>
<div class="paragraph">
<p>Please refer to <a href="#IntermediateUpdateModeSE">Section 5.2.1.3</a> for additional allowed functions in <strong>Intermediate Update Mode</strong> for SE.</p>
</div>
<div class="paragraph">
<p>The following code example shows an implementation of <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> that uses intermediate update to record a set of variables at every internal solver step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="c" class="language-c hljs">fmi3Status recordVariables(InstanceEnvironment *instanceEnvironment, fmi3Float64 time) {
    fmi3ValueReference outputsVRs[2] = { vr_h, vr_v };
    fmi3Float64 y[2];
    fmi3Status status = fmi3GetFloat64(instanceEnvironment-&gt;instance, outputsVRs, 2, y, 2);
    fprintf(instanceEnvironment-&gt;outputFile, "%g,%g,%g\n", time, y[0], y[1]);
    return status;
}

void cb_intermediateUpdate(fmi3InstanceEnvironment instanceEnvironment,
                           fmi3Float64 intermediateUpdateTime,
                           fmi3Boolean eventOccurred,
                           fmi3Boolean clocksTicked,
                           fmi3Boolean intermediateVariableSetAllowed,
                           fmi3Boolean intermediateVariableGetAllowed,
                           fmi3Boolean intermediateStepFinished,
                           fmi3Boolean canReturnEarly,
                           fmi3Boolean *earlyReturnRequested,
                           fmi3Float64 *earlyReturnTime) {

    if (!instanceEnvironment) {
        return;
    }

    *earlyReturnRequested = fmi3False;

    InstanceEnvironment* env = (InstanceEnvironment*)instanceEnvironment;

    // remember the intermediateUpdateTime
    env-&gt;intermediateUpdateTime = intermediateUpdateTime;

    fmi3Status status = fmi3OK;

    if (eventOccurred) {
        return; // don't record events
    }

    // if getting intermediate output variables is allowed
    if (intermediateVariableGetAllowed) {

        // Get the output variables at time == intermediateUpdateTime
        // fmi3Get{VariableType}();
        status = recordVariables(env, intermediateUpdateTime);

        // If integration step in FMU solver is finished
        if (intermediateStepFinished) {
            //Forward output variables to other FMUs or write to result files
        }
    }

    // if setting intermediate output variables is allowed
    if (intermediateVariableSetAllowed) {
        // Compute intermediate input variables from output variables and
        // variables from other FMUs. Use latest available output
        // variables, possibly from get functions above.
        // inputVariables = ...

        // Set the input variables at time == intermediateUpdateTime
        // fmi3Set{VariableType}();
    }

    // Internal execution in FMU will now continue
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fmi-description-schema">2.4. FMI Description Schema</h3>
<div id="modelDescription.xml" class="paragraph">
<p>All static information related to the core functionality of an FMU is stored in the text file <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> in XML format as specified by the XML schema file <code>fmi3ModelDescription.xsd</code>.
Especially, the FMU variables and their attributes such as <code>name</code>, <code>unit</code>, default <a href="#initial"><code>initial</code></a> value, etc. are stored in this file.</p>
</div>
<div class="paragraph">
<p>Additional optional information about the graphical representation and the grouping of FMU variables into terminals is stored in the optional text file <code>icons/terminalsAndIcons.xml</code> in XML format as specified by the XML schema file <code>fmi3TerminalsAndIcons.xsd</code>.</p>
</div>
<div class="paragraph">
<p>Build information for source code FMUs is provided together with a <code>buildDescription.xml</code> file in the <code>sources</code> directory that adheres to the <code>fmi3BuildDescription.xsd</code> schema file.</p>
</div>
<div class="paragraph">
<p>It is not allowed to change the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file.
<em>[Reason: The <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file has to be consistent with the binary or source code implementations.</em>
<em>Specifically, changes to the start values are not allowed.]</em></p>
</div>
<div class="paragraph">
<p>The structure of the XML files is defined with the schema file <code>fmi3ModelDescription.xsd</code> and the optional <code>fmi3TerminalsAndIcons.xsd</code> and <code>fmi3BuildDescription.xsd</code> files.
These schema files utilize several helper schema files.</p>
</div>
<div class="paragraph">
<p>In this section these schema files are discussed.
The normative definition are the above mentioned schema files.
In the graphical representation of the schema, optional elements are marked with a dashed box (e.g., see <a href="#figure-schema-Annotations">Figure 10</a>).
The required data types (like: <code>xs:normalizedString</code>) are defined in <a href="https://www.w3.org/TR/xmlschema-2/">XML Schema Part 2: Datatypes Second Edition</a>.
The types used in the FMI schema files are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 50%;">
<col style="width: 16.6666%;">
<col style="width: 16.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description (<a href="http://www.w3.org/TR/xmlschema-2/" class="bare">http://www.w3.org/TR/xmlschema-2/</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping to C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping to FMI 3.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IEEE 754 double-precision 64-bit floating point type <em>[An IEEE 754 double-precision floating point value can have up to 17 significant digits in its decimal representation.
In order to not loose precision, either an appropriate minimal printer algorithm should be used, or alternatively a number of this type should be stored in XML files with at least 17 significant digits.]</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Float64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>single</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IEEE 754 single-precision 32-bit floating point type <em>[An IEEE 754 single-precision floating point value can have up to 9 significant digits in its decimal representation.
In order to not loose precision, either an appropriate minimal printer algorithm should be used, or alternatively a number of this type should be stored in XML files with at least 9 significant digits.]</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Float32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 127 and minimum value -128 (8 bit signed integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int8_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Int8</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unsignedByte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 255 and minimum value 0 (8 bit unsigned integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint8_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3UInt8</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 32767 and minimum value -32768 (16 bit signed integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int16_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Int16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unsignedShort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 65535 and minimum value 0 (16 bit unsigned integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint16_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3UInt16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 2147483647 and minimum value -2147483648 (32 bit signed integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int32_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Int32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unsignedInt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 4294967295 and minimum value 0 (32 bit unsigned integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint32_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3UInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 9223372036854775807 and minimum value -9223372036854775808 (64 bit signed integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int64_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Int64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unsignedLong</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer number with maximum value 18446744073709551615 and minimum value 0 (64 bit unsigned integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint64_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3UInt64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean number.
Legal literals: <code>false</code>, <code>true</code>, <code>0</code>, <code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Boolean</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any number of characters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>normalizedString</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String without carriage return, line feed, and tab characters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hexBinary</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary hex-encoded binary data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Binary</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date, time and time zone (for details see <a href="https://www.w3.org/TR/xmlschema-2/">XML Schema Part 2: Datatypes Second Edition</a>).
Example: <code>2002-10-23T12:00:00Z</code> (noon on October 23, 2002, Greenwich Mean Time)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tool specific</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not defined</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The first line of an XML file, such as <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>, must contain the encoding scheme of the XML file.
It is required that the encoding scheme is always UTF-8:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The FMI schema files (<code>fmi3*.xsd</code>) are also stored in UTF-8.<br>
<em>[Note that the definition of an encoding scheme is a prerequisite in order for the XML file to contain letters outside of the 7 bit ANSI ASCII character set, such as German umlauts, or Asian characters.</em>
<em>Furthermore, note the FMI calling interface requires that strings are encoded in UTF-8.</em>
<em>Since the XML files are also required to be encoded in UTF-8, string variables need not to be transformed when reading from the XML files in to C string variables.].</em></p>
</div>
<div class="paragraph">
<p><em>[Note that child information items, such as elements in a sequence are ordered lists according to document order, whereas attribute information items are unordered sets (see <a href="http://www.w3.org/TR/XML-infoset/#infoitem.element" class="bare">http://www.w3.org/TR/XML-infoset/#infoitem.element</a>).</em>
<em>The FMI schema is based on ordered lists in a sequence and therefore parsing must preserve this order.</em>
<em>For example, the information stored in <code>&lt;ModelVariables&gt;&lt;Derivative&gt;</code> is only correct if this property is fulfilled.]</em></p>
</div>
<div class="paragraph">
<p>All XML-based file formats defined in this standard allow optional <code>Annotation</code> elements to be inserted in all XML elements that represent entities of the underlying data model.
This is achieved through the <code>Annotations</code> element:</p>
</div>
<div id="figure-schema-Annotations" class="imageblock">
<div class="content">
<img src="images/schema/Annotations.png" alt="Annotations" width="80%">
</div>
<div class="title">Figure 10. Annotations Element.</div>
</div>
<div class="paragraph">
<p>Each <code>Annotation</code> element contains a required <code>type</code> attribute, which contains the namespace for that annotation.
The content of the <code>Annotation</code> element can be arbitrary XML data, and can make use of XML namespaces and XML schemas for combined validation where appropriate.</p>
</div>
<div class="paragraph">
<p>The namespace mechanism for the <code>type</code> attribute is based on reverse domain notation:
The originator of a specification for additional data specifies a domain name under their control as the namespace for the additional data, in order to avoid conflicts due to name collisions.
The namespace is used in reverse domain notation.
All namespaces under both the <code>org.modelica</code> and <code>org.fmi-standard</code> domains are reserved for use in future layered standards.</p>
</div>
<div class="paragraph">
<p><em>[For example, extensions defined by the Modelica Association might make use of the <code>org.modelica.fmi</code> namespace.</em>
<em>This could lead to annotations with a <code>type</code> attribute of <code>org.modelica.fmi.something</code>, and/or extra files under the <code>extra/org.modelica.ssp.something</code> sub-directory.]</em></p>
</div>
<div class="paragraph">
<p>Annotations are intended to allow structured extensions of the FMI XML files, without creating conflicting extensions, or leaving ambiguities in interpretation.
All annotations can safely be ignored by implementations that just implement the base FMI standard.</p>
</div>
<div class="sect3">
<h4 id="fmiModelDescription">2.4.1. Definition of an FMU</h4>
<div class="paragraph">
<p>This is the root-level schema file and is illustrated in <a href="#system_overview">Figure 11</a>.
The figure contains all elements in the schema file.
Data is defined by attributes to these elements.</p>
</div>
<div id="system_overview" class="imageblock">
<div class="content">
<img src="images/schema/fmiModelDescription.png" alt="fmiModelDescription" width="70%">
</div>
<div class="title">Figure 11. fmiModelDescription element.</div>
</div>
<div class="paragraph">
<p>On the top level, the schema consists of the elements detailed in <a href="#table-schema-fmiModelDescription">Table 3</a>.
<em>[If an optional element is present and defines a list (such as <code>&lt;UnitDefinitions&gt;</code>), the list must have at least one element (such as <code>&lt;Unit&gt;</code>).]</em></p>
</div>
<table id="table-schema-fmiModelDescription" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. fmiModelDescription element details.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;ModelExchange&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If present, the FMU is based on FMI for Model Exchange (<a href="#fmi-for-model-exchange">Section 3</a>) <em>[(in other words, the FMU includes the model or the communication to a tool that provides the model, and the environment provides the simulation engine)]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;CoSimulation&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If present, the FMU is based on FMI for Co-Simulation (<a href="#fmi-for-co-simulation">Section 4</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;ScheduledExecution&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If present, the FMU is based on FMI for Scheduled Execution (<a href="#fmi-for-scheduled-execution">Section 5</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;UnitDefinitions&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A global list of unit and display unit definitions <em>[for example, used to convert display units into the units used in the model equations]</em>.
These definitions are used in the XML element <code>&lt;ModelVariables&gt;</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;TypeDefinitions&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A global list of type definitions that are utilized in <code>&lt;ModelVariables&gt;</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;LogCategories&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A global list of log categories that can be set to define the log information that is supported from the FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;DefaultExperiment&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Providing default settings for the integrator, such as stop time and relative tolerance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;ModelVariables&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The central FMU data structure defining all variables of the FMU that are visible/accessible via the FMU functions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;ModelStructure&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the structure of the model.
Especially, the ordered lists of <a href="#output"><code>outputs</code></a>, continuous-time <a href="#state"><code>states</code></a>, initial unknowns (the unknowns during <strong>Initialization Mode</strong>) and the event indicators are defined here.
For more details on <code>&lt;ModelStructure&gt;</code>, see <a href="#ModelStructure">Section 2.4.9</a>.
Furthermore, the dependency of the unknowns from the knowns can be optionally defined for <a href="#output"><code>outputs</code></a>, continuous-time <a href="#state"><code>states</code></a> and initial unknowns.
<em>[This information can be, for example, used to compute efficiently a sparse Jacobian for simulation, or to utilize the <a href="#input"><code>input</code></a> / <a href="#output"><code>output</code></a> dependency in order to detect that in some cases there are actually no algebraic loops when connecting FMUs together]</em>.
Dependencies for event indicators are not provided.
<em>[The calculation of derivatives of event indicators is not provided.]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Annotations&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional annotations for the top-level element.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>At least one element of <code>&lt;ModelExchange&gt;</code>, <code>&lt;CoSimulation&gt;</code> or <code>&lt;ScheduledExecution&gt;</code> must be present to identify the type of the FMU.
If multiple elements are defined, different types of models are included in the FMU.
The details of these elements are defined in <a href="#fmi-for-model-exchange">Section 3</a>, <a href="#fmi-for-co-simulation">Section 4</a> or <a href="#fmi-for-scheduled-execution">Section 5</a>.</p>
</div>
<div class="paragraph">
<p>The XML attributes of <code>&lt;fmiModelDescription&gt;</code> are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmiVersion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of FMI that was used to generate the XML file.
The value for this version is <code>3.0</code>.
Future minor revisions are denoted as <code>3.1</code>, <code>3.2</code> &#8230;&#8203;</p>
<p class="tableblock"><em>[During development prototype FMU implementations can indicate compliance with a certain development version based on the tags available at <a href="https://github.com/modelica/fmi-standard/tags" class="bare">https://github.com/modelica/fmi-standard/tags</a>.</em>
<em>For example the value for the FMI 3.0 Alpha 2 release is <code>3.0-alpha.2</code>.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>modelName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the model as used in the modeling environment that generated the XML file, such as <code>Modelica.Mechanics.Rotational.Examples.CoupledClutches</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instantiationToken</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>instantiationToken</code> is a string that can be used by the FMU to check that the XML file is compatible with the implementation of the FMU.
For this purpose the importing tool must pass the <code>instantiationToken</code> from the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> to the <a href="#fmi3Instantiate"><code>fmi3InstantiateXXX</code></a> function call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional string with a brief description of the model.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>author</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional string with the name and organization of the model author.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional version of the model <em>[for example <code>1.0</code>]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>copyright</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional information on the intellectual property copyright for this FMU <em>[for example <code>&#169; My Company 2011</code>]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>license</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional information on the intellectual property licensing
for this FMU <em>[for example <code>BSD license &lt;license text or link to license&gt;</code>]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>generationTool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the tool that generated the XML file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>generationDateAndTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional date and time when the XML file was generated.
The format is a subset of <code>dateTime</code> and should be: <code>YYYY-MM-DDThh:mm:ssZ</code> (with one <code>T</code> between date and time; <code>Z</code> characterizes the Zulu time zone, in other words, Greenwich meantime) <em>[for example <code>2009-12-08T14:33:22Z</code>]</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>variableNamingConvention</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines whether the variable names in <code>&lt;ModelVariables&gt;</code> and in <code>&lt;TypeDefinitions&gt;</code> follow a particular convention.
For the details, see <a href="#variableNamingConvention">Section 2.4.10</a>.
Currently standardized are:</p>
<p class="tableblock"><code>= flat</code>: A list of strings (the default).</p>
<p class="tableblock"><code>= structured</code>: Hierarchical names with <code>.</code> as hierarchy separator, and with array elements and derivative characterization.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="common-capability-flags">2.4.2. Definition of Capability Flags</h4>
<div class="paragraph">
<p>The elements <code>&lt;ModelExchange&gt;</code>, <code>&lt;CoSimulation&gt;</code> and <code>&lt;ScheduledExecution&gt;</code> contain attributes representing capability flags describing which optional functionalities the FMU supports.</p>
</div>
<div class="paragraph">
<p>The following table contains capability flags common to all three interface types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>needsExecutionTool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, a tool is needed to execute the model and the FMU just contains the communication to this tool.
<em>[Typically, this information is only utilized for information purposes.</em>
<em>For example, when loading an FMU with <code>needsExecutionTool = true</code>, the environment can inform the user that a tool has to be available on the computer where the model is instantiated.</em>
<em>The name of the tool can be taken from attribute <code>generationTool</code> in <code>&lt;fmiModelDescription&gt;</code>.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>canBeInstantiatedOnlyOncePerProcess</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This flag indicates cases (especially for embedded code), where only one instance per FMU is possible (multiple instantiation is default = <code>false</code>; if multiple instances are needed and the flag <code>canBeInstantiatedOnlyOncePerProcess = true</code>, the FMUs must be instantiated in different processes).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="canGetAndSetFMUState"></a><code>canGetAndSetFMUState</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, the environment can inquire the internal FMU state and can restore it.
That is, functions <a href="#fmi3GetFMUState"><code>fmi3GetFMUState</code></a>, <a href="#fmi3SetFMUState"><code>fmi3SetFMUState</code></a>, and <a href="#fmi3FreeFMUState"><code>fmi3FreeFMUState</code></a> are supported by the FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>canSerializeFMUState</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, the environment can serialize the internal FMU state, in other words, functions <a href="#fmi3SerializedFMUStateSize"><code>fmi3SerializedFMUStateSize</code></a>, <a href="#fmi3SerializeFMUState"><code>fmi3SerializeFMUState</code></a>, <a href="#fmi3DeSerializeFMUState"><code>fmi3DeSerializeFMUState</code></a> are supported by the FMU.
If this is the case, then flag <code>canGetAndSetFMUState</code> must be <code>true</code> as well.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providesDirectionalDerivatives</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, the directional derivative of the equations can be computed with <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providesAdjointDerivatives</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, the adjoint derivatives of the equations can be computed with <a href="#fmi3GetAdjointDerivative"><code>fmi3GetAdjointDerivative</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providesPerElementDependencies</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The FMU is able to provide detailed dependency information at run time using <a href="#fmi3GetNumberOfVariableDependencies"><code>fmi3GetNumberOfVariableDependencies</code></a> and <a href="#fmi3GetVariableDependencies"><code>fmi3GetVariableDependencies</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxOutputDerivativeOrder</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The FMU is able to provide <a href="#derivative"><code>derivatives</code></a> of <a href="#output"><code>outputs</code></a> with maximum order.
Calling of <code>fmi3GetOutputDerivatives</code> is allowed up to the order defined by <code>maxOutputDerivativeOrder</code>.
This flag is ignored in <code>ModelExchange</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providesIntermediateUpdate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The FMU supports <strong>Intermediate Update Mode</strong> and will call <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>, if provided.
This flag is ignored in <code>ModelExchange</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="recommendedIntermediateInputSmoothness"></a><code>recommendedIntermediateInputSmoothness</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A value of \(k\) with \(k&gt;0\) signals to the co-simulation algorithm, that it is beneficial for the solver to receive intermediate inputs that are k-time continuously differentiable (\(C^k\)) on the current communication interval.
\(k=0\) means continuous (see <a href="#smoothness">Section 4.1.3</a>).<br>
This flag is not supported in <code>ModelExchange</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_definition_of_units">2.4.3. Definition of Units</h4>
<div class="paragraph">
<p>In this section, the units of the variables are defined.</p>
</div>
<div class="paragraph">
<p><em>[Unit support is important for technical systems since otherwise it is very easy for errors to occur.</em>
<em>Unit handling is a difficult topic, and there seems to be no method available that is really satisfactory for all applications, such as unit check, unit conversion, unit propagation or dimensional analysis.</em>
<em>In FMI, a pragmatic approach is used that takes into account that every software system supporting units has potentially its own specific technique to describe and utilize units.</em>
<em>The approach used here is slightly different than FMI 1.0 to reduce the need for standardized string representations.]</em></p>
</div>
<div class="paragraph">
<p>Element <code>&lt;fmiModelDescription&gt;&lt;UnitDefinitions&gt;</code> is defined as:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/schema/UnitDefinitions.png" alt="UnitDefinitions" width="90%">
</div>
</div>
<div class="paragraph">
<p>It consists of zero or more <code>Unit</code> definitions.
If no units are defined, element <code>&lt;UnitDefinitions&gt;</code> must not be present.
If 1 or more units are defined, this element must be present.</p>
</div>
<div class="paragraph">
<p>A <code>Unit</code> is defined by its <code>name</code> attribute such as <code>N.m</code> or <code>N*m</code> or <code>Nm</code>, which must be unique with respect to all other defined elements of the <code>&lt;UnitDefinitions&gt;</code> list.
If a variable is associated with a <code>Unit</code>, then the value set (resp. get) with functions <code>fmi3Set{VariableType}</code> (resp. <code>fmi3Get{VariableType}</code>) has this <code>Unit</code>.
<em>[The purpose of the name is to uniquely identify a unit and, for example, use it to display the unit in menus or in plots.</em>
<em>Since there is no standard to represent units in strings, and there are different ways how this is performed in different tools, no specific format for the string representation of the unit is required.]</em></p>
</div>
<div class="paragraph">
<p>Optionally, a value given in unit <code>Unit</code> can be converted to a value with respect to unit <code>&lt;BaseUnit&gt;</code> utilizing the conversion <code>factor</code> and <code>offset</code> attributes:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/BaseUnit.png" alt="BaseUnit" width="50%">
</div>
</div>
<div class="paragraph">
<p>Besides <code>factor</code> and <code>offset</code>, the <code>&lt;BaseUnit&gt;</code> definition consists of the exponents of the 7 SI base units <code>kg</code>, <code>m</code>, <code>s</code>, <code>A</code>, <code>K</code>, <code>mol</code>, <code>cd</code>, and of the exponent of the SI derived unit <code>rad</code>.
<em>[The additional <code>rad</code> base unit helps to handle the often occurring quantities in technical systems that depend on an angle.]</em></p>
</div>
<div class="paragraph">
<p>A value with respect to <code>Unit</code> (abbreviated as <code>Unit_value</code>) is converted with respect to <code>&lt;BaseUnit&gt;</code> (abbreviated as <code>BaseUnit_value</code>) by the equation:</p>
</div>
<div class="paragraph">
<p><code>BaseUnit_value = factor * Unit_value + offset</code></p>
</div>
<div class="paragraph">
<p><em>[For example, if</em> \({p_{\mathit{bar}}}\) <em>is a pressure value in unit <code>bar</code>, and</em> \({p_{\mathit{Pa}}}\) <em>is the pressure value in <code>&lt;BaseUnit&gt;</code>, then</em></p>
</div>
<div class="paragraph">
<p>\({p_{\mathit{Pa}} = 10^5 p_{\mathit{bar}}}\)</p>
</div>
<div class="paragraph">
<p><em>and therefore, <code>factor = 1.0e5</code> and <code>offset = 0.0</code>.</em></p>
</div>
<div class="paragraph">
<p><em>In the following table several unit examples are given (Note that if in column <code>exponents</code> the definition "\({kgm^2 / s^2}\)" is present, then the attributes of <code>&lt;BaseUnit&gt;</code> are: <code>kg=1, m=2, s=-2</code>):</em></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Quantity</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Unit.name<br>
(examples)</p></td>
<td class="tableblock halign-left valign-top" colspan="3"><p class="tableblock">Unit.BaseUnit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exponents</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">factor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">offset</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Torque</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N.m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\({kg \cdot m^2 / s^2}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Energy</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>J</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\({kg \cdot m^2 / s^2}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Pressure</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\({\frac{kg}{m \cdot s^2}}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0e5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Angle</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rad</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.01745329251994330 (= pi/180)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Angular velocity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rad/s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rad/s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Angular velocity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rpm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rad/s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.1047197551196598 (=2*pi/60)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Frequency</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Hz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rad/s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6.283185307179586</code><br>
<code>(= 2*pi)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Temperature</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#176;F</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.5555555555555556</code><br>
<code>(= 5/9)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>255.3722222222222</code><br>
<code>(= 273.15-32*5/9)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Per cent by length</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%/m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1/m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.01</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Parts per million</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ppm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.0e-6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Length</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>km</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Length</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>yd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.9144</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.0</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>Note that <code>Hz</code> is typically used as <code>Unit.name</code> for a frequency quantity, but it can also be used as <code>&lt;DisplayUnit&gt;</code> for an angular velocity quantity (since <code>revolution/s</code>).]</em></p>
</div>
<div class="paragraph">
<p><em>The <code>&lt;BaseUnit&gt;</code> definitions can be utilized for different purposes (the following application examples are optional and a tool may also completely ignore the <code>Unit</code> definitions):</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Signal connection check</dt>
<dd>
<div class="paragraph">
<p><em>When two signals v1 and v2 are connected together, and on at least one of the signals no <code>&lt;BaseUnit&gt;</code> element is defined, then the connection equation "v2 = v1" holds (if v1 is an <a href="#output"><code>output</code></a> of an FMU and v2 is an <a href="#input"><code>input</code></a> of another FMU, with <code>fmi3Get{VariableType}</code> the value of v1 is inquired and used as value for v2 by calling <code>fmi3Set{VariableType}</code>).</em></p>
</div>
<div class="paragraph">
<p><em>When two signals v1 and v2 are connected together, and for both of them <code>&lt;BaseUnit&gt;</code> elements are defined, then they must have identical exponents of their <code>&lt;BaseUnit&gt;</code>.</em>
<em>If <code>factor</code> and <code>offset</code> are also identical, again the connection equation <code>v2 = v1</code> holds.</em>
<em>If <code>factor</code> and <code>offset</code> are not identical, the tool may either trigger an error or, if supported, perform a conversion; in other words, use the connection equation (in this case the <code>relativeQuantity</code> of the <code>&lt;TypeDefinition&gt;</code>, see below, has to be taken into account in order to determine whether <code>offset</code> shall or shall not be utilized):</em></p>
</div>
<div class="paragraph">
<p><code>factor(v1) * v1 + offset(v1) = factor(v2) * v2 + offset(v2)</code></p>
</div>
<div class="paragraph">
<p><em>As a result, wrong connections can be detected (for example, connecting a force with an angle signal would trigger an error) and conversions between, say, US and SI units can be either automatically performed or, if not supported, an error is triggered as well.</em></p>
</div>
<div class="paragraph">
<p><em>[Note that this approach is not satisfactory for variables belonging to different quantities that have, however, the same <code>&lt;BaseUnit&gt;</code>, such as quantities <code>Energy</code> and <code>Torque</code>, or <code>AngularVelocity</code> and <code>Frequency</code>.</em>
<em>To handle such cases, quantity definitions have to be taken into account (see <code>&lt;TypeDefinitions&gt;</code>) and quantity names need to be standardized.]</em></p>
</div>
<div class="paragraph">
<p><em>This approach allows a general treatment of units, without being forced to standardize the grammar and allowed values for units (for example, in FMI 1.0, a unit could be defined as <code>N.m</code> in one FMU and as <code>N*m</code> in another FMU, and a tool would have to reject a connection, since the units are not identical.</em>
<em>In FMI 2.0, the connection would be accepted, provided both elements have the same <code>&lt;BaseUnit&gt;</code> definition).</em></p>
</div>
</dd>
<dt class="hdlist1">Dimensional analysis of equations</dt>
<dd>
<div class="paragraph">
<p><em>In order to check the validity of equations in a modeling language, the defined units can be used for dimensional analysis, by using the <code>&lt;BaseUnit&gt;</code> definition of the respective unit.</em>
<em>For this purpose, the <code>&lt;BaseUnit&gt;</code> <code>rad</code> has to be treated as <code>1</code>.</em>
<em>Example:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
J \cdot \alpha = \tau \rightarrow [kg.m^2]*[rad/s^2] = [kg.m^2/s^2] &amp; \quad \text{// o.k. ("rad" is treated as "1")} \\
J \cdot \alpha = f \rightarrow [kg.m^2]*[rad/s^2] = [kg.m/s^2] &amp; \quad \text{// error, since dimensions do not agree}
\end{align*}\]
</div>
</div>
</dd>
<dt class="hdlist1">Unit propagation</dt>
<dd>
<div class="paragraph">
<p><em>If unit definitions are missing for signals, they might be deduced from the equations where the signals are used.</em>
<em>If no unit computation is needed, <code>rad</code> is propagated.</em>
<em>If a unit computation is needed and one of the involved units has <code>rad</code> as a <code>&lt;BaseUnit&gt;</code>, then unit propagation is not possible.</em>
<em>Examples:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>a = b + c, and <code>Unit</code> of c is provided, but not <code>Unit</code> of a and b:</em><br>
<em>The Unit definition of <code>c</code> (in other words, <code>Unit.name</code>, <code>&lt;BaseUnit&gt;</code>, <code>&lt;DisplayUnit&gt;</code>) is also used for <code>a</code> and <code>b</code>.</em>
<em>For example, if BaseUnit(c) = <code>rad/s</code>, then BaseUnit(a) = BaseUnit(b) = <code>rad/s</code>.</em></p>
</li>
<li>
<p><em>a = b*c, and <code>Unit</code> of a and of c is provided, but not <code>Unit</code> of b:</em><br>
<em>If <code>rad</code> is either part of the <code>&lt;BaseUnit&gt;</code> of <code>a</code> and/or of <code>c</code>, then the <code>&lt;BaseUnit&gt;</code> of <code>b</code> cannot be deduced (otherwise it can be deduced).</em>
<em>Example: If <code>BaseUnit(a) = kg.m/s2</code> and <code>BaseUnit(c) = m/s2</code>, then the <code>BaseUnit(b) can be deduced to be `kg</code>.</em>
<em>In such a case <code>Unit.name</code> of b cannot be deduced from the <code>Unit.name</code> of <code>a</code> and <code>c</code>, and a tool would typically construct the <code>Unit.name</code> of <code>b</code> from the deduced <code>&lt;BaseUnit&gt;</code>.</em></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>Additionally to the unit definition, optionally a set of display units can be defined.
These can be utilized for <a href="#input"><code>input</code></a> / <a href="#output"><code>output</code></a> of a value:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/DisplayUnit.png" alt="DisplayUnit" width="60%">
</div>
</div>
<div class="paragraph">
<p>A <code>&lt;DisplayUnit&gt;</code> is defined by <code>name</code>, <code>factor</code> and <code>offset</code>.
The attribute <code>name</code> must be unique with respect to all other <code>names</code> of the <code>&lt;DisplayUnit&gt;</code> definitions of the same <code>Unit</code> [(different <code>Unit</code> elements may have the same <code>&lt;DisplayUnit&gt;</code> names)].
A value with respect to Unit (abbreviated as <code>Unit_value</code>) is converted with respect to <code>&lt;DisplayUnit&gt;</code> (abbreviated as <code>DisplayUnit_value</code>) by the equation:</p>
</div>
<div class="paragraph">
<p><code>DisplayUnit_value = factor * Unit_value + offset</code></p>
</div>
<div class="paragraph">
<p><em>[For example, <code>offset</code> is needed for temperature units.]</em></p>
</div>
<div class="paragraph">
<p><em>[For example, if \({T_K}\) is the temperature value of <code>Unit.name</code> (in <code>K</code>) and \({T_F}\) is the temperature value of <code>&lt;DisplayUnit&gt;</code> (in <code>&#176;F</code>), then</em></p>
</div>
<div class="stemblock">
<div class="content">
\[T_F = (9/5) * (T_K - 273.15) + 32\]
</div>
</div>
<div class="paragraph">
<p><em>and therefore, <code>factor = 1.8 (=9/5)</code> and <code>offset = -459.67 (= 32 - 273.15*9/5)</code>.</em></p>
</div>
<div class="paragraph">
<p><em>Both the <code>DisplayUnit.name</code> definitions as well as the <code>Unit.name</code> definitions are used in the variable elements.</em>
<em>Example of a definition:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;Unit name="rad/s"&gt;
    &lt;BaseUnit s="-1" rad="1"/&gt;
    &lt;DisplayUnit name="deg/s" factor="57.29577951308232"/&gt;
    &lt;DisplayUnit name="rev/min" factor="9.549296585513721"/&gt;
&lt;/Unit&gt;
 &lt;Unit name="bar"&gt;
    &lt;BaseUnit kg="1" m="-1" s="-2" factor="1e5" offset="0"/&gt;
&lt;/Unit&gt;
 &lt;Unit name="Re"&gt;
    &lt;BaseUnit/&gt; &lt;!-- unit="1" --&gt;
                &lt;!-- (dimensionless, all exponents of BaseUnit are zero) --&gt;
 &lt;/Unit&gt;
 &lt;Unit name="Euro/PersonYear"/&gt;  &lt;!-- no mapping to BaseUnit defined --&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>The schema definition is present in a separate file <code>fmi3Unit.xsd</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="definition-of-types">2.4.4. Definition of Types</h4>
<div class="paragraph">
<p>Element <code>&lt;fmiModelDescription&gt;&lt;TypeDefinitions&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/TypeDefinitions.png" alt="TypeDefinitions" width="70%">
</div>
</div>
<div class="paragraph">
<p>This element consists of a set of <code>&lt;TypeDefinition&gt;</code> elements according to schema <code>fmi3TypeDefinition</code> in file <code>fmi3Type.xsd</code>.
Each <code>&lt;TypeDefinition&gt;</code> has attributes <code>name</code> and <code>description</code>.
Attribute <code>name</code> must be unique with respect to all other elements of the <code>&lt;TypeDefinitions&gt;</code> list.
Furthermore, <code>name</code> of a <code>&lt;TypeDefinition&gt;</code> must be different to all <code>name</code> attributes of variables <em>[if the same names would be used, then this would nearly always give problems when importing the FMU in an environment such as Modelica, where a type name cannot be used as instance name]</em>.</p>
</div>
<div class="paragraph">
<p>Additionally, one variable type element must be present.
Each variable type has its own attributes which can be consulted in the schema.
<a href="#figure-schema-Float64Type">Figure 12</a>, <a href="#figure-schema-Int32Type">Figure 13</a>, <a href="#figure-schema-BooleanType">Figure 14</a>, <a href="#figure-schema-BinaryType">Figure 15</a>, and <a href="#figure-schema-EnumerationType">Figure 16</a>, are representative examples.</p>
</div>
<div id="figure-schema-Float64Type" class="imageblock text-center">
<div class="content">
<img src="images/schema/Float64Type.png" alt="Float64Type" width="60%">
</div>
<div class="title">Figure 12. Float64Type element.</div>
</div>
<div id="figure-schema-Int32Type" class="imageblock text-center">
<div class="content">
<img src="images/schema/Int32Type.png" alt="Int32Type" width="50%">
</div>
<div class="title">Figure 13. Int32Type element.</div>
</div>
<div id="figure-schema-BooleanType" class="imageblock text-center">
<div class="content">
<img src="images/schema/BooleanType.png" alt="BooleanType" width="50%">
</div>
<div class="title">Figure 14. BooleanType element.</div>
</div>
<div id="figure-schema-BinaryType" class="imageblock text-center">
<div class="content">
<img src="images/schema/BinaryType.png" alt="BinaryType" width="70%">
</div>
<div class="title">Figure 15. BinaryType element.</div>
</div>
<div id="figure-schema-EnumerationType" class="imageblock text-center">
<div class="content">
<img src="images/schema/EnumerationType.png" alt="EnumerationType" width="75%">
</div>
<div class="title">Figure 16. EnumerationType element.</div>
</div>
<div class="paragraph">
<p>The type elements are referred to in variable elements to declare their type.
<em>[The alternative would be to define a type per variable.</em>
<em>However, this would lead to a situation where, e.g., the definition of a <code>Torque</code> type would have to be repeated over and over.]</em>
The attributes and elements have the following meaning:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute or Elements</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quantity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical quantity of the variable.
<em>[For example, <code>Angle</code>, or <code>Energy</code>.</em>
<em>The quantity names are not standardized]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit of the variable defined with attribute <code>name</code> of <code>&lt;UnitDefinitions&gt;&lt;Unit&gt;</code> that is used for the model equations.
<em>[For example, <code>N.m</code>: in this case a <code>Unit.name = `N.m</code> must be present under <code>&lt;UnitDefinitions&gt;</code>.]</em>
<em>[Note that for variables that are without a unit, the element should not have a <code>unit</code> attribute.]</em>
<em>[Giving an empty string as a <code>unit</code> attribute specifies a valid unit that needs to be defined among the unit definitions.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="displayUnit"></a> <code>displayUnit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default display unit.
The conversion to the <code>unit</code> is defined with the element <code>&lt;fmiModelDescription&gt;&lt;UnitDefinitions&gt;</code>.
If the corresponding <code>displayUnit</code> is not defined under <code>&lt;UnitDefinitions&gt;&lt;Unit&gt;&lt;DisplayUnit&gt;</code>, then <code>displayUnit</code> is ignored.
It is an error if <code>displayUnit</code> is defined as variable type element, but <code>unit</code> is not, or unit is not defined under <code>&lt;UnitDefinitions&gt;&lt;Unit&gt;</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mimeType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates the type of data passed as a binary.
Defaults to <code>application/octet-stream</code>, which is unspecific.
Implementations can use this information to provide guidance to the user about valid/useful connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>relativeQuantity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If this attribute is <code>true</code>, then the <code>offset</code> of <code>displayUnit</code> must be ignored.
<em>[For example, 10 degree Celsius = 10 Kelvin if <code>relativeQuantity = true</code> and not 283.15 Kelvin.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum value of variable (variable value \(\geq\) <code>min</code>).
If not defined, the minimum is the largest negative number that can be represented on the machine.
The <code>min</code> definition is information from the FMU to the environment defining the region in which the FMU is designed to operate, see also comment after this table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum value of variable (variable value \(\leq\) <code>max</code>).
If not defined, the maximum is the largest positive number that can be represented on the machine.
The <code>max</code> definition is information from the FMU to the environment defining the region in which the FMU is designed to operate, see also comment after this table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nominal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nominal value of variable.
If not defined and no other information about the nominal value is available, then <code>nominal = 1</code> is assumed.<br>
<em>[The nominal value of a variable can be, for example, used to determine the absolute tolerance for this variable as needed by numerical algorithms:</em><br>
<code>absoluteTolerance = nominal * tolerance * 0.01</code><br>
<em>where <code>tolerance</code> is, for example, the relative tolerance defined in <a href="#DefaultExperiment">Section 2.4.6</a>.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unbounded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, indicates that during time integration, the variable gets a value much larger than its nominal value <code>nominal</code>.
<em>[Typical examples are the monotonically increasing rotation angles of crank shafts and the longitudinal position of a vehicle along the track in long distance simulations.</em>
<em>This information can, for example, be used to increase numerical stability and accuracy by setting the corresponding bound for the relative error to zero (relative tolerance = 0.0), if the corresponding variable is a continuous <a href="#state"><code>state</code></a> variable.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Item</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Item&gt;</code> of an enumeration has a sequence of <code>name</code> and <code>value</code> pairs.
The values can be any integer number but must be unique within the same enumeration (in order that the mapping between <code>name</code> and <code>value</code> is bijective).
An <code>&lt;Enumeration&gt;</code> element must have at least one <code>&lt;Item&gt;</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Attributes <code>min</code> and <code>max</code> can be set for variables of numeric type or <code>&lt;Enumeration&gt;</code>.</em>
<em>The question is how <code>fmi3Set{VariableType}</code>, <code>fmi3Get{VariableType}</code> shall utilize this definition.</em>
<em>There are several conflicting requirements:</em><br>
<em>Avoiding forbidden regions (for example, if <code>u</code> is an <a href="#input"><code>input</code></a> and "sqrt(u)" is computed in the FMU, <code>min = 0</code> on <code>u</code> shall guarantee that only values of <code>u</code> in the allowed regions are provided).</em>
<em>Numerical algorithms (solvers or optimizers) do not guarantee constraints.</em>
<em>If a variable is outside of the bounds, the solver tries to bring it back into the bounds.</em>
<em>As a consequence, calling <code>fmi3Get{VariableType}</code> during an iteration of such a solver might return values that are not in the defined min/max region.</em>
<em>After the iteration is finalized, it is only guaranteed that a value is within its bounds up to a certain numerical precision.</em><br>
<em>During system creation and prototyping, checks on min/max should be performed.</em>
<em>For maximum performance on production or real-time systems, these checks might not be performed.</em><br>
<em>The approach in FMI is therefore that min/max definitions are an information from the FMU to the environment defining the region in which the FMU is designed to operate.</em>
<em>In any case, it is expected that the FMU handles variables appropriately where the region definition is critical.</em>
<em>For example, dividing by an <a href="#input"><code>input</code></a> (so the <a href="#input"><code>input</code></a> should not be in a small range of zero) or taking the square root of an <a href="#input"><code>input</code></a> (so the <a href="#input"><code>input</code></a> should not be negative) may either result in <a href="#fmi3Error"><code>fmi3Error</code></a>, or the FMU is able to handle this situation in other ways.</em></p>
</div>
<div class="paragraph">
<p><em>If the FMU is generated so that min/max shall be checked whenever meaningful (for example, for debug purposes), then the following strategy should be used:</em></p>
</div>
<div class="paragraph">
<p><em>If <code>fmi3Set{VariableType}</code> is called violating the min/max attribute settings of the corresponding variable, the following actions are performed:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>On a <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a> <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a> is returned.</em></p>
</li>
<li>
<p><em>On an <a href="#input"><code>input</code></a>, the FMU decides what to return (If no computation is possible, it could return <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a>, in other situations it may return <a href="#fmi3Warning"><code>fmi3Warning</code></a> or <a href="#fmi3Error"><code>fmi3Error</code></a>, or <a href="#fmi3OK"><code>fmi3OK</code></a>, if it is uncritical).</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>If an FMU defines min/max values for integer types and <code>&lt;Enumeration&gt;</code> variables (<a href="#local"><code>local</code></a> and <a href="#output"><code>output</code></a> variables), then the expected behavior of the FMU is that <code>fmi3Get{VariableType}</code> functions return values in the defined range.</em></p>
</div>
<div class="paragraph">
<p><em>If an FMU defines min/max values for numeric types, then the expected behavior of the FMU is that <code>fmi3Get{VariableType}</code> returns values at the solution (accepted steps of the integrators) in the defined range with a certain uncertainty related to the tolerances of the numerical algorithms.]</em></p>
</div>
<div class="sect4">
<h5 id="clock-type-definition">2.4.4.1. Clock Type Definition</h5>
<div class="paragraph">
<p>Clocks are integrated in the element <code>&lt;fmiModelDescription&gt;&lt;ModelVariables&gt;</code> as a variable element with the base type <code>fmi3Clock</code>.
The variable sub type <code>fmi3Clock</code> provides additional attributes for defining <a href="#clock"><code>clocks</code></a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clockType</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="clockType" class="paragraph">
<p>The type of <a href="#clock"><code>clocks</code></a> is defined based on the mandatory attribute <code>clockType</code> with the following two values:</p>
</div>
<div id="synchronousTime" class="paragraph">
<p><code>= synchronousTime</code> is used, if the properties of the <a href="#clock"><code>clock</code></a> adhere to synchronous clock theory.</p>
</div>
<div id="communicationPoint" class="paragraph">
<p><code>= communicationPoint</code> <a href="#clock"><code>clocks</code></a> define sampling points (i.e. communication points) for the variables of model partitions.</p>
</div>
<div class="paragraph">
<p>It is not allowed to include <a href="#clock"><code>clocks</code></a> of different <code>clockType</code> in one FMU.
<code>clockType</code> is a required attribute.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>triggeredBy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="triggeredBy"></a>
The optional attribute <a href="#triggeredBy"><code>triggeredBy</code></a> is used to define a tick relationship from an <a href="#outputClock"><code>outputClock</code></a> to an <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>inputClock</code></a> (see <a href="#clock-relationships-for-communication-point-clocks">Section 2.2.7.5</a>).</p>
<p class="tableblock">Only <a href="#clock"><code>clocks</code></a> with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a> can have this attribute.
It is not allowed to combine <a href="#outputClock"><code>output clocks</code></a> with <a href="#periodic"><code>periodic</code></a> or <a href="#strict"><code>strict</code></a> <a href="#periodic"><code>periodic</code></a> <a href="#inputClock"><code>input clocks</code></a> based on <a href="#triggeredBy"><code>triggeredBy</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>priority</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="#clock"><code>clocks</code></a> are ordered descending based on their priorities.
The priority of a <a href="#clock"><code>clock</code></a> has to be defined via the unsigned integer attribute <code>priority</code> - smaller values have a higher priority.
It is possible to define multiple <a href="#clock"><code>clocks</code></a> with the same priority.
No ordering is defined for <a href="#clock"><code>clocks</code></a> of the same priority.
If a computational order information is needed, different priorities have to be defined.</p>
<p class="tableblock"><em>[For <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> it is recommended to derive the priorities based on a rate monotonic scheduling scheme (smallest period leads to highest priority, that is, has the smallest priority value.]</em></p>
<p class="tableblock"><code>priority</code> is a required attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>periodic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="periodic"></a>
Clocks can be periodic or aperiodic.
If a <a href="#clock"><code>clock</code></a> is periodic, the attribute <code>periodic = true</code>.</p>
<p class="tableblock"><code>periodic</code> is an optional attribute.
The default value is <code>false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strict</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="strict"></a>
If a <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clock</code></a> is strictly periodic, the <code>strict</code> attribute is <code>true</code>.
If the optional attribute <code>strict</code> is set to <code>true</code>, then the FMU and the simulation algorithm have to respect the predefined interval and offset.
If the optional attribute <code>strict</code> is set to <code>false</code> another interval or offset can be used, derived from the current simulation setup.</p>
<p class="tableblock"><code>strict</code> is an optional attribute.
The default value is <code>false</code>.
The FMU exporter is not allowed to set <code>strict</code> to <code>true</code> if <code>periodic = false</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>intervalCounter</code>, <code>shiftCounter</code>, <code>resolution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval of <a href="#output"><code>output</code></a> or <a href="#input"><code>input</code></a> <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> is a rational number defined with unsignedLong valued <code>intervalCounter</code> and <code>resolution</code> attributes:</p>
<p class="tableblock"><code>interval = intervalCounter / resolution</code>.</p>
<p class="tableblock">The initial tick of <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> may be delayed by an offset.
The offset can be defined by the <code>unsignedLong</code> valued <code>shiftCounter</code> attribute (default value 0).</p>
<p class="tableblock">This results in the actual</p>
<p class="tableblock"><code>offset = shiftCounter / resolution</code>.</p>
<p class="tableblock">The time <code>t</code> of the <code>n`th activation of a periodic clock is therefore computed as</p>
<p class="tableblock">`t = (shiftCounter + n * intervalCounter) / resolution</code>.</p>
<p class="tableblock">More information about clock intervals:
 <a href="#periodic-clock-ticks">Section 2.2.7.7</a>.</p>
<p class="tableblock">The attributes <code>intervalCounter</code>, <code>shiftCounter</code> and <code>resolution</code> are interval <a href="#start"><code>start</code></a> values for <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> and must not be used together with <a href="#periodic">aperiodic</a> <a href="#clock"><code>clocks</code></a>.
If <code>strict = true</code> it is required to provide values for <code>intervalCounter</code> and <code>resolution</code>.</p>
<p class="tableblock"><code>intervalCounter</code> and <code>resolution</code> have no default value.</p></td>
</tr>
</tbody>
</table>
<div id="TypeDefinitions" class="imageblock text-center">
<div class="content">
<img src="images/schema/ClockType.png" alt="ClockType" width="55%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="definition-of-log-categories">2.4.5. Definition of Log Categories</h4>
<div class="paragraph">
<p>Element <code>&lt;fmiModelDescription&gt;&lt;LogCategories&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/LogCategories.png" alt="LogCategories" width="80%">
</div>
</div>
<div class="paragraph">
<p><code>&lt;LogCategories&gt;</code> defines an unordered set of category strings that can be utilized to define the log output via function <a href="#logMessage"><code>logMessage</code></a>, see <a href="#FMUStateSetable">Section 2.3.1</a>.
A tool is free to use any <code>normalizedString</code> for a category value.
The <code>name</code> attribute of <code>&lt;Category&gt;</code> must be unique with respect to all other elements of the <code>&lt;LogCategories&gt;</code> list.</p>
</div>
<div class="paragraph">
<p><a href="#table-standard-categories">Table 4</a> shows the standardized names for <code>&lt;Category&gt;</code>.
These names should be used if a tool supports the corresponding log category.
If a tool supports one of these log categories and wants to expose it, then an element <code>&lt;Category&gt;</code> with this name should be added to <code>&lt;LogCategories&gt;</code>.
<em>[To be clear, only the <code>&lt;Category&gt;</code> names listed under <code>&lt;LogCategories&gt;</code> in the XML file are known to the importer of the FMU.]</em></p>
</div>
<table id="table-standard-categories" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Standard names for <code>&lt;Category&gt;</code>.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logEvents</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log all events (during initialization and simulation).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logSingularLinearSystems</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log the solution of linear systems of equations if the solution is singular (and the tool picked one solution of the infinitely many solutions).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logNonlinearSystems</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log the solution of nonlinear systems of equations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logDynamicStateSelection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log the dynamic selection of <a href="#state"><code>states</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logStatusWarning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log messages when returning <a href="#fmi3Warning"><code>fmi3Warning</code></a> status from any function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logStatusDiscard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log messages when returning <a href="#fmi3Discard"><code>fmi3Discard</code></a> status from any function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logStatusError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log messages when returning <a href="#fmi3Error"><code>fmi3Error</code></a> status from any function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logStatusFatal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log messages when returning <a href="#fmi3Fatal"><code>fmi3Fatal</code></a> status from any function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logAll</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log all messages.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The optional attribute <code>description</code> shall contain a description of the respective log category.
<em>[Typically, this string can be shown by a tool if more details for a log category are presented.]</em></p>
</div>
<div class="paragraph">
<p><em>[This approach to define <code>&lt;LogCategories&gt;</code> has the following advantages:</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>A simulation environment can present the possible log categories in a menu and the user can select the desired one (in the FMI 1.0 approach, there was no easy way for a user to figure out from a given FMU what log categories could be provided).</em><br>
<em>Note that since element <code>&lt;LogCategories&gt;</code> is optional, an FMU does not need to expose its log categories.</em></p>
</li>
<li>
<p><em>The log output is drastically reduced, because via <a href="#fmi3SetDebugLogging"><code>fmi3SetDebugLogging</code></a> exactly the categories are set that shall be logged and therefore the FMU only has to print the messages with the corresponding categories to the <a href="#logMessage"><code>logMessage</code></a> function.</em>
<em>In FMI 1.0, it was necessary to provide all log output of the FMU to the <a href="#logMessage"><code>logMessage</code></a> and then a filter in the <a href="#logMessage"><code>logMessage</code></a> could select what to show to the end-user.</em>
<em>The approach introduced in FMI 2.0 is therefore much more efficient.]</em></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="DefaultExperiment">2.4.6. Definition of a Default Experiment</h4>
<div class="paragraph">
<p>Element <code>&lt;fmiModelDescription&gt;&lt;DefaultExperiment&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/DefaultExperiment.png" alt="DefaultExperiment" width="60%">
</div>
</div>
<div class="paragraph">
<p><code>&lt;DefaultExperiment&gt;</code> consists of the optional default start time, stop time, relative tolerance, and step size for the first simulation run.
A tool may ignore this information.
However, it is convenient for a user that <code>startTime</code>, <code>stopTime</code>, <code>tolerance</code> and <code>stepSize</code> have already a meaningful default value for the model at hand.
Furthermore, for Co-Simulation FMUs the <code>stepSize</code> defines the preferred <a href="#communicationStepSize"><code>communicationStepSize</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="fmiTerminalsAndIcons">2.4.7. Definition of Terminals and Icons</h4>
<div class="paragraph">
<p>This is the root element of the XML file <code>icons/terminalsAndIcons.xml</code>, and is defined as:</p>
</div>
<div id="terminals_and_icons_overview" class="imageblock text-center">
<div class="content">
<img src="images/schema/fmiTerminalsAndIcons.png" alt="fmiTerminalsAndIcons" width="60%">
</div>
<div class="title">Figure 17. Overview of fmiTerminalsAndIcons.</div>
</div>
<div class="paragraph">
<p>On the top level, the schema consists of the following elements (see <a href="#terminals_and_icons_overview">Figure 17</a>).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;GraphicalRepresentation&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If present, contains information for importers of FMUs to draw graphical representations of the FMU in a system view.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Terminals&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If present, this allows combining input and output signals into logical groups to ease connections on a system level.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="graphicalRepresentation">2.4.7.1. Definition of a Graphical Representation</h5>
<div class="sect5">
<h6 id="_overview_2">2.4.7.1.1. Overview</h6>
<div class="paragraph">
<p>The graphical representation of the FMU and terminals are needed in order to more easily comprehend the meaning of connected FMUs and to help an importing tool to display the terminals and the FMU icon in the way the exporter intended.</p>
</div>
<div class="paragraph">
<p>The graphical representation is fully optional.
The graphical representation of terminals is separate from the terminal definitions in the <code>&lt;Terminals&gt;</code> element.</p>
</div>
<div class="paragraph">
<p>There are two optional elements in the <code>&lt;GraphicalRepresentation&gt;</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>&lt;CoordinateSystem&gt;</code> defines the extent of the whole icon (graphical items may exceed that rectangle).</p>
</li>
<li>
<p>The <code>&lt;Icon&gt;</code> defines an image source for the FMU.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/GraphicalRepresentation.png" alt="GraphicalRepresentation" width="100%">
</div>
</div>
</div>
<div class="sect5">
<h6 id="_coordinatesystem">2.4.7.1.2. CoordinateSystem</h6>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/CoordinateSystem.png" alt="CoordinateSystem" width="70%">
</div>
</div>
<div class="paragraph">
<p>The <code>&lt;CoordinateSystem&gt;</code> element and its defined extent is used as reference for other graphical items.
It also provides a scaling factor to millimeter.</p>
</div>
<div class="paragraph">
<p>The coordinate system is defined by the coordinates of two points, the lower left (<code>x1</code>, <code>y1</code>) corner and the upper right (<code>x2</code>, <code>y2</code>) corner, where the coordinates of the first point shall be less than the coordinates of the second point <em>[a first quadrant coordinate system]</em>.
The x-axis is directed to the right, the y-axis is directed upwards.</p>
</div>
<div class="paragraph">
<p><em>[The exporting tool should define how the coordinate system unit relates to mm display or print out size.</em>
<em>However, an importing tool might choose to use the factor from the default coordinate system extent to the actual coordinate system extent to calculate a scaling factor, to match the default icon size in the importing tool.</em></p>
</div>
<div class="paragraph">
<p><em>The area defined by the coordinate system is suggested to be used as "clickable icon size" in other tools.</em>
<em>A <code>&lt;Terminal&gt;</code> might be placed outside of this area, so the visible bounding box has to be determined by the importing tool.]</em></p>
</div>
<div class="paragraph">
<p>The coordinate system default is <code>x1=-100, y1=-100, x2=100, y2=100</code>.
This extent is used if the <code>&lt;CoordinateSystem&gt;</code> element is missing.
The default <code>suggestedScalingFactorTo_mm</code> is 0.1.
So the default coordinate system display size should be 20 mm width and 20 mm height.</p>
</div>
<div class="paragraph">
<p>The FMU icon and all graphical representations provide the position and extent with the attributes <code>x1</code>, <code>y1</code>, <code>x2</code>, <code>y2</code>.
The values of these attributes directly relate to this coordinate system and are not normalized.
Flipping of the FMU icon or a terminal can be realized by setting its attributes <code>x2 &lt; x1</code> or <code>y2 &lt; y1</code> without changing the coordinate system.</p>
</div>
</div>
<div class="sect5">
<h6 id="_icon">2.4.7.1.3. Icon</h6>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/Icon.png" alt="Icon" width="40%">
</div>
</div>
<div class="paragraph">
<p>The extent and position of the FMU icon are defined in the <code>&lt;Icon&gt;</code> element.
The optional image file of the FMU icon is placed at the path <code>icons/icon.png</code> in the ZIP archive of the FMU.
The terminals should not be visible in the image.
Optionally an SVG file can be provided if also the PNG file is present.
This enables high quality rendering and printing in importing tools.
This SVG file has to be placed at the path <code>icons/icon.svg</code> in the ZIP archive.</p>
</div>
<div class="paragraph">
<p>The point (<code>x1</code>, <code>y1</code>) maps to the left lower corner of the PNG image or SVG viewport.
The point (<code>x2</code>, <code>y2</code>) maps to the right upper corner of the PNG image or SVG viewport.</p>
</div>
</div>
<div class="sect5">
<h6 id="_placement_extent_and_painting_order_of_graphical_items">2.4.7.1.4. Placement, Extent, and Painting Order of Graphical Items</h6>
<div class="imageblock text-center">
<div class="content">
<img src="images/GraphicalRepresentation.svg" alt="GraphicalRepresentation" width="70%">
</div>
</div>
<div class="paragraph">
<p>The clickable icon size is defined by the <code>&lt;CoordinateSystem&gt;</code> element.
The FMU icon itself may exceed this extent (or bounding box).
The bounding box of the terminals is given by the extent in the terminals element.
Their location is neither limited to the extent of the icon nor the extent of the coordinate system.
<em>[An importing tool has to determine the outer bounding box enclosing all graphical items.]</em></p>
</div>
<div class="paragraph">
<p>Transparent SVG or PNG files are allowed and wanted.
The order of the elements in the XML file defines the order of painting.
The first element in the <code>&lt;TerminalGraphicalRepresentation&gt;</code> is painted first and therefore behind the others, the last element is painted on top of the others and because of that in front of them.
<em>[So the FMU icon should be placed first in the XML file, terminal below.]</em></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_definition_of_terminals">2.4.7.2. Definition of Terminals</h5>
<div class="sect5">
<h6 id="_overview_3">2.4.7.2.1. Overview</h6>
<div class="paragraph">
<p>Terminals are fully optional and can be ignored by any importing tool.</p>
</div>
<div class="paragraph">
<p>Definition <code>&lt;Terminal&gt;</code>: A terminal is&#8230;&#8203;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a structured interface for connections to other models</p>
</li>
<li>
<p>intended to be used for signal flow between models, parameter propagation, and compatibility checks of the model configuration</p>
</li>
<li>
<p>a sequence of references to variables with connection meta data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Predefined rules for variable matching in a connection are given in <a href="#table-predefined-matching-rules">Table 5</a>.
Predefined variable kinds are used to describe how the member variables have to be handled.
Domain specific connection rules, terminals and their member variables can be provided by other standards.</p>
</div>
<div class="paragraph">
<p><em>[Co-simulation errors are not addressed by the terminals.</em>
<em>The co-simulation algorithm has to be chosen and implemented by the importing tool.</em>
<em>Features that might be required for specific co-simulation algorithms had to be implemented by the FMU exporting tool.</em></p>
</div>
<div class="paragraph">
<p><em>Algebraic loops in systems of connected Model Exchange FMUs are not addressed or resolved by the terminals.</em>
<em>It is not required that the <a href="#causality"><code>causality</code></a> of the terminal member variables in connected terminals match.</em></p>
</div>
<div class="paragraph">
<p><em>The SSP standard refers to a <code>connectorKind</code>.</em>
<em>This <code>connectorKind</code> is not related to the <code>terminalKind</code> or <code>variableKind</code> described in <a href="#section-terminals">Section 2.4.7.2.2</a> and <a href="#section-terminalvars">Section 2.4.7.2.3</a>.]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="section-terminals">2.4.7.2.2. Terminals</h6>
<div class="paragraph">
<p>Element <code>&lt;fmiTerminalsAndIcons&gt;&lt;Terminals&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/Terminals.png" alt="Terminals" width="80%">
</div>
</div>
<div class="paragraph">
<p>All instances of <code>&lt;Terminal&gt;</code> have the type <code>fmi3Terminal</code> and are listed in the <code>&lt;Terminals&gt;</code> sequence.</p>
</div>
<div class="paragraph">
<p>The normalized string attribute <code>name</code> of the <code>&lt;Terminal&gt;</code> element is the instance name of the terminal.
The terminal name must be unique on each level.</p>
</div>
<div class="paragraph">
<p>The normalized string attribute <code>matchingRule</code> describes the rules for variable matching in a connection.
As detailed in <a href="#table-predefined-matching-rules">Table 5</a>, there are three predefined matching rules: plug, bus, and sequence.
Other standards may define new matching rules.
In order to avoid ambiguities and conflicts, rule names must follow the reverse domain notation of a domain that is controlled by the entity defining the semantics and content of the additional entries.
The rule names beginning with <code>org.modelica</code> and <code>org.fmi-standard</code> are explicitly reserved for use by MAP FMI-defined layered standards.</p>
</div>
<div class="paragraph">
<p>There is a sequence of terminal member variables, terminal stream member variables, nested terminals, and an optional <code>&lt;TerminalGraphicalRepresentation&gt;</code> element in the <code>&lt;Terminal&gt;</code> element.
The member variables are the exchanged variables.
The type of the nested terminals is <code>fmi3Terminal</code>, and they can be used to implement structured terminals.</p>
</div>
<table id="table-predefined-matching-rules" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Predefined matching rules.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><code>matchingRule</code></th>
<th class="tableblock halign-left valign-top">Description

<a id="plug"></a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>plug</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Matching of the variables is based on <code>memberName</code>.
An importing tool should connect terminals only if all member variables are present and match.</p>
<p class="tableblock"><a id="bus"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bus</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Matching of the variables is based on <code>memberName</code>.
An importing tool may connect terminals if some or no terminal member variables are present.</p>
<p class="tableblock"><a id="sequence"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sequence</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Matching of the variables is based on the order of the terminal member variables.
An importing tool should connect terminals only if the number of member variables matches.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The normalized string <code>terminalKind</code> is an optional attribute.
Other standards may define terminal kinds.
It is intended that the <code>terminalKind</code> is used to define domain specific member variable sequences, member names and order, or high level restrictions for connections.</p>
</div>
<div class="paragraph">
<p><em>[Other terminal kinds should refer to the predefined <code>matchingRule</code>.</em>
<em>Vendor specific terminal kinds should start with <code>_vendorName</code> or <code>_toolName</code> to avoid namespace clashes.</em></p>
</div>
<div class="paragraph">
<p><em>Examples for <code>terminalKind</code>: <code>StandardXXX_Mechanical_Translational</code>, <code>Modelica.Mechanics.Translational.Interfaces.Flange_a</code>, <code>vendorNameA_customTypeA</code>, <code>_vendorNameB_customLibrary_customTypeB</code>.</em></p>
</div>
<div class="paragraph">
<p><em>The structured naming convention of the <code>&lt;ModelVariables&gt;</code> is independent from the terminal names and member variable names.</em></p>
</div>
<div class="paragraph">
<p><em>A tool may choose to connect terminals with a different or unknown <code>terminalKind</code>, if the <code>matchingRule</code> matches.]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="section-terminalvars">2.4.7.2.3. Terminal Member Variable</h6>
<div class="paragraph">
<p>The <code>&lt;TerminalMemberVariable&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/TerminalMemberVariable.png" alt="TerminalMemberVariable" width="70%">
</div>
</div>
<div class="paragraph">
<p>The normalized string <code>variableName</code> is used to identify the terminal member variable in the element <code>&lt;ModelVariables&gt;</code>.
The information about minimum, maximum, and nominal values is available in there.</p>
</div>
<div class="paragraph">
<p>One variable can be part of several terminals.</p>
</div>
<div class="paragraph">
<p>If the <code>matchingRule</code> <code>plug</code> and <code>bus</code> are used, then the normalized string <code>memberName</code> is used for member variable matching.
So the <code>memberName</code> attribute is required for <code>plug</code> and <code>bus</code> and it has to be unique for a terminal.
The <code>memberName</code> is not required for <code>matchingRule</code> <code>sequence</code>.</p>
</div>
<div class="paragraph">
<p>The normalized string <code>variableKind</code> is used to provide general information about the variable.
This information defines how the connection of this variable has to be implemented (e.g. Kirchhoff&#8217;s current law or common signal flow).</p>
</div>
<div class="paragraph">
<p>The predefined <code>variableKind</code> are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><code>variableKind</code></th>
<th class="tableblock halign-left valign-top">Description

<a id="signal"></a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>signal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The values in connected terminals are intended to be equal.
Restricted to <a href="#input"><code>input</code></a> and <a href="#output"><code>output</code></a>, <a href="#parameter"><code>parameter</code></a> and <a href="#calculatedParameter"><code>calculatedParameter</code></a>.
<em>[Example: Signal flow, parameter propagation, equality checks]</em></p>
<p class="tableblock"><a id="inoutflow"></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>inflow</code> / <code>outflow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variables which fulfill Kirchhoff&#8217;s current law.
Restricted to <a href="#input"><code>input</code></a> and <a href="#output"><code>output</code></a>, <a href="#parameter"><code>parameter</code></a> and <a href="#calculatedParameter"><code>calculatedParameter</code></a>.
<em>[Example: Electric current]</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[The suggested variable naming scheme for the structured naming convention is &lt;ModelVariable name&gt; = &lt;terminalName&gt;.&lt;memberName&gt;.</em></p>
</div>
<div class="paragraph">
<p><em>Not all <code>&lt;ModelVariables&gt;</code> which have the prefix "&lt;terminalName&gt;." are a member variable, and there may exist member variables which don&#8217;t have this prefix.</em></p>
</div>
<div class="paragraph">
<p><em>Example 1 (suggested scheme): &lt;ModelVariable name&gt; is <code>portA.U</code>, &lt;terminalName&gt; is <code>portA</code>, &lt;memberName&gt; is <code>U</code>.</em></p>
</div>
<div class="paragraph">
<p><em>Example 2 (suggested scheme): &lt;ModelVariable name&gt; is <code>hierarchConn.innerConn.U</code>, &lt;outer terminal name&gt; is <code>hierarchConn</code>, &lt;inner terminal name&gt; is <code>innerConn</code>, &lt;memberName&gt; is <code>U</code>.</em></p>
</div>
<div class="paragraph">
<p><em>Example 3 (no prefix): &lt;ModelVariable name&gt; is <code>u</code>, &lt;terminalName&gt; is <code>portA</code>, &lt;memberName&gt; is <code>u</code>.</em></p>
</div>
<div class="paragraph">
<p><em>Example 4 (prefix but not a member): &lt;ModelVariable name&gt; is <code>portA.u</code>, there is a terminal with &lt;terminalName&gt; <code>portA</code>, but this variable is not a terminal member.</em></p>
</div>
<div class="paragraph">
<p><em>The suggested variable naming scheme for the non-structured naming convention is: &lt;ModelVariable name&gt; = &lt;memberName&gt;</em></p>
</div>
<div class="paragraph">
<p><em>Matching is not restricted by <a href="#variability"><code>variability</code></a>, <a href="#causality"><code>causality</code></a> or variable type.</em>
<em>Example: A <a href="#fixed"><code>fixed</code></a> variable may be connected to a <a href="#tunable"><code>tunable</code></a> variable, a variable of type <code>fmi3Float64</code> may be connected to a variable of type <code>fmi3Int32</code>.</em>
<em>However, it is recommended that the variable types and variabilities are equal.</em></p>
</div>
<div class="paragraph">
<p><em>The <code>matchingRule</code> refers to the <code>&lt;TerminalMemberVariable&gt;</code> on the same level only.</em>
<em>Nested terminals can have different `matchingRule`s.</em></p>
</div>
<div class="paragraph">
<p><em>There is no special handling of <a href="#derivative"><code>derivatives</code></a>.</em>
<em>If a <a href="#derivative"><code>derivative</code></a> is a terminal member variable then it is considered as normal member variable.</em>
<em>However, if a <a href="#derivative"><code>derivative</code></a> of a terminal member variable is not terminal member, then this <a href="#derivative"><code>derivative</code></a> information may be used by an importing tool.]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="_terminal_stream_member_variable">2.4.7.2.4. Terminal Stream Member Variable</h6>
<div class="paragraph">
<p>The <code>&lt;TerminalStreamMemberVariable&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/TerminalStreamMemberVariable.png" alt="TerminalStreamMemberVariable" width="80%">
</div>
</div>
<div class="paragraph">
<p>This element is used for variables which fulfill the balance equation for transported quantities.
It is restricted to <a href="#input"><code>input</code></a> and <a href="#output"><code>output</code></a>, <a href="#parameter"><code>parameter</code></a> and <a href="#calculatedParameter"><code>calculatedParameter</code></a>.</p>
</div>
<div class="paragraph">
<p>The Stream concept is described in the appendix D.3 of the Modelica specification.
Only one terminal member variable with the <code>variableKind</code> <code>inflow</code> or <code>outflow</code> per terminal is allowed, if a <code>&lt;TerminalStreamMemberVariable&gt;</code> is present.
<em>[More sophisticated structures can be implemented using hierarchical terminals.]</em></p>
</div>
<div class="paragraph">
<p>The attribute <code>inStreamVariableName</code> and <code>outStreamVariableName</code> are used to identify the <code>&lt;ModelVariables&gt;</code>.
If the referenced model variables are arrays, then the size of the <code>inStreamVariableName</code> and <code>outStreamVariableName</code> has to be equal.
A terminal may have more than one <code>&lt;TerminalStreamMemberVariable&gt;</code>.
The <code>inStreamMemberName</code> and <code>outStreamMemberName</code> describe the terminal member name for matching purposes, similar to the <code>memberName</code> attribute in the <code>&lt;TerminalMemberVariable&gt;</code>.</p>
</div>
<div class="paragraph">
<p><em>[An example of use for an array of stream variables is a gas mixture flow.</em>
<em>The gas composition could be implemented as a mass fraction vector.</em>
<em>The <code>outStreamVariableName</code> refers to</em> \(portA.q_\textit{outStream}\textit{[]}\) <em>and the <code>inStreamVariableName</code> refers to</em>  \(portA.q_\textit{inStream}\textit{[]}\) <em>.</em>
<em>The <code>inStreamMemberName</code> and <code>outStreamMemberName</code> are "</em> \(q_\textit{inStream}\textit{[]}\) <em>" and "</em> \(q_\textit{outStream}\textit{[]}\) <em>".</em></p>
</div>
<div class="paragraph">
<p><em>Balance equation for transported quantities:</em></p>
</div>
<div class="paragraph">
<p><em>\(0 = \sum{q_i\dot{m}_i}\)</em></p>
</div>
<div class="paragraph">
<p><em>\(0 = \sum{\dot{m}_i}\cdot
\left\{\begin{array}{ll}
q_{i, \mathit{outStream}} &amp;\textit{if $\dot{m}$ is outflowing through terminal $i$}\\
q_{i, \mathit{inStream}} &amp;\textit{if $\dot{m}$ is inflowing through terminal $i$}
\end{array}\right.\)</em></p>
</div>
<div class="paragraph">
<p><em>The</em> \(q_{i,\mathit{outStream}}\) <em>is the convective quantity in case the matter flows out of the FMU.</em>
\(q_{i,\mathit{inStream}}\) <em>is the convective quantity in case the matter flows into the FMU.</em>
<em>Both variables are present in the terminal.</em>
<em>The outStream variable has the <a href="#causality"><code>causality</code></a> <a href="#output"><code>output</code></a> or <a href="#calculatedParameter"><code>calculatedParameter</code></a> because this information has to be provided by each FMU.</em>
<em>The inStream variable has the <a href="#causality"><code>causality</code></a> <a href="#input"><code>input</code></a> or <a href="#parameter"><code>parameter</code></a>.</em>
<em>To display the actual value in an importing tool, this actual value has to be selected depending on the sign of the terminal member variable with <code>variableKind</code> <code>inflow</code> or <code>outflow</code>.</em>
<em>However, calculating the actual value is not necessary.</em></p>
</div>
<div class="paragraph">
<p><em>If only two terminals with a variable are connected and their <a href="#causality"><code>causality</code></a> matches, then the values of the outStream variables can be forwarded to the corresponding inStream values.</em></p>
</div>
<div class="paragraph">
<p><em>In Modelica the inStream variable is not directly visible, the value can only be accessed using "inStream()", therefore an additional model variable has to be added during the export.</em>
<em>It is suggested that Modelica tools exporting an FMU derive the member name for the inStream variable according to the scheme "&lt;outStream name&gt;_inStream".</em>
<em>E.g. if the outStream name is "h_outflow" then the inStream name should be "h_outflow_inStream".]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="_terminal_graphical_representation">2.4.7.2.5. Terminal Graphical Representation</h6>
<div class="paragraph">
<p>The <code>&lt;TerminalGraphicalRepresentation&gt;</code> is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/TerminalGraphicalRepresentation.png" alt="TerminalGraphicalRepresentation" width="75%">
</div>
</div>
<div class="paragraph">
<p>The <code>iconBaseName</code> attribute is mandatory.
This attribute defines the base name of the image file as a relative URI according to RFC 3986.
The base URI that this relative URI is resolved against is the URI of the <code>icons/terminalsAndIcons.xml</code> file in the FMU ZIP archive.
Implementations are required to support relative URIs, excluding relative URIs that move beyond the baseURI (i.e. go "up" a level via ..).
Implementations are not required to support any absolute URIs and any specific URI schemes.
The PNG file with the extension '.png' has to be provided.
An additional SVG file with extension '.svg' is optional.</p>
</div>
<div class="paragraph">
<p><em>[Note that this specification is functionally equivalent to looking up image sources from the icons folder of the FMU ZIP archive after dot removal from the path as per section 5.2.4 of RFC 3986.]</em></p>
</div>
<div class="paragraph">
<p>The <code>defaultConnectionStrokeSize</code> and <code>defaultConnectionColor</code> can be provided to define the intended connection line layout in the importing tool.
The stroke size is given relative to the coordinate system extent.
The stroke color is given in RGB values from 0 to 255. E.g.: <code>255 255 0</code>.</p>
</div>
<div class="paragraph">
<p><em>[Nested terminals may have a <code>&lt;TerminalGraphicalRepresentation&gt;</code> element.</em>
<em>However, if and how nested terminals are displayed, is up to the importing tool.]</em></p>
</div>
<div class="paragraph">
<p><em>[The order of painting of the <code>&lt;TerminalGraphicalRepresentation&gt;</code> of terminals on each level is equal to the order of appearance in the <code>&lt;Terminal&gt;</code> element.</em>
<em>So graphical representations appearing first, are painted first, are behind graphical representations which appear below.]</em></p>
</div>
<div class="paragraph">
<p>The <code>Annotations</code> element can be used by vendors to store additional information for the graphical representation.
<em>[It is suggested that Modelica tools store the Modelica annotation of the connector under the <code>type</code> <code>org.modelica.Modelica4Annotation</code> in the annotations of an element <code>connector</code>.</em>
<em>The attribute <code>name</code> of the connector element is equal to the <code>name</code> attribute of the referenced <code>fmi3Terminal</code>.]</em></p>
</div>
<div class="paragraph">
<p><em>[If the graphical representation is used for an <a href="#input"><code>input</code></a> or <a href="#output"><code>output</code></a> (e.g. a <code>fmi3Float64</code> <a href="#input"><code>input</code></a> <code>u</code>), then a <code>&lt;Terminal&gt;</code> has to be added to the <code>&lt;Terminals&gt;</code> element which has one <code>&lt;TerminalMemberVariable&gt;</code>.]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="GeneralRemarkOnSignal">2.4.7.2.6. General Remark on Signal</h6>
<div class="paragraph">
<p><em>[The signal <code>variableKind</code> can be applied for different use cases.</em>
<em>The first use case is a signal flow from an <a href="#output"><code>output</code></a> of one FMU to an <a href="#input"><code>input</code></a> of another FMU.</em>
<em>The <a href="#output"><code>output</code></a> value has to be forwarded to the <a href="#input"><code>input</code></a>.</em></p>
</div>
<div class="paragraph">
<p><em>The signal flow can cause algebraic loops.</em>
<em>If variables in connected terminals have the <a href="#causality"><code>causality</code></a> <a href="#output"><code>output</code></a>, then an importing tool may iterate an undefined <a href="#input"><code>input</code></a> of an FMU to ensure that the connected output values are equal.</em></p>
</div>
<div class="paragraph">
<p><em>Another use case is the parameter propagation.</em>
<em>If a variable in both connected terminals has the <a href="#causality"><code>causality</code></a> <a href="#parameter"><code>parameter</code></a>, then an importing tool could ask the user for the value of one of those <a href="#parameter"><code>parameters</code></a> only, and propagate this value to the other FMU.</em>
<em>If only one of the variables has <a href="#causality"><code>causality</code></a> <a href="#parameter"><code>parameter</code></a>, and the other is a <a href="#constant"><code>constant</code></a> <a href="#output"><code>output</code></a> or <a href="#calculatedParameter"><code>calculatedParameter</code></a>, then the importing tool could also propagate the <a href="#parameter"><code>parameter</code></a> value without presenting a parameter to the user.</em>
<em>One example of use would be the name of a substance flowing through a pipe.</em>
<em>If the fluid flows from one pipe FMU to another, the substance should be the same.</em>
<em>This substance name could be propagated over several FMUs.</em></p>
</div>
<div class="paragraph">
<p><em>Finally the <code>variableKind</code> <code>signal</code> can be applied to implement compatibility checks.</em>
<em>If for example the <a href="#variability"><code>variability</code></a> of the variables in connected terminals are <a href="#constant"><code>constant</code></a>, then the importing tool can implement an equality assertion.</em>
<em>This is also possible with <a href="#calculated"><code>calculated</code></a> <a href="#parameter"><code>parameters</code></a>.</em>
<em>One example of use would be the cross sectional flow area in pipes which is calculated from geometry parameters.</em>
<em>A change in the cross sectional flow area is relevant for the momentum equation, and therefore the connection has to be deemed incompatible if these variables are present and unequal.]</em></p>
</div>
</div>
<div class="sect5">
<h6 id="_general_remark_on_inflow_and_outflow">2.4.7.2.7. General Remark on Inflow and Outflow</h6>
<div class="paragraph">
<p><em>[Flow variables have a direction and must fulfill a zero sum constraint i.e. the sum of all flow variables connected together must be zero (Kirchhoff&#8217;s current law).</em>
<em>In addition because different tools might have different direction definitions both, <code>inflow</code> and <code>outflow</code> are available as <code>variableKind</code>.</em>
<em>For variables with <code>inflow</code> a positive value means that the flow is inwards, and for <code>outflow</code> a positive value means that the flow is outwards.</em>
<em>For the sake of simplicity in the following \(\dot{m}_i\) denotes an inflowing quantity:</em></p>
</div>
<div class="paragraph">
<p><em>\(0 = \sum{\dot{m}_i}\)</em></p>
</div>
<div class="paragraph">
<p><em>[Connecting a single <a href="#output"><code>output</code></a> <code>outflow</code> to a single <a href="#input"><code>input</code></a> <code>inflow</code>, or vice versa automatically fulfills the flow constraint, while connecting two single signals of the same flow type requires a negation of the signal.</em></p>
</div>
<div class="paragraph">
<p><code>inflow</code> <em>and</em> <code>outflow</code> <em>is only used as a sign convention for scalar flow quantities which obey Kirchhoff&#8217;s current law (sum up to zero).</em>
<em>Other, nonscalar, quantities which also sum up to zero, like a mechanical force in 3D space according to D&#8217;Alembert&#8217;s principle, are not covered by this sign convention.</em>
<em>This is the case since Kirchhoff&#8217;s current law only holds for scalars where a sign convention is sufficient.</em>
<em>Other definitions are beyond the scope of this terminal specification and need clear definition in other specifications on top of this.]</em></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="definition-of-model-variables">2.4.8. Definition of Model Variables</h4>
<div class="paragraph">
<p>The element of <code>&lt;fmiModelDescription&gt;&lt;ModelVariables&gt;</code> is the central part of the model description.
It provides the static information of all exposed variables and is defined as follows.</p>
</div>
<div id="figure-schema-ModelVariables" class="imageblock text-center">
<div class="content">
<img src="images/schema/ModelVariables.png" alt="ModelVariables" width="60%">
</div>
<div class="title">Figure 18. ModelVariables element.</div>
</div>
<div class="paragraph">
<p>The <code>&lt;ModelVariables&gt;</code> element consists of an ordered set of variable elements (see <a href="#figure-schema-ModelVariables">Figure 18</a>).
Variable elements can uniformly represent variables of primitive (atomic) types, like single floating point or integer variables, or as well as arrays of an arbitrary (but fixed) number of dimensions.
The schema definition is present in a separate file <code>fmi3Variable.xsd</code>.</p>
</div>
<div class="paragraph">
<p>Variable elements representing array variables must contain at least one <code>&lt;Dimension&gt;</code> element.
Each <code>&lt;Dimension&gt;</code> element specifies the size of one dimension of the array:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <a href="#start"><code>start</code></a> attribute of the <code>&lt;Dimension&gt;</code> element is present, it defines a constant unsigned 64-bit integer size for this dimension.
The <a href="#variability"><code>variability</code></a> of the dimension size is <a href="#constant"><code>constant</code></a> in this case.</p>
</li>
<li>
<p>If the <a href="#valueReference"><code>valueReference</code></a> attribute of the <code>&lt;Dimension&gt;</code> element is present, it defines the size of this dimension to be the value of the variable with the value reference given by the <a href="#valueReference"><code>valueReference</code></a> attribute.
The referenced variable must be a variable of type <code>&lt;UInt64&gt;</code>, and must either be a constant (i.e. with <a href="#variability"><code>variability</code></a> = <a href="#constant"><code>constant</code></a>) or a <a href="#structuralParameter"><code>structural parameter</code></a>(i.e. with <a href="#causality"><code>causality</code></a> = <a href="#structuralParameter"><code>structuralParameter</code></a>).
The <a href="#variability"><code>variability</code></a> of the dimension size is in this case the <a href="#variability"><code>variability</code></a> of the referenced variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These two options are mutually exclusive, i.e. for each <code>&lt;Dimension&gt;</code> element either a <a href="#start"><code>start</code></a> attribute or an <a href="#valueReference"><code>valueReference</code></a> attribute can be supplied, but not both.
However different dimension sizes can be specified using different mechanisms and can have differing <a href="#variability"><code>variability</code></a> attributes.</p>
</div>
<div class="paragraph">
<p>All initial dimension sizes (i.e. prior to any configuration or reconfiguration) must be positive integers (i.e. not zero), so that no dimension is initially vanished.</p>
</div>
<div class="paragraph">
<p><em>[This allows importing tools to ignore <a href="#structuralParameter"><code>structural parameters</code></a> because that <a href="#start"><code>start</code></a> value reflects the internal default setting of that <a href="#structuralParameter"><code>structural parameter</code></a>.</em>
<em>The rationale for requiring positive start values for <a href="#structuralParameter"><code>structural parameters</code></a> is that this avoids importers having to deal with vanishing dimensions if they do not want to deal with them (or even with changing sizes at all).</em>
<em>If we allowed 0 dimension sizes for initial values, tools that do not even care about changing dimension sizes must be prepared to handle vanishing dimensions.]</em></p>
</div>
<div class="paragraph">
<p>Changes to dimension sizes are constrained by the <code>min</code>/<code>max</code> attributes of the referenced <a href="#structuralParameter"><code>structural parameters</code></a>, which can be any non-negative integer, including zero.
Specifying a minimum size of zero on a <a href="#structuralParameter"><code>structural parameter</code></a> allows any related dimension sizes to be changed to zero in <strong>Configuration Mode</strong> or <strong>Reconfiguration Mode</strong>, thus causing the respective array size to go to zero, which leaves the respective array variable without any active elements.</p>
</div>
<div class="paragraph">
<p>The actual dimension sizes of arrays are also constrained by the FMU platform, due to memory and addressing constraints:
Since the API functions to access variables and their values are constrained to <code>size_t</code> individual elements, platforms with addresses of less than 64-bit width will not be able to access elements beyond their addressing limits, neither will they be able to allocate enough memory or address space to represent such arrays.
For these reasons implementations must take platform-specific constraints into account when changing dimension sizes, and must be prepared to handle the inability of the FMU to adjust to the desired sizes during <strong>Configuration Mode</strong> or <strong>Reconfiguration Mode</strong>.</p>
</div>
<div class="paragraph">
<p>Changing any dimension of a variable in <strong>Configuration Mode</strong> or <strong>Reconfiguration Mode</strong> invalidates the variable&#8217;s current value (including its <a href="#start"><code>start</code></a> value).
It should be noted that changing a <a href="#structuralParameter"><code>structural parameter</code></a> might affect dimension sizes of several variables.</p>
</div>
<div id="alias" class="paragraph">
<p>A variable can have any number of <code>&lt;Alias&gt;</code> elements that define a variable alias.
Each variable alias has a required attribute <code>name</code> whose value must be unique among all variables and variable aliases, and an optional attribute <code>description</code>.
Variable aliases of floating point variables may additionally have a <a href="#displayUnit"><code>displayUnit</code></a> that follows the same rules as for variables.</p>
</div>
<div class="paragraph">
<p><em>[ Example:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs"> &lt;Float64 name="engine.torque" valueReference="1" unit="N.m"&gt;
   &lt;Alias name="engine.torqueLbfFt" description="Engine torque in pound-foot"
     displayUnit="lbf.ft"/&gt;
 &lt;/Float64&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>The attributes of variables are:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/fmi3VariableBase.png" alt="fmi3VariableBase" width="80%">
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The full, unique name of the variable.
Every variable is uniquely identified within an FMU instance by this name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>valueReference</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="valueReference" class="paragraph">
<p>A handle of the variable to efficiently identify the variable value in the model interface and for references within the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.
This handle is a secret of the tool that generated the C functions.
It is required to be unique for an FMU.
This attribute is <code>required</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>An optional description string describing the meaning of the variable.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>causality</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="causality" class="paragraph">
<p>Enumeration that defines the causality of the variable.
Allowed values of this enumeration:</p>
</div>
<div id="parameter" class="paragraph">
<p><code>= parameter</code>: A data value that is constant during the simulation (except for <a href="#tunable"><code>tunable</code></a> parameters, see there) and is provided by the environment and cannot be used in connections, except for parameter propagation in terminals as described in <a href="#GeneralRemarkOnSignal">Section 2.4.7.2.6</a>.
<a href="#variability"><code>variability</code></a> must be <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a>.
These parameters can be changed independently, unlike <a href="#calculatedParameter">calculated parameters</a>.
<a href="#initial"><code>initial</code></a> must be <a href="#exact"><code>exact</code></a> or not present (meaning <a href="#exact"><code>exact</code></a>).</p>
</div>
<div id="calculatedParameter" class="paragraph">
<p><code>= calculatedParameter</code>: A data value that is constant during the simulation and is computed during initialization or when <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> change.
<a href="#variability"><code>variability</code></a> must be <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a>.
<a href="#initial"><code>initial</code></a> must be <a href="#approx"><code>approx</code></a>, <a href="#calculated"><code>calculated</code></a> or not present (meaning <a href="#calculated"><code>calculated</code></a>).</p>
</div>
<div id="input" class="paragraph">
<p><code>= input</code>: The variable value can be provided from another FMU.<br>
<a id="inputClock"></a> If <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a> the variable defines an <a href="#inputClock"><code>input clock</code></a> that is controlled by the importer.
An <a href="#inputClock"><code>input clock</code></a> can be left unconnected, can be connected to an <a href="#outputClock"><code>output clock</code></a>, or the importer generates the clock signal.</p>
</div>
<div id="output" class="paragraph">
<p><code>= output</code>: The variable value can be used by another FMU.
The algebraic relationship to the <a href="#input"><code>inputs</code></a> is defined via the <a href="#dependencies"><code>dependencies</code></a> attribute of <code>&lt;fmiModelDescription&gt;&lt;ModelStructure&gt;&lt;Output&gt;</code>.<br>
<a id="outputClock"></a> If <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a> the variable defines an <a href="#outputClock"><code>output clock</code></a> that is controlled by the FMU.
An <a href="#outputClock"><code>output clock</code></a> can be left unconnected or can be connected to an <a href="#inputClock"><code>input clock</code></a>, usually of another FMU (for exceptions see <a href="#triggeredBy"><code>triggeredBy</code></a>).</p>
</div>
<div id="local" class="paragraph">
<p><code>= local</code>: Local variables are:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>continuous-time <a href="#state"><code>states</code></a> and their <code>Derivative</code>s, <code>ClockedState</code>s, <code>EventIndicator</code>s or <code>InitialUnknown</code>s.
These variables are listed in the <code>&lt;fmiModelDescription&gt;&lt;ModelStructure&gt;</code>.<br></p>
</li>
<li>
<p><a id="localClock"></a> internal, intermediate variables or local clocks which can be read for debugging purposes and are not listed in the <code>&lt;fmiModelDescription&gt;&lt;ModelStructure&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Setting of local variables:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In <strong>Initialization Mode</strong> and before, local variables need to be set if they do have start values or are listed as <code>InitialUnknown</code>.</p>
</li>
<li>
<p>In super state <strong>Initialized</strong>, <code>fmi3Set{VariableType}</code> must not be called on any of the local variables.
Only in Model Exchange, continuous <a href="#state"><code>states</code></a> can be set with <a href="#fmi3SetContinuousStates"><code>fmi3SetContinuousStates</code></a>.
Local variable values must not be used as input to another model or FMU.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[Continuous-time <a href="#state"><code>states</code></a> and their <code>Derivative</code>s, <code>ClockedState</code>s, <code>EventIndicator</code>s or <code>InitialUnknown</code>s are listed as local variables to give them properties like name and unit for debugging purposes and a value reference to be listed in &lt;fmiModelDescription&gt;&lt;ModelStructure&gt;.]</em></p>
</div>
<div class="paragraph">
<p><em>[TODO: add ClockedState elements to ModelStructure.]</em>
<em>[TODO: rename Derivative to StateDerivative to differentiate between derivatives of states and general derivatives of any other variable.]</em></p>
</div>
<div id="independent" class="paragraph">
<p><code>= independent</code>: The independent variable (usually <code>time</code> <em>[but could also be, for example, <code>angle</code>]</em>).
All variables are a function of this <a href="#independent"><code>independent</code></a> variable.
<a href="#variability"><code>variability</code></a> must be <a href="#continuous"><code>continuous</code></a>.
Exactly one variable of an FMU must be defined as <a href="#independent"><code>independent</code></a>.
If the unit for the independent variable is not defined, it is implicitely`unit = s`.
If one variable is defined as <a href="#independent"><code>independent</code></a>, it must be defined with a floating point type without a <a href="#start"><code>start</code></a> attribute.
It is not allowed to call function <code>fmi3Set{VariableType}</code> on an <a href="#independent"><code>independent</code></a> variable.
Instead, its value is initialized with <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a> and after initialization set by <a href="#fmi3SetTime"><code>fmi3SetTime</code></a> for Model Exchange and by arguments <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> and <a href="#communicationStepSize"><code>communicationStepSize</code></a> of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> for Co-Simulation FMUs.
<em>[The actual value can be inquired with <code>fmi3Get{VariableType}</code>.]</em></p>
</div>
<div id="structuralParameter" class="paragraph">
<p><code>= structuralParameter</code>: parameter (a data value that is constant during the simulation and is provided by the environment and cannot be used in connections).
<a href="#variability"><code>variability</code></a> must be <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a>.
<a href="#initial"><code>initial</code></a> must be <a href="#exact"><code>exact</code></a> or not present (meaning <a href="#exact"><code>exact</code></a>).
This <a href="#causality"><code>causality</code></a> requires the variable not to have a <code>&lt;Dimension&gt;</code> element.</p>
</div>
<div class="paragraph">
<p><em>[</em>
<em>Example:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">   &lt;UInt64 name="spD"      valueReference= "100"
     description="Dimension" causality="structuralParameter"
     variability="fixed" start="7"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p><a href="#structuralParameter"><code>structural parameters</code></a> that are referenced in <code>&lt;Dimension&gt;</code> elements may have a <code>min</code> attribute with 0 but the <a href="#start"><code>start</code></a> attribute, which is mandatory for <a href="#structuralParameter"><code>structural parameters</code></a>, must have a value larger than 0 for <a href="#structuralParameter"><code>structural parameters</code></a> used in <code>&lt;Dimension&gt;</code> elements.</p>
</div>
<div class="paragraph">
<p>The default of <a href="#causality"><code>causality</code></a> is <a href="#local"><code>local</code></a>.<br>
A continuous-time <a href="#state"><code>state</code></a> or a event indicator must have <a href="#causality"><code>causality</code></a> = <a href="#local"><code>local</code></a> or <a href="#output"><code>output</code></a>, see also <a href="#ModelStructure">Section 2.4.9</a>.</p>
</div>
<div class="paragraph">
<p><em>[<a href="#causality"><code>causality</code></a> = <a href="#calculatedParameter"><code>calculatedParameter</code></a> and <a href="#causality"><code>causality</code></a> = <a href="#local"><code>local</code></a> with <a href="#variability"><code>variability</code></a> = <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> are similar.</em>
<em>The difference is that a <a href="#calculatedParameter"><code>calculatedParameter</code></a> can be used in another model or FMU, whereas a <a href="#local"><code>local</code></a> variable cannot.</em>
<em>For example, when importing an FMU in a Modelica environment, a <a href="#calculatedParameter"><code>calculatedParameter</code></a> should be imported in a <code>public</code> section as <code>final parameter</code>, whereas a <a href="#local"><code>local</code></a> variable should be imported in a <code>protected</code> section of the model.]</em></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>variability</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="variability" class="paragraph">
<p>Enumeration that defines the time dependency of the variable, in other words, it defines the time instants when a variable can change its value.
<em>[The purpose of this attribute is to define when a result value needs to be inquired and to be stored.</em>
<em>For example, <a href="#discrete"><code>discrete</code></a> variables change their values only at event instants (ME) or at a communication point (CS and SE) and it is therefore only necessary to inquire them with <code>fmi3Get{VariableType}</code> and store them at event times.]</em>
Allowed values of this enumeration:</p>
</div>
<div id="constant" class="paragraph">
<p><code>= constant</code>: The value of the variable never changes.</p>
</div>
<div id="fixed" class="paragraph">
<p><code>= fixed</code>: The value of the variable is fixed after initialization, in other words, after <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> was called the variable value does not change anymore.</p>
</div>
<div id="tunable" class="paragraph">
<p><code>= tunable</code>: The value of the variable is constant between events (ME) and between communication points (CS and SE) due to changing variables with <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>.
Whenever a <a href="#parameter"><code>parameter</code></a> with <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a> changes, an event is triggered externally (ME or CS if events are supported), or the change is performed at the next communication point (CS and SE) and the variables with <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a> and <a href="#causality"><code>causality</code></a> = <a href="#calculatedParameter"><code>calculatedParameter</code></a> or <a href="#output"><code>output</code></a> must be newly computed.
<em>[<a href="#tunable"><code>tunable</code></a> <a href="#input">inputs</a> are not allowed, see <a href="#table-allowed-variability-causality-combinations">Table 7</a>.]</em></p>
</div>
<div id="discrete" class="paragraph">
<p><code>= discrete</code>:<br>
Model Exchange: The value of the variable is constant between external and internal events (= <a href="#time-event"><code>time</code></a>, <a href="#state-event"><code>state</code></a>, <a href="#step-event"><code>step events</code></a> defined implicitly in the FMU).<br>
Co-Simulation: By convention, the variable is from a real sampled data system and its value is only changed at communication points (including event handling).
During <a href="#intermediateUpdate"><code>intermediateUpdate</code></a>, <a href="#discrete"><code>discrete</code></a> variables are not allowed to change.
<em>[If the simulation algorithm notices a change in a discrete variable during <a href="#intermediateUpdate"><code>intermediateUpdate</code></a>, the simulation algorithm will delay the change, raise an event with <a href="#earlyReturnRequested"><code>earlyReturnRequested == fmi3True</code></a> and during the communication point it can change the <a href="#discrete"><code>discrete</code></a> variable, followed by event handling.]</em></p>
</div>
<div id="continuous" class="paragraph">
<p><code>= continuous</code>: Only a variable of <code>type == fmi3GetFloat32</code> or <code>type == fmi3GetFloat64</code> can be <a href="#continuous"><code>continuous</code></a>.<br>
Model Exchange: No restrictions on value changes (see <a href="#smoothness">Section 4.1.3</a>).</p>
</div>
<div id="clock" class="paragraph">
<p><code>= clock</code>: Only a variable of type <code>&lt;Clock&gt;</code> can have this variability.</p>
</div>
<div class="paragraph">
<p>The default is <a href="#continuous"><code>continuous</code></a> for variables of type <code>&lt;Float32&gt;</code> and <code>&lt;Float64&gt;</code>, and <a href="#discrete"><code>discrete</code></a> for all other types.</p>
</div>
<div class="paragraph">
<p><em>[Note that the information about continuous <a href="#state"><code>states</code></a> is defined with elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>.]</em></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initial</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="initial" class="paragraph">
<p>Enumeration that defines how the variable is initialized.
It is not allowed to provide a value for <a href="#initial"><code>initial</code></a> if <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a> or <a href="#independent"><code>independent</code></a>:</p>
</div>
<div id="exact" class="paragraph">
<p><code>= exact</code>: The variable is initialized with the <a href="#start"><code>start</code></a> value (provided under the variable type element).</p>
</div>
<div id="approx" class="paragraph">
<p><code>= approx</code>: The <a href="#start"><code>start</code></a> value provides an approximation that may be modified during initialization, e.g., if the FMU is part of an algebraic loop where the variable might be an iteration variable and <a href="#start"><code>start</code></a> value is taken as initial value for an iterative solution process.</p>
</div>
<div id="calculated" class="paragraph">
<p><code>= calculated</code>: The variable is calculated from other variables during initialization.
It is not allowed to provide a <a href="#start"><code>start</code></a> value.</p>
</div>
<div class="paragraph">
<p>If <a href="#initial"><code>initial</code></a> is not present, it is defined by <a href="#table-definition-initial">Table 6</a> based on <a href="#causality"><code>causality</code></a> and <a href="#variability"><code>variability</code></a>.
If <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> or <a href="#approx"><code>approx</code></a>, or <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, a <a href="#start"><code>start</code></a> value must be provided.
If <a href="#initial"><code>initial</code></a> = <a href="#calculated"><code>calculated</code></a>, or <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a>, it is not allowed to provide a <a href="#start"><code>start</code></a> value.</p>
</div>
<div class="paragraph">
<p><em>[The environment decides when to use the <a href="#start"><code>start</code></a> value of a variable with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>.
Examples: (a) automatic tests of FMUs are performed, and the FMU is tested by providing the <a href="#start"><code>start</code></a> value as <a href="#constant"><code>constant</code></a> <a href="#input"><code>input</code></a>.
(b) For a Model Exchange FMU, the FMU might be part of an algebraic loop.
If the <a href="#input"><code>input</code></a> variable is iteration variable of this algebraic loop, then initialization starts with its <a href="#start"><code>start</code></a> value.]</em></p>
</div>
<div class="paragraph">
<p>If <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a>, that is, the variable is an <a href="#inputClock"><code>inputClock</code></a>, it is required to provide a <a href="#start"><code>start</code></a> value for describing the expected initial condition of the <a href="#inputClock"><code>inputClock</code></a> for that FMU.
If an <a href="#inputClock"><code>inputClock</code></a> has <code>fmi3True</code> as a <a href="#start"><code>start</code></a> value, the environment should activate the <a href="#clock"><code>clock</code></a> the first time it enters <strong>Event Mode</strong>.
The environment can nevertheless choose different <a href="#start"><code>start</code></a> values if it is not possible to fulfill the conditions in a simulation setup.</p>
</div>
<div class="paragraph">
<p>If <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> the <a href="#initial"><code>initial</code></a> attribute value is set to <a href="#calculated"><code>calculated</code></a> and no <a href="#start"><code>start</code></a> value is provided.</p>
</div>
<div class="paragraph">
<p>If <code>fmi3Set{VariableType}</code> is not called on a variable with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, then the FMU must use the <a href="#start"><code>start</code></a> value as value of this <a href="#input"><code>input</code></a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>canHandleMultipleSetPerTimeInstant</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="canHandleMultipleSetPerTimeInstant" class="paragraph">
<p>Only for variables with <a href="#variability"><code>variability</code></a> = <a href="#input"><code>input</code></a> :<br>
If not present, the default value is assumed to be <code>true</code>.
If <code>canHandleMultipleSetPerTimeInstant = false</code>, then only one <code>fmi3Set{VariableType}</code> call is allowed at one super-dense time instant (model evaluation) on this variable.
That is, this <a href="#input"><code>input</code></a> is not allowed to appear in a (real) algebraic loop requiring multiple calls of <code>fmi3Set{VariableType}</code> on this variable <em>[for example, due to a Newton iteration]</em>.<br>
<em>[This flag must be set to <code>false</code> for variables where (internal) discrete-time states are directly updated when assigned (xd := f(xd) instead of xd = f(previous(xd)), and at least one <a href="#output"><code>output</code></a> depends on this <a href="#input"><code>input</code></a> and on discrete-time states.</em><br>
<em>It is strongly recommended that such an FMU checks the fulfillment of the requirement by itself during run-time, because an environment might not be able to check it; usually, there is a generic mechanism to import an FMU in an environment, but the mechanism to connect FMUs together is unrelated to the import mechanism.</em>
<em>For example, there is no mechanism in the Modelica language to formulate connection restrictions for C functions (the FMU) called in a Modelica model.]</em></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clockReference</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="clockReference" class="paragraph">
<p>The optional attribute <a href="#clockReference"><code>clockReference</code></a> is used, in conjunction with the <a href="#clockElementIndex"><code>clockElementIndex</code></a> attribute, to reference the <a href="#clock"><code>clocks</code></a> this variable is assigned to.
The <a href="#clockReference"><code>clockReference</code></a> holds only <a href="#valueReference"><code>valueReference</code></a> information for variables with base type <code>fmi3Clock</code>.</p>
</div>
<div class="paragraph">
<p>If the <a href="#clock"><code>clock</code></a> referenced by <a href="#clockReference"><code>clockReference</code></a> is a <a href="#SynchronousClocks">Synchronous Clock</a> (<a href="#clockType"><code>clockType</code></a> = <a href="#synchronousTime"><code>synchronousTime</code></a>), the variable is a clocked variable associated uniquely with this <a href="#clock"><code>clock</code></a>.
It is not possible to associate more than one <a href="#clock"><code>clock</code></a> to a variable.</p>
</div>
<div class="paragraph">
<p>If the <a href="#clock"><code>clock</code></a> referenced by <a href="#clockReference"><code>clockReference</code></a> is a <a href="#CommunicationPointClocks">Communication Point Clock</a> (<a href="#clockType"><code>clockType</code></a> = <a href="#communicationPoint"><code>communicationPoint</code></a>) the variable is not necessarily <code>clocked</code> in the sense of synchronous time clock theory.
Such variables can also be continuous-time or discrete-time variables.</p>
</div>
<div class="paragraph">
<p>If <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a> the <a href="#outputClock"><code>outputClock</code></a> activation can occur only in the model partition that is related to the referenced <a href="#inputClock"><code>inputClock</code></a>, i.e. the <a href="#outputClock"><code>output clock</code></a> value (active/inactive) can only change in this model partition.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clockElementIndex</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="clockElementIndex" class="paragraph">
<p>The optional attribute <a href="#clockElementIndex"><code>clockElementIndex</code></a> is used in conjunction with the <a href="#clockReference"><code>clockReference</code></a> attribute to define the element index of the <a href="#clock"><code>clocks</code></a> this variable is assigned to for array clock variables.
The element index is the 1-based index of the element (with serialization of indices for multi-dimensional arrays in the usual row-major order).
For scalar clock variables this attribute must not be specified or must be specified as 0.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>intermediateUpdate</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="intermediateUpdate" class="paragraph">
<p>If this boolean attribute is <code>true</code>, the variable can be accessed during a communication step.
Variables with <a href="#causality"><code>causality</code></a> <a href="#parameter"><code>parameter</code></a> must not be marked with <a href="#intermediateUpdate"><code>intermediateUpdate = true</code></a>.</p>
</div>
<div class="paragraph">
<p>This attribute is only used for Co-Simulation.
The default value of this attribute is <code>false</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If <a href="#initial"><code>initial</code></a> is not present, its value is defined by <a href="#table-definition-initial">Table 6</a> based on the values of <a href="#causality"><code>causality</code></a> and <a href="#variability"><code>variability</code></a> (default <span class="underline">underlined</span>):</p>
</div>
<table id="table-definition-initial" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Definition of <a href="#initial"><code>initial</code></a>.</caption>
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="2" rowspan="2"></td>
<td class="tableblock halign-center valign-top" colspan="7"><p class="tableblock"><a href="#causality"><code>causality</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#structuralParameter"><code>structural Parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#parameter"><code>parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#calculatedParameter"><code>calculated Parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#input"><code>input</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#output"><code>output</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#local"><code>local</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#independent"><code>independent</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" rowspan="6"><p class="tableblock"><a href="#variability"><code>variability</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#constant"><code>constant</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span>,&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#fixed"><code>fixed</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#tunable"><code>tunable</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#discrete"><code>discrete</code></a> signals</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, exact, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, exact, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#continuous"><code>continuous</code></a> signals</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, exact, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span>, exact, approx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#clock"><code>clocks</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">exact</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="underline">calculated</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Note: For local and output signals and <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a>, then the variable is explicitly set in <strong>Initialization Mode</strong>.</em>
<em>The value of the variable is either the <a href="#start"><code>start</code></a> value stored in a variable element <code>&lt;XXX start=YYY/&gt;</code> or the value set with <code>fmi3Set{VariableType}</code> during <strong>Initialization Mode</strong>.]</em></p>
</div>
<div class="paragraph">
<p><a href="#table-allowed-variability-causality-combinations">Table 7</a> shows the combinations of <a href="#variability"><code>variability</code></a>/<a href="#causality"><code>causality</code></a> settings that are allowed.</p>
</div>
<table id="table-allowed-variability-causality-combinations" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Allowed combinations of <a href="#variability"><code>variability</code></a>/<a href="#causality"><code>causality</code></a>.</caption>
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="2" rowspan="2"></td>
<td class="tableblock halign-center valign-top" colspan="7"><p class="tableblock"><a href="#causality"><code>causality</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#structuralParameter"><code>structural Parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#parameter"><code>parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#calculatedParameter"><code>calculated Parameter</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#input"><code>input</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#output"><code>output</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#local"><code>local</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#independent"><code>independent</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" rowspan="6"><p class="tableblock"><a href="#variability"><code>variability</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#constant"><code>constant</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(a)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(a)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(a)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(c)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#fixed"><code>fixed</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(16)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(d)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(e)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(c)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#tunable"><code>tunable</code></a> data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(17)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(d)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(e)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(c)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#discrete"><code>discrete</code></a> signals</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">--(c)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#continuous"><code>continuous</code></a> signals</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;(b)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(15)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="#clock"><code>clocks</code></a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(18)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(19)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Discussion of the combinations that are not allowed:</em></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top"><em>Explanation why this combination is not allowed</em></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>(a)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>The combinations <a href="#constant"><code>constant</code></a> / <a href="#parameter"><code>parameter</code></a>, <a href="#constant"><code>constant</code></a> / <a href="#calculatedParameter"><code>calculatedParameter</code></a> and <a href="#constant"><code>constant</code></a> / <a href="#input"><code>input</code></a> do not make sense, since <a href="#parameter"><code>parameters</code></a> and <a href="#input"><code>inputs</code></a> are set from the environment, whereas a constant has always a value.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>(b)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>The combinations <a href="#discrete"><code>discrete</code></a> / <a href="#structuralParameter"><code>structuralParameter</code></a>, <a href="#discrete"><code>discrete</code></a> / <a href="#parameter"><code>parameter</code></a>, <a href="#discrete"><code>discrete</code></a> / <a href="#calculatedParameter"><code>calculatedParameter</code></a> , <a href="#continuous"><code>continuous</code></a> / <a href="#structuralParameter"><code>structuralParameter</code></a>, <a href="#continuous"><code>continuous</code></a> / <a href="#parameter"><code>parameter</code></a> and <a href="#continuous"><code>continuous</code></a> / <a href="#calculatedParameter"><code>calculatedParameter</code></a> do not make sense, since <a href="#causality"><code>causality</code></a> = <a href="#structuralParameter"><code>structuralParameter</code></a>, <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#causality"><code>causality</code></a> = <a href="#calculatedParameter"><code>calculatedParameter</code></a> define variables that do not depend on time, whereas <a href="#discrete"><code>discrete</code></a> and <a href="#continuous"><code>continuous</code></a> define variables where the values can change during simulation.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>(c)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>For an <a href="#independent"><code>independent</code></a> variable only <a href="#variability"><code>variability</code></a> = <a href="#continuous"><code>continuous</code></a> makes sense.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>(d)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> <a href="#input"><code>input</code></a> has exactly the same properties as a <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a>.</em>
<em>For simplicity, only <a href="#fixed"><code>fixed</code></a> and <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> shall be defined.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><em>(e)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>A <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> <a href="#output"><code>output</code></a> has exactly the same properties as a <a href="#fixed"><code>fixed</code></a> or <a href="#tunable"><code>tunable</code></a> <a href="#calculatedParameter"><code>calculatedParameter</code></a>.</em>
<em>For simplicity, only <a href="#fixed"><code>fixed</code></a> and <a href="#tunable"><code>tunable</code></a> <a href="#calculatedParameter"><code>calculatedParameters</code></a> shall be defined.</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>Discussion of the combinations that are allowed</em>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 25%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top"><em>Setting</em></th>
<th class="tableblock halign-left valign-top"><em>Example</em></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(1)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#fixed"><code>fixed</code></a> <a href="#parameter"><code>parameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Non-<a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a></em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(2)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>Tunable</code></a> <a href="#parameter"><code>parameter</code></a> (changing such a <a href="#parameter"><code>parameter</code></a> triggers event handling (ME) or takes effect at the next communication point (CS and SE), and <a href="#tunable"><code>tunable</code></a> <a href="#calculatedParameter"><code>calculatedParameter</code></a>/<a href="#output"><code>output</code></a>/<a href="#local"><code>local</code></a> variables might change their values).</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(3)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#fixed"><code>fixed</code></a> <a href="#dependenciesKind"><code>dependent</code></a> <a href="#parameter"><code>parameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Non-<a href="#tunable"><code>tunable</code></a> <a href="#dependenciesKind"><code>dependent</code></a> <a href="#parameter"><code>parameter</code></a> (variable that is computed directly or indirectly from constants or <a href="#parameter"><code>parameters</code></a>).</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(4)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>tunable</code></a> <a href="#dependenciesKind"><code>dependent</code></a> <a href="#parameter"><code>parameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>Tunable</code></a> <a href="#dependenciesKind"><code>dependent</code></a> <a href="#parameter"><code>parameter</code></a> (changing a <a href="#parameter"><code>parameter</code></a> triggers event handling (ME) or takes effect at the next communication point (CS and SE), and <a href="#tunable"><code>tunable</code></a> <a href="#dependenciesKind"><code>dependent</code></a> <a href="#parameter"><code>parameters</code></a> and <a href="#tunable"><code>tunable</code></a> <a href="#local"><code>local</code></a> variables might change their values).</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(5)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>discrete</code></a> <a href="#input"><code>input</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>Discrete</code></a> <a href="#input"><code>input</code></a> variable from another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(6)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>continuous</code></a> <a href="#input"><code>input</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>Continuous</code></a> <a href="#input"><code>input</code></a> variable from another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(7)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#constant"><code>constant</code></a> <a href="#output"><code>output</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Variable where the value never changes and that can be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(8)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>discrete</code></a> <a href="#output"><code>output</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>Discrete</code></a> variable that is computed in the FMU.</em>
<em>Can be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(9)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>continuous</code></a> <a href="#output"><code>output</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>Continuous</code></a> variable that is computed in the FMU and can be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(10)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#constant"><code>constant</code></a> <a href="#local"><code>local</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Variable where the value never changes.</em>
<em>Cannot be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(11)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#fixed"><code>fixed</code></a> <a href="#local"><code>local</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Local variable that depends on <a href="#fixed"><code>fixed</code></a> <a href="#parameter"><code>parameters</code></a> only and is computed in the FMU.</em>
<em>Cannot be used in another model.</em>
<em>After initialization, the value of this <a href="#local"><code>local</code></a> variable cannot change.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(12)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>tunable</code></a> <a href="#local"><code>local</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Local variable that depends on <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> only and is computed in the FMU.</em>
<em>Cannot be used in another model.</em>
<em>The value of this <a href="#local"><code>local</code></a> variable can only change during initialization and at event instants, provided a <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a> was changed.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(13)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>discrete</code></a> <a href="#local"><code>local</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#discrete"><code>Discrete</code></a> variable that is computed in the FMU and cannot be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(14)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>continuous</code></a> <a href="#local"><code>local</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>Continous</code></a> variable that is computed in the FMU and cannot be used in another model.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(15)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#continuous"><code>continuous</code></a> <a href="#independent"><code>independent</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>All variables are a function of the continuous-time variable marked as <a href="#independent"><code>independent</code></a>.</em>
<em>Usually, this is <code>time</code>.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(16)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#fixed"><code>fixed</code></a> <a href="#structuralParameter"><code>structuralParameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#parameter"><code>Parameter</code></a> used in  <code>&lt;Dimension&gt;</code> element;  can be changed before initialization in <strong>Configuration Mode</strong>.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(17)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#tunable"><code>tunable</code></a> <a href="#structuralParameter"><code>structuralParameter</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#parameter"><code>Parameter</code></a> used in  <code>&lt;Dimension&gt;</code> element;  can be changed before initialization in <strong>Configuration Mode</strong> and in <strong>Reconfiguration Mode</strong>.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(18)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#clock"><code>clock</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Variable that defines a <a href="#clock"><code>clock</code></a>.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><em>(19)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em><a href="#clock"><code>clock</code></a></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Variable that defines a <a href="#clock"><code>clock</code></a> that is computed in the FMU and cannot be used in another model.</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>How to treat <a href="#tunable"><code>tunable</code></a> variables:</em></p>
</div>
<div class="paragraph">
<p><em>A <a href="#parameter"><code>parameter</code></a> p is a variable that does not change its value during simulation, in other words, dp/dt = 0.</em>
<em>If the <a href="#parameter"><code>parameter</code></a> p is changing, then Dirac impulses are introduced since dp/dt of a discontinuous <a href="#constant"><code>constant</code></a> variable <code>p</code> is a Dirac impulse.</em>
<em>Even if this Dirac impulse would be modeled correctly by the modeling environment, it would introduce unwanted <code>vibrations</code>.</em>
<em>Furthermore, in many cases the model equations are derived under the assumption of a <a href="#constant"><code>constant</code></a> value (like mass or capacity), and the model equations would be different if <code>p</code> would be time varying.</em></p>
</div>
<div class="paragraph">
<p><em>FMI for Model Exchange:</em><br>
<em>Therefore, "tuning a (structural) <a href="#parameter"><code>parameter</code></a>" during simulation does not mean to "change the parameter online" during simulation.</em>
<em>Instead, this is a short hand notation for:</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Stop the simulation at an event instant (usually, a <a href="#step-event">step event</a>, in other words, after a successful integration step).</em></p>
</li>
<li>
<p><em>Change the values of the <a href="#tunable"><code>tunable</code></a> (structural) <a href="#parameter"><code>parameters</code></a>.</em>
<em>For <a href="#tunable"><code>tunable</code></a> <a href="#structuralParameter"><code>structural parameters</code></a>, the <strong>Reconfiguration Mode</strong> must be entered before and left afterwards.</em></p>
</li>
<li>
<p><em>Compute all <a href="#parameter"><code>parameters</code></a> (and sizes of variables, <a href="#state"><code>states</code></a>, <a href="#derivative"><code>derivatives</code></a>, event indicators, &#8230;&#8203;) that depend on the <a href="#tunable"><code>tunable</code></a> (structural) <a href="#parameter"><code>parameters</code></a>.</em></p>
</li>
<li>
<p><em>Newly start the simulation using as initial values previously stored values and the new values of the <a href="#parameter"><code>parameters</code></a>.</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>Basically this means that a new simulation run is started from the previous FMU state with changed <a href="#parameter"><code>parameter</code></a> values.</em>
<em>With this interpretation, changing <a href="#parameter"><code>parameters</code></a> online is "clean", as long as these changes appear at an event instant.</em></p>
</div>
<div class="paragraph">
<p><em>FMI for Co-Simulation:</em>
<em>Changing of <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> is allowed before an <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> call (so, whenever an <a href="#input"><code>input</code></a> can be set with <code>fmi3Set{VariableType}</code>) and before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called (that is before and during <strong>Initialization Mode</strong>).</em>
<em>The FMU internally carries out event handling if necessary.]</em></p>
</div>
<div class="paragraph">
<p>Type specific properties are defined in the required choice element, where exactly one of the numeric types or an <code>&lt;Enumeration&gt;</code> must be present in the XML file:
<a href="#figure-schema-Float64">Figure 19</a>, <a href="#figure-schema-Int32">Figure 20</a>, <a href="#figure-schema-Boolean">Figure 21</a>, <a href="#figure-schema-Binary">Figure 22</a>, and <a href="#figure-schema-Enumeration">Figure 23</a>, are representative examples.</p>
</div>
<div id="figure-schema-Float64" class="imageblock text-center">
<div class="content">
<img src="images/schema/Float64.png" alt="Float64" width="70%">
</div>
<div class="title">Figure 19. Float64 element.</div>
</div>
<div id="figure-schema-Int32" class="imageblock text-center">
<div class="content">
<img src="images/schema/Int32.png" alt="Int32" width="70%">
</div>
<div class="title">Figure 20. Int32 element.</div>
</div>
<div id="figure-schema-Boolean" class="imageblock text-center">
<div class="content">
<img src="images/schema/Boolean.png" alt="Boolean" width="70%">
</div>
<div class="title">Figure 21. Boolean element.</div>
</div>
<div id="figure-schema-Binary" class="imageblock text-center">
<div class="content">
<img src="images/schema/Binary.png" alt="Binary" width="70%">
</div>
<div class="title">Figure 22. Binary element.</div>
</div>
<div id="figure-schema-Enumeration" class="imageblock text-center">
<div class="content">
<img src="images/schema/Enumeration.png" alt="Enumeration" width="70%">
</div>
<div class="title">Figure 23. Enumeration element.</div>
</div>
<div class="paragraph">
<p>The attributes are defined in <a href="#definition-of-types">Section 2.4.4</a> (<code>&lt;TypeDefinitions&gt;</code>), except:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 87.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>declaredType</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If present, name of type defined with <code>&lt;TypeDefinitions&gt;&lt;TypeDefinition&gt;</code>.
The value defined in the corresponding <code>&lt;TypeDefinition&gt;</code> (see <a href="#definition-of-types">Section 2.4.4</a>) is used as default.
<em>[For example, if <code>min</code> is present both in variable type element of <code>&lt;TypeDefinition&gt;</code> and in the concrete variable type element of the variable, then the <code>min</code> of the variable is actually used.]</em>
For numeric types and <code>&lt;String&gt;</code>, this attribute is optional.
For <code>&lt;Enumeration&gt;</code> it is required, because the <code>&lt;Enumeration&gt;</code> items are defined in <code>&lt;TypeDefinitions&gt;&lt;TypeDefinition&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>start</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="start" class="paragraph">
<p>Initial or guess value of variable.
This value is also stored in the C functions.
<em>[Therefore, calling</em> <code>fmi3Set{VariableType}</code> <em>to set <a href="#start"><code>start</code></a> values is only necessary, if a different value as stored in the XML file is desired.</em>
<em>It is not allowed to change the start values in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file of an FMU, as this would break the consistency with the hard-coded start values in the C-Code.</em>
<em>This could lead to unpredictable behavior of the FMU in different importing tools, as it is not mandatory to call <code>fmi3Set{VariableType}</code> to set start values during initialization.</em>
<em>Instead it is recommended to use the SSP Standard (<a href="https://ssp-standard.org/" class="bare">https://ssp-standard.org/</a>) to handle modified parameters of FMUs or different parameter sets.]</em></p>
</div>
<div class="paragraph">
<p>The interpretation of <a href="#start"><code>start</code></a> is defined by variable attribute <a href="#initial"><code>initial</code></a>.
A different <a href="#start"><code>start</code></a> value can be provided with an <code>fmi3Set{VariableType}</code> function before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called (but not for variables with <a href="#variability"><code>variability</code></a> = <a href="#constant"><code>constant</code></a>).</p>
</div>
<div class="paragraph">
<p><em>[The standard approach is to set the <a href="#start"><code>start</code></a> value before <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a>.</em>
<em>However, if the initialization shall be modified in the calling environment (for example, changing from initialization of states to steady-state initialization), it is also possible to use the <a href="#start"><code>start</code></a> value as iteration variable of an algebraic loop: using an additional condition in the environment, such as</em> \({\dot{x} = 0}\) <em>, the actual <a href="#start"><code>start</code></a> value is determined.]</em></p>
</div>
<div class="paragraph">
<p>If <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> or <a href="#approx"><code>approx</code></a> or <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, a <a href="#start"><code>start</code></a> value must be provided.</p>
</div>
<div class="paragraph">
<p>If <a href="#initial"><code>initial</code></a> = <a href="#calculated"><code>calculated</code></a> or <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a>, it is not allowed to provide a <a href="#start"><code>start</code></a> value.</p>
</div>
<div class="paragraph">
<p>Variables with <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> or <a href="#input"><code>input</code></a>, as well as variables with <a href="#variability"><code>variability</code></a> = <a href="#constant"><code>constant</code></a>, must have a <a href="#start"><code>start</code></a> value.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a>, the <a href="#start"><code>start</code></a> value is the value of it.</p>
</li>
<li>
<p>If <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, the <a href="#start"><code>start</code></a> value is used by the model as value of the <a href="#input"><code>input</code></a>, if the <a href="#input"><code>input</code></a> is not set by the environment.</p>
</li>
<li>
<p>If <a href="#variability"><code>variability</code></a> = <a href="#constant"><code>constant</code></a>, the <a href="#start"><code>start</code></a> value is the value of the constant.</p>
</li>
<li>
<p>If <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> or <a href="#local"><code>local</code></a>, then the <a href="#start"><code>start</code></a> value is either an <a href="#initial"><code>initial</code></a> or a <code>guess</code> value, depending on the setting of attribute <a href="#initial"><code>initial</code></a>.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>derivative</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="derivative" class="paragraph">
<p>If present, this variable is the derivative of variable with value reference <code>derivative</code>.
<em>[For example, if there are 10 variables and <code>derivative = 3</code> for variable 8, then variable 8 is the derivative of variable 3 with respect to the <a href="#independent"><code>independent</code></a> variable (usually time).</em>
<em>This information might be especially used if an <a href="#input"><code>input</code></a> or an <a href="#output"><code>output</code></a> is the derivative of another <a href="#input"><code>input</code></a> or <a href="#output"><code>output</code></a>, or to define the <a href="#state"><code>states</code></a>.]</em></p>
</div>
<div class="paragraph">
<p>The <a href="#state"><code>state</code></a> <a href="#derivative"><code>derivatives</code></a> of an FMU are listed as elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>.
All variables listed in this element must have attribute <code>derivative</code> (in order that the continuous-time <a href="#state"><code>states</code></a> are uniquely defined).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reinit</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="reinit" class="paragraph">
<p>Only for Model Exchange (if only a Co-Simulation FMU, this attribute must not be present.
If both Model Exchange and a Co-Simulation FMU, this attribute is ignored for co-simulation):<br>
Can only be present for a continuous-time <a href="#state"><code>state</code></a>.<br>
If <code>true</code>, <a href="#state"><code>state</code></a> can be reinitialized at an event by the FMU.<br>
If <code>false</code>, <a href="#state"><code>state</code></a> will not be reinitialized at an event by the FMU.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min / max</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The optional attributes <code>min</code> and <code>max</code> in element <code>&lt;Enumeration&gt;</code> restrict the allowed values of the enumeration.
The <code>min/max</code> definitions are information from the FMU to the environment defining the region in which the FMU is designed to operate, see also comment in <a href="#definition-of-types">Section 2.4.4</a>.
<em>[If, for example, an <code>&lt;Enumeration&gt;</code> is defined with <code>name1 = -4</code>, <code>name2 = 1</code>, <code>name3 = 5</code>, <code>name4 = 11</code> and <code>min = -2</code>, <code>max = 5</code>, then only <code>name2</code> and <code>name3</code> are allowed.]</em></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="ModelStructure">2.4.9. Definition of the Model Structure</h4>
<div class="paragraph">
<p>The structure of the model is defined in element <code>&lt;fmiModelDescription&gt;&lt;ModelStructure&gt;</code>.
This structure is with respect to the underlying model equations, independently how these model equations are solved.
<em>[For example, when exporting a model in more than one FMI format; then the model structure is identical in all cases.</em>
<em>E.g. a Co-Simulation FMU has either an integrator included that solves the model equations, or the discretization formula of the integrator and the model equations are solved together ("inline integration").</em>
<em>In all cases the model has the same continuous-time <a href="#state"><code>states</code></a>.</em>
<em>In the case of a Model-Exchange FMU, the internal implementation is a discrete-time system, but from the outside this is still a continuous-time model that is solved with an integration method.]</em></p>
</div>
<div class="paragraph">
<p>The required part defines an ordering of the <a href="#output"><code>outputs</code></a>, the (exposed) <a href="#derivative"><code>derivatives</code></a>, the event indicators, and the unknowns that are available during Initialization <em>[Therefore, when linearizing an FMU, every tool will use the same ordering for the <a href="#output"><code>outputs</code></a>, <a href="#state"><code>states</code></a>, and <a href="#derivative"><code>derivatives</code></a> for the linearized model.
The ordering of the <a href="#input"><code>inputs</code></a> should be performed in this case according to the ordering in <code>&lt;ModelVariables&gt;</code>.]</em>
A Model Exchange FMU must expose all <a href="#derivative"><code>derivatives</code></a> of its continuous-time <a href="#state"><code>states</code></a> in elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code> and must expose all event indicators in elements <code>&lt;EventIndicator&gt;</code>.
A Co-Simulation FMU does not need to expose these state derivatives and event indicators.
<em>[If a Co-Simulation FMU exposes its state derivatives, they are usually not utilized for the co-simulation, but, for example, to linearize the FMU at a communication point.]</em></p>
</div>
<div class="paragraph">
<p>The optional part defines in which way <a href="#derivative"><code>derivatives</code></a>, <a href="#output"><code>outputs</code></a>, and initial unknowns, depend on <a href="#input"><code>inputs</code></a>, and continuous-time <a href="#state"><code>states</code></a>, at the current super-dense time instant (ME) or at the current communication point (CS and SE).
<em>[The listed <a href="#dependencies"><code>dependencies</code></a> declare the dependencies between whole (multi-dimensional-)variables and not individual elements of the variables.]</em>
<em>[A simulation environment can utilize this information to improve the efficiency, for example, when connecting FMUs together, or when computing the partial derivative of the <a href="#derivative"><code>derivatives</code></a> with respect to the <a href="#state"><code>states</code></a> in the simulation engine.]</em></p>
</div>
<div class="paragraph">
<p><a href="#figure-schema-ModelStructure">Figure 24</a> shows the definition of <code>&lt;ModelStructure&gt;</code>.</p>
</div>
<div id="figure-schema-ModelStructure" class="imageblock">
<div class="content">
<img src="images/schema/ModelStructure.png" alt="ModelStructure" width="90%">
</div>
<div class="title">Figure 24. ModelStructure element.</div>
</div>
<div class="paragraph">
<p>Note that attribute <a href="#dependenciesKind"><code>dependenciesKind</code></a> for element <a href="#InitialUnknown"><code>&lt;InitialUnknown&gt;</code></a> has less enumeration values as <a href="#dependenciesKind"><code>dependenciesKind</code></a> in the other lists, as detailed in <a href="#table-model-structure-elements">Table 8</a>.</p>
</div>
<div class="paragraph">
<p><code>&lt;ModelStructure&gt;</code> consists of the elements detailed in <a href="#table-model-structure-elements">Table 8</a> (see also <a href="#figure-schema-ModelStructure">Figure 24</a>; the symbols of the mathematical equations describing the dependency are defined in <a href="#math-model-exchange">Section 3.1</a>):</p>
</div>
<table id="table-model-structure-elements" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. ModelStructure elements.</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Output</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordered list of all outputs, in other words, a list of value references where every corresponding variable must have <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> (and every variable with <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> must be listed here).
<em>[Note that all <a href="#output"><code>output</code></a> variables are listed here, especially <a href="#discrete"><code>discrete</code></a> and <a href="#continuous"><code>continuous</code></a> <a href="#output"><code>outputs</code></a>.</em>
<em>The ordering of the variables in this list is defined by the exporting tool.</em>
<em>Usually, it is best to order according to the declaration order in the source model, since then the <code>&lt;Output&gt;</code> list does not change if the declaration order of <a href="#output"><code>outputs</code></a> in the source model is not changed.</em>
<em>This is for example, important for linearization, in order that the interpretation of the output vector does not change for a re-exported FMU.]</em>
Attribute <a href="#dependencies"><code>dependencies</code></a> defines the dependencies of the <a href="#output"><code>outputs</code></a> from the knowns at the current super-dense time instant in Event and in <strong>Continuous-Time Mode</strong> (ME) and at the current communication point (CS and SE).
Attribute <a href="#dependencies"><code>dependencies</code></a> for output clocks (variables with <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a>) lists all known variables (including input clocks) that contribute to trigger a clock tick for that output clock.
Beside the knowns, the <a href="#output"><code>outputs</code></a> also depend on "frozen" variables (= variables which cannot be changed in the current mode) but these "frozen" variables are not listed as <a href="#dependencies"><code>dependencies</code></a>.
The functional dependency is defined as (dependencies of variables that are fixed in Event and <strong>Continuous-Time Mode</strong> and at communication points are not shown):<br>
\({(\mathbf{y}_c, \mathbf{y}_d) := \mathbf{f}_{\mathit{output}}(\mathbf{x}_c, \mathbf{u}_c, \mathbf{u}_d, t, \mathbf{p}_{\mathit{tune}})}\)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Derivative</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordered list of all state derivatives, in other words, a list of value references where every corresponding variable must be a state derivative.
<em>[Note that only <a href="#continuous"><code>continuous</code></a> floating point variables are listed here.</em>
<em>If a <a href="#state"><code>state</code></a> or a <a href="#derivative"><code>derivative</code></a> of a <a href="#state"><code>state</code></a> shall not be exposed from the FMU, or if states are not statically associated with a variable (due to dynamic state selection), then dummy variables have to be introduced, for example, <code>x[4]</code>, or <code>xDynamicStateSet2[5]</code>.</em>
<em>The ordering of the variables in this list is defined by the exporting tool.</em>
<em>Usually, it is best to order according to the declaration order of the <a href="#state"><code>states</code></a> in the source model, since then the <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code> list does not change if the declaration order of states in the source model is not changed.</em>
<em>This is for example, important for linearization, in order that the interpretation of the state vector does not change for a re-exported FMU.]</em></p>
<p class="tableblock">The corresponding continuous-time <a href="#state"><code>states</code></a> are defined by attribute <a href="#derivative"><code>derivative</code></a> of the corresponding variable state derivative element.
<em>[Note that higher order derivatives must be mapped to first order derivatives but the mapping definition can be preserved due to attribute <a href="#derivative"><code>derivative</code></a>.</em>
<em>Example: if</em> \({\frac{\text{ds}}{\text{dt}} = v,\ \frac{\text{dv}}{\text{dt}} =f(..)}\) <em>,then</em> \({\left\{ v,\ \frac{\text{dv}}{\text{dt}} \right\}}\) <em>is the vector of state derivatives and attribute <a href="#derivative"><code>derivative</code></a> of</em> \({v}\) <em>references</em> \({s}\) <em>, and attribute <a href="#derivative"><code>derivative</code></a> of</em> \({\frac{\text{dv}}{\text{dt}}}\) <em>references</em> \({v}\) <em>.]</em><br>
For Co-Simulation, elements <code>&lt;Derivative&gt;</code> are ignored if capability flag <code>providesDirectionalDerivatives</code> has a value of <code>false</code>, in other words, it cannot be computed.
<em>[This is the default.</em>
<em>If an FMU supports more than Model Exchange , then the <code>&lt;Derivative&gt;</code> elements might be present, since it is needed for Model Exchange.</em>
<em>If the above flag is set to <code>false</code> for the Co-Simulation cases, then the <code>&lt;Derivative&gt;</code> elements are ignored for Co-Simulation.</em>
<em>If "inline integration" is used for a co-simulation FMU, then the model still has continuous-time <a href="#state"><code>states</code></a> and just a special solver is used (internally the implementation results in a discrete-time system, but from the outside, it is still a continuous-time system).]</em><br>
Attribute <a href="#dependencies"><code>dependencies</code></a> defines the dependencies of the state derivatives from the knowns at the current super-dense time instant in Event and in <strong>Continuous-Time Mode</strong> (ME) and at the current communication point (CS and SE).
Beside the knowns the derivatives also depend on the "frozen" variables (= variables which cannot be changed in the current mode) but these "frozen" variables are not listed as <a href="#dependencies"><code>dependencies</code></a>.
The functional dependency is defined as (dependencies of variables that are fixed in Event and <strong>Continuous-Time Mode</strong> and at communication points are not shown):<br>
\({\dot{\mathbf{x}_c} := \mathbf{f}_{\mathit{der}}(\mathbf{x}_c, \mathbf{u}_c, \mathbf{u}_d, t, \mathbf{p}_{\mathit{tune}})}\)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InitialUnknown</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="InitialUnknown"></a>
Ordered list of all exposed unknowns in <strong>Initialization Mode</strong>.
This list consists of all variables with</p>
<p class="tableblock">- <a href="#causality"><code>causality</code></a> = <a href="#output"><code>output</code></a> and (<a href="#initial"><code>initial</code></a> = <a href="#approx"><code>approx</code></a> or <a href="#calculated"><code>calculated</code></a>), and</p>
<p class="tableblock">- <a href="#causality"><code>causality</code></a> = <a href="#calculatedParameter"><code>calculatedParameter</code></a> and</p>
<p class="tableblock">- all continuous-time <a href="#state"><code>states</code></a> and all state derivatives (defined with elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>) with <a href="#initial"><code>initial</code></a> = <a href="#approx"><code>approx</code></a> or <a href="#calculated"><code>calculated</code></a> <em>[if a Co-Simulation FMU does not define the <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code> elements, (3) cannot be present]</em>.</p>
<p class="tableblock">The resulting list is not allowed to have duplicates (for example, if a <a href="#state"><code>state</code></a> is also an <a href="#output"><code>output</code></a>, it is included only once in the list).<br>
Attribute <a href="#dependencies"><code>dependencies</code></a> defines the dependencies of the unknowns from the knowns in <strong>Initialization Mode</strong> at the initial time.
Beside the knowns the initial unknowns also depend on the "frozen" variables (= variables which cannot be changed in the current mode) but these "frozen" variables are not listed as <a href="#dependencies"><code>dependencies</code></a>.
The functional dependency is defined as:</p>
<p class="tableblock">\({\mathbf{v}_{\mathit{initialUnknowns}} := \mathbf{f}_{\mathit{init}}(\mathbf{u}_c, \mathbf{u}_d, t_0, \mathbf{v}_{\mathit{initial=exact}})}\)</p>
<p class="tableblock">Since, <a href="#output"><code>outputs</code></a>, continuous-time <a href="#state"><code>states</code></a> and state derivatives are either present as knowns (if <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a>) or as unknowns (if <a href="#initial"><code>initial</code></a> = <a href="#approx"><code>approx</code></a> or <a href="#calculated"><code>calculated</code></a>), they can be inquired with <code>fmi3Get{VariableType}</code> in <strong>Initialization Mode</strong>.</p>
<p class="tableblock"><em>[Example: Assume an FMU is defined in the following way:</em></p>
<p class="tableblock">\({(\mathbf{y}_{c+d}, \dot{\mathbf{x}}_c) := \mathbf{f}_{\mathit{init}}(\mathbf{x}_c, \mathbf{u}_{c+d}, t_0, \mathbf{p})}\)<br></p>
<p class="tableblock">\({(\mathbf{y}_{c+d}, \dot{\mathbf{x}}_c) := \mathbf{f}_{\mathit{sim}}(\mathbf{x}_c, \mathbf{u}_{c+d}, t_i, \mathbf{p})}\)<br></p>
<p class="tableblock"><em>Therefore, the initial state \({\mathbf{x}_c(t_0)}\) has <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> and the initial state derivative \({\dot{\mathbf{x}}_c(t_0)}\) has <a href="#initial"><code>initial</code></a> = <a href="#calculated"><code>calculated</code></a>.</em>
<em>The environment can still initialize this FMU in steady-state, by using \({\mathbf{x}_c(t_0)}\) as iteration variables and adding the equations \({\dot{\mathbf{x}}_c(t_0) = \mathbf{0}}\) in the environment.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EventIndicator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="EventIndicator"></a>
Ordered list of all event indicators, in other words, a list of value references where every corresponding variable must be a event indicator.
<em>[Note that only <a href="#continuous"><code>continuous</code></a> floating point variables are listed here.</em>
<em>If an event indicator shall not be exposed from the FMU, or if event indicators are not statically associated with a variable (due to dynamic event indicator selection), then dummy variables have to be introduced, for example, <code>eventIndicator[4]</code>.</em>
<em>The ordering of the variables in this list is defined by the exporting tool.]</em></p>
<p class="tableblock">For Co-Simulation, elements <code>&lt;EventIndicator&gt;</code> are ignored.
<em>[If an FMU supports both Model Exchange and Co-Simulation, then the <code>&lt;EventIndicator&gt;</code> elements might be present, since it is needed for Model Exchange.]</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Elements <code>&lt;Output&gt;</code>, <code>&lt;Derivative&gt;</code> and <code>&lt;InitialUnknown&gt;</code> have the following attributes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>valueReference</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value reference of the unknown \({v_{\mathit{unknown}}}\).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dependencies</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="dependencies"></a>
Optional attribute defining the dependencies of the unknown \({v_{\mathit{unknown}}}\) (directly or indirectly via auxiliary variables) with respect to \({\mathbf{v}_{\mathit{known}}}\).
If not present, it must be assumed that the unknown depends on all knowns.
If present as empty list, the unknown depends on none of the knowns.
Otherwise the unknown depends on the knowns defined by the given value references.<br>
Knowns \({\mathbf{v}_{\mathit{known}}}\) in <strong>Event Mode</strong> and <strong>Continuous-Time Mode</strong> (ME) and at communication points (CS and SE) for <code>&lt;Output&gt;</code> and <code>&lt;Derivative&gt;</code> elements:</p>
<p class="tableblock">- inputs (variables with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>)</p>
<p class="tableblock">- continuous-time states</p>
<p class="tableblock">- <a href="#independent"><code>independent</code></a> variable (usually time; <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a>).</p>
<p class="tableblock"><em>[<a href="#parameter"><code>parameters</code></a> and <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> must not be listed as knowns in this mode.</em>
<em>This may change in a future FMI version which implies the possibility to calculate derivatives with respect to parameters.</em>
<em>The list of dependencies may include input clocks (variables with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#clock"><code>clock</code></a>).</em>
<em>If an <a href="#outputClock"><code>output clock</code></a> depends on an <a href="#inputClock"><code>input clock</code></a>, then clock ticks of the <a href="#inputClock"><code>input clock</code></a> in <strong>Event Mode</strong> may create <a href="#outputClock"><code>output clock</code></a> ticks during this event handling.]</em></p>
<p class="tableblock"><code>Knowns</code> \({\mathbf{v}_{\mathit{known}}}\) in <strong>Initialization Mode</strong> (for elements <a href="#InitialUnknown"><code>&lt;InitialUnknown&gt;</code></a>):</p>
<p class="tableblock">- inputs (variables with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>)</p>
<p class="tableblock">- variables with <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> <em>[for example, <a href="#parameter"><code>parameters</code></a> or initial <a href="#state"><code>states</code></a>]</em></p>
<p class="tableblock">- <a href="#independent"><code>independent</code></a> variable (usually time; <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a>).</p>
<p class="tableblock">For Co-Simulation, if the capability flag <code>providesDirectionalDerivatives</code> has a value of <code>false</code>, then <a href="#dependencies"><code>dependencies</code></a> does not list the dependency on continuous-time.
In other words, the respective partial derivatives cannot be computed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dependenciesKind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="dependenciesKind"></a>
If <a href="#dependenciesKind"><code>dependenciesKind</code></a> is present, <a href="#dependencies"><code>dependencies</code></a> must be present and must have the same number of list elements.
If not present, it must be assumed that the unknown \({v_{\mathit{unknow}}}}\) depends on the knowns \({\mathbf{v}_{\mathit{known}}}\) without a particular structure.
Otherwise, the corresponding known \({v_{\mathit{known},i}}\) enters the equation as:</p>
<p class="tableblock"><code>= dependent</code>: no particular structure, \({{h(..,\ v}_{\mathit{known},i}}\),..)</p>
<p class="tableblock">Only for floating point type unknowns \({v_{\mathit{unknown}}}\):</p>
<p class="tableblock"><code>=</code> <a href="#constant"><code>constant</code></a>: constant factor, \({c \cdot v_{\mathit{known},i}}\) where \({c}\) is an expression that is evaluated before <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a> is called.</p>
<p class="tableblock">Only for floating point type unknowns \({v_{\mathit{unknown}}}\) in Event and <strong>Continuous-Time Mode</strong> (ME) and at communication points (CS and SE), and not for <a href="#InitialUnknown"><code>&lt;InitialUnknown&gt;</code></a> for <strong>Initialization Mode</strong>:</p>
<p class="tableblock"><code>=</code> <a href="#fixed"><code>fixed</code></a>: fixed factor, \({p \cdot v_{\mathit{known},i}}\) where \({p}\) is an expression that is evaluated before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called.</p>
<p class="tableblock"><code>=</code> <a href="#tunable"><code>tunable</code></a>: tunable factor, \({p \cdot v_{\mathit{known},i}}\) where \({p}\) is an expression that is evaluated before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called and in <strong>Event Mode</strong> due to event handling (ME) or at a communication point (CS and SE)</p>
<p class="tableblock"><code>=</code> <a href="#discrete"><code>discrete</code></a>: discrete factor, \({d \cdot v_{\mathit{known},i}}\) where \({d}\) is an expression that is evaluated before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called and in <strong>Event Mode</strong> due to an external or internal event or at a communication point (CS and SE).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Example 1:</em></p>
</div>
<div class="paragraph">
<p><em>An FMU is defined by the following equations:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}

\frac{d}{\text{dt}}\begin{bmatrix}
x_{1} \\
x_{2} \\
x_{3} \\
\end{bmatrix}

&amp;=

\begin{bmatrix}
f_{1}\left( x_{2} \right) \\
f_{2}\left( x_{1} \right) + 3 \cdot p^{2} \cdot x_{2} + 2 \cdot u_{1} + 3 \cdot u_{3} \\
f_{3}\left( x_{1},x_{3},u_{1},u_{2},u_{3} \right) \\
\end{bmatrix}

\\

y &amp;= g_1(x_2, x_3)

\end{align*},\]
</div>
</div>
<div class="paragraph">
<p><em>where</em> \({u_{1}}\) <em>is a continuous-time <a href="#input"><code>input</code></a> (<a href="#variability"><code>variability</code></a> = <a href="#continuous"><code>continuous</code></a>),</em> \({u_{2}}\) <em>is any type of <a href="#input"><code>input</code></a>,</em> \({u_{3}}\) <em>is a floating point discrete-time <a href="#input"><code>input</code></a> (<a href="#variability"><code>variability</code></a> = "discrete"`), and</em> \({p}\) <em>is a <a href="#fixed"><code>fixed</code></a> <a href="#parameter"><code>parameter</code></a> (<a href="#variability"><code>variability</code></a> = <a href="#fixed"><code>fixed</code></a>).</em>
<em>The initialization is defined by:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[x_1 = 1.1, \frac{dx_2}{dt} = 0, y = 3.3,\]
</div>
</div>
<div class="paragraph">
<p><em>and therefore, the initialization equations are:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
x_{2} &amp;= \frac{1}{3 \cdot p^{2}} \cdot ( f_{2}\left( x_{1} \right) + 2 \cdot u_{1} + 3 \cdot u_{3} )
\\
x_{3} &amp;= g_{1}^{- 1}( x_{2}, y)
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p><em>This equation system can be defined as:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;ModelVariables&gt;
   &lt;Float64 name="p"       valueReference= "1"/&gt;
   &lt;Float64 name="u1"      valueReference= "2"/&gt;
   &lt;Float64 name="u2"      valueReference= "3"/&gt;
   &lt;Float64 name="u3"      valueReference= "4"/&gt;
   &lt;Float64 name="x1"      valueReference= "5"/&gt;
   &lt;Float64 name="x2"      valueReference= "6"/&gt;
   &lt;Float64 name="x3"      valueReference= "7"/&gt;
   &lt;Float64 name="der(x1)" valueReference= "8" derivative="5"/&gt;
   &lt;Float64 name="der(x2)" valueReference= "9" derivative="6"/&gt;
   &lt;Float64 name="der(x3)" valueReference="10" derivative="7"/&gt;
   &lt;Float64 name="y"       valueReference="11" causality="output"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
   &lt;Output valueReference="11" dependencies="6 7"/&gt;
   &lt;Derivative valueReference="8"  dependencies="6"/&gt;
   &lt;Derivative valueReference="9"  dependencies="2 4 5 6" dependenciesKind="constant constant dependent fixed"/&gt;
   &lt;Derivative valueReference="10" dependencies="2 3 4 5 6" /&gt;
   &lt;InitialUnknown valueReference="6" dependencies="2 4 5"/&gt;
   &lt;InitialUnknown valueReference="7" dependencies="2 4 5 11"/&gt;
   &lt;InitialUnknown valueReference="8"/&gt;
   &lt;InitialUnknown valueReference="10"/&gt;
   &lt;InitialUnknown valueReference="11"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Example 2:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[y = \left\{ \begin{matrix}
2 \cdot u \ \mathrm{if} \ u &gt; 0 \\
3 \cdot u \ \mathrm{else} \\
\end{matrix}\right.\]
</div>
</div>
<div class="paragraph">
<p><em>where</em> \({u}\) <em>is a continuous-time <a href="#input"><code>input</code></a> with <a href="#valueReference"><code>valueReference</code></a> = <code>1</code> and</em> \({y}\) <em>is a continuous-time <a href="#output"><code>output</code></a> with <a href="#valueReference"><code>valueReference</code></a> = <code>2</code>.</em>
<em>The definition of the model structure is then:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="1" dependenciesKind="discrete"/&gt;
  &lt;InitialUnknown valueReference="2"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>[Note that</em> \({y = d \cdot u}\) <em>where</em> \({d}\) <em>changes only during <strong>Event Mode</strong> (</em> \({d = 2 \cdot u}\) <em>or</em> \({3 \cdot u\ }\) <em>depending on relation</em> \({u &gt; 0}\) <em>that changes only at <strong>Event Mode</strong>).</em>
<em>Therefore <a href="#dependenciesKind"><code>dependenciesKind</code></a> = <a href="#discrete"><code>discrete</code></a>.]</em></p>
</div>
<div class="paragraph">
<p><em>Example 3:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[y = \left\{ \begin{matrix}
2\ \ \mathrm{if}\ \ u &gt; 0 \\
3\ \ \mathrm{else} \\
\end{matrix}\right.\]
</div>
</div>
<div class="paragraph">
<p><em>where</em> \({u}\) <em>is a continuous-time <a href="#input"><code>input</code></a> with <a href="#valueReference"><code>valueReference</code></a> = <code>1</code> and</em> \({y}\) <em>is a continuous-time <a href="#output"><code>output</code></a> with <a href="#valueReference"><code>valueReference</code></a> = <code>2</code>.</em>
<em>The definition of the model structure is then:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="1" dependenciesKind="dependent"/&gt;
  &lt;InitialUnknown valueReference="2"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>[Note that</em> \({y = c}\) <em>where</em> \({c}\) <em>changes only during <strong>Event Mode</strong> (</em> \({c = 2}\) <em>or</em> \({3\ }\) <em>depending on relation</em> \({u &gt; 0}\) <em>that changes only at <strong>Event Mode</strong>).</em>
<em>Therefore <a href="#dependenciesKind"><code>dependenciesKind</code></a> = <a href="#dependenciesKind"><code>dependent</code></a> because it is not a linear relationship on</em> \({u}\). <em>]</em></p>
</div>
<div class="paragraph">
<p><em>Example 4:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\frac{dx}{dt}=u, y=x\]
</div>
</div>
<div class="paragraph">
<p>where <code>u</code> is continuous-time input value reference <code>1</code>, <code>y</code> is a continuous-time output with value reference <code>2</code> and <code>dxdt</code> is a continuous-time derivative with value reference <code>4</code>.
The definition of the model structure is then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;ModelVariables&gt;
   &lt;Float64 name="u" valueReference= "1"/&gt;
   &lt;Float64 name="y" valueReference= "2" causality="output"/&gt;
   &lt;Float64 name="x" valueReference= "3"/&gt;
   &lt;Float64 name="dxdt" valueReference= "4"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="3" dependenciesKind="constant"/&gt;
  &lt;Derivative valueReference="4" dependencies="1" dependenciesKind="constant"/&gt;
  &lt;InitialUnknown valueReference="2" dependencies="3"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Defining FMU features with the</em> <a href="#dependencies"><code>dependencies</code></a> <em>list:</em></p>
</div>
<div class="paragraph">
<p><em>[Note that via the <a href="#dependencies"><code>dependencies</code></a> list the supported features of the FMU can be defined.</em>
<em>Examples:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>If a state derivative <code>der_x</code> is a function of a <a href="#parameter"><code>parameter</code></a> p (so of a <a href="#start"><code>start</code></a> value of a variable with <a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#fixed"><code>fixed</code></a>), and the FMU does not support an iteration over <code>p</code> during <strong>Initialization Mode</strong> (for example, to iterate over p such that the state derivative <code>der_x</code> is zero), then the <a href="#dependencies"><code>dependencies</code></a> list of <code>der_x</code> should not include <code>p</code>.</em>
<em>If an FMU is imported in an environment and such an iteration is set up, then the tool can figure out that the resulting algebraic system of equations is structurally singular and therefore can reject such a definition.</em></p>
</li>
<li>
<p><em>For Co-Simulation FMUs, it is common that no algebraic loops over the <a href="#input"><code>input</code></a> / <a href="#output"><code>output</code></a> variables nor over <a href="#start"><code>start</code></a> values is supported.</em>
<em>In such a case, all <a href="#dependencies"><code>dependencies</code></a> lists for <a href="#output"><code>output</code></a> variables under the <a href="#InitialUnknown"><code>&lt;InitialUnknown&gt;</code></a> element should be defined as empty lists defining that the setting of <a href="#input"><code>inputs</code></a> and/or of <a href="#start"><code>start</code></a> values does not influence the <a href="#output"><code>outputs</code></a>.</em>
<em>As a result, it is not possible to formulate algebraic loops of connected FMUs during <strong>Initialization Mode</strong>.]</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="variableNamingConvention">2.4.10. Variable Naming Conventions</h4>
<div class="paragraph">
<p>With attribute <code>variableNamingConvention</code> in <code>&lt;fmiModelDescription&gt;</code>, the convention is defined how the variable names have been constructed.
If this information is known, the environment may be able to represent the names in a better way (for example, as a tree and not as a linear list).</p>
</div>
<div class="paragraph">
<p>In the following definitions, the <a href="http://en.wikipedia.org/wiki/Extended_BNF">EBNF</a> is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>=   production rule
[ ] optional
{ } repeat zero or more times
|   or</pre>
</div>
</div>
<div class="paragraph">
<p>The names must be unique, non-empty strings.<br>
<em>[It is recommended that the names are visually clearly different from each other; but it is not required.]</em></p>
</div>
<div class="paragraph">
<p>The following conventions for scalar names are defined:</p>
</div>
<div class="paragraph">
<p><strong><code>variableNamingConvention = flat</code></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>name = Unicode-char { Unicode-char } // identical to xs:normalizedString
Unicode-char = any Unicode character without carriage return (#xD),
line feed (#xA) nor tab (#x9)</pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>variableNamingConvention = structured</code></strong></p>
</div>
<div class="paragraph">
<p>Structured names are hierarchical using "." as a separator between hierarchies.
A name consists of "_", letters and digits or may consist of any characters enclosed in single apostrophes.
A name may identify an array element on every hierarchical level using "[&#8230;&#8203;]" to identify the respective array index.
If an array is a leaf node of the variable hierarchy then the array can also be represented as a single variable of type array.
A <a href="#derivative"><code>derivative</code></a> of a variable is defined with <code>der(name)</code> for the first time derivative and <code>der(name,N)</code> for the N-th derivative.
Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vehicle.engine.speed
resistor12.u
v_min
robot.axis.'motor #234'
der(pipe[3,4].T[14],2) // second time derivative of pipe[3,4].T[14]</pre>
</div>
</div>
<div class="paragraph">
<p>The precise syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>name            = identifier | "der(" identifier ["," unsignedInteger ] ")"
identifier      = B-name [ arrayIndices ] {"." B-name [ arrayIndices ] }
B-name          = nondigit { digit | nondigit } | Q-name
nondigit        = "pass:[_]" | letters "a" to "z" | letters "A" to "Z"
digit           = "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"
Q-name          = "'" ( Q-char | escape ) { Q-char | escape } "'"
Q-char          = nondigit | digit | "!" | "#" | "$" | "%" | "&amp;" | "(" | ")" |
                                     "*" | "+" | "," | "-" | "." | "/" | ":" |
                                     ";" | "&lt;" | "&gt;" | "=" | "?" | "@" | "[" |
                                     "]" | "^" | "{" | "}" | "|" | "~" | " "
escape          = "\'" | "\"" | "\?" | "\\" | "\a" | "\b" |
                  "\f" | "\n" | "\r" | "\t" | "\v"
arrayIndices    = "[" unsignedInteger {"," unsignedInteger} "]"
unsignedInteger = digit { digit }</pre>
</div>
</div>
<div class="paragraph">
<p><em>[This definition is identical to the syntax of an identifier in Modelica version 3.2.]</em></p>
</div>
<div class="paragraph">
<p>The tree of names is mapped to an ordered list of variable names in <a href="http://en.wikipedia.org/wiki/Depth-first_search">depth-first</a> order.
Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vehicle
  transmission
    ratio
    outputSpeed
  engine
    inputSpeed
    temperature</pre>
</div>
</div>
<div class="paragraph">
<p>is mapped to the following list of variable names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vehicle.transmission.ratio
vehicle.transmission.outputSpeed
vehicle.engine.inputSpeed
vehicle.engine.temperature</pre>
</div>
</div>
<div class="paragraph">
<p>All flattened array elements are given in a consecutive sequence of variables.
Elements of multi-dimensional arrays are ordered according to "row major" order that is elements of the last index are given in sequence.</p>
</div>
<div class="paragraph">
<p><em>[For example, the vector <code>centerOfMass</code> in body <code>arm1</code> is mapped to the following variables:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>robot.arm1.centerOfMass[1]
robot.arm1.centerOfMass[2]
robot.arm1.centerOfMass[3]</pre>
</div>
</div>
<div class="paragraph">
<p><em>[For example, a controller might receive 3 rpm sensors mapped to the following variables:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>transmission.rpms[0]
transmission.rpms[1]
transmission.rpms[2]</pre>
</div>
</div>
<div class="paragraph">
<p><em>For example, a table <code>T[4,3,2]</code> (first dimension 4 entries, second dimension 3 entries, third dimension 2 entries) is mapped to the following variables:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>T[1,1,1]
T[1,1,2]
T[1,2,1]
T[1,2,2]
T[1,3,1]
T[1,3,2]
T[2,1,1]
T[2,1,2]
T[2,3,1]
...</pre>
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>It might be that not all elements of an array are present.
If they are present, they are given in consecutive order in the XML file.</p>
</div>
<div class="paragraph">
<p>The <code>variableNamingConvention</code> <code>structured</code> does not define if arrays are 0-based or 1-based.</p>
</div>
<div class="paragraph">
<p><em>[FMI 3.0 introduces arrays of variables to improve handling of arrays.]</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fmu-distribution">2.5. FMU Distribution</h3>
<div class="paragraph">
<p>An FMU consists of several files, that are stored in a ZIP file with a pre-defined structure.
The implementation of the simulation model represented by the FMU may be distributed in source code and/or in binary format.
The FMU must be distributed with at least one implementation, in other words, either sources or one of the binaries for a particular machine.
It is also possible to provide the sources and binaries for different target machines together in one ZIP file.
The FMU must implement all common API functions according to <a href="#general-mechanisms">Section 2.2</a> and the functions for at least one of the FMI interface types.
Especially it is required that all functions that are part of the specified FMI interface type are present, even if they are only needed for optional capabilities that the FMU does not support.
The behavior of those functions is unspecified, so while calling environments can rely on the functions being present, they cannot rely on any particular behavior for functions only needed for capabilities the FMU does not support.
The extension of the ZIP file must be <code>.fmu</code> <em>[, for example, <code>HybridVehicle.fmu</code>]</em>.
The compression method used for the ZIP file must be <code>deflate</code> <em>[(most free tools, such as zlib, offer only the common compression method <code>deflate</code>)]</em>.</p>
</div>
<div class="paragraph">
<p><em>[Note: especially section 4.4.17 of <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">the ZIP format specification</a> states that backslashes "\" are forbidden as path separator, only forward slashes "/" are allowed.</em><br>
<em>Non-ASCII directory names are not explicitly forbidden, but might pose a problem on different operating systems and are thus discouraged.]</em></p>
</div>
<div class="paragraph">
<p>Every FMU is distributed with its own ZIP file.</p>
</div>
<div class="sect3">
<h4 id="structure-of-zip">2.5.1. Structure of the ZIP file</h4>
<div class="listingblock">
<div class="content">
<pre>// Structure of ZIP file of an FMU
modelDescription.xml          // description of FMU (required file)
documentation                 // directory containing the documentation (optional)
   index.html                 // entry point of the documentation
   diagram.png                // descriptive diagram view of the model (optional)
   diagram.svg                // if existing the diagram.png is required (optional)
   &lt;other documentation files&gt;
   licenses                   // directory for licenses (optional)
      license.{txt|html}      // Entry point for license information
      &lt;license files&gt;         // For example BSD licenses
icons                         // FMU and terminal icons (optional)
   terminalsAndIcons.xml      // description of terminals and icons (optional)
   icon.png                   // image file of icon without terminals (optional)
   icon.svg                   // if existing the icon.png is required (optional)
   // all terminal and fmu icons referenced in the graphical representation
sources                       // directory containing the C sources (optional)
   buildDescription.xml
   // All needed C sources and header files to compile and link the FMU
   // except fmi3PlatformTypes.h, fmi3FunctionTypes.h, and fmi3Functions.h.
   // The files to be compiled (but not the files included from these files)
   // have to be reported in the buildDescription.xml.
binaries                      // directory containing the binaries (optional)
   x86_64-windows             // binaries for Windows on Intel 64-bit
      &lt;modelIdentifier&gt;.dll   // shared library of the FMI implementation
      &lt;other DLLs&gt;            // the DLL can include other DLLs
   x86_64-windows-msvc140mt   // static libraries for 64-bit Windows generated
      &lt;modelIdentifier&gt;.lib   // with Visual Studio 2015 with /MT flag
   i686-linux                 // binaries for Linux on Intel 32-bit
      &lt;modelIdentifier&gt;.so    // shared library of the FMI implementation
   aarch32-linux              // binaries for Linux on ARM 32-bit
      &lt;modelIdentifier&gt;.so    // shared library of the FMI implementation
   x86_64-darwin              // binaries for macOS
      &lt;modelIdentifier&gt;.dylib // shared library of the FMI implementation
   // If an FMU is run through one of its binaries all items in that binary
   // folder are recommended to be unpacked at the same location as the binary
   // &lt; modelIdentifier &gt;.* is unpacked. If not it is likely that, if the FMU
   // has dependencies on those items, it will not be able to find them.
resources                     // resources used by the FMU (optional)
   // data in FMU specific files which will be read during initialization;
   // also more folders can be added under resources (tool/model specific).
   // In order for the FMU to access these resource files, the resource directory
   // shall be available in unzipped form and the absolute path to this directory
   // should be reported via argument "resourceLocation" of fmi3InstantiateXXX.
extra                         // Additional (meta-)data of the FMU (optional)
   // additional (meta-)data that is supposed to travel with the FMU;
   // see below for structure and content definition.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="documentation-directory">2.5.2. Documentation Directory</h4>
<div class="sect4">
<h5 id="license-information">2.5.2.1. Licenses Subdirectory</h5>
<div class="paragraph">
<p>This optional subdirectory can be used to bundle all license texts for the code, binaries or other material (documentation, content of resources folder) contained tin the FMU.
If it is present, it must contain either a <code>license.txt</code> or <code>license.html</code> file as entry point.</p>
</div>
<div class="paragraph">
<p><em>[It is strongly recommended to include all license and copyright related information in the licenses folder of an FMU (especially but not only for contained open source software) - the <code>license.{txt|html}</code> file can serve as an entry point for describing the contained licenses.</em>
<em>This will help the users to comply with license conditions when passing source or binary code contained in an FMU to other persons or organizations.]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sources-directory">2.5.3. Sources Directory</h4>
<div class="paragraph">
<p><code>#include</code> directive with <code>"&#8230;&#8203;"</code> should be used for header files distributed in the FMU instead of using <code>&lt;&#8230;&#8203;&gt;</code>.
In case information beyond <code>&lt;BuildConfiguration&gt;</code> is required to compile the FMU for specific targets, the <code>documentation</code> directory is the place to store further instructions.</p>
</div>
<div class="paragraph">
<p><em>[Note that the header files <code>fmi3PlatformTypes.h</code> and <code>fmi3FunctionTypes.h/fmi3Functions.h</code> are not included in the FMU due to the following reasons:</em></p>
</div>
<div class="paragraph">
<p><em><code>fmi3PlatformTypes.h</code> makes no sense in the <code>sources</code> directory, because if sources are provided, then the importer defines this header file and not the FMU.</em><br>
<em>This header file is not included in the <code>binaries</code> directory, because it is implicitly defined by the platform directory (for example, <code>i686-windows</code> for a 32-bit machine or <code>x86_64-linux</code> for a 64-bit machine).</em></p>
</div>
<div class="paragraph">
<p><em><code>fmi3FunctionTypes.h</code> / <code>fmi3Functions.h</code> are not needed in the <code>sources</code> directory, because they are implicitly defined by attribute <code>fmiVersion</code> in file <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.</em>
<em>Furthermore, in order that the C compiler can check for consistent function arguments, the header file from the importer should be used when compiling the C sources.</em>
<em>It would therefore be counter-productive (unsafe) if this header file was present.</em><br>
<em>These header files are not included in the <code>binaries</code> directory, since they are already utilized to build the executable of the simulation environment.</em>
<em>The version number of the header file used to construct the FMU can be deduced via attribute <code>fmiVersion</code> in file <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> or via function call <a href="#fmi3GetVersion"><code>fmi3GetVersion</code></a>.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="binarie-directory">2.5.4. Binaries Directory</h4>
<div class="sect4">
<h5 id="platform-tupe-definition">2.5.4.1. Platform Tuple Definition</h5>
<div class="paragraph">
<p>The names of the binary directories are standardized by the "platform tuple".
Further names can be introduced by vendors.
Dynamic link libraries must include all referenced resources that are not available on a standard target machine <em>[for example, DLLs on Windows that are built  with Visual Studio should be compiled with the <code>/MT</code> option to include the required symbols from the Visual C runtime in the DLL, and not use the option <code>/MD</code> where this is not the case]</em>.
When compiling a shared object on Linux, <code>RPATH="$ORIGIN"</code> has to be set when generating the shared object in order that shared objects used from it, can be dynamically loaded.</p>
</div>
<div class="paragraph">
<p>The binaries must be placed in the respective &lt;platformTuple&gt; directory with the general format <code>&lt;arch&gt;-&lt;sys&gt;{-&lt;abi&gt;{&lt;abi_ver&gt;}{&lt;abi_sub&gt;}}</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Architecture <code>&lt;arch&gt;</code></dt>
<dd>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aarch32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARM 32-bit Architecture</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aarch64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARM 64-bit Architecture</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i386</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intel 3rd generation x86 32-bit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i586</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intel 5th generation x86 32-bit w/o SSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i686</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intel 6th generation x86 32-bit with SSE2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x86_64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intel/AMD x86 64-bit</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1">Operating system <code>&lt;sys&gt;</code></dt>
<dd>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">darwin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Darwin (macOS, iOS, watchOS, tvOS, audioOS)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">windows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoft Windows</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1">Application Binary Interface (ABI) <code>&lt;abi&gt;</code></dt>
<dd>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">elf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ELF file format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gnu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GNU</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">android</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Android</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">macho</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mach object file format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">msvc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoft Visual C</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1">ABI version <code>&lt;abi_ver&gt;</code></dt>
<dd>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2005 (MSVC++ 8.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">90</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2008 (MSVC++ 9.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2010 (MSVC++ 10.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2012 (MSVC++ 11.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">120</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2013 (MSVC++ 12.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">140</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2015 (MSVC++ 14.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">141</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio 2017 (MSVC++ 15.0)</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1">Sub-ABI <code>&lt;abi_sub&gt;</code></dt>
<dd>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">md</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio with /MD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio with /MT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mdd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio with /MDd</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mtd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio with /MTd</p></td>
</tr>
</tbody>
</table>
</dd>
</dl>
</div>
<div class="paragraph">
<p><em>[Typical scenarios are to provide binaries only for one machine type (for example, on the machine where the importer is running and for which licenses of run-time libraries are available) or to provide only sources (for example, for translation and download for a particular micro-processor).]</em></p>
</div>
</div>
<div class="sect4">
<h5 id="external-libraries">2.5.4.2. External Libraries</h5>
<div class="paragraph">
<p>If run-time libraries are needed by the FMU that have to be present on the target machine and cannot be shipped within the FMU (e.g., due to licensing issues), then automatic processing is likely impossible.
In such cases special handling is needed, for example, by providing the run-time libraries at appropriate places by the receiver.
The requirements and the expected processing should be documented in the <code>documentation</code> directory in this case.<br></p>
</div>
</div>
<div class="sect4">
<h5 id="dependency-on-exteranl-tool">2.5.4.3. Dependency on Installed Tool</h5>
<div class="paragraph">
<p>FMI provides the means for two kinds of implementation: <code>needsExecutionTool = true</code> and <code>needsExecutionTool = false</code>.
In the first case a tool specific wrapper DLL/SharedObject has to be provided as the binary, in the second a compiled or source code version of the model with its solver is stored (see <a href="#fmi-for-co-simulation">Section 4</a> for details).</p>
</div>
</div>
<div class="sect4">
<h5 id="multiple-interface-types">2.5.4.4. Multiple Interface Types</h5>
<div class="paragraph">
<p>In an FMU multiple interface types might be present.
If in all cases the executable part is provided as a shared library, then one of up to four libraries can be provided.
The library names are defined in the <code>modelIdentifier</code> attribute of elements <code>&lt;fmiModelDescription&gt;&lt;ModelExchange|CoSimulation|ScheduledExecution&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[Example of different libraries:
   binaries
     x86_64-windows
        MyModel_ModelExchange.dll      // modelIdentifier of &lt;ModelExchange&gt; =
                                       //    "MyModel_ModelExchange"
        MyModel_CoSimulation.dll       // modelIdentifier of &lt;CoSimulation&gt; =
                                       //    "MyModel_CoSimulation"
]</pre>
</div>
</div>
<div class="paragraph">
<p><em>[The usual distribution of an FMU will be with DLLs/SharedObjects because then further automatic processing (for example, importing into another tool) is possible.]</em><br></p>
</div>
<div class="paragraph">
<p>A source-based distribution might require manual interaction in order that it can be utilized.
The intention is to support platforms that are not known in advance (such as HIL platforms or microcontrollers).
All source file names that need to be defined in a compiler directive have to be defined in <code>sources/buildDescription.xml</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resources-directory">2.5.5. Resources Directory</h4>
<div class="paragraph">
<p>In the optional directory <code>resources</code>, additional data can be provided in FMU specific formats, typically for tables and maps used in the FMU.
This data must be read into the model at the latest during initialization (that is, before <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> is called).
The actual file names in the ZIP file to access the data files can either be hard-coded in the generated FMU functions, or the file names can be provided as string arguments via the <code>fmi3SetString</code> function.
<em>[Note that an URI pointing to the resources directory is provided by the initialization functions.</em>
<em>If the environment is not able to do so, a NULL pointer will be provided instead, and the FMU can react with an error, if it requires access to the content of the resources folder.]</em>
In the case of an FMU implementation of <code>needsExecutionTool = true</code> type, the <code>resources</code> directory can contain the model file in the tool specific file format.</p>
</div>
</div>
<div class="sect3">
<h4 id="extra-directory">2.5.6. Extra Directory</h4>
<div class="paragraph">
<p>The ZIP archive may contain additional entries with the prefix <code>extra/</code> that can be used to store additional data and meta-data.
In order to avoid ambiguities and conflicts, the extra files should be provided in subdirectories using a reverse domain notation of a domain that is controlled by the entity defining the semantics and content of the additional entries <em>[(for example <code>extra/com.example/SimTool/meta.xml</code> or <code>extra/org.example.stdname/data.asd</code>)]</em>.
The use of subdirectories beginning with <code>org.modelica</code> and <code>org.fmi-standard</code> is explicitly reserved for use by MAP FMI-defined layered standards, i.e. other uses must not use subdirectory names beginning with these prefixes.
It is explicitly allowed for tools and users other than the original creator of an FMU to modify, add or delete entries in the <code>extra/</code> directory without affecting the validity of the FMU in all other aspects.
Specifically all validation or digital signature schemes used to protect the content of the FMU should take the variability of extra file content into account <em>[(for example by having separate checksums or signatures for FMU core content and extra content, or not having signatures at all for extra content)]</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_supporting_multiple_interface_types_in_one_fmu">2.5.7. Supporting Multiple Interface Types in one FMU</h4>
<div class="paragraph">
<p>Exporters are encouraged to support multiple FMI interface types in one FMU, so it can be used in differently capable simulation algorithms and for different use cases.
To indicate support for a specific interface type, the <code>&lt;fmiModelDescription&gt;</code> must have the respective element present.<br>
<em>[That improves the reusability of FMUs.</em>
<em>A common application of this multiple mode support is the reuse of FMUs for real-time and non-real-time simulations.]</em><br>
The described multi-mode support is based on wrapping functionality into the <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> function by emulating missing features of the Co-Simulation or Model Exchange interface types, the FMU has been specifically exported for.<br>
<em>[An FMU that supports <a href="#scheduled-execution-api">Scheduled Execution</a> will in most cases also support <a href="#co-simulation-api">Co-Simulation</a>.</em>
<em>Wrapping towards other the Co-Simulation interface can influence the simulation results.</em>
<em>Especially <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>input clocks</code></a> can not always be sufficiently emulated in modes that do not directly support <a href="#clock"><code>clocks</code></a>.</em>
<em>Therefore it is recommended that the FMU provides logging information to the user about the influence of the current mode on simulation results, if non-optimal modes are used by the simulation environment.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_import_examples">2.5.8. Import Examples</h4>
<div class="paragraph">
<p>The following code examples demonstrate how to access the FMI functions of FMUs that are implemented as a shared library or static library / source code.</p>
</div>
<div class="sect4">
<h5 id="_accessing_fmi_functions_in_shared_libraries">2.5.8.1. Accessing FMI Functions in Shared Libraries</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">/* This example demonstrates how to import an FMU implemented as a shared library */

#ifdef _WIN32
#include &lt;Windows.h&gt;
#else
#include &lt;dlfcn.h&gt;
#endif

#include &lt;stdlib.h&gt;

// FMI function types
#include "fmi3FunctionTypes.h"

#define INSTANTIATION_TOKEN "{8c4e810f-3da3-4a00-8276-176fa3c9f000}"

#ifdef _WIN32
#define RESOURCE_LOCATION "file:/C:/tmp/VanDerPol"
#else
#define RESOURCE_LOCATION "file:///var/tmp/VanDerPol"
#endif

static void cb_logMessage(fmi3InstanceEnvironment instanceEnvironment, fmi3String instanceName, fmi3Status status, fmi3String category, fmi3String message) {
    // log message...
}

int main(int argc, char* argv[]) {

#if defined(_WIN32)
    HMODULE libraryHandle = LoadLibrary("VanDerPol\\binaries\\x86_64-windows\\VanDerPol.dll");
#elif defined(__APPLE__)
    void *libraryHandle = dlopen("VanDerPol/binaries/x86_64-darwin/VanDerPol.dylib", RTLD_LAZY);
#else
    void *libraryHandle = dlopen("VanDerPol/binaries/x86_64-linux/VanDerPol.so", RTLD_LAZY);
#endif

    if (!libraryHandle) {
        return EXIT_FAILURE;
    }

    fmi3InstantiateModelExchangeTYPE *instantiateModelExchange =
#ifdef _WIN32
        GetProcAddress(libraryHandle, "fmi3InstantiateModelExchange");
#else
        dlsym(libraryHandle, "fmi3InstantiateModelExchange");
#endif

    fmi3FreeInstanceTYPE *freeInstance =
#ifdef _WIN32
        GetProcAddress(libraryHandle, "fmi3FreeInstance");
#else
        dlsym(libraryHandle, "fmi3FreeInstance");
#endif

    // load remaining FMI functions...

    if (!instantiateModelExchange || !freeInstance) {
        return EXIT_FAILURE;
    }

    fmi3Instance m = instantiateModelExchange(
        "instance1",             // instance name
        INSTANTIATION_TOKEN,     // instantiation token (from XML)
        RESOURCE_LOCATION,       // resource location (extracted FMU)
        fmi3False,               // visible
        fmi3False,               // debug logging disabled
        NULL,                    // instance environment
        cb_logMessage);          // logger callback


    if (!m) {
        return EXIT_FAILURE;
    }

    // simulation...

    freeInstance(m);

    // unload shared library
#ifdef _WIN32
    FreeLibrary(libraryHandle);
#else
    dlclose(libraryHandle);
#endif

    return EXIT_SUCCESS;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_accessing_fmi_functions_in_static_libraries_and_source_code">2.5.8.2. Accessing FMI Functions in Static Libraries and Source Code</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">/* This example demonstrates how to import an FMU implemented as a static library or source code*/

// FMI function prefix (from XML)
#define FMI3_FUNCTION_PREFIX VanDerPol_
#include "fmi3Functions.h"
#undef FMI3_FUNCTION_PREFIX

#define INSTANTIATION_TOKEN "{8c4e810f-3da3-4a00-8276-176fa3c9f000}"


static void cb_logMessage(fmi3InstanceEnvironment instanceEnvironment, fmi3String instanceName, fmi3Status status, fmi3String category, fmi3String message) {
    // log message
}

int main(int argc, char* argv[]) {

    fmi3Instance m = VanDerPol_fmi3InstantiateModelExchange(
        "instance1",             // instance name
        INSTANTIATION_TOKEN,     // instantiation token (from XML)
        "file:///tmp/VanDerPol", // resource location (extracted FMU)
        fmi3False,               // visible
        fmi3False,               // debug logging disabled
        NULL,                    // instance environment
        cb_logMessage);          // logger callback

    // simulation ...

    VanDerPol_fmi3FreeInstance(m);

    return m ? EXIT_SUCCESS : EXIT_FAILURE;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_definition_of_source_code">2.6. Definition of Source Code</h3>
<div class="paragraph">
<p>A source code FMU contains the sources of the model in the <code>sources</code> directory together with a <code>buildDescription.xml</code> that contains at least one <code>&lt;BuildConfiguration&gt;</code> element for the supported platforms.
Each <code>&lt;BuildConfiguration&gt;</code> provides the necessary information to compile and link the sources of the model into a dynamic library or as part of an executable.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>modelIdentifier</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The attribute <code>modelIdentifier</code> of the <code>&lt;ModelExchange&gt;</code>, <code>&lt;CoSimulation&gt;</code> or <code>&lt;ScheduledExecution&gt;</code> elements this build configuration is associated with.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>platform</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Platform tuple of the platform the build configuration is intended for (e.g. <code>x86_64-linux</code>)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description of the build configuration</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_sourcefileset">2.6.1. SourceFileSet</h4>
<div class="paragraph">
<p>The <code>&lt;SourceFileSet&gt;</code> element groups source files that can be compiled with the same compiler and compiler options.
Every build configuration must contain at least one <code>&lt;SourceFileSet&gt;</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>language</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Language of the source files (e.g. <code>C99</code>, <code>C++11</code>)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compiler</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The compiler to compile the sources (e.g. <code>VisualC</code>, <code>gcc</code>, <code>clang++</code>)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compilerOptions</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The compiler flags that have to be used when compiling the sources (e.g. <code>-fno-rtti</code>, <code>/Od</code>)</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_sourcefile">2.6.1.1. SourceFile</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path of the source file relative to the <code>sources</code> directory</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_preprocessordefinition">2.6.1.2. PreprocessorDefinition</h5>
<div class="paragraph">
<p>The <code>&lt;PreprocessorDefinition&gt;</code> element defines a preprocessor definition that needs to be passed to the compiler when compiling the source files in the <code>&lt;SourceFileSet&gt;</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Name of the preprocessor definition</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Value of the preprocessor definition</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>optional</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Determines wether the definition is optional (default is <code>false</code>)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description of the preprocessor definition</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_preprocessordefinitionoption">2.6.1.3. PreprocessorDefinition/Option</h5>
<div class="paragraph">
<p>The <code>&lt;Option&gt;</code> element defines a possible value for the <code>&lt;PreprocessorDefinition&gt;</code>.
If a <code>&lt;PreprocessorDefinition&gt;</code> contains <code>&lt;Option&gt;</code> elements, its default value must be contained in the options.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Value of the preprocessor definition option</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description of the preprocessor definition option</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_includedirectory">2.6.1.4. IncludeDirectory</h5>
<div class="paragraph">
<p>The <code>&lt;IncludeDirectory&gt;</code> element defines the include directories that need to be passed to the compiler when compiling the source files in the <code>&lt;SourceFileSet&gt;</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path of the include directory relative to the <code>sources</code> directory</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_library">2.6.2. Library</h4>
<div class="paragraph">
<p>The <code>&lt;Library&gt;</code> element defines a static library required to link the model binary.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Name of the library</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Version specifier of the library as defined in <a href="https://www.python.org/dev/peps/pep-0440/#version-specifiers">PEP 440</a>.
The characters <code>&gt;</code> (greater-than) and <code>&lt;</code> (less-than) must be escaped as <code>&gt;</code> and <code>&lt;</code>.
 <em>[For example <code>2.5</code>, <code>&gt;=2.0,&lt;3.0</code> or <code>&gt;=1.0,!=1.2</code>]</em>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>external</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Boolean attribute that determines wether the library is contained in the <code>binaries/&lt;platform_tuple&gt;</code> directory (<code>false</code>) or if it has to be provided by the environment (<code>true</code>).
The default is <code>false</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Description of the library definition option</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_examples">2.6.3. Examples</h4>
<div class="listingblock">
<div class="title">A minimal build configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;fmiBuildDescription fmiVersion="3.0-alpha.5"&gt;

  &lt;BuildConfiguration modelIdentifier="PIDContoller"&gt;
    &lt;SourceFileSet&gt;
      &lt;SourceFile name="all.c"/&gt;
    &lt;/SourceFileSet&gt;
  &lt;/BuildConfiguration&gt;

&lt;/fmiBuildDescription&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Multiple complex build configurations</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;fmiBuildDescription fmiVersion="3.0-alpha.5"&gt;

  &lt;BuildConfiguration modelIdentifier="PlantModel" description="Build configuration for desktop platforms"&gt;
    &lt;SourceFileSet language="C99"&gt;
      &lt;SourceFile name="fmi3Functions.c"/&gt;
      &lt;SourceFile name="solver.c"/&gt;
    &lt;/SourceFileSet&gt;
    &lt;SourceFileSet language="C++11"&gt;
      &lt;SourceFile name="model.c"/&gt;
      &lt;SourceFile name="logging/src/logger.c"/&gt;
      &lt;PreprocessorDefinition name="FMI_VERSION" value="3"/&gt;
      &lt;PreprocessorDefinition name="LOG_TO_FILE" optional="true"/&gt;
      &lt;PreprocessorDefinition name="LOG_LEVEL" value="0" optional="true"&gt;
        &lt;Option value="0" description="Log infos, warnings and errors"/&gt;
        &lt;Option value="1" description="Log warnings and errors"/&gt;
        &lt;Option value="2" description="Log only errors"/&gt;
      &lt;/PreprocessorDefinition&gt;
      &lt;IncludeDirectory name="logging/include"/&gt;
    &lt;/SourceFileSet&gt;
    &lt;Library name="hdf5" version="&amp;gt;=1.8,!=1.8.17,&amp;lt;1.10" external="true" description="HDF5"/&gt;
  &lt;/BuildConfiguration&gt;

  &lt;BuildConfiguration modelIdentifier="PlantModel" platform="aarch64-linux"&gt;
    &lt;SourceFileSet language="C99"&gt;
      &lt;SourceFile name="fmi3Functions.c"/&gt;
    &lt;/SourceFileSet&gt;
    &lt;SourceFileSet language="C++11" compiler="clang++" compilerOptions="-fno-rtti"&gt;
      &lt;SourceFile name="model.c"/&gt;
      &lt;PreprocessorDefinition name="NO_FILE_SYSTEM"/&gt;
    &lt;/SourceFileSet&gt;
    &lt;Library name="libm.a" description="OpenLibm math library"/&gt;
  &lt;/BuildConfiguration&gt;

&lt;/fmiBuildDescription&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="VersioningLayered">2.7. Versioning and Layered Standards</h3>
<div class="paragraph">
<p>The FMI standard uses semantic version numbers, as defined in <a href="#PW13">[PW13]</a>, where the standard version consists of a triple of version numbers, consisting of major version, minor version, and patch version numbers <em>[e.g. 1.2.3 for major version 1, minor version 2 and patch version 3]</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Major versions will introduce changes that are neither backward nor forward-compatible, including changes to the XML schemas to include new non-ignorable content.</p>
</li>
<li>
<p>Minor versions will only contain clarifications and include new layered standards, which may add new ignorable XML content, as defined below, into the core standard document, indicating that the standard needs to be supported by all conforming implementations.</p>
</li>
<li>
<p>Patch versions will only change explanatory text of the standard, make formerly defined content clearer, without any other changes to the XML schemas or other content definitions. For this reason, the version number attribute of all FMI files will only contain major and minor version numbers and not the patch version number: It should never be necessary for an importing tool to know the patch version number of the standard that the generating tool implemented.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to enable the backward-compatible extension of the FMI standard in minor releases and between minor releases, the FMI project intends the use of the layered standard mechanism to introduce new features in a fully backward-compatible and optional way.<br>
A layered standard defines extensions to the base FMI standard by specifying either standardized annotations, standardized extra files in the FMU, and/or support for additional MIME types/file formats, defined in <a href="#definition-of-types">Section 2.4.4</a>. <br>
A layered standard can include a single or combined set of extension mechanisms from this set.<br>
The layered standard is thus considered to be layered on top of the definitions and extensions mechanisms provided by this base standard.</p>
</div>
<div class="paragraph">
<p>Layered standards can fall into three categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Layered standards defined by third parties, without any representations by the FMI project for their suitability or content, or even knowledge by the FMI project about their existence.</p>
</li>
<li>
<p>Layered standards defined by third parties that are endorsed by the FMI project and listed on the FMI project website.</p>
</li>
<li>
<p>Layered standards can be defined/adopted and published by the FMI project itself, making them FMI project layered standards.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Layered standards that have achieved enough adoption or importance to be included into the base standard set could be incorporated into a new minor or major release version of the base standard as an optional or mandatory appendix, making support for this layered standard optional or required for conformance with the newly published minor release version of the base standard.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fmi-for-model-exchange">3. FMI for Model Exchange</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter contains the interface description to access the equations of a dynamic system from a C program.
A schematic view of a model in FMI for Model Exchange format is shown in <a href="#figure-model-exchange-data-flow">Figure 25</a>:</p>
</div>
<div id="figure-model-exchange-data-flow" class="imageblock text-center">
<div class="content">
<img src="images/model-exchange-data-flow.svg" alt="model exchange data flow" width="80%">
</div>
<div class="title">Figure 25. Data flow between the environment and an FMU for Model Exchange</div>
</div>
<div class="paragraph">
<p><strong class="blue">Blue</strong> arrows: Information provided by the FMU.<br>
<strong class="red">Red</strong> arrows : Information provided to the FMU.<br>
\(\mathbf{v}_{\mathit{start}}\), \(\mathbf{u}\), \(\mathbf{y}\), and \(\mathbf{w}\), are of a numeric type or string;
\(\mathbf{t}\), \(\mathbf{x}_c\), \(\mathbf{z}\) are of floating point type.</p>
</div>
<div class="paragraph">
<p>The goal of the Model Exchange interface is to numerically solve a system of differential, algebraic and discrete-time equations.
In this version of the interface, ordinary differential equations in state-space representation with events are handled (abbreviated as "hybrid ODE").
Algebraic equation systems might be contained inside the FMU.
Also, the FMU might consist of discrete-time equations only, for example, describing a sampled-data controller.</p>
</div>
<div class="sect2">
<h3 id="math-model-exchange">3.1. Mathematical Description</h3>
<div class="sect3">
<h4 id="computation-modes-model-exchange">3.1.1. Computation Modes</h4>
<div class="paragraph">
<p>Computing the solution of an FMI model means to split the solution process in different phases, and in every phase different equations and solution methods are utilized.
The phases can be categorized according to the following modes:</p>
</div>
<div class="sect4">
<h5 id="_initialization_mode">3.1.1.1. Initialization Mode</h5>
<div class="paragraph">
<p>This mode is used to compute at the start time \(t_0\) initial values for continuous-time <a href="#state"><code>states</code></a> \(\mathbf{x}_c(t_0)\), and for the previous (internal) discrete-time states \(\mathbf{x}_d(t_0)\), by utilizing extra equations not present in the other modes (for example, equations to define the <a href="#start"><code>start</code></a> value for a <a href="#state"><code>state</code></a> or for the derivative of a <a href="#state"><code>state</code></a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_continuous_time_mode">3.1.1.2. Continuous-Time Mode</h5>
<div class="paragraph">
<p>This mode is used to compute the values of all floating point continuous-time variables between events by numerically solving ordinary differential and algebraic equations.
All discrete-time variables are fixed during this phase and the corresponding discrete-time equations are not evaluated.</p>
</div>
</div>
<div class="sect4">
<h5 id="_event_mode">3.1.1.3. Event Mode</h5>
<div class="paragraph">
<p>This mode is used to compute new values for all continuous-time variables, as well as for all discrete-time variables that are activated at the current event instant \(t\), given the values of the variables from the previous instant \({}^{\bullet}t\).
This is performed by solving algebraic equations consisting of all continuous-time and all active discrete-time equations.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_model_evaluations_dependencies_and_call_sequence">3.1.2. Model Evaluations, Dependencies, and Call Sequence</h4>
<div class="paragraph">
<p>When connecting FMUs together, loop structures can occur that lead to particular difficulties because linear or non-linear algebraic systems of equations in floating point variables but also in Boolean or Integer variables might be present.
In order to solve such systems of equations over FMUs efficiently, the dependency information is needed stating, for example, which <a href="#output"><code>outputs</code></a> depend directly on <a href="#input"><code>inputs</code></a>.
This data is optionally provided in the XML file under element <code>&lt;ModelStructure&gt;</code>.
If this data is not provided, the worst case must be assumed, that is, all <a href="#output"><code>output</code></a> variables depend algebraically on all <a href="#input"><code>input</code></a> variables.</p>
</div>
<div class="paragraph">
<p><em>[Example: In <a href="#figure-connected-fmus">Figure 26</a> two different types of connected FMUs are shown (the "dotted lines" characterize the dependency information):</em></p>
</div>
<div id="figure-connected-fmus" class="imageblock text-center">
<div class="content">
<img src="images/ArtificialAlgebraicLoops.svg" alt="ArtificialAlgebraicLoops" width="80%">
</div>
<div class="title">Figure 26. Calling sequences for FMUs that are connected in a loop.</div>
</div>
<div class="paragraph">
<p><em>In the left diagram, FMU1 and FMU2 are connected in such a way that by an appropriate sequence of <code>fmi3Set{VariableType}</code> and <code>fmi3Get{VariableType}</code> calls, the FMU variables can be computed with the following call sequence:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">fmi3Instance FMI1, FMI2;
fmi3ValueReference vr_FMU1_u, vr_FMU1_y, vr_FMU2_u1, vr_FMU2_u2, vr_FMU2_y1, vr_FMU2_y2;
fmi3Float64 s=0.1, FMU2_y1, FMU1_y, FMU2_y2;

...

fmi3SetFloat64(FMU2, &amp;vr_FMU2_u1, 1, &amp;s,        1);
fmi3GetFloat64(FMU2, &amp;vr_FMU2_y1, 1, &amp;FMU2_y1,  1);
fmi3SetFloat64(FMU1, &amp;vr_FMU1_u,  1, &amp;FMU2_y1,  1);
fmi3GetFloat64(FMU1, &amp;vr_FMU1_y,  1, &amp;FMU1_y,   1);
fmi3SetFloat64(FMU2, &amp;vr_FMU2_u2, 1, &amp;FMU1_y,   1);
fmi3GetFloat64(FMU2, &amp;vr_FMU2_y1, 1, &amp;FMU2_y2,  1);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>In the right diagram, FMU3 and FMU4 are connected in such a way that a real algebraic loop is present.</em>
<em>This loop might be solved iteratively with a Newton method.</em>
<em>In every iteration the iteration variable \(u_4\) is provided by the solver, and via the shown sequence of <code>fmi3Set{VariableType}</code> and <code>fmi3Get{VariableType}</code> calls, the residual is computed and is provided back to the solver.</em>
<em>Based on the residual a new value of \(u_4\) is provided.</em>
<em>The iteration is terminated when the residual is close to zero.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">fmi3Instance FMI1, FMI2;
fmi3ValueReference vr_FMU3_u, vr_FMU3_y, vr_FMU4_u, vr_FMU4_y;
fmi3Float64 s, FMU3_y, FMU4_y, residual;
bool converged;

// Newton iteration
while (!converged)
{
  // input s[0] calculated by the solver
  ...
  fmi3SetFloat64(FMU2, &amp;vr_FMU4_u, 1, &amp;s,   1);
  fmi3GetFloat64(FMU2, &amp;vr_FMU4_y, 1, &amp;FMU4_y,  1);
  fmi3SetFloat64(FMU1, &amp;vr_FMU3_u, 1, &amp;FMU4_y,  1);
  fmi3GetFloat64(FMU1, &amp;vr_FMU3_y, 1, &amp;FMU3_y,  1);
  residual=s-FMU3_y; // provided to the solver
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>These types of artificial or real algebraic loops can occur in all the different modes, such as <strong>Initialization Mode</strong>, <strong>Event Mode</strong>, and <strong>Continuous-Time Mode</strong>.</em>
<em>Since different variables are computed in every mode and the causality of variable computation can be different in <strong>Initialization Mode</strong> as with respect to the other two modes, it might be necessary to solve different kinds of loops in the different modes.]</em></p>
</div>
<div class="paragraph">
<p>In <a href="#table-math-model-exchange">Table 9</a> the equations are defined that can be evaluated in the respective mode.
The following color coding is used in the table:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="silver"><strong>grey</strong></span>: If a variable in an argument list is marked in <span class="silver">grey</span>, then this variable is not changing in this mode and just the last calculated value from the previous mode is internally used.
For an input argument, it is not allowed to call <code>fmi3Set{VariableType}</code>.
For an output argument, calling <code>fmi3Get{VariableType}</code> on such a variable returns always the same value in this mode.</p>
</li>
<li>
<p><span class="lime"><strong>green</strong></span>: Functions marked in <span class="lime">green</span> are special functions to enter or leave a mode.</p>
</li>
<li>
<p><span class="blue"><strong>blue</strong></span>: Equations and functions marked in <span class="blue">blue</span> define the actual computations to be performed in the respective mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[In <a href="#table-math-model-exchange">Table 9</a>, the setting of the super-dense time, (\(t_R\), \(t_I\)), is precisely described.</em>
<em>Tools will usually not have such a representation of time.</em>
<em>However, super-dense time defines precisely when a new "model evaluation" starts and therefore which variable values belong to the same "model evaluation" at the same (super-dense) time instant and should be stored together.]</em></p>
</div>
<table id="table-math-model-exchange" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Mathematical description of an FMU for Model Exchange.</caption>
<colgroup>
<col style="width: 62.5%;">
<col style="width: 37.5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FMI functions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations before <strong>Initialization Mode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set variables \(\mathbf{v}_{\mathit{initial=exact}}\) and \(\mathbf{v}_{\mathit{initial=approx}}\)  that have a <a href="#start"><code>start</code></a> value (<a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> or <a href="#approx"><code>approx</code></a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Initialization Mode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Enter <strong>Initialization Mode</strong> at \(t=t_0\) (activate initialization, discrete-time and continuous-time equations).</span>
<mark>Set <a href="#independent"><code>independent</code></a> variable time \(T_{\mathit{R0}}\) and define \(t_0 := (t_{\mathit{R0}},0)\)</mark></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3EnterInitializationMode</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set variables \(\mathbf{v}_{\mathit{initial=exact}}\) that have a <a href="#start"><code>start</code></a> value with
<a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> (<a href="#parameter"><code>parameters</code></a> \(\mathbf{p}\) and
continuous-time <a href="#state"><code>states</code></a> with <a href="#start"><code>start</code></a> values \(\mathbf{x}_{\mathit{c,initial=exact}}\) are included here)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time and discrete-time <a href="#input"><code>inputs</code></a>  \(\mathbf{u}(\color{grey}t_{\color{grey} 0})\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">\(\mathbf{v}_{\mathit{initialUnknowns}}:=f_{\mathit{init}}(\mathbf{u_c}, \mathbf{u_d}, \color{grey}t_{\color{grey} 0}, \mathbf{v}_{\mathit{initial=exact}}\))</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="blue">fmi3Get{VariableType}</span></code>, <code><span class="blue">fmi3GetContinuousStates</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Exit <strong>Initialization Mode</strong> (de-activate initialization equations)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3ExitInitializationMode</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Event Mode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Enter <strong>Event Mode</strong> at \(t = t_{i}\) with \({t_{i}\ : = (t}_{R},t_{I} + 1)\) <strong>if</strong>  externalEvent <strong>or</strong> nextMode \(\equiv\) EventMode <strong>or</strong> \(t_i=(T_{\mathit{next}}(t_{i-1}), 0)\) <strong>or</strong>  \(\min_{t&gt;t_{i-1}} t:\left\lbrack z_{j}\left( t \right) &gt; 0\  \neq \ z_{j}\left( t_{i-1} \right) &gt; 0 \right\rbrack\)<br>
(activate discrete-time equations)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3EnterEventMode</span></code> <span class="lime">(only from <strong>Continuous-Time Mode</strong>)</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> \(\mathbf{p}_{\mathit{tune}}\)<br>
(and do not set other <a href="#parameter"><code>parameters</code></a> \(\mathbf{p}_{\mathit{other}}\))</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time and discrete-time <a href="#input"><code>inputs</code></a> \(\mathbf{u}(t_i)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time <a href="#state"><code>states</code></a> \(\mathbf{x}_c(t_i)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code>, <a href="#fmi3SetContinuousStates"><code>fmi3SetContinuousStates</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">\((\mathbf{y}_{c+d}, \mathbf{\dot{x}}_c, \mathbf{w}_{c+d}, \mathbf{z}, \mathbf{x}_{c,\mathit{reinit}})=\mathbf{f}_{\mathit{sim}}(\mathbf{x_c}, \mathbf{u_{c+d}}, \color{grey}t_{\color{grey} i}, \mathbf{p}_{\mathit{tune}}, \color{grey}{\mathbf{p}_{\mathit{other}})}\)</span> <br>
\(\mathbf{f}_{\mathit{sim}}\)is also a function of the internal variables \({}^\bullet\mathbf{x}_d\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="blue">fmi3Get{VariableType}</span></code>,
<code><span class="blue">fmi3GetContinuousStates</span></code>,
<code><span class="blue">fmi3GetDerivatives</span></code>
<code><span class="blue">fmi3GetEventIndicators</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Increment super-dense time and define with</span>
<code><span class="lime">newDiscreteStatesNeeded</span></code> <span class="lime">whether a new event iteration is required.</span><br>
<span class="blue">\(\qquad\)<strong>if not</strong></span> <code><span class="blue">newDiscreteStatesNeeded</span></code><span class="blue"><strong>then</strong><br>
\(\qquad \qquad T_{\mathit{next}}=T_{\mathit{next}}(\mathbf{x}_c,{}^\bullet\mathbf{x}_d, \mathbf{u_{c+d}}, \color{grey}t_{\color{grey} i}, \mathbf{p}_{\mathit{tune}}, \color{grey}{\mathbf{p}_{\mathit{other}})}\)</span><br>
<span class="blue">\(\qquad\)<strong>end if</strong></span><br>
<span class="blue">\(\qquad t:=t(t_R, t_i+1)\)</span><br>
<span class="blue">\(\qquad {}^\bullet\mathbf{x}_d:=\mathbf{x}_d\)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3NewDiscreteStates</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Continuous-Time Mode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Enter <strong>Continuous-Time Mode</strong>:</span><br>
<span class="lime">\(\qquad \textrm{// de-activate discrete-time equations}\)</span><br>
<span class="lime">\(\qquad \textrm{// "frozen" variables:}\)</span><br>
<span class="lime">\(\qquad \mathbf{r} := \mathbf{z}&gt;0 \qquad \textrm{//all relations}\)</span><br>
<span class="lime">\(\qquad \textbf{x}_d, \textbf{w}_d \qquad \textrm{//all discrete-time variables}\)</span><br></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3EnterContinuousTimeMode</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <a href="#independent"><code>independent</code></a> variable <em>[typically: time]</em> \(t(&gt;t_{\mathit{enter  mode}}): t:=(\min(t_{Ri} + h, T_{\mathit{next}}), 0)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#fmi3SetTime"><code>fmi3SetTime</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time <a href="#input"><code>inputs</code></a> \(\mathbf{u}_{c}(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time <a href="#state"><code>states</code></a> \(\mathbf{x}_{c}(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code>, <a href="#fmi3SetContinuousStates"><code>fmi3SetContinuousStates</code></a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="blue">\((\mathbf{y}_{c}\mathbf{,} \color{grey}{\mathbf{y}_{d}}\mathbf{,\ }{\dot{\mathbf{x}}}_{c}\mathbf{,}_{}\mathbf{w}_{c}\mathbf{,}\color{grey}{\mathbf{w}_{d}}\mathbf{,z,}\color{grey}{\mathbf{x}_{c,\mathit{reinit}}}):=\mathbf{f}_{\mathit{sim}}(\mathbf{x}_{c},\ \mathbf{u}_{c}\mathbf{,} \color{grey}{\mathbf{\ u}_{d}}, t,\color{grey}{\mathbf{p}_{\mathit{tune}},\mathbf{p}_{\mathit{other}}})\)</span><br>
<span class="blue">\(\qquad \mathbf{f}_{\mathit{sim}}\) is also a function of the internal variables</span> <span class="silver">\({}^\bullet\mathbf{x}_{d},\mathbf{r}\).</span></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code><span class="blue">fmi3Get{VariableType},</span></code>
<code><span class="blue">fmi3GetDerivatives,</span></code>
<code><span class="blue">fmi3GetEventIndicators</span></code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Complete integrator step and return <code>enterEventMode</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="lime">fmi3CompletedIntegratorStep</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Data types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">\(t \in \mathbb{R}, \mathbf{p} \in \mathbb{P}^{np},  \mathbf{u}(t) \in \mathbb{P}^{nu},\mathbf{y}(t) \in \mathbb{P}^{ny}, \mathbf{x}_c(t) \in \mathbb{R}^{nxc}, \mathbf{x}_d(t) \in \mathbb{P}^{nxd}, \mathbf{w}(t) \in \mathbb{P}^{nw}, \mathbf{z}(t) \in \mathbb{R}^{nz}\)<br>
\(\qquad \mathbb{R}\): floating point variable, \(\mathbb{P}\): floating point <strong>or</strong> Boolean <strong>or</strong> integer <strong>or</strong> enumeration <strong>or</strong> string variable<br>
\(\mathbf{f}_{\mathit{init}}, \mathbf{f}_{\mathit{sim}} \in C^0\) (=continuous functions with respect to all input parameters inside the respective mode).<br>
\(h \in \mathbb{R}\) is the simulation step size.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Remark 1 - Calling Sequences:</em></p>
</div>
<div class="paragraph">
<p><em>In <a href="#table-math-model-exchange">Table 9</a>, for notational convenience in every mode one function call is defined to compute all output arguments from all inputs arguments.</em>
<em>In reality, every scalar output argument can be computed by one <code>fmi3Get{VariableType}</code> function call.</em>
<em>Additionally, the output argument need not be a function of all input arguments, but of only a subset from it, as defined in the XML file under <code>&lt;ModelStructure&gt;</code>.</em>
<em>This is essential when FMUs are connected in a loop, as shown in <a href="#figure-connected-fmus">Figure 26</a>.</em>
<em>For example, since</em> \(y_{\mathit{2a}}\) <em>depends only on</em> \(u_{\mathit{1a}}\) <em>, but not on</em> \(u_{\mathit{1b}}\)<em>, it is possible to call</em> <code>fmi3Set{VariableType}</code> <em>to set</em> \(u_{\mathit{1a}}\) <em>, and then inquire</em> \(y_{\mathit{2a}}\) <em>with</em> <code>fmi3Get{VariableType}</code> <em>without setting</em> \(u_{\mathit{1b}}\) <em>beforehand.</em></p>
</div>
<div class="paragraph">
<p><em>It is non-trivial to provide code for <code>fmi3Set{VariableType}</code>, <code>fmi3Get{VariableType}</code>, if the environment can call <code>fmi3Set{VariableType}</code> on the <a href="#input"><code>inputs</code></a> in quite different orders.</em>
<em>A simple remedy is to provide the dependency information, not according to the real functional dependency, but according to the sorted equations in the generated code.</em>
<em>Example:</em></p>
</div>
<div class="paragraph">
<p><em>Assume an FMU is described by the following equations (<code>u1</code>, <code>u2</code> are <a href="#input"><code>inputs</code></a>, <code>y1</code>, <code>y2</code> are <a href="#output"><code>outputs</code></a>,<code>w1</code>, <code>w2</code> are internal variables):</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>w1 = w2 + u1
w2 = u2
y1 = w1
y2 = w2</pre>
</div>
</div>
<div class="paragraph">
<p><em>Sorting of the equations might result in (this ordering is not unique):</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>w2 := u2
y2 := w2
w1 := w2 + u1
y1 := w1</pre>
</div>
</div>
<div class="paragraph">
<p><em>With this ordering, the dependency should be defined as <code>y2 = f(u2), y1 = f(u1,u2)</code>.</em>
<em>When <code>y2</code> is called first with <code>fmi3Get{VariableType}</code>, then only <code>u2</code> must be set first (since <code>y2 = f(u2)</code>), and the first two equations are evaluated.</em>
<em>If later <code>y1</code> is inquired as well, then the first two equations are not evaluated again and only the last two equations are evaluated.</em>
<em>On the other hand, if <code>y1</code> is inquired first, then <code>u1</code> and <code>u2</code> must be set first (since <code>y1 = f(u1,u2)</code>) and then all equations are computed.</em>
<em>When <code>y2</code> is inquired afterwards, the cached value is returned.</em></p>
</div>
<div class="paragraph">
<p><em>If sorting of the equations in this example would instead result in the following code:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>w2 := u2
w1 := w2 + u1
y1 := w1
y2 := w2</pre>
</div>
</div>
<div class="paragraph">
<p><em>then the dependency should be defined as <code>y2 = f(u1,u2)</code>, <code>y1 = f(u1,u2)</code>, because <code>u1</code> and <code>u2</code> must be first set, before <code>y2</code> can be inquired with <code>fmi3Get{VariableType}</code> when executing this code.</em></p>
</div>
<div class="paragraph">
<p><em>Remark 2 - Mathematical Model of Discrete-Time FMUs:</em></p>
</div>
<div class="paragraph">
<p><em>There are many different ways discrete-time systems are described.</em>
<em>For FMI, the following basic mathematical model for discrete-time systems is used (other description forms must be mapped, as sketched below):</em></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remark_2_source.png" alt="remark 2 source" width="70%">
</div>
</div>
<div class="paragraph">
<p><em>At an event instant, the discrete system is described by algebraic equations as function of the previous (internal) discrete-time states&gt;&gt;</em> \(_{}^{\bullet}\mathbf{x}_{d}\) <em>and the discrete-time <a href="#input"><code>inputs</code></a></em> \(\mathbf{u}_{d}\).
<em>If FMUs are connected in a loop, these algebraic equations are called iteratively, until the solution is found.</em>
<em>If the current discrete-time states</em> \(\mathbf{x}_{d}\) <em>and the previous discrete-time states</em> \(_{}^{\bullet}\mathbf{x}_{d}\) <em>are not identical, the discrete-time states are updated, the integer part of the time is incremented and a new event iteration is performed.</em>
<em>Other discrete-time models must be mapped to this description form.</em>
<em>Examples:</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronous systems</dt>
<dd>
<p><em>A synchronous system, such as Lucid Synchrone <a href="#PZ06">[PZ06]</a> or Modelica 3.3 <a href="#MLS12">[MLS12]</a>, is called periodically, and at every sample instant the discrete-time equations are evaluated exactly once.</em>
<em>An FMU of this type should be implemented in FMI 3.0 with <a href="#clock"><code>clocks</code></a>.</em></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><em>However, just like in FMI 2.0, it could in principle also be implemented by activating the model equations only at the first event iteration and returning always <code>newDiscreteStatesNeeded == fmi3False</code> from <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>.</em>
<em>Furthermore, the discrete-time states are not updated by <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>, but as first action before the discrete-time equations are evaluated, in order that</em> \(^{\bullet}\mathbf{x}_d\) <em>(= value at the previous Lucid Synchrone/Modelica 3.3 clock tick) and</em> \(\mathbf{x}_d\) <em>(value at the latest Lucid Synchrone/Modelica 3.3 clock tick) have reasonable values between Lucid Synchrone/Modelica 3.3 clock ticks.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">State machines with one memory location for a state</dt>
<dd>
<p><em>In such a system there is only one memory location for a discrete-time state and not two, and therefore a discrete-time state is updated in the statement where it is assigned (and not in <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>).</em>
<em>As a result, <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> is basically just used to start a new (super-dense) time instant.</em>
<em>This is unproblematic, as long as no algebraic loops occur.</em>
<em>FMUs of this type can therefore not be used in real algebraic loops if the involved variables depend on a discrete-time state.</em>
<em>This restriction is communicated to the environment of the FMU by the <code>ScalarVariable</code> definition of the corresponding <a href="#input"><code>input</code></a> with flag <a href="#canHandleMultipleSetPerTimeInstant"><code>canHandleMultipleSetPerTimeInstant</code></a> <code>= false</code> (so an <a href="#input"><code>input</code></a> with this flag is not allowed to be called in an algebraic loop).</em></p>
</dd>
</dl>
</div>
<div id="Remark3" class="paragraph">
<p><em>Remark 3 - Event Indicators / Frozen Relations:</em></p>
</div>
<div class="paragraph">
<p><em>In <a href="#table-math-model-exchange">Table 9</a>, vector</em> \(\mathbf{r}\) <em>is used to collect all relations together that are utilized in the event indicators</em> \(\mathbf{z}\) <em>.</em>
<em>In <strong>Continuous-Time Mode</strong> all these relations are "frozen" and do not change during the evaluations in the respective mode.</em>
<em>This is indicated in <a href="#table-math-model-exchange">Table 9</a> by computing</em> \(\mathbf{r}\) <em>when entering the <strong>Continuous-Time Mode</strong> and providing</em> \(\mathbf{r}\) <em>as (internal) input argument to the evaluation functions.</em>
<em>Example:</em></p>
</div>
<div class="paragraph">
<p><em>An equation of the form</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>y = if x1 &gt; x2 or x1 &lt; x3 then +1 else -1;</pre>
</div>
</div>
<div class="paragraph">
<p><em>can be implemented in the FMU as:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>z1 := x1 - x2;
z2 := x3 - x1;
if *Initialization Mode* or *Event Mode* then
  r1 := z1 &gt; 0;
  r2 := z2 &gt; 0;
end if;
y = if r1 or r2 then +1 else -1</pre>
</div>
</div>
<div class="paragraph">
<p><em>Therefore, the original if-clause is evaluated in this form only during <strong>Initialization Mode</strong> and <strong>Event Mode</strong>.</em>
<em>In <strong>Continuous-Time Mode</strong> this equation is evaluated as:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>z1 = x1 - x2;
z2 = x3 - x1
y = if r1 or r2 then +1 else -1;</pre>
</div>
</div>
<div class="paragraph">
<p><em>and when entering <strong>Continuous-Time Mode</strong> r1 and r2 are computed as</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>r1 = z1 &gt; 0
r2 = z2 &gt; 0</pre>
</div>
</div>
<div class="paragraph">
<p><em>When z1 changes from z1 &gt; 0 to z1 &#8656; 0 or vice versa, or z2 correspondingly, the integration is halted, and the environment must call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>.</em></p>
</div>
<div class="paragraph">
<p><em>An actual implementation will pack the code into a function with side effects, say Greater(&#8230;&#8203;), resulting in:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>y = if Greater(x1-x2,...) or Greater(x3-x1,...) then +1 else -1;</pre>
</div>
</div>
<div class="paragraph">
<p><em>Furthermore, a hysteresis should be added for the event indicators.]</em></p>
</div>
<div class="paragraph">
<p>An FMU is initialized in <strong>Initialization Mode</strong> with \(\mathbf{f}_{\mathit{init}}(\ldots)\).</p>
</div>
<div class="paragraph">
<p>The input arguments to this function consist of the <a href="#input"><code>input</code></a> variables (= variables with <a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>), of the <a href="#independent"><code>independent</code></a> variable (= variable with <a href="#causality"><code>causality</code></a> = <a href="#independent"><code>independent</code></a> <em>[typically: time]</em>), and of all variables that have a <a href="#start"><code>start</code></a> value with <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> in order to compute the continuous-time <a href="#state"><code>states</code></a> and the output variables at the initial time \(t_0\).
In <a href="#table-math-model-exchange">Table 9</a>, the variables with <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> are collected together in variable \(\mathbf{v}_{\mathit{initial=exact}}\).</p>
</div>
<div class="paragraph">
<p>For example, initialization might be defined by providing initial <a href="#start"><code>start</code></a> values for the <a href="#state"><code>states</code></a>, \(\mathbf{x}_{\mathit{c0}}\), or by stating that the state derivatives are zero (\(\dot{\mathbf{x}}_{c} = \mathbf{0}\)).
Initialization is a difficult topic by itself, and it is required that an FMU solves a well-defined initialization problem inside the FMU in <strong>Initialization Mode</strong>.<br>
After calling <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a>, the FMU is implicitly in <strong>Event Mode</strong>, and all discrete-time and continuous-time variables at the initial time instant \((t_R, 0)\) can be calculated.
If these variables are present in an algebraic loop, iteration can be used to compute them.
Once finalized, <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> must be called, and depending on the value of the return argument, the FMU either continues the event iteration at the initial time instant or switches to <strong>Continuous-Time Mode</strong>.<br>
After switching to <strong>Continuous-Time Mode</strong>, the integration is started.
Basically, during <strong>Continuous-Time Mode</strong>, the <a href="#derivative"><code>derivatives</code></a> of the continuous <a href="#state"><code>states</code></a> are computed.
If FMUs and/or submodels are connected together, then the <a href="#input"><code>inputs</code></a> of these models are the <a href="#output"><code>outputs</code></a> of other models, and therefore, the corresponding FMU outputs must be computed.
Whenever result values shall be stored, usually at output points defined before the start of the simulation, the <code>fmi3Get{VariableType}</code> function with respect to the desired variables must be called.<br>
Continuous integration is stopped at an event instant.
An event instant is determined by a <a href="#time-event"><code>time</code></a>, <a href="#state-event"><code>state</code></a> or <a href="#step-event">step event</a>, or by the environment (e.g. to change a <a href="#continuous"><code>continuous</code></a> variable discretely).</p>
</div>
<div class="paragraph">
<p>In order to determine a <a href="#state-event">state event</a>, the event indicators <strong>z</strong> have to be inquired at every completed integrator step.
Once the event indicators signal a change of their domain, an iteration over time is performed between the previous and the actual completed integrator step, in order to determine the time instant of the domain change up to a certain precision.<br>
After an event is triggered, the FMU needs to be switched to <strong>Event Mode</strong>.
In this mode, systems of equations over connected FMUs might be solved (similarly as in <strong>Continuous-Time Mode</strong>).
Once convergence is reached, <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> must be called to increment super-dense time (and conceptually update the discrete-time states defined internally in the FMU by \(^{\bullet}\mathbf{x}_d := \mathbf{x}_d\)).
Depending on the discrete-time model, a new event iteration might be needed.</p>
</div>
<div class="paragraph">
<p><em>[For example, an FMU implements a state machine that forces an internal state transitions to occur, when new <a href="#input"><code>input</code></a> values are available.]</em></p>
</div>
<div class="paragraph">
<p>The function calls in <a href="#table-math-model-exchange">Table 9</a> describe precisely which input arguments are needed to compute the desired output argument(s).
There is no 1:1 mapping of these mathematical functions to C functions.
Instead, all input arguments are set with <code>fmi3Set{VariableType}</code> C function calls, and then the result argument(s) can be determined with the C functions defined in the right column of <a href="#table-math-model-exchange">Table 9</a>.
This technique is discussed in detail in <a href="#providing-independent-variables-and-re-initialization">Section 3.2.1</a>.
<em>[In short: For efficiency reasons, all equations from <a href="#table-math-model-exchange">Table 9</a> will usually be available in one (internal) C function.</em>
<em>With the C functions described in the next sections, input arguments are copied into the internal model data structure only when their value has changed in the environment.</em>
<em>With the C functions in the right column of <a href="#table-math-model-exchange">Table 9</a>, the internal function is called in such a way that only the minimum needed equations are evaluated.</em>
<em>Hereby, variable values calculated from previous calls can be reused.</em>
<em>This technique is called "caching" and can significantly enhance the simulation efficiency of real-world models.]</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_application_programming_interface">3.2. Application Programming Interface</h3>
<div class="paragraph">
<p>This section contains the interface description to evaluate different model parts from a C program.</p>
</div>
<div class="sect3">
<h4 id="providing-independent-variables-and-re-initialization">3.2.1. Providing Independent Variables and Re-initialization of Caching</h4>
<div class="paragraph">
<p>Depending on the situation, different variables need to be computed.
In order to be efficient, it is important that the interface requires only the computation of variables that are needed in the present context.
For example, during the iteration of an integrator step, only the state derivatives need to be computed, provided the <a href="#output"><code>output</code></a> of a model is not connected.
It might be that at the same time instant other variables are needed.
For example, if an integrator step is completed, the event indicator functions need to be computed as well.
If the state derivatives have already been computed at the present time instant, then it is important for efficiency that they are not newly computed in the call to compute the event indicator functions.
This means, the state derivatives shall be reused from the previous call.
This feature is called "caching of variables" in the sequel.<br>
Caching requires that the model evaluation can detect when the input arguments, like time or states, have changed.
This is achieved by setting them explicitly with a function call, since every such function call signals precisely a change of the corresponding variables.
For this reason, this section contains functions to set the input arguments of the equation evaluation functions.
This is unproblematic for time and states, but is more involved for <a href="#parameter"><code>parameters</code></a> and <a href="#input"><code>inputs</code></a>, since the latter may have different data types.</p>
</div>
<div id="fmi3SetTime" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetTimeTYPE(fmi3Instance instance, fmi3Float64 time);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set a new value for the independent variable (typically a time instant) and re-initialize caching of variables that depend on time, provided the newly provided time value is different to the previously set time value (variables that depend solely on <a href="#constant"><code>constants</code></a> or <a href="#parameter"><code>parameters</code></a> need not to be newly computed in the sequel, but the previously computed values can be reused).</p>
</div>
<div id="fmi3SetContinuousStates" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3SetContinuousStatesTYPE(fmi3Instance instance,
                                               const fmi3Float64 continuousStates[],
                                               size_t nContinuousStates);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set a new (continuous) state vector and re-initialize caching of variables that depend on the <a href="#state"><code>states</code></a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Argument <code>nContinuousStates</code> is the length of</p>
</li>
<li>
<p>argument <code>continuousStates</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and is provided for checking purposes (variables that depend solely on<a href="#constant"><code>constants</code></a>, <a href="#parameter"><code>parameters</code></a>, time, and <a href="#input"><code>inputs</code></a> do not need to be newly computed in the sequel, but the previously computed values can be reused).
Note that the continuous <a href="#state"><code>states</code></a> might also be changed in <strong>Event Mode</strong>.
Note that <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a> is possible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">fmi3Status fmi3Set{VariableType}(..);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set new values for <a href="#parameter"><code>parameters</code></a>, <a href="#start"><code>start</code></a> values and <a href="#input"><code>inputs</code></a> and re-initialize caching of variables that depend on these variables.
The details of these functions are defined in <a href="#get-and-set-variable-values">Section 2.2.5</a>.</p>
</div>
<div class="paragraph">
<p><em>[The functions above have the slight drawback that values must always be copied.</em>
<em>For example, a call to</em> <a href="#fmi3SetContinuousStates"><code>fmi3SetContinuousStates</code></a> <em>will provide the actual states in a vector, and this function has to copy the values in to the internal model data structure so that subsequent evaluation calls can utilize these values.</em>
<em>If this turns out to be an efficiency issue, a future release of FMI might provide additional functions to provide the address of a memory area where the variable values are present.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="evaluation-of-model-equations">3.2.2. Evaluation of Model Equations</h4>
<div class="paragraph">
<p>This section contains the core functions to evaluate the model equations.
Before one of these functions can be called, the appropriate functions from the previous section have to be used, to set the input arguments to the current model evaluation.</p>
</div>
<div id="fmi3EnterEventMode" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterEventModeTYPE(fmi3Instance instance,
                                          fmi3Boolean stepEvent,
                                          const fmi3Int32 rootsFound[],
                                          size_t nEventIndicators,
                                          fmi3Boolean timeEvent);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The model enters <strong>Event Mode</strong> from the <strong>Continuous-Time Mode</strong> and discrete-time equations may become active (and relations are not "frozen").</p>
</div>
<div class="paragraph">
<p>The followings function arguments have to be given to inform the FMU why <strong>Event Mode</strong> was entered.</p>
</div>
<div class="paragraph">
<p><em>[These arguments are not mutually exclusive.]</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>stepEvent</code> signals with <code>fmi3True</code> that a <a href="#step-event">step event</a> occurred.</p>
</li>
<li>
<p><code>rootsFound</code> is an array of length <code>nEventIndicators</code> that signals if a <a href="#state-event">state event</a> occurred.
For <code>i = 1, &#8230;&#8203;, nEventIndicators, rootsFound[i-1] != 0</code> if the event indicator \(z_i\) has a root, and <code>rootsFound[i-1] == 0</code> if not.
For the components \(z_i\) for which a root was found, the sign of <code>rootsFound[i-1]</code> indicates the direction of the zero-crossing.
A value of <code>+1</code> indicates that \(z_i\) is increasing, while a value of <code>-1</code> indicates a decreasing \(z_i\).
If <code>nEventIndicators == 0</code> the value of <code>rootsFound</code> is not defined.</p>
</li>
<li>
<p><code>nEventIndicators</code> contains the number of event indicators (length of <code>rootsFound</code>) or <code>0</code> if the caller cannot provide this information.</p>
</li>
<li>
<p><code>timeEvent</code> signals with <code>fmi3True</code> that a <a href="#time-event">time event</a> occurred.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[An <a href="#input-event">input event</a> can be detected by the FMU by keeping track of the calls of <code>fmi3Set{VariableType}</code> in <strong>Event Mode</strong>.]</em></p>
</div>
<div id="fmi3NewDiscreteStates" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3NewDiscreteStatesTYPE(fmi3Instance instance,
                                             fmi3Boolean *newDiscreteStatesNeeded,
                                             fmi3Boolean *terminateSimulation,
                                             fmi3Boolean *nominalsOfContinuousStatesChanged,
                                             fmi3Boolean *valuesOfContinuousStatesChanged,
                                             fmi3Boolean *nextEventTimeDefined,
                                             fmi3Float64 *nextEventTime);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The FMU is in <strong>Event Mode</strong>.
If the super-dense time before a call to <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> was \((t_R,t_I)\), then the time instant after the call is \((t_R,t_{I + 1})\).<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>If output argument <code>newDiscreteStatesNeeded == fmi3True</code>, the FMU should stay in <strong>Event Mode</strong>, and the FMU requires to set new inputs to the FMU (<code>fmi3Set{VariableType}</code> on <a href="#input"><code>inputs</code></a>) to compute and get the <a href="#output"><code>outputs</code></a> (<code>fmi3Get{VariableType}</code> on <a href="#output"><code>outputs</code></a>) and to call <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> again.</p>
</li>
</ul>
</div>
<div id="terminateSimulation" class="ulist">
<ul>
<li>
<p>If output argument <code>terminateSimulation == fmi3True</code>, the FMU signals it needs to terminate the simulation.</p>
</li>
<li>
<p>If argument <code>nominalsOfContinuousStatesChanged == fmi3True</code>, then the nominal values of the <a href="#state"><code>states</code></a> have changed due to the function call and can be inquired with <a href="#fmi3GetNominalsOfContinuousStates"><code>fmi3GetNominalsOfContinuousStates</code></a>.</p>
</li>
<li>
<p>If argument <code>valuesOfContinuousStatesChanged == fmi3True</code>, then at least one element of the continuous state vector has changed its value due to the function call.</p>
</li>
</ul>
</div>
<div id="state" class="paragraph">
<p>The new values of the <a href="#state"><code>states</code></a> can be inquired with <a href="#fmi3GetContinuousStates"><code>fmi3GetContinuousStates</code></a> or individually for each state for which <a href="#reinit"><code>reinit = true</code></a> by calling <code>fmi3GetFloat*</code>.
If no element of the continuous state vector has changed its value, <code>valuesOfContinuousStatesChanged</code> must return <code>fmi3False</code>.
<em>[If <code>fmi3True</code> would be returned in this case, an infinite event loop may occur.]</em></p>
</div>
<div id="nextEventTimeDefined" class="ulist">
<ul>
<li>
<p>If argument <code>nextEventTimeDefined == fmi3True</code>, then the simulation shall integrate at most until <code>time</code> reaches value of</p>
</li>
</ul>
</div>
<div id="nextEventTime" class="ulist">
<ul>
<li>
<p>argument <a href="#nextEventTime"><code>nextEventTime</code></a>, and shall call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> at this time instant.
If a (e.g. <a href="#state-event">state event</a>) event happens before <a href="#nextEventTime"><code>nextEventTime</code></a>, the definition of <a href="#nextEventTime"><code>nextEventTime</code></a> becomes obsolete.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With multiple connected FMUs, the environment shall</p>
</div>
<div class="ulist">
<ul>
<li>
<p>call <a href="#fmi3Terminate"><code>fmi3Terminate</code></a>, if <a href="#terminateSimulation"><code>terminateSimulation == fmi3True</code></a> is returned by at least one FMU,</p>
</li>
<li>
<p>call <a href="#fmi3EnterContinuousTimeMode"><code>fmi3EnterContinuousTimeMode</code></a> if all FMUs return <code>newDiscreteStatesNeeded == fmi3False</code>, and</p>
</li>
<li>
<p>stay in <strong>Event Mode</strong> otherwise.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the FMU is terminated, it is assumed that an appropriate message is printed by the <a href="#logMessage"><code>logMessage</code></a> function (see <a href="#FMUStateSetable">Section 2.3.1</a>) to explain the reason for the termination.</p>
</div>
<div id="fmi3CompletedIntegratorStep" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3CompletedIntegratorStepTYPE(fmi3Instance instance,
                                                   fmi3Boolean noSetFMUStatePriorToCurrentPoint,
                                                   fmi3Boolean* enterEventMode,
                                                   fmi3Boolean* terminateSimulation);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function must be called by the environment after every completed step of the integrator provided the capability flag <code>completedIntegratorStepNotNeeded = false</code>.
Argument <code>noSetFMUStatePriorToCurrentPoint == fmi3True</code> if <code>fmi3SetFMUState</code> will no longer be called for time instants prior to current time in this simulation run [the FMU can use this flag to flush a result buffer].<br>
The function returns <code>enterEventMode</code> to signal to the environment that the environment shall call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>, and it returns <a href="#terminateSimulation"><code>terminateSimulation</code></a> to signal if the simulation shall be terminated.
If <code>enterEventMode == fmi3False</code> and <a href="#terminateSimulation"><code>terminateSimulation == fmi3False</code></a> the FMU stays in <strong>Continuous-Time Mode</strong> without the environment having to call <a href="#fmi3EnterContinuousTimeMode"><code>fmi3EnterContinuousTimeMode</code></a> again.
When the integrator step is completed and the <a href="#state"><code>states</code></a> are modified by the integrator afterwards (for example, correction by a BDF method),
then <a href="#fmi3SetContinuousStates"><code>fmi3SetContinuousStates</code></a> has to be called with the updated states before <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> is called.<br>
When the integrator step is completed and one or more event indicators change sign (with respect to the previously completed integrator step), then the integrator or the environment has to determine the time instant of the sign change that is closest to the previous completed step up to a certain precision (usually a small multiple of the machine epsilon).
This is usually performed by an iteration where time is varied and <a href="#state"><code>state</code></a> variables needed during the iteration are determined by interpolation.
Function <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> must be called after this <a href="#state-event">state event</a> location procedure and not after the successful computation of the time step by the integration algorithm.
The intended purpose of the function call is to indicate to the FMU that at this stage all <a href="#input"><code>inputs</code></a> and <a href="#state"><code>state</code></a> variables have valid (accepted) values.
After <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> is called, it is still allowed to go back in time (calling <a href="#fmi3SetTime"><code>fmi3SetTime</code></a>) and inquire values of variables at previous time instants with <code>fmi3Get{VariableType}</code> <em>[for example, to determine values of non-state variables at output points]</em>.
However, it is not allowed to go back in time over the previous <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> or the previous <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> call.</p>
</div>
<div class="paragraph">
<p><em>[This function might be used, for example, for the following purposes:</em></p>
</div>
<div class="paragraph">
<p><em>Delays:</em><br>
<em>All variables that are used in a "delay(..)" operator are stored in an appropriate buffer and the function returns with <code>enterEventMode == fmi3False</code>, and <a href="#terminateSimulation"><code>terminateSimulation == fmi3False</code></a>.</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Dynamic state selection:</em><br>
<em>It is checked whether the dynamically selected states are still numerically appropriate.</em>
<em>If yes, the function returns with <code>enterEventMode == fmi3False</code>  otherwise with <code>enterEventMode == fmi3True</code>.</em>
<em>In the latter case, <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> has to be called and the states are dynamically changed by a subsequent <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>.</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>Note that this function is not used to detect time or <a href="#state-event"><code>state events</code></a>, for example, by comparing event indicators of the previous with the current call of <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a>.</em>
<em>These types of events are detected in the environment, and the environment has to call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> independently in these cases, whether the return argument <code>enterEventMode</code> of <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> is <code>fmi3True</code> or <code>fmi3False</code>.]</em></p>
</div>
<div id="fmi3GetDerivatives" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetDerivativesTYPE(fmi3Instance instance,
                                          fmi3Float64 derivatives[],
                                          size_t nContinuousStates);</code></pre>
</div>
</div>
<div id="fmi3GetEventIndicators" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetEventIndicatorsTYPE(fmi3Instance instance,
                                              fmi3Float64 eventIndicators[],
                                              size_t nEventIndicators);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute state derivatives (that is derivatives w.r.t. to the <a href="#independent"><code>independent</code></a> variable also taking into account its unit) and event indicators at the current instant of the <a href="#independent"><code>independent</code></a> variable <em>[typically: time]</em> and for the current <a href="#state"><code>states</code></a>.
Note that <a href="#fmi3Discard"><code>fmi3Status == fmi3Discard</code></a> is possible for both functions.</p>
</div>
<div class="paragraph">
<p>The <a href="#derivative"><code>derivatives</code></a> are returned as a vector with <code>nContinuousStates</code> elements.
The ordering of the elements of the <code>derivatives</code> vector must be identical to the ordering of the <code>continuousStates</code> vector (for example, <code>derivatives[2]</code> is the <a href="#derivative"><code>derivative</code></a> of <code>continuousStates[2]</code>).
The order of the <code>continuousStates</code> and <code>derivatives</code> vector must be the same as the ordered list of elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>.
<em>[Array variables are serialized in "row major" order, as usual.]</em></p>
</div>
<div class="paragraph">
<p>The event indicators are returned as a vector with <code>nEventIndicators</code> elements.
The order of the <code>eventIndicators</code> vector must be the same as the ordered list of elements <code>&lt;ModelStructure&gt;&lt;EventIndicator&gt;</code>.
<em>[Array variables are serialized in "row major" order, as usual.]</em>
A <a href="#state-event">state event</a> is triggered when the domain of an event indicator changes from \(z_j &gt; 0\) to \(z_j \leq 0\) or vice versa.
The FMU must guarantee that at an event restart \(z_j \neq 0\), for example, by shifting \(z_j\) with a small value.
Furthermore, \(z_j\) should be scaled in the FMU with its nominal value (so all elements of the returned vector <code>eventIndicators</code> should be in the order of "one").</p>
</div>
<div id="fmi3GetContinuousStates" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetContinuousStatesTYPE(fmi3Instance instance,
                                               fmi3Float64 continuousStates[],
                                               size_t nContinuousStates);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return the new continuous state vector <code>continuousStates</code>.
The order of the states is also the same as the ordered list of elements <code>&lt;ModelStructure&gt;&lt;Derivative&gt;</code>.
_[Array variables are serialized in "row major" order, as usual.]</p>
</div>
<div id="fmi3GetNominalsOfContinuousStates" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetNominalsOfContinuousStatesTYPE(fmi3Instance instance,
                                                         fmi3Float64 nominals[],
                                                         size_t nContinuousStates);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return the nominal values of the continuous <a href="#state"><code>states</code></a> with the some convention for the order as above.
This function should always be called after calling function <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>, if <code>nominalsOfContinuousStatesChanged == fmi3True</code>, since then the nominal values of the continuous <a href="#state"><code>states</code></a> have changed <em>[for example, because the association of the continuous <a href="#state"><code>states</code></a> to variables has changed due to internal dynamic state selection]</em>.
If the FMU does not have information about the nominal value of a continuous <a href="#state"><code>state</code></a> i, a nominal value <code>nominals[i] == 1.0</code> should be returned.
Note that it is required that <code>nominals[i] &gt; 0.0</code>.
<em>[Typically, the nominal values of the continuous <a href="#state"><code>states</code></a> are used to compute the absolute tolerance required by the integrator.</em>
<em>Example:</em><br>
<code>absoluteTolerance[i] = 0.01 * tolerance * nominals[i];</code> <em>]</em></p>
</div>
<div class="paragraph">
<p>Note that simulation backward in time is only allowed over continuous time intervals.
As soon as an event occurs (<a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> was called), going back in time is forbidden, because <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> / <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> can only compute the next discrete state, not the previous one.</p>
</div>
<div class="paragraph">
<p>Note that during <strong>Initialization</strong>, <strong>Event Mode</strong>, and <strong>Continuous-Time Mode</strong>, <a href="#input"><code>input</code></a> variables can be set with <code>fmi3Set{VariableType}</code> and output variables can be retrieved with <code>fmi3Get{VariableType}</code> interchangeably according to the model structure defined under element <code>&lt;ModelStructure&gt;</code> in the XML file.
<em>[For example, if one <a href="#output"><code>output</code></a> <code>y1</code> depends on two <a href="#input"><code>inputs</code></a> <code>u1</code>, <code>u2</code>, then these two <a href="#input"><code>inputs</code></a> must be set, before <code>y1</code> can be retrieved.</em>
<em>If additionally an <a href="#output"><code>output</code></a> <code>y2</code> depends on an <a href="#input"><code>input</code></a> <code>u3</code>, then <code>u3</code> can be set and <code>y2</code> can be retrieved afterwards.</em>
<em>As a result, artificial or <code>real</code> algebraic loops over connected FMUs in any of these three modes can be handled by using appropriate numerical algorithms.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="state-machine-model-exchange">3.2.3. State Machine for Model Exchange</h4>
<div class="paragraph">
<p>Every implementation of the FMI must support calling sequences of the functions according to the state machine in <a href="#figure-model-exchange-state-machine">Figure 27</a>.</p>
</div>
<div id="figure-model-exchange-state-machine" class="imageblock text-center">
<div class="content">
<img src="images/state-machine-model-exchange.svg" alt="state machine model exchange" width="80%">
</div>
<div class="title">Figure 27. Calling sequence of Model Exchange C functions.</div>
</div>
<div class="paragraph">
<p>The objective of the state machine is to define the allowed calling sequences for functions of the FMI: Calling sequences not accepted by the state machine are not supported by the FMI.
The behavior of an FMU is undefined for such a calling sequence.
The state machine is given here as UML 2.0 state machine.
If a transition is labelled with one or more function names (for example, <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>, <a href="#fmi3EnterContinuousTimeMode"><code>fmi3EnterContinuousTimeMode</code></a>), this means that the transition is taken if any of these functions is successfully called.
Note that the FMU can always determine in which state it is since every state is entered by a particular function call (such as <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>), or a particular return value (such as <a href="#fmi3Fatal"><code>fmi3Fatal</code></a>).</p>
</div>
<div class="paragraph">
<p>The transition conditions <a href="#time-event">time event</a>, and <a href="#state-event">state event</a> are defined in <a href="#math-model-exchange">Section 3.1</a>.</p>
</div>
<div class="paragraph">
<p>Each state of the state machine corresponds to a certain phase of a simulation.
Common states are defined in <a href="#common-state-machine">Section 2.3</a>, such as super states <a href="#FMUStateSetable"><strong>FMU State Setable</strong></a> and  <a href="#Initialized"><strong>Initialized</strong></a>, states <a href="#Instantiated"><strong>Instantiated</strong></a>, <a href="#ConfigurationMode"><strong>Configuration Mode</strong></a>, <a href="#ReconfigurationMode"><strong>Reconfiguration Mode</strong></a>, <a href="#InitializationMode"><strong>Initialization Mode</strong></a>, and <a href="#Terminated"><strong>Terminated</strong></a>.</p>
</div>
<div class="sect4">
<h5 id="_state_continuous_time_mode">3.2.3.1. State: Continuous-Time Mode</h5>
<div class="paragraph">
<p>In this state, the continuous-time model equations are active and integrator steps are performed.</p>
</div>
<div class="paragraph">
<p><strong>Continuous-Time Mode</strong> is entered from <strong>Event Mode</strong> with calling <code>fmi3EnterContinuousTimeMode</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a></dt>
<dd>
<p>When an event is detected, the importer must call this function to move the FMU into <strong>Event Mode</strong>.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a></dt>
<dd>
<p>If the environment wants to change <a href="#structuralParameter"><code>structural parameters</code></a>, it must move the FMU into <strong>Reconfiguration Mode</strong> using <a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a>.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a></dt>
<dd>
<p>See <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_example">3.2.4. Code Example</h4>
<div class="paragraph">
<p>In the following example, the usage of the <code>fmi3XXX</code> functions is sketched in order to clarify the typical calling sequence of the functions in a simulation environment.
Furthermore, it is assumed that one FMU is directly integrated in a simulation environment.
If the FMU would be used inside another model, additional code is needed, especially initialization and event iteration has to be adapted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="c" class="language-c hljs">m = M_fmi3InstantiateModelExchange("m", INSTANTIATION_TOKEN, NULL, fmi3False, fmi3False, NULL, cb_logMessage);
// "m" is the instance name
// "M_" is the MODEL_IDENTIFIER

if (m == NULL) {
    status = fmi3Error;
    goto TERMINATE;
}

// set the start time
time  = tStart;

// set all variable start values (of "ScalarVariable / &lt;type&gt; / start") and
// set the start values at time = Tstart
// M_fmi3SetReal/Integer/Boolean/String(m, ...)

// initialize
// determine continuous and discrete states
CHECK_STATUS(M_fmi3EnterInitializationMode(m, fmi3False, 0.0, tStart, fmi3True, tEnd));
CHECK_STATUS(M_fmi3ExitInitializationMode(m));

initialEventMode = fmi3True;
enterEventMode   = fmi3False;
timeEvent        = fmi3False;
stateEvent       = fmi3False;

// initialize previous event indicators
CHECK_STATUS(M_fmi3GetEventIndicators(m, previous_z, NZ));

initialEventMode = fmi3False;

CHECK_STATUS(M_fmi3EnterContinuousTimeMode(m));

// retrieve initial state x and
// nominal values of x (if absolute tolerance is needed)
CHECK_STATUS(M_fmi3GetContinuousStates(m, x, NX));
CHECK_STATUS(M_fmi3GetNominalsOfContinuousStates(m, x_nominal, NX));

// retrieve solution at t=Tstart, for example, for outputs
// M_fmi3SetFloat*/Int*/UInt*/Boolean/String/Binary(m, ...)

while (!terminateSimulation) {

    tNext = time + h;

    // handle events
    if (enterEventMode || stateEvent || timeEvent) {

        if (!initialEventMode) {
            CHECK_STATUS(M_fmi3EnterEventMode(m, fmi3False, rootsFound, NZ, timeEvent));
        }

        // event iteration
        fmi3Boolean newDiscreteStatesNeeded           = fmi3True;
        fmi3Boolean terminateSimulation               = fmi3False;
        fmi3Boolean nominalsOfContinuousStatesChanged = fmi3False;
        fmi3Boolean valuesOfContinuousStatesChanged   = fmi3False;
        fmi3Boolean nextEventTimeDefined              = fmi3False;
        fmi3Float64 nextEventTime                     = 0;

        while (newDiscreteStatesNeeded) {

            // set inputs at super dense time point
            // M_fmi3SetFloat*/Int*/UInt*/Boolean/String/Binary(m, ...)

            fmi3Boolean nominalsChanged = fmi3False;
            fmi3Boolean statesChanged   = fmi3False;

            // update discrete states
            CHECK_STATUS(M_fmi3NewDiscreteStates(m, &amp;newDiscreteStatesNeeded, &amp;terminateSimulation, &amp;nominalsChanged, &amp;statesChanged, &amp;nextEventTimeDefined, &amp;nextEventTime));

            // getOutput at super dense time point
            // M_fmi3GetFloat*/Int*/UInt*/Boolean/String/Binary(m, ...)

            nominalsOfContinuousStatesChanged |= nominalsChanged;
            valuesOfContinuousStatesChanged   |= statesChanged;

            if (terminateSimulation) goto TERMINATE;
        }

        // enter Continuous-Time Mode
        CHECK_STATUS(M_fmi3EnterContinuousTimeMode(m));

        // retrieve solution at simulation (re)start
        CHECK_STATUS(recordVariables(outputFile, m, time));

        if (initialEventMode || valuesOfContinuousStatesChanged) {
            // the model signals a value change of states, retrieve them
            CHECK_STATUS(M_fmi3GetContinuousStates(m, x, NX));
        }

        if (initialEventMode || nominalsOfContinuousStatesChanged) {
            // the meaning of states has changed; retrieve new nominal values
            CHECK_STATUS(M_fmi3GetNominalsOfContinuousStates(m, x_nominal, NX));
        }

        if (nextEventTimeDefined) {
            tNext = min(nextEventTime, tEnd);
        } else {
            tNext = tEnd;
        }

        initialEventMode = fmi3False;
    }

    if (time &gt;= tEnd) {
        goto TERMINATE;
    }

    // compute derivatives
    CHECK_STATUS(M_fmi3GetDerivatives(m, der_x, NX));

    // advance time
    h = min(fixedStep, tNext - time);
    time += h;
    CHECK_STATUS(M_fmi3SetTime(m, time));

    // set continuous inputs at t = time
    // M_fmi3SetFloat*(m, ...)

    // set states at t = time and perform one step
    for (size_t i = 0; i &lt; NX; i++) {
        x[i] += h * der_x[i]; // forward Euler method
    }

    CHECK_STATUS(M_fmi3SetContinuousStates(m, x, NX));

    // get event indicators at t = time
    CHECK_STATUS(M_fmi3GetEventIndicators(m, z, NZ));

    stateEvent = fmi3False;

    for (size_t i = 0; i &lt; NZ; i++) {

        // check for zero crossings
        if (previous_z[i] &lt; 0 &amp;&amp; z[i] &gt;= 0) {
            rootsFound[i] = 1;   // -\+
        } else  if (previous_z[i] &gt; 0 &amp;&amp; z[i] &lt;= 0) {
            rootsFound[i] = -1;  // +/-
        } else {
            rootsFound[i] = 0;   // no zero crossing
        }

        stateEvent |= rootsFound[i];

        previous_z[i] = z[i]; // remember the current value
    }

    // inform the model about an accepted step
    CHECK_STATUS(M_fmi3CompletedIntegratorStep(m, fmi3True, &amp;enterEventMode, &amp;terminateSimulation));

    // get continuous output
    // M_fmi3GetFloat*(m, ...)
    CHECK_STATUS(recordVariables(outputFile, m, time));
}

TERMINATE:

if (m &amp;&amp; status != fmi3Error &amp;&amp; status != fmi3Fatal) {
    // retrieve final values and terminate simulation
    CHECK_STATUS(recordVariables(outputFile, m, time));
    fmi3Status s = M_fmi3Terminate(m);
    status = max(status, s);
}

if (m &amp;&amp; status != fmi3Fatal) {
    // clean up
    M_fmi3FreeInstance(m);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code above errors are handled by the following definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">#define CHECK_STATUS(S) status = S; if (status != fmi3OK) goto TERMINATE;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_event_handling">3.2.5. Event Handling</h4>
<div class="paragraph">
<p>This concerns the following API calls: <a href="#fmi3SetClock"><code>fmi3SetClock</code></a>, <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>, <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a>, <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a>, <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a>, <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a></p>
</div>
<div class="paragraph">
<p>A <a href="#clock"><code>clock</code></a> event is handled by the environment in the following way:</p>
</div>
<div class="paragraph">
<p><em>[TODO: Move this section into Common and there the Event Mode description.]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Enter event mode</dt>
<dd>
<p>The <strong>Event Mode</strong> is entered after initialization (call to function <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a>) or during simulation with a call to the function <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>.
The FMU activates <a href="#outputClock"><code>output clocks</code></a>.</p>
</dd>
<dt class="hdlist1">Synchronize clock activation and intervals with the environment</dt>
<dd>
<p><em>[TODO: remove usage of clock tick and use clock activation instead (Note to self: search also for "`clock` tick").]</em></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <a href="#clock"><code>clock</code></a> activation status can be inquired with the function <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>.
The environment calls the function <a href="#fmi3SetClock"><code>fmi3SetClock</code></a> for <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a> and <a href="#inputClock"><code>input clocks</code></a>.
Moreover the current <a href="#clock"><code>clock</code></a> intervals may be inquired with the function <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> or <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a> and set with the function <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a>.
<em>[In the Modelica language this is the value returned by the interval() operator.</em>
<em>The initialization of intervals is needed for <a href="#output"><code>output</code></a> and <a href="#input"><code>input</code></a> sample times if a <a href="#clock"><code>clock</code></a> ticks the first time.</em>
<em>The FMU determines the interval itself at subsequent <a href="#clock"><code>clock</code></a> ticks.]</em></p>
</div>
<div class="paragraph">
<p><em>[TODO: This should not be in Event Handling, merge into the other section for clock intervals with the table.]</em></p>
</div>
<div class="paragraph">
<p><em>[TODO: Write here a few sentences about how clocks interact with the event iteration.]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Leave event mode</dt>
<dd>
<p>The function <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> evaluates the discrete-time equations, provided the corresponding <a href="#clock"><code>clock</code></a> is active and the discrete-time equations have not already been evaluated with calls to <code>fmi3Get{VariableType}</code> functions.
Clocks are automatically deactivated by <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> and by <a href="#fmi3Reset"><code>fmi3Reset</code></a>.
<em>[This handling of discrete-time states and <a href="#time-event">`time events</a> is forward compatible with FMI 2.0 for any model that could be treated with FMI 2.0 and is exported again using the new features.</em>
<em>The environment may ignore the new functions <a href="#fmi3SetClock"><code>fmi3SetClock</code></a>, <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>, <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a>, <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a>, <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> and <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a>.</em>
<em>The new functions are needed for FMUs with input sample times and to set discrete-time states in model-based control applications or if algebraic loops are present among discrete-time equations of multiple connected FMUs.]</em></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="model-exchange-schema">3.3. Description Schema</h3>
<div class="paragraph">
<p>The common XML elements and attributes are defined in <a href="#fmi-description-schema">Section 2.4</a>.
Additional elements and attributes are defined subsequently.
If the FMU implements the Model Exchange interface type, the element <code>&lt;ModelExchange&gt;</code> must be present.
It is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/ModelExchange.png" alt="ModelExchange" width="80%">
</div>
</div>
<div class="paragraph">
<p>The attributes in the following table are defined on top of the <a href="#common-capability-flags">common attributes</a> and have the following meaning (all attributes are optional with exception of <code>modelIdentifier</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>modelIdentifier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short class name according to C syntax, for example, <code>A_B_C</code>.
Used as prefix for FMI functions if the functions are provided in C source code or in static libraries, but not if the functions are provided by a DLL/SharedObject.
<code>modelIdentifier</code> is also used as name of the static library or DLL/SharedObject.
See also <a href="#header-files-and-naming-of-functions">Section 2.2.1</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>completedIntegratorStepNotNeeded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, function <a href="#fmi3CompletedIntegratorStep"><code>fmi3CompletedIntegratorStep</code></a> need not be called (this gives a slightly more efficient integration).
If it is called, it has no effect.<br>
If <code>false</code> (the default), the function must be called after every completed integrator step, see <a href="#evaluation-of-model-equations">Section 3.2.2</a>.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="xml-example-model-exchange">3.3.1. Example XML Description File</h4>
<div class="paragraph">
<p>When generating an FMU from the hypothetical model <code>MyLibrary.SpringMassDamper</code>, the XML file may have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;fmiModelDescription
  fmiVersion="3.0-alpha.5"
  modelName="MyLibrary.SpringMassDamper"
  instantiationToken="{8c4e810f-3df3-4a00-8276-176fa3c9f9e0}"
  description="Rotational Spring Mass Damper System"
  version="1.0"
  generationDateAndTime="2011-09-23T16:57:33Z"
  variableNamingConvention="structured"&gt;
  &lt;ModelExchange modelIdentifier="MyLibrary_SpringMassDamper"/&gt;
  &lt;UnitDefinitions&gt;
    &lt;Unit name="rad"&gt;
      &lt;BaseUnit rad="1"/&gt;
      &lt;DisplayUnit name="deg" factor="57.2957795130823"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="rad/s"&gt;
      &lt;BaseUnit s="-1" rad="1"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="kg.m2"&gt;
      &lt;BaseUnit kg="1" m="2"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="N.m"&gt;
      &lt;BaseUnit kg="1" m="2" s="-2"/&gt;
    &lt;/Unit&gt;
  &lt;/UnitDefinitions&gt;
  &lt;TypeDefinitions&gt;
    &lt;Float64Type name="Modelica.Units.SI.Inertia" quantity="MomentOfInertia" unit="kg.m2" min="0.0"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.Torque" quantity="Torque" unit="N.m"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.AngularVelocity" quantity="AngularVelocity" unit="rad/s"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.Angle" quantity="Angle" unit="rad"/&gt;
  &lt;/TypeDefinitions&gt;
  &lt;DefaultExperiment startTime="0.0" stopTime="3.0" tolerance="0.0001"/&gt;
  &lt;ModelVariables&gt;
    &lt;Float64 name="inertia1.J" valueReference="1073741824"
      description="Moment of load inertia" causality="parameter" variability="fixed"
      declaredType="Modelica.Units.SI.Inertia" start="1"/&gt;
    &lt;Float64 name="torque.tau" valueReference="536870912"
      description="Accelerating torque acting at flange (= -flange.tau)" causality="input"
      declaredType="Modelica.Units.SI.Torque" start="0"/&gt;
    &lt;Float64 name="inertia1.phi" valueReference="805306368"
      description="Absolute rotation angle of component" causality="output"
      declaredType="Modelica.Units.SI.Angle"/&gt;
    &lt;Float64 name="inertia1.w" valueReference="805306369"
      description="Absolute angular velocity of component (= der(phi))" causality="output"
      declaredType="Modelica.Units.SI.AngularVelocity"/&gt;
    &lt;Float64 name="x[1]" valueReference="0" initial="exact" start="0"/&gt;
    &lt;Float64 name="x[2]" valueReference="1" initial="exact" start="0"/&gt;
    &lt;Float64 name="der(x[1])" valueReference="2" derivative="0"/&gt;
    &lt;Float64 name="der(x[2])" valueReference="3" derivative="1"/&gt;
  &lt;/ModelVariables&gt;
  &lt;ModelStructure&gt;
    &lt;Output valueReference="805306368"/&gt;
    &lt;Output valueReference="805306369"/&gt;
    &lt;Derivative valueReference="2"/&gt;
    &lt;Derivative valueReference="3"/&gt;
    &lt;InitialUnknown valueReference="805306368"/&gt;
    &lt;InitialUnknown valueReference="805306369"/&gt;
    &lt;InitialUnknown valueReference="2" dependencies="0 536870912"/&gt;
    &lt;InitialUnknown valueReference="3" dependencies="0 1"/&gt;
  &lt;/ModelStructure&gt;
&lt;/fmiModelDescription&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fmi-for-co-simulation">4. FMI for Co-Simulation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter defines the Functional Mock-up Interface (FMI) for the coupling of two or more simulation models in a co-simulation environment (FMI for Co-Simulation).
It is designed both for coupling with subsystem models, which have been exported by their simulator together with its solver as runnable code, and for coupling of simulation tools on a single machine or as part of a distributed co-simulation.</p>
</div>
<div class="paragraph">
<p>Co-simulation exploits the modular structure of coupled problems in all stages of the simulation process beginning with the separate model setup and preprocessing for the individual subsystems in different simulation tools (which can be powerful simulators as well as simple C programs).
During time integration, the simulation is again performed independently for all subsystems restricting the data exchange between subsystems to discrete communication points \(t_i\).
For simulator coupling, also the visualization and post-processing of simulation data is done individually for each subsystem in its own native simulation tool.
We use the following terms: the communication points \(t_i\), the communication steps \(t_i \rightarrow t_{i+1}\) and the communication step sizes \(h_i := t_{i+1} - t_i\).
The term "communication point" in FMI for Co-Simulation refers to the communication between subsystems in a co-simulation environment and should not be mixed with the output points for saving simulation results to file.</p>
</div>
<div class="paragraph">
<p>FMI for Co-Simulation provides an interface standard for the solution of time-dependent coupled systems consisting of subsystems that are continuous in time (model components that are described by non-stationary differential equations) or time-discrete (model components that are described by difference equations such as discrete controllers).
In a block representation of the coupled system, the subsystems are represented by blocks with (internal) <a href="#state"><code>state</code></a> variables \(x(t)\) that are connected to other subsystems (blocks) of the coupled problem by <em>subsystem <a href="#input"><code>inputs</code></a></em> \(u(t)\) and <em>subsystem <a href="#output"><code>outputs</code></a></em> \(y(t)\).
In this framework, the physical connections between subsystems are represented by mathematical coupling conditions between the inputs \(u(t)\) and the <a href="#output"><code>outputs</code></a> \(y(t)\) of all subsystems, <a href="#KS00">[KS00]</a>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/co-simulation-data-flow.svg" alt="co simulation data flow" width="80%">
</div>
<div class="title">Figure 28. Data flow at communication points.</div>
</div>
<div class="paragraph">
<p>For co-simulation, two basic groups of functions have to be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>functions for the data exchange between subsystems</p>
</li>
<li>
<p>functions to synchronize the simulation of all subsystems and to proceed in communication steps \(t_i \rightarrow t_{i+1}\) from initial time \(t_0 := t_{\mathit{start}}\) to end time \(t_N := t_{\mathit{stop}}\)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In FMI for Co-Simulation, both groups of functions are implemented in one software component, the co-simulation algorithm.
The data exchange between the FMUs is handled via the co-simulation algorithm only.
There is no direct communication between the FMUs.
The co-simulation functionality can be implemented by a special software tool (a separate simulation backplane) or by one of the involved simulation tools.
In its most general form, the coupled system may be simulated in nested co-simulation environments and FMI for Co-Simulation applies to each level of the hierarchy.</p>
</div>
<div class="paragraph">
<p>FMI for Co-Simulation defines interface routines for the communication between the importer and all FMUs in a co-simulation environment.
The most common co-simulation algorithms stop at each communication point \(t_i\) the simulation (time integration) of all FMUs, collects the outputs \(y(t_i)\) from all FMUs, determines the FMU inputs \(u(t_i)\), distributes these FMU inputs and continues the (co-)simulation with the next communication step \(t_i \rightarrow t_{i+1} = t_i + h\) with fixed communication step size \(h\).
In each FMU, an appropriate solver is used to integrate its subsystem for a given communication step \(t_i \rightarrow t_{i+1}\).
The simplest co-simulation algorithms approximate the (unknown) FMU inputs \(u(t), (t &gt; t_i))\) by constant data \(u(t_i)\) for \(t_i \leq t &lt; t_{i+1}\).
FMI for Co-Simulation supports this classical brute force approach as well as more sophisticated simulation algorithms.
FMI for Co-Simulation is designed to support a very general class of simulation algorithms but it does not define simulation algorithms itself.</p>
</div>
<div class="paragraph">
<p>The ability of FMUs to support more sophisticated simulation algorithms is characterized by a set of capability flags inside the XML description of the FMU (see <a href="#fmi-for-co-simulation">Section 4</a>).
Typical examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the ability to handle variable communication step sizes \(h_i\),</p>
</li>
<li>
<p>the ability to repeat a rejected communication step \(t_i \rightarrow t_{i+1}\) with reduced communication step size,</p>
</li>
<li>
<p>the ability to provide <a href="#derivative"><code>derivatives</code></a> of <a href="#output"><code>outputs</code></a> w.r.t. time, to allow input approximation (<a href="#transfer-of-input-output-and-parameters">Section 4.2.1</a>),</p>
</li>
<li>
<p>or the ability to provide Jacobians.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FMI for Co-Simulation is restricted to FMUs with the following properties:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All calculated values are time-dependent functions within an a priori defined time interval \(t_{\mathit{start}} \leq t \leq t_{\mathit{stop}}\) (provided <code>stopTimeDefined == fmi3True</code> when calling <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a>).</p>
</li>
<li>
<p>All simulations are carried out with increasing time in general.
The current time \(t\) is running step by step from \(t_{\mathit{start}}\) to \(t_{\mathit{stop}}\).
The algorithm of the FMU may have the property to be able to repeat the simulation of parts of \([t_{\mathit{start}}, t_{\mathit{stop}}\)] or the whole time interval \([t_{\mathit{start}}, t_{\mathit{stop}}\)].</p>
</li>
<li>
<p>The FMU can be given a time value \(t_i, t_{\mathit{start}} \leq t_i \leq t_{\mathit{stop}}\).</p>
</li>
<li>
<p>The FMU is able to interrupt the simulation when \(t_i\) is reached.</p>
</li>
<li>
<p>During the interrupted simulation, the FMU (and its individual solver) can receive values for <a href="#input"><code>inputs</code></a> \(u(t_i)\) and send values of outputs \(y(t_i)\).</p>
</li>
<li>
<p>Whenever the simulation in an FMU is interrupted, a new time value \(t_{i+1}, t_i \leq t_{i+1} \leq t_{\mathit{stop}}\), can be given to simulate the time subinterval \(t_i &lt; t \leq t_{i+1}\).</p>
</li>
<li>
<p>The subinterval length \(h_i\) is the communication step size of the \(i^{th}\) communication step, \(h_i = t_{i+1} - t_i\).
Note that the communication step size initiated by the co-simulation algorithm has to be greater than zero.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>FMI for Co-Simulation allows a co-simulation flow which starts with instantiation and initialization (all FMUs are prepared for computation, the communication links are established), followed by simulation (the FMUs are forced to simulate a communication step), and finishes with shutdown.
The details of the flow are given in the state machine of the calling sequences from co-simulation algorithm to FMU, for each co-simulation interface (see <a href="#state-machine-co-simulation">Section 4.2.7</a>, and <a href="#state-machine-scheduled-execution">Section 5.2.1</a>).</p>
</div>
<div class="paragraph">
<p>The asynchronous mode for FMUs known from FMI 2.0 has been removed since this mode was not supported by tools and it can be suitably replaced by Co-Simulation implementations that control the asynchronous computation of FMUs via separate tasks/threads created for each FMU.</p>
</div>
<div class="paragraph">
<p>The <a href="#co-simulation-api">Co-Simulation</a> interface provides functionalities to control and observe the ticking of <a href="#clock">clocks</a>.
For FMI for Co-Simulation, the ticking of a clock is interpreted as an activity of the associated model partition.
During simulation, the co-simulation algorithm updates and manages values of inputs and outputs of FMUs and further models at communication points for each model partition.
The number of communication points created for a model partition per time unit can be seen as a model rate.
In that sense multiple model partitions of a model define multiple model rates in a model.</p>
</div>
<div class="paragraph">
<p>The notion of <a href="#clock"><code>clock</code></a> in FMI for Model Exchange has been extended to the FMI for Co-Simulation.</p>
</div>
<div class="paragraph">
<p>Both <a href="#outputClock"><code>output clocks</code></a> and <a href="#inputClock"><code>input clocks</code></a> are supported in Co-Simulation with <a href="#clock"><code>clocks</code></a>.
In order to handle <a href="#inputClock"><code>input</code></a> and <a href="#outputClock"><code>output clocks</code></a> in Co-Simulation, a new <strong>Event Mode</strong> has been introduced.</p>
</div>
<div class="paragraph">
<p>The concept and the way <a href="#inputClock"><code>input</code></a> and <a href="#outputClock"><code>output clocks</code></a> are handled are very similar in Model Exchange and Co-Simulation.
In order to handle <a href="#inputClock"><code>input clocks</code></a>, the co-simulation algorithm schedules <a href="#inputClock"><code>input clocks</code></a> and adjusts the communication steps in such a way that <a href="#inputClock"><code>inputClock</code></a> ticks become communication points.
At these communication points, the FMU is pushed to the <strong>Event Mode</strong> and <a href="#inputClock"><code>input clocks</code></a> are handled.</p>
</div>
<div class="paragraph">
<p><a href="#outputClock"><code>Output clocks</code></a>, on the other hand, communicate events detected by the FMU.
The FMU detects an <a href="#outputClock"><code>outputClock</code></a> and informs the co-simulation algorithm by invoking a callback in which the event time and the event type is communicated.
Then FMU stops the current Co-Simulation step and returns back from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.
Then the FMU is pushed to the <strong>Event Mode</strong> and the event is handled.
Note that, since output events time instants are not known in advance, at output event time instants, new communication points are created.</p>
</div>
<div class="sect2">
<h3 id="math-co-simulation">4.1. Mathematical Description</h3>
<div class="paragraph">
<p>This section contains a formal mathematical model of Co-Simulation FMUs.</p>
</div>
<div class="paragraph">
<p><em>[The following fundamental assumptions are made:</em>
<em>The FMUs are seen by the co-simulation algorithm as purely sampled-data systems, with the exception, that the simulation algorithm can provide input data of a defined level of smoothness (with the flag <a href="#recommendedIntermediateInputSmoothness"><code>recommendedIntermediateInputSmoothness</code></a>) within a communication interval via the intermediate update mechanism (see <a href="#IntermediateUpdateMode">Section 2.3.3</a>).</em></p>
</div>
<div class="paragraph">
<p><em>Such a sampled-data system consists typically of a hybrid ODE that is integrated between communication points (known as "sampled access to time continuous systems") where internal events may occur and be handled, but events are not visible from the outside of the FMU.</em></p>
</div>
<div class="paragraph">
<p><em>Co-Simulation FMUs can also be used for real sampled-data systems (so a sampled discrete controller; the <a href="#input"><code>inputs</code></a> and <a href="#output"><code>outputs</code></a> could be of type <code>&lt;Float{32|64}&gt;</code>, <code>&lt;[U]Int{8|16|32|64}&gt;</code>, <code>&lt;Boolean&gt;</code>, <code>&lt;String&gt;</code>, <code>&lt;Clock&gt;</code> or <code>&lt;Enumeration&gt;</code> with <a href="#variability"><code>variability</code></a> = <a href="#discrete"><code>discrete</code></a>.)</em>
<em>However, in FMI 3.0, Co-Simulation (CS) and Scheduled Execution (SE) may likely be more suitable for this use-case.</em><br>
<em>And - at least without using intermediate update (see <a href="#IntermediateUpdateMode">Section 2.3.3</a>), which is untypical for sampled data systems - with Co-Simulation there will always be a communication step delay for information going "through the FMU", so there cannot be an immediate reaction as in Co-Simulation (see <a href="#fmi-for-co-simulation">Section 4</a>).</em>
<em>]</em></p>
</div>
<div class="paragraph">
<p>The communication between the importer and a FMU takes place at</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a discrete set of time instants, called communication points, where input variables may change in non-smooth or even non-continuous way.</p>
</li>
<li>
<p>intermediate time instances, where the simulation algorithm may get and set variables using <a href="#IntermediateUpdateMode">Section 2.3.3</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the transient simulation of the coupled system through Co-Simulation is completed, the sequence of evaluations is the following (here \(\mathbf{x} = {\lbrack \mathbf{x}_c; \mathbf{x}_d \rbrack}^T\) is the combined vector of continuous-time and discrete-time states, and \(\mathbf{y} = {\lbrack \mathbf{y}_c; \mathbf{y}_d \rbrack}^T\)) is the combined vector of continuous-time and discrete-time <a href="#output"><code>outputs</code></a>):</p>
</div>
<div id="equation-co-simulation-evaluations" class="stemblock">
<div class="title">Sequence of Co-Simulation evaluations</div>
<div class="content">
\[\mathrm{\text{for}}\ i = 0, \cdots, n-1

\begin{Bmatrix}

\mathbf{x}_{i+1} = \Phi_i \left( \mathbf{x}_i,  \mathbf{u}(t_i), \mathbf{u}_u, \mathbf{p}_{\mathit{tune},i}, h_i  \right)

\\

\left( \left\{ \mathbf{y}^{(j)}_{i+1} \right\}_{j=0,\cdots,m_{odo}}, \mathbf{w}_{i+1}\right) = \Gamma_i \left( \mathbf{x}_i,  \mathbf{u}(t_i), \mathbf{u}_u, \mathbf{p}_{\mathit{tune},i}, h_i  \right)

\end{Bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>where \(\mathbf{\Phi}_i\) and \(\mathbf{\Gamma}_i\) define the system behavior for the time interval \(t_i &lt; t \leq t_{i+1}\),
with \(t_i = t_0 + \sum_{k=0}^{i-1}h_k\).</p>
</div>
<div class="paragraph">
<p><em>[For the part of the Co-Simulation FMU that is based on an ODE, a differential equation is solved between communication points:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\dot{\mathbf{x}}_c = \mathbf{\varphi} \left( \mathbf{x}_c(t), \mathbf{u}_c(t),
\mathbf{p}_{\mathit{tune}} \right)\]
</div>
</div>
<div class="paragraph">
<p><em>If the simulation algorithm implements an extrapolation method of order</em> \(m_{extra}\) <em>, it can provide intermediate inputs of the form:</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{u}_u(t)
=
\sum^{m_{\mathit{extra}}}_{j=0} \mathbf{C_{i, j}} \frac{(t-t_i)^j}{j!}\]
</div>
</div>
<div class="paragraph">
<p><em>where</em> \(\mathbf{C}_{i, j}\) <em>are coefficients that can be equal to output derivatives of a connected FMU to realize a Taylor polynomial.</em></p>
</div>
<div class="paragraph">
<p><em>The function</em> \(\mathbf{\varphi}\)  <em>shall approximate the numerical integration of the underlying differential equation.</em></p>
</div>
<div class="paragraph">
<p><em>For example, for a stiff differential equation one could use a linear implicit Euler method (neglecting intermediate variable information):</em></p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{\Phi}_i \left( \mathbf{x}_{c,i}, \left\{ \mathbf{u}_{c,i} \right\}_{j = 0,\cdots,m_{ido}},\ \mathbf{p}_{\mathit{tune},i}, t_i \right)
=
\mathbf{x}_{c,i} + \left( \mathbf{I} -
h_i \frac{\partial \mathbf{\varphi}}{\partial \mathbf{x}_c} \right)^{- 1}  h_i \mathbf{\phi} \left( \mathbf{x}_{c,i}, \mathbf{u}_{c,i}, \mathbf{p}_{\mathit{tune},i} \right).\]
</div>
</div>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="paragraph">
<p>Definition <a href="#equation-co-simulation-evaluations">Sequence of Co-Simulation evaluations</a> is consistent with the definition of co-simulation by <a href="#KS00">[KS00]</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the communication points, the simulation algorithm provides generalized inputs to the FMU:</p>
<div class="ulist">
<ul>
<li>
<p>The current <a href="#input"><code>input</code></a> variables \(\mathbf{u}_i\) of the FMU (in other words, the <a href="#input"><code>input</code></a> variables of the model represented by the FMU, in the sense of system-level simulation).</p>
</li>
<li>
<p>Varying <a href="#parameter"><code>parameters</code></a> \(\mathbf{p}_{\mathit{tune},i}\), also known as <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The FMU provides generalized outputs to the simulation algorithm, which are:</p>
<div class="ulist">
<ul>
<li>
<p>The current output variables \(\mathbf{y}_{i+1}^{(0)}\) of the FMU (same remark as above), along with some of their successive <a href="#derivative"><code>derivatives</code></a> \(\left\{ \mathbf{y}_{i+1}^{(j)} \right\}_{j=1,\cdots,m_{odo}}\) (in case of continuous-time variables).</p>
</li>
<li>
<p>Observation variables and <a href="#calculated"><code>calculated</code></a> varying <a href="#parameter"><code>parameters</code></a> \(\mathbf{w}_{i+1}\), along with directional derivatives estimated at \(t = t_{i+1}\) (in case of continuous-time variables).</p>
</li>
</ul>
</div>
</li>
<li>
<p>At intermediate times \(t\in (t_i, t_{i+1})\) the simulation algorithm and the FMU exchange values for \(\mathbf{u}_u(t)\) and \(\mathbf{y}_u(t)\).</p>
</li>
<li>
<p>Initialization: The FMU being a sampled-data system, its internal states (which can be either continuous-time or discrete-time) need to be initialized at \(t = t_0\).
This is performed through an auxiliary function <em>[this relationship is defined in the XML file under elements <code>&lt;ModelStructure&gt;&lt;InitialUnknown&gt;</code>]</em>:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Computing the solution of an FMI Co-Simulation model means to split the solution process in two phases and in every phase different equations and solution methods are utilized.
The phases can be categorized according to the following modes:</p>
</div>
<div class="sect3">
<h4 id="_initialization_mode_2">4.1.1. Initialization Mode</h4>
<div class="paragraph">
<p>This mode is used to compute at the start time \(t_0\) initial values for all variables of the Co-Simulation FMU, especially for continuous-time <a href="#state"><code>states</code></a> \(\mathbf{x}_c(t_0)\), discrete-time states \(\mathbf{x}_d(t_0)\), and for the previous discrete-time states \(^{\bullet}\mathbf{x}_d(t_0)\) by utilizing extra equations only present in <strong>Initialization Mode</strong> <em>[for example, equations to set all <a href="#derivative"><code>derivatives</code></a> to zero, that is, to initialize in steady-state]</em>.</p>
</div>
<div class="paragraph">
<p>If the FMU is connected in loops with other models, iterations over the FMU equations are possible.
Algebraic equations are solved in this mode.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_mode">4.1.2. Step Mode</h4>
<div class="paragraph">
<p>This mode is used to compute the values of all continuous-time and discrete-time variables at communication points by numerically solving ordinary differential, algebraic and discrete equations.
If the FMU is connected in loops with other models, no iterations over the FMU equations are possible for a given communication point.</p>
</div>
<div class="paragraph">
<p><em>[Note that for a Co-Simulation FMU, no super-dense time description is used at communication points.]</em></p>
</div>
<div class="paragraph">
<p>The equations are defined in <a href="#table-math-co-simulation">Table 10</a> can be evaluated in the respective mode.
The following color coding is used in the table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 88.8889%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="silver"><strong>grey</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a variable in an argument list is marked in grey, then this variable is not changing in this mode and just the last calculated value from the previous mode is internally used.
For an input argument it is not allowed to call <code>fmi3Set{VariableType}</code>.
For an output argument, calling <code>fmi3Get{VariableType}</code> on such a variable returns always the same value in this mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime"><strong>green</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functions marked in <span class="lime">green</span> are special functions to enter or leave a mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue"><strong>blue</strong></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equations and functions marked in <span class="blue">blue</span> define the actual computations to be performed in the respective mode.</p></td>
</tr>
</tbody>
</table>
<table id="table-math-co-simulation" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Mathematical description of an FMU for Co-Simulation.</caption>
<colgroup>
<col style="width: 66.6666%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Equations</th>
<th class="tableblock halign-left valign-top">FMI functions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations before <strong>Initialization Mode</strong> in state machine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set variables and that have a start value (<a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> or <a href="#approx"><code>approx</code></a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Initialization Mode</strong> in state machine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Enter <strong>Initialization Mode</strong> at (activate initialization, discrete-time and continuous-time equations). Set and set <a href="#start"><code>start</code></a> value of <a href="#independent"><code>independent</code></a> variable \(t_{i=0}\).</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">fmi3EnterInitializationMode</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set variables \(v_{\mathit{initial=exact}}\) and \(v_{\mathit{initial=approx}}\) that have a <a href="#start"><code>start</code></a> value with <a href="#initial"><code>initial</code></a> = <a href="#exact"><code>exact</code></a> (<a href="#parameter"><code>parameters</code></a> \(\mathbf{p}\) and continuous-time <a href="#state"><code>states</code></a> with start values \(\mathbf{x}_{c,\mathit{initial=exact}}\) are included here)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time and discrete-time <a href="#input"><code>inputs</code></a> \(\mathbf{u}_{c+d}(t_0)\) of continuous-time <a href="#input"><code>inputs</code></a> \(\mathbf{u}_{c}^{(j)}(t_0)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">\(\mathbf{v}_{\mathit{InitialUnknowns}} := \mathbf{f}_{\mathit{init}}(\mathbf{u}_c, \mathbf{u}_d, t_0, \mathbf{v}_{\mathit{initial=exact}})\)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="blue">fmi3Get{VariableType}</span></code><br>
<code><span class="blue">fmi3GetDirectionalDerivative</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">Exit <strong>Initialization Mode</strong> (de-activate initialization equations)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="lime">fmi3ExitInitializationMode</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Step Mode</strong> in state machine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameters</code></a> \(\mathbf{p}_{\mathit{tune}}\) (and do not set other <a href="#parameter"><code>parameters</code></a> \(\mathbf{p}_{\mathit{other}}\))</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time and discrete-time <a href="#input"><code>inputs</code></a> \(\mathbf{u}_{d+c}(t_i)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">\(\begin{matrix} t_{i+1} := t_i + h_i \\ (\mathbf{y}_{c+d}, \mathbf{y}_c^{(j)}, \mathbf{w}_{c+d}) := \mathbf{f}_{\mathit{doStep}}(\mathbf{u}_{c+d}, \mathbf{u}_u,  t_i, h_i, \mathbf{p}_{\mathit{tune}}, \mathbf{p}_{\mathit{other}})_{t_i} \\ t_i := t_{i+1} \end{matrix}\)</span><br>
<span class="blue">\(\mathbf{f}_{\mathit{doStep}}\) is also a function of the internal variables \(\mathbf{x}_c\), \(^{\bullet}\mathbf{x}_d\)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="blue">fmi3DoStep</span></code><br>
<code><span class="blue">fmi3Get{VariableType}</span></code><br>
<code><span class="blue">fmi3GetOutputDerivatives</span></code><br>
<code><span class="blue">fmi3GetDirectionalDerivative</span></code><br>
<code><span class="blue">fmi3CallbackIntermediateUpdate</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Equations during <strong>Intermediate Update Mode</strong> in state machine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set continuous-time  <a href="#input"><code>inputs</code></a> \(\mathbf{u}_u(t)\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmi3Set{VariableType}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">\(\mathbf{y}_u(t):= \mathbf{f}_{\mathit{Intermediate}}(\mathbf{u}_{i, c+d}, \mathbf{u}_u (t \in [t_i, t_{i+1}) ),  t, h_i, \mathbf{p}_{\mathit{tune}}, \mathbf{p}_{\mathit{other}})\)</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><span class="blue">fmi3Get{VariableType}</span></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock"><strong>Data types</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">\(t, t_i, h_i \in \mathbb{R}, \mathbf{p} \in \mathbb{P}^{np}, \mathbf{u}(t) \in \mathbb{P}^{nu}, \mathbf{y}(t) \in \mathbb{P}^{ny}, \mathbf{x}_c(t) \in \mathbb{R}^{nxc}, \mathbf{x}_d(t) \in \mathbb{P}^{nxd}, \mathbf{w}(t) \in \mathbb{P}^{nw}\)<br>
\(\mathbb{R}\): floating point variable, \(\mathbb{R}\): floating point or Boolean or integer or enumeration or string variable<br>
\(\mathbf{f}_{\mathit{init}}, \mathbf{f}_{\mathit{out}} \in C^0\) (=continuous functions with respect to all input parameters inside the respective mode).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>[Remark - Calling Sequences:</em></p>
</div>
<div class="paragraph">
<p><em>In <a href="#table-math-co-simulation">Table 10</a>, for notational convenience in <strong>Initialization Mode</strong> one function call is defined to compute all output arguments from all inputs arguments.</em>
<em>In reality, every variable output argument is computed by one</em> <code>fmi3Get{VariableType}</code> <em>function call.</em></p>
</div>
<div class="paragraph">
<p><em>In <strong>Step Mode</strong> the input arguments to</em> \(\mathbf{f}_{\mathit{doStep}}\) <em>are defined by calls to</em> <code>fmi3Set{VariableType}</code> <em>functions.</em>
<em>The variables computed by</em> \(\mathbf{f}_{\mathit{doStep}}\) <em>can be inquired by</em>  <code>fmi3Get{VariableType}</code> <em>function calls.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="smoothness">4.1.3. Smoothness, Continuity and Discontinuity</h4>
<div class="paragraph">
<p>Since inputs will be set at specific communication points by the importing tool, the FMU must make assumptions about the values between these communication points, including points of intermediate updates.</p>
</div>
<div class="paragraph">
<p>Between communication points, even when intermediate updates are called, all changes must be assumed to be continuous.
Changes to <a href="#continuous"><code>continuous</code></a> variables are only considered discrete in <strong>Event Mode</strong>.</p>
</div>
<div class="paragraph">
<p><a href="#continuous">Continuous</a> inputs may change between communication points in case of <a href="#intermediateVariableSetRequested"><code>intermediateVariableSetRequested == true</code></a>.
These intermediate values are provided by the co-simulation algorithm for example by an extrapolation polynomial build with the output derivatives of connected FMUs (see <a href="#recommendedIntermediateInputSmoothness"><code>recommendedIntermediateInputSmoothness</code></a>).
FMUs can signal with the optional flag <a href="#recommendedIntermediateInputSmoothness"><code>recommendedIntermediateInputSmoothness</code></a> of value \(k\) to the co-simulation algorithm that best convergence rates can be achieved if the functions are of smoothness \(C^{k}([t_i, t_{i+1}])\), that is k-time continuously differentiable, with \(C^{0}\) meaning continuous.
It is therefore recommended that the function defined by the continuation of \(\mathbf{u}_{i, u}\) with \(\mathbf{u}_{i+1, u}\) is of smoothness \(C^{k}([t_i, t_{i+2}])\) with the optional flag <a href="#recommendedIntermediateInputSmoothness"><code>recommendedIntermediateInputSmoothness</code></a> of value \(k\).<br>
<em>[This can increase simulation speed for higher order multi-step solvers that in this case do not have to reset at communication points.]</em></p>
</div>
<div class="paragraph">
<p>For <a href="#continuous"><code>continuous</code></a> input variables, the importer must ensure that the input approximation function \(\mathbf{u}_u\) is consistent with the values of the input variable (\(\mathbf{u}_u(t_{i+1})= \mathbf{u}(t_{i+1})\)).<br>
If a <a href="#continuous"><code>continuous</code></a> input changes <code>discontinuously</code> (e.g. the actual input value deviates too much from the extrapolation polynomial), the co-simulation algorithm must raise an event (if supported) to indicate to the FMU a discontinuous change at an input.</p>
</div>
<div class="paragraph">
<p><em>[In the case of Co-Simulation without events, detecting discrete changes to continuous input variables (for instance to reset the integration algorithm) requires heuristics.]</em></p>
</div>
<div class="paragraph">
<p><a href="#discrete"><code>Discrete</code></a> inputs keep their values between communication points.
Furthermore, changing <a href="#discrete"><code>discrete</code></a> variables at communication points will likely require special handling within the FMU.
Since the FMU itself can detect such changes, the co-simulation algorithm does not need to raise explicit events in such a case.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="co-simulation-api">4.2. Application Programming Interface</h3>
<div class="paragraph">
<p>This section contains the interface description to access the input/output data and status information of a Co-Simulation FMU from a C program.</p>
</div>
<div class="sect3">
<h4 id="transfer-of-input-output-and-parameters">4.2.1. Getting and Setting Variable Values</h4>
<div class="paragraph">
<p><a href="#input"><code>Input</code></a>, <a href="#output"><code>output</code></a> and other variables are accessed via the <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code> functions, defined in <a href="#get-and-set-variable-values">Section 2.2.5</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3GetOutputDerivatives"><code>fmi3GetOutputDerivatives</code></a></dt>
</dl>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The n-th <a href="#derivative"><code>derivatives</code></a> with respect to time of continuous <a href="#output"><code>outputs</code></a> can be retrieved with <a href="#fmi3GetOutputDerivatives"><code>fmi3GetOutputDerivatives</code></a> to allow interpolation/extrapolation of connected input variables between communication points by the co-simulation algorithm using <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.<br>
<em>[This enables the same functionality as <code>fmi2SetInputDerivatives</code> did in FMI1.0 and FMI2.0.]</em></p>
</div>
<div class="paragraph">
<p>Whether the FMU is able to provide the <a href="#derivative"><code>derivatives</code></a> of <a href="#output"><code>outputs</code></a> is given by the unsigned integer capability flag <code>maxOutputDerivativeOrder</code> that represents the maximum order of the <a href="#output"><code>output</code></a> <a href="#derivative"><code>derivatives</code></a>.
If the actual order is lower (because the order of integration algorithm is low), the retrieved value is 0.</p>
</div>
<div class="paragraph">
<p>Restrictions on calling the function are the same as for the <code>fmi3Get{VariableType}</code> function for <a href="#continuous"><code>continuous</code></a> <a href="#output"><code>outputs</code></a>.
The returned values correspond to the current time of the FMU.
For example, after a successful call to <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>, the returned values are related to the end of the communication step.</p>
</div>
</div>
</div>
<div id="fmi3GetOutputDerivatives" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3GetOutputDerivativesTYPE(fmi3Instance instance,
                                                const fmi3ValueReference valueReferences[],
                                                size_t nValueReferences,
                                                const fmi3Int32 orders[],
                                                fmi3Float64 values[],
                                                size_t nValues);</code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>valueReferences</code> is a vector of value references that define the variables whose <a href="#derivative"><code>derivatives</code></a> shall be retrieved.
If multiple derivatives of a variable shall be retrieved, list the value reference multiple times.</p>
</li>
<li>
<p><code>nValueReferences</code> is the dimension of the arguments <code>valueReferences</code> and <code>orders</code>.</p>
</li>
<li>
<p><code>orders</code> contains the orders of the respective <a href="#derivative"><code>derivative</code></a> (1 means the first <a href="#derivative"><code>derivative</code></a>, 2 means the second <a href="#derivative"><code>derivative</code></a>, &#8230;&#8203;, 0 is not allowed).
If multiple derivatives of a variable shall be retrieved, provide a list of them in the <code>orders</code> array, corresponding to a multiply occurring value reference in the <code>valueReferences</code> array.</p>
</li>
<li>
<p><code>values</code> is a vector with the values of the <a href="#derivative"><code>derivatives</code></a>.
The order of the <code>values</code> elements is derived from a twofold serialization: the outer level corresponds to the combination of a value reference (e.g., <code>valueReferences[k]</code>) and order (e.g., <code>orders[k]</code>), and the inner level to the serialization of variables.
The inner level does not exist for scalar variables.</p>
</li>
<li>
<p><code>nValues</code> is the size of the argument <code>values</code>.
<code>nValues</code> only equals <code>nValueReferences</code> if all corresponding output variables are scalar variables.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p><em>[ Example:</em><br>
<em>Assuming an FMU has outputs \(y_1\)[2*3] with value reference 1, \(y_2\) with value reference 2, \( y_3\)[2] value reference 3, \(y_4\) with value reference 4 and <code>maxOutputDerivativeOrder</code>=2.</em><br>
<em>With <code>valueReferences</code>= [1, 1, 3, 3, 4, 4], and <code>orders</code>= [1, 2, 1, 2, 1, 2], <a href="#fmi3GetOutputDerivatives"><code>fmi3GetOutputDerivatives</code></a> will provide first and second time derivatives of the outputs y1, y3, y4, which in <code>values</code> are serialized in the following way:</em>
<em>((array serialization of \(\dot y_1\)), (array serialization of \(\ddot y_1\)), (array serialization of \(\dot y_3\)), (array serialization of \(\ddot y_3\)), \(\dot y_4\), \(\ddot y_4\))</em><br>
<em>If the internal polynomial is of order 1 and the co-simulation algorithm inquires the second <a href="#derivative"><code>derivative</code></a> of an <a href="#output"><code>output</code></a>, the FMU will return zero.]</em></p>
</div>
</div>
<div class="sect3">
<h4 id="Computation-in-Co-Simulation">4.2.2. Computation in Co-Simulation</h4>
<div class="paragraph">
<p>The importer requests the computation of the next time step with the following function:</p>
</div>
<div id="fmi3DoStep" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3DoStepTYPE(fmi3Instance instance,
                                  fmi3Float64 currentCommunicationPoint,
                                  fmi3Float64 communicationStepSize,
                                  fmi3Boolean noSetFMUStatePriorToCurrentPoint,
                                  fmi3Boolean* eventEncountered,
                                  fmi3Boolean* clocksAboutToTick,
                                  fmi3Boolean* terminate,
                                  fmi3Boolean* earlyReturn,
                                  fmi3Float64* lastSuccessfulTime);</code></pre>
</div>
</div>
<div id="currentCommunicationPoint" class="ulist">
<ul>
<li>
<p><code>currentCommunicationPoint</code> is the current communication point of the co-simulation algorithm (\(t_i\)) with the unit of the <a href="#independent"><code>independent</code></a> variable and</p>
</li>
</ul>
</div>
<div id="communicationStepSize" class="ulist">
<ul>
<li>
<p><code>communicationStepSize</code> is the communication step size (\(h_i\)) with the unit of the <a href="#independent"><code>independent</code></a> variable.
<code>communicationStepSize</code> must be \(&gt; 0.0\).</p>
</li>
</ul>
</div>
<div id="noSetFMUStatePriorToCurrentPoint" class="ulist">
<ul>
<li>
<p><code>noSetFMUStatePriorToCurrentPoint == fmi3True</code> if <code>fmi3SetFMUState</code> will no longer be called for time instants prior to <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> in this simulation run.
<em>[The FMU can use this flag to flush a result buffer.]</em></p>
</li>
</ul>
</div>
<div id="eventEncountered" class="ulist">
<ul>
<li>
<p><a href="#eventEncountered"><code>eventEncountered == fmi3True</code></a> indicates that an event was encountered at <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> and the co-simulation algorithm has to call <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> to gather related information about the event.</p>
</li>
</ul>
</div>
<div id="clocksAboutToTick" class="ulist">
<ul>
<li>
<p><a href="#clocksAboutToTick"><code>clocksAboutToTick == fmi3True</code></a> indicates that one or more clocks will tick at <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> and, after calling <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>, <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> should be called to gather all information related to <a href="#outputClock"><code>output clocks</code></a> that have the value <code>fmi3ClockActive</code>.</p>
</li>
<li>
<p><code>terminate</code> signals to the co-simulation algorithm that the FMU requests the end of the simulation for internal reasons.
This is not due to an error, but a natural limit to the simulation time has been reached inside the FMU.</p>
</li>
</ul>
</div>
<div id="earlyReturn" class="ulist">
<ul>
<li>
<p><code>earlyReturn</code> signals to the co-simulation algorithm that the FMU returns early from the <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> at the time specified in <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a>.</p>
</li>
</ul>
</div>
<div id="lastSuccessfulTime" class="ulist">
<ul>
<li>
<p><code>lastSuccessfulTime</code> represents the internal time of the FMU when <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returns.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The FMU is expected to compute until time \(t_{i+1} = t_i + h_i\), or <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> <code>=</code> <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> <code>+</code> <a href="#communicationStepSize"><code>communicationStepSize</code></a>.</p>
</div>
<div class="paragraph">
<p>This is especially interesting, if <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returns with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a>.
In this case, the step did not compute until \(t_{i+1}\), but stopped computation error free until <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a>.
However, even when the FMU returns from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with <a href="#fmi3OK"><code>fmi3OK</code></a>, it is allowed that <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> deviates from the expected <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> <code>+</code> <a href="#communicationStepSize"><code>communicationStepSize</code></a>.
<em>[An example is a fixed-step integrator inside the FMU that cannot possibly stop at exactly the requested time.</em>
<em>Advanced co-simulation algorithms might be able to take this information into account.</em>
<em>It is even possible that the <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a> is still equal to <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> when <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a> is returned (contrary to the possibly expected <a href="#fmi3Discard"><code>fmi3Discard</code></a>) to indicate a changed internal state of the FMU, e.g. steps in super-dense time.]</em></p>
</div>
<div class="paragraph">
<p><em>[The calling environment defines the communication points and <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> must synchronize to these points by always integrating exactly to \(t_i + h_i\).</em>
<em>It is up to <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> how to achieve this.]</em></p>
</div>
<div class="paragraph">
<p>At the first call to <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> after <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> was called <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> must be equal to <code>startTime</code> as set with <a href="#fmi3EnterInitializationMode"><code>fmi3EnterInitializationMode</code></a>.</p>
</div>
<div class="paragraph">
<p><em>[Formally, argument <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> is not needed.</em>
<em>It is present in order to handle a mismatch between the co-simulation algorithm and the state of the FMU: The <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> and the state of the FMU defined by former</em> <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> <em>or</em> <code>fmi3SetFMUState</code> <em>calls have to be consistent with respect to each other.</em>
<em>For example, if the FMU does not use the update formula for the <a href="#independent"><code>independent</code></a> variable as required above,</em> \(t_{i+1} = t_i + h_i\) <em>(using argument</em> \(t_i\) = <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> <em>of</em> <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>) <em>but uses internally an own update formula, such as</em> \(t_{s,i+1} = t_{s,i} + h_{s,i}\) <em>then the FMU could use as time increment</em> \(\text{h}_{s,i} := (t_i - t_{s,i}) + h_i\) <em>(instead of</em> \(\text{h}_{s,i} := h_i\) <em>) to avoid a mismatch between the co-simulation algorithm time</em> \(t_{i+1}\) <em>and the FMU internal time</em> \(t_{s,i+1}\) <em>for large i.]</em></p>
</div>
<div class="paragraph">
<p>It depends on the capabilities of the FMU which argument constellations and calling sequences are allowed (see <a href="#fmi-for-co-simulation">Section 4</a>).</p>
</div>
<div class="paragraph">
<p>Only <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> can change the time of a Co-Simulation FMU from the outside (time advances internally during a communication interval).</p>
</div>
</div>
<div class="sect3">
<h4 id="Communication-during-update">4.2.3. Communication of Event Time and Input and Output Values</h4>
<div class="paragraph">
<p>The <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> callback described in <a href="#IntermediateUpdateMode">Section 2.3.3</a> is also used in order to communicate the <a href="#input"><code>input</code></a> and <a href="#output"><code>output</code></a> and, in particular, the event and <a href="#clock"><code>clock</code></a> time from the FMU to the co-simulation algorithm.
The <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> callback allows internal events (e.g. associated to <a href="#outputClock"><code>outputClock</code></a> ticks) to be signaled from an FMU to the co-simulation algorithm.
For the interface type Co-Simulation, the <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> callback must be defined in the instantiate function, i.e. NULL is not allowed.</p>
</div>
<div class="paragraph">
<p>The arguments of <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> are used to signal <a href="#outputClock"><code>outputClock</code></a> ticks and internal events to the co-simulation algorithm.
See <a href="#IntermediateUpdateMode">Section 2.3.3</a> for details of the function parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void (*fmi3CallbackIntermediateUpdate) (
    fmi3InstanceEnvironment instanceEnvironment,
    fmi3Float64 intermediateUpdateTime,
    fmi3Boolean clocksTicked,
    fmi3Boolean intermediateVariableSetRequested,
    fmi3Boolean intermediateVariableGetAllowed,
    fmi3Boolean intermediateStepFinished,
    fmi3Boolean canReturnEarly,
    fmi3Boolean *earlyReturnRequested,
    fmi3Float64 *earlyReturnTime);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only the first discontinuity event at a Newtonian time instant shall be signaled using this function.
There may be an event iteration in <strong>Event Mode</strong> at a Newtonian time instant causing super-dense time instants.</p>
</div>
<div class="paragraph">
<p>Based on the information provided by <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>, additional information about the discontinuity at that time instant can be obtained by the co-simulation algorithm from the FMU by calling <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> and <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="early-return">4.2.4. Early Return</h4>
<div class="paragraph">
<p><em>[In the particular context of multi-FMU architectures, significant co-simulation speed-up may be obtained if the co-simulation algorithm can avoid waiting until the end of the slowest FMU step integration.</em>
<em>If an FMU prematurely stops its current step integration computation due to an unpredictable internal event before the normal end of the step calculation, all other concurrently running FMUs may be stopped as soon as possible in order to minimize the time needed for the co-simulation algorithm to resynchronize all the FMUs at the same event time.</em></p>
</div>
<div class="paragraph">
<p><em>In this context based on parallel multi-FMU calculations, <a href="#figure-early-return">Figure 29</a> illustrates different possibilities to synchronize FMUs at the same event time.</em></p>
</div>
<div id="figure-early-return" class="imageblock text-center">
<div class="content">
<img src="images/earlyReturnFigure.svg" alt="earlyReturnFigure" width="100%">
</div>
<div class="title">Figure 29. Different possibilities to synchronize parallel FMUs at the same event time.</div>
</div>
<div class="paragraph">
<p><em>Each FMU starts integration from communication point</em> \(t_{i}\) <em>to reach the next communication point</em> \(t_{i+1}\) <em>.</em>
<em>Assuming an unexpected internal event is detected at</em> \(t^{'}_{i+1}&lt; t_{i+1}\) <em>inside FMU<sub>1</sub> , the FMU immediately informs the co-simulation algorithm and asks for an early return.</em>
<em>Since all FMUs should be resynchronized at the event time which will be the next new communication point, the co-simulation algorithm would like to avoid other FMUs exceed the event time.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>In the case of FMU<sub>1</sub>, the FMU waits to get pushed into the event mode to handle the event at</em> \(t^{'}_{i+1}\) <em>.</em></p>
</li>
<li>
<p><em>FMU<sub>2</sub> can not be interrupted before it reaches</em> \(t_{i+1}\) <em>, which requires a complete rollback and a new co-simulation from</em> \(t_{i}\) <em>to</em> \(t^{'}_{i+1}\) <em>.</em></p>
</li>
<li>
<p><em>FMU<sub>3</sub> triggers the callback function to the co-simulation algorithm after passing</em> \(t^{'}{i+1}\) <em>, which leads to a request by the co-simulation algorithm to immediately do an early return.
The FMU interrupts its computation and a partial rollback and a new co-simulation from</em> \(t_{i}\) <em>to</em> \(t^{'}_{i+1}\) <em>is necessary.</em></p>
</li>
<li>
<p><em>In the case of FMU<sub>4</sub>, the FMU triggered the callback function before reaching</em> \(t^{'}_{i+1}\) <em>.
The co-simulation algorithm requests FMU<sub>4</sub> to do an early return at</em> \(t^{'}{i+1}\) <em>and the FMU will interrupt its current integration step at</em> \(t^{'}{i+1}\) <em>.
No rollback is necessary for FMU<sub>4</sub>.</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Each ongoing FMU stops its integration either exactly at the interrupt time given by the co-simulation algorithm or immediately after its current intermediate step, if this time is already out-of-date.</em>
<em>Afterwards, a new step integration done on the FMU returns and signals the premature stop (early-return) to the co-simulation algorithm.</em></p>
</div>
<div class="paragraph">
<p><em>Due to the early-return mechanism, the overall execution time of the simulation can be reduced.]</em></p>
</div>
<div class="paragraph">
<p>A Co-Simulation FMU is allowed to stop the execution of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> and return without reaching the predefined communication time, i.e. <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> <code>+</code> <a href="#communicationStepSize"><code>communicationStepSize</code></a>.
This mechanism is called "early return".</p>
</div>
<div id="canReturnEarlyAfterIntermediateUpdate" class="paragraph">
<p>The Boolean capability flag <a href="#canReturnEarlyAfterIntermediateUpdate"><code>canReturnEarlyAfterIntermediateUpdate</code></a> in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file indicates whether the FMU supports the early-return feature.
The default value of this capability flag is <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Each time an internal discontinuity or an event happens inside an FMU with capability flag <a href="#canReturnEarlyAfterIntermediateUpdate"><code>canReturnEarlyAfterIntermediateUpdate = true</code></a>, the callback function <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> is called by the FMU.
The co-simulation algorithm can only use this early return functionality, if it provides the <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> callback function pointer in the instantiate function.</p>
</div>
<div class="paragraph">
<p>With the early return feature, an FMU can signal <a href="#outputClock"><code>outputClock</code></a> events or internal state changes, i.e., discontinuity events to the co-simulation algorithm at any time (not only at the end of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> function calls).
When an internal event occurs inside the FMU at a time instant, it informs the co-simulation algorithm that a new communication point for the Co-Simulation can be created.
Note that an event signal is not seen in the narrow sense of solver induced discontinuity events but in the general sense of a simulation event that has to be handled by the co-simulation algorithm (e.g. state changes that require extended handling).</p>
</div>
<div class="paragraph">
<p>A second use of the early-return mechanism is the following:
In particular in multi-node architectures, significant co-simulation speed-up may be obtained if the co-simulation algorithm can avoid waiting until the end of the slowest <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>, when many FMUs are integrating in parallel and an event occurs.
To exploit such efficiency gains, the co-simulation algorithm can command the FMUs to return early from the current communication step, if it gets triggered in the callback function by the FMUs.
<em>[In this use case, early return is a simple form of cooperative multitasking.]</em></p>
</div>
<div class="paragraph">
<p>Early return is even helpful if the FMU or the co-simulation algorithm do not support the advanced handling of events based on the <a href="#co-simulation-api">Co-Simulation</a> functionalities.
Multiple event types and also <a href="#outputClock"><code>outputClock</code></a> ticks or interrupts can be supported based on the early-return functionality and additional functionalities provided by <a href="#co-simulation-api">Co-Simulation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_early_return_and_events">4.2.5. Handling Early Return and Events</h4>
<div class="paragraph">
<p>If the FMU is successful in conducting an early return, <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returns with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a>.
If the FMU returns from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a>, the co-simulation algorithm has to call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> for that FMU.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterEventModeTYPE(fmi3Instance instance,
                                          fmi3Boolean stepEvent,
                                          const fmi3Int32 rootsFound[],
                                          size_t nEventIndicators,
                                          fmi3Boolean timeEvent);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The co-simulation algorithm can also call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> at communication instants to handle input events, as will be discussed in following sections.</p>
</div>
<div class="paragraph">
<p>If an FMU provides the early-return capability that includes the handling of events in <strong>Event Mode</strong>,
the FMU signals this via <a href="#canReturnEarlyAfterIntermediateUpdate"><code>canReturnEarlyAfterIntermediateUpdate</code></a> in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.</p>
</div>
<div class="paragraph">
<p>The FMU stops computation at the first encountered internal event (if any) and the event time is provided through the output argument <a href="#lastSuccessfulTime"><code>lastSuccessfulTime</code></a>, along with the reason <a href="#eventEncountered"><code>eventEncountered == fmi3True</code></a>.
The co-simulation algorithm will start event handling by calling <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> for that FMU to push the FMU into <strong>Event Mode</strong>.
In this mode the co-simulation algorithm is supposed to catch all events through the <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> function.</p>
</div>
<div class="paragraph">
<p>If an early-return request of the co-simulation algorithm is ignored by the FMU, then <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returns with <a href="#earlyReturn"><code>earlyReturn == fmi3False</code></a>.
The co-simulation algorithm can start a resynchronization of FMUs at an event time, if the <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a> has passed the event time, the co-simulation algorithm can roll-back the FMU and repeat the step with a suitable <a href="#communicationStepSize"><code>communicationStepSize</code></a> (if the FMU supports the roll-back).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3NewDiscreteStatesTYPE(fmi3Instance instance,
                                             fmi3Boolean *newDiscreteStatesNeeded,
                                             fmi3Boolean *terminateSimulation,
                                             fmi3Boolean *nominalsOfContinuousStatesChanged,
                                             fmi3Boolean *valuesOfContinuousStatesChanged,
                                             fmi3Boolean *nextEventTimeDefined,
                                             fmi3Float64 *nextEventTime);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <strong>Event Mode</strong> and only after <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returned with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a>, and <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> was called, the function <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> may be called.
Only the following output arguments are defined by the FMU:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When <code>newDiscreteStatesNeeded = true</code>, the co-simulation algorithm should stay in <strong>Event Mode</strong> and another call to <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> is required.</p>
</li>
<li>
<p>When <a href="#nextEventTime"><code>nextEventTimeDefined == fmi3True</code></a>, an event time is available and the value is given by <a href="#nextEventTime"><code>nextEventTime</code></a>.
This is the case when the model can report in advance the accurate time of the next predictable <a href="#time-event">time event</a>.</p>
</li>
<li>
<p>When <a href="#terminateSimulation"><code>terminateSimulation == fmi3True</code></a>, the model requested to stop integration and the co-simulation algorithm should call <a href="#fmi3Terminate"><code>fmi3Terminate</code></a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All other output arguments of <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> are undefined and have no meaning in Co-Simulation.</p>
</div>
<div class="paragraph">
<p>In <strong>Event Mode</strong> it is allowed to call <code>fmi3Get{VariableType}</code> after <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> has been called and it is allowed to call <code>fmi3Set{VariableType}</code> before calling <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>.
The FMU leaves <strong>Event Mode</strong> when the co-simulation algorithm calls <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="api-clocked-co-simulation">4.2.6. Co-Simulation with Clock Support</h4>
<div class="paragraph">
<p>In this section, signaling and retrieving <a href="#clock"><code>clock</code></a> ticks as well as the interface for supporting <a href="#clock"><code>clocks</code></a> in FMI for Co-Simulation will be discussed.
If an FMU for Co-Simulation declares <a href="#clock"><code>clocks</code></a> and clocked variables in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> file, it supports <a href="#clock"><code>clocks</code></a>.
Note, even if no <a href="#clock"><code>clock</code></a> is defined by an FMU in <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>, the co-simulation algorithm can instantiate a Co-Simulation FMU to be able to use early return with event handling in <strong>Event Mode</strong>.</p>
</div>
<div class="paragraph">
<p>If an FMU provides <a href="#clock"><code>clocks</code></a> and the co-simulation algorithm is using the interface type Co-Simulation, the co-simulation algorithm must handle these <a href="#clock"><code>clocks</code></a> and early return requests by the FMU.
If the co-simulation algorithm does not support or does not want to support early-return or <a href="#clock"><code>clocks</code></a>, it must set the interface type to Co-Simulation if supported by the FMU.
If the FMU provides the Co-Simulation interface and is instantiated with it, the FMU must internally handle all events during <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.</p>
</div>
<div id="fmi3EnterStepMode" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3EnterStepModeTYPE(fmi3Instance instance);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="transfer-of-input-output-and-parameters-clocked-co-simulation">4.2.6.1. Transfer of Input and Output Values and Parameters</h5>
<div class="paragraph">
<p>If the co-simulation algorithm supports <a href="#clock"><code>clocks</code></a>, all <a href="#inputClock"><code>input clocks</code></a> of the model should be handled and <a href="#inputClock"><code>inputClock</code></a> events should be scheduled by the co-simulation algorithm.
If an <a href="#outputClock"><code>outputClock</code></a> will tick, the FMU returns from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with <a href="#clocksAboutToTick"><code>clocksAboutToTick == fmi3True</code></a>.
After calling <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a>, the activation status of <a href="#outputClock"><code>output clocks</code></a> can be retrieved with <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>.
Then <a href="#fmi3SetClock"><code>fmi3SetClock</code></a> (and <a href="#fmi3SetIntervalDecimal"><code>fmi3SetIntervalDecimal</code></a> or <a href="#fmi3SetIntervalFraction"><code>fmi3SetIntervalFraction</code></a> if necessary) should be invoked to enable the ticked <a href="#inputClock"><code>input clocks</code></a>.
Each <a href="#clock"><code>clock</code></a>, that ticks outside of the FMU (i.e. <a href="#inputClock"><code>inputClock</code></a>), is activated for an FMU based on its <a href="#clockReference"><code>clockReference</code></a> and an associated <a href="#fmi3SetClock"><code>fmi3SetClock</code></a> in <strong>Event Mode</strong>.
<a href="#fmi3SetClock"><code>fmi3SetClock</code></a> can activate multiple <a href="#clock"><code>clocks</code></a> with each call.
An event iteration is possible.
Once all <a href="#clock"><code>clock</code></a> events are handled for this time instant, the FMU should be pushed into <strong>Step Mode</strong> by calling <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a>.
In <strong>Step Mode</strong>, the co-simulation algorithm can call <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> for the time interval from the current event time instant until the next input event instant.
Note that <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> may not reach the next input event instant because an early return may occur.</p>
</div>
<div class="paragraph">
<p>The co-simulation algorithm sets and gets <a href="#clock"><code>clock</code></a> variable values similar to the FMI for Model Exchange, as defined in <a href="#fmi-api-setting-getting-clock-activation-state">Section 2.2.7.9</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="computation-clocked-co-simulation">4.2.6.2. Computation in Co-Simulation</h5>
<div class="paragraph">
<p>Similar to FMI for Model Exchange, in order to activate <a href="#inputClock"><code>input clocks</code></a> of an FMU, it is required to push the FMU into <strong>Event Mode</strong> by calling <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>.
If <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> returns with <a href="#eventEncountered"><code>eventEncountered == fmi3True</code></a> or <a href="#clocksAboutToTick"><code>clocksAboutToTick == fmi3True</code></a>, the FMU must be pushed into <strong>Event Mode</strong> and <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> must be called.</p>
</div>
<div class="paragraph">
<p>In order to retrieve the status of <a href="#outputClock"><code>output clocks</code></a>, <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> and <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> or <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a> need to be called in the <strong>Event Mode</strong>.
If the <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> return value is <a href="#fmi3OK"><code>fmi3OK</code></a>, the calling of <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>, <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a>, <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a>, <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> is only meaningful after <a href="#fmi3SetClock"><code>fmi3SetClock</code></a> in the case of super-dense time iterations are desired.</p>
</div>
<div class="paragraph">
<p>Similar to the Model Exchange case, the allowed call order is <a href="#fmi3GetClock"><code>fmi3GetClock</code></a>, <a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a>, <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a>, <code>fmi3Get{VariableType}</code>, <code>fmi3Set{VariableType}</code>.
Function calls of this call order can be omitted.</p>
</div>
<div class="paragraph">
<p>The handling of return values of function calls is identical to Co-Simulation.</p>
</div>
<div class="paragraph">
<p>If <a href="#terminateSimulation"><code>terminateSimulation</code></a> becomes <code>fmi3True</code> after calling <a href="#fmi3NewDiscreteStates"><code>fmi3NewDiscreteStates</code></a> then the co-simulation should be terminated by calling <a href="#fmi3Terminate"><code>fmi3Terminate</code></a>.
Once handling of the <a href="#clock"><code>clock</code></a> events finished, the co-simulation algorithm calls <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a> for that FMU to push it into <strong>Step Mode</strong>.
Note that it is not allowed to call <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a> or <a href="#fmi3EnterStepMode"><code>fmi3EnterStepMode</code></a> in Scheduled Execution.</p>
</div>
<div class="paragraph">
<p><em>[Usually the co-simulation algorithm should be able to derive (but is not forced to do so) the correct communication point times for <a href="#inputClock"><code>input clocks</code></a> in advance and thus it should be able to set the proper <a href="#communicationStepSize"><code>communicationStepSize</code></a> for <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>.</em>
<em>This might not be possible if an <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>inputClock</code></a> of an FMU depends on the ticking of an <a href="#periodic">aperiodic</a> <a href="#outputClock"><code>outputClock</code></a> of another FMU or other <a href="#periodic">aperiodic</a> tick sources.]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="state-machine-co-simulation">4.2.7. State Machine for Co-Simulation</h4>
<div class="paragraph">
<p>The state machine in <a href="#figure-co-simulation-state-machine">Figure 30</a> defines the supported calling sequences.</p>
</div>
<div id="figure-co-simulation-state-machine" class="imageblock text-center">
<div class="content">
<img src="images/state-machine-co-simulation.svg" alt="state machine co simulation" width="80%">
</div>
<div class="title">Figure 30. Calling sequence of Co-Simulation C functions.</div>
</div>
<div class="paragraph">
<p>Each state of the state machine corresponds to a certain phase of a simulation.
Common states are defined in <a href="#common-state-machine">Section 2.3</a>, such as super states <a href="#FMUStateSetable"><strong>FMU State Setable</strong></a> and  <a href="#Initialized"><strong>Initialized</strong></a>, states <a href="#Instantiated"><strong>Instantiated</strong></a>, <a href="#ConfigurationMode"><strong>Configuration Mode</strong></a>, <a href="#ReconfigurationMode"><strong>Reconfiguration Mode</strong></a>, <a href="#InitializationMode"><strong>Initialization Mode</strong></a>, <a href="#Terminated"><strong>Terminated</strong></a> and <a href="#IntermediateUpdateMode"><strong>Intermediate Update Mode</strong></a>.</p>
</div>
<div class="sect4">
<h5 id="state-step-mode-co-simulation">4.2.7.1. State: Step Mode</h5>
<div class="paragraph">
<p>This state is used by the co-simulation algorithm to progress simulation time.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dt class="hdlist1">Function <a href="#fmi3EnterConfigurationMode"><code>fmi3EnterConfigurationMode</code></a></dt>
<dd>
<p>Changes state to <strong>Reconfiguration Mode</strong>.
This function must not be called if the FMU contains no <a href="#tunable"><code>tunable</code></a> <a href="#structuralParameter"><code>structural parameters</code></a> (i.e. with <a href="#causality"><code>causality</code></a>= <a href="#structuralParameter"><code>structuralParameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a>).</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a></dt>
<dd>
<p>Changes state to <strong>Event Mode</strong>.
This function must not be called, if <a href="#fmi3InstantiateCoSimulation"><code>fmi3InstantiateCoSimulation</code></a> signaled <code>eventModeUsed = fmi3False</code>, which implies that the capability flag <code>hasEventMode = true</code>.</p>
</dd>
<dt class="hdlist1">Function <a href="#fmi3DoStep"><code>fmi3DoStep</code></a></dt>
<dd>
<p>Within <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> the FMU may call <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a></p>
<div class="ulist">
<ul>
<li>
<p>If the function returns with <a href="#fmi3OK"><code>fmi3OK</code></a> or <a href="#fmi3Warning"><code>fmi3Warning</code></a> the FMU stays in this state.</p>
</li>
<li>
<p>The co-simulation algorithm must call <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with <a href="#communicationStepSize"><code>communicationStepSize &gt; 0.0</code></a>.</p>
</li>
<li>
<p>If the function returns with <a href="#earlyReturn"><code>earlyReturn == fmi3True</code></a> the FMU will change to states depending on the flags of <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.</p>
</li>
<li>
<p>The FMU may return immediately from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> with <a href="#lastSuccessfulTime"><code>lastSuccessfulTime == currentCommunicationPoint</code></a> if an event was detected immediately at the <a href="#currentCommunicationPoint"><code>currentCommunicationPoint</code></a>.
Such an event might be caused by the change of an input during the communication point, or may be pending after the initialization.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Function <code>fmi3Set{VariableType}</code></dt>
<dd>
<p>For variables with:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#causality"><code>causality</code></a> = <a href="#input"><code>input</code></a>, or</p>
</li>
<li>
<p><a href="#causality"><code>causality</code></a> = <a href="#parameter"><code>parameter</code></a> and <a href="#variability"><code>variability</code></a> = <a href="#tunable"><code>tunable</code></a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is not allowed to call <code>fmi3Get{VariableType}</code> functions after <code>fmi3Set{VariableType}</code> functions without an <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> call in between.</p>
</div>
<div class="paragraph">
<p><em>[The reason is to avoid different interpretations of the caching, since contrary to FMI for Model Exchange, <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> will perform the actual calculation instead of <code>fmi3Get{VariableType}</code>, and therefore, dummy algebraic loops at communication points cannot be handled by an appropriate sequence of <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code> calls as for Model Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Examples:</em></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><em>Correct calling sequence</em></th>
<th class="tableblock halign-left valign-top"><em>Wrong calling sequence</em></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>fmi3Set{VariableType} on inputs</em><br>
<em>fmi3DoStep</em><br>
<em>fmi3Get{VariableType} on outputs</em><br>
<em>fmi3Set{VariableType} on inputs</em><br>
<em>fmi3DoStep</em><br>
<em>fmi3Get{VariableType} on outputs</em><br></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>fmi3Set{VariableType} on inputs</em><br>
<em>fmi3DoStep</em><br>
<em>fmi3Get{VariableType} on outputs</em><br>
<em>fmi3Set{VariableType} on inputs</em><br>
<em>fmi3Get{VariableType} on outputs // not allowed</em><br>
<em>fmi3DoStep</em><br>
<em>fmi3Get{VariableType} on outputs</em><br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_example_for_co_simulation">4.2.8. Code Example for Co-Simulation</h4>
<div class="paragraph">
<p>In the following example, the usage of the FMI functions is sketched in order to clarify the typical calling sequence of the functions in a simulation environment.
We consider two FMUs, where both have one <a href="#continuous"><code>continuous</code></a> floating point <a href="#input"><code>input</code></a> and one <a href="#continuous"><code>continuous</code></a> floating point <a href="#output"><code>output</code></a> which are connected in the following way:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/co-simulation-connection-of-FMUs.svg" alt="co simulation connection of FMUs" width="30%">
</div>
<div class="title">Figure 31. Connection graph of FMUs.</div>
</div>
<div class="paragraph">
<p>We assume no algebraic dependency between input and <a href="#output"><code>output</code></a> of each FMU.
The code demonstrates the simplest co-simulation algorithm as shown in <a href="#math-co-simulation">Section 4.1</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Constant communication step size.</p>
</li>
<li>
<p>No repeating of communication steps.</p>
</li>
<li>
<p>The error handling is implemented in a very rudimentary way.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">////////////////////////////
// Initialization sub-phase

// instantiate both FMUs
s1 = s1_fmi3InstantiateCoSimulation("instance1",      // instanceName
                                    guid,          // instantiationToken
                                    NULL,          // resourceLocation
                                    fmi3False,     // visible
                                    fmi3False,     // loggingOn
                                    fmi3False,     // eventModeRequired
                                    NULL,          // requiredIntermediateVariables
                                    0,             // nRequiredIntermediateVariables
                                    NULL,          // instanceEnvironment
                                    cb_logMessage, // logMessage
                                    NULL);         // intermediateUpdate

s2 = s2_fmi3InstantiateCoSimulation("instance1",      // instanceName
                                    guid,          // instantiationToken
                                    NULL,          // resourceLocation
                                    fmi3False,     // visible
                                    fmi3False,     // loggingOn
                                    fmi3False,     // eventModeRequired
                                    NULL,          // requiredIntermediateVariables
                                    0,             // nRequiredIntermediateVariables
                                    NULL,          // instanceEnvironment
                                    cb_logMessage, // logMessage
                                    NULL);         // intermediateUpdate

if (s1 == NULL || s2 == NULL)
    return EXIT_FAILURE;

// start and stop time
startTime = 0;
stopTime = 10;

// communication step size
h = 0.01;

// set all variable start values (of "ScalarVariable / &lt;type&gt; / start")
// s1_fmi3SetReal/Integer/Boolean/String(s1, ...);
// s2_fmi3SetReal/Integer/Boolean/String(s2, ...);

// initialize the FMUs
s1_fmi3EnterInitializationMode(s1, fmi3False, 0.0, startTime, fmi3True, stopTime);
s2_fmi3EnterInitializationMode(s2, fmi3False, 0.0, startTime, fmi3True, stopTime);

// set the input values at time = startTime
// fmi3SetReal/Integer/Boolean/String(s1, ...);
// fmi3SetReal/Integer/Boolean/String(s2, ...);

s1_fmi3ExitInitializationMode(s1);
s2_fmi3ExitInitializationMode(s2);

////////////////////////
// Simulation sub-phase
tc = startTime; // current time

while ((tc &lt; stopTime) &amp;&amp; (status == fmi3OK)) {

    // retrieve outputs
    // fmi3GetReal(s1, ..., 1, &amp;y1);
    // fmi3GetReal(s2, ..., 1, &amp;y2);

    // set inputs
    // fmi3SetReal(s1, ..., 1, &amp;y2);
    // fmi3SetReal(s2, ..., 1, &amp;y1);

    // call instance s1 and check status
    fmi3Boolean terminate, earlyReturn;
    fmi3Float64 lastSuccessfulTime;

    status = s1_fmi3DoStep(s1, tc, h, fmi3True, &amp;terminate, &amp;earlyReturn, &amp;lastSuccessfulTime);

    if (terminate) {
        printf("Instance s1 requested to terminate simulation.");
        break;
    }

    // call instance s2 and check status as above
    status = s2_fmi3DoStep(s2, tc, h, fmi3True, &amp;terminate, &amp;earlyReturn, &amp;lastSuccessfulTime);

    // ...

    // increment current time
    tc += h;
 }

//////////////////////////
// Shutdown sub-phase
if (status != fmi3Error &amp;&amp; status != fmi3Fatal) {
    s1_fmi3Terminate(s1);
    s2_fmi3Terminate(s2);
}

if (status != fmi3Fatal) {
    s1_fmi3FreeInstance(s1);
    s2_fmi3FreeInstance(s2);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="code-example-clocked-co-simulation">4.2.9. Code Example for Clocks</h4>
<div class="paragraph">
<p>In the following example, the usage of the FMI functions is sketched in order to clarify the typical calling sequence of the functions in a simulation environment.
We consider &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The error handling is implemented in a very rudimentary way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">//include::examples/c-code/co_simulation_clocked.c[tags=CoSimulation]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="co-simulation-schema">4.3. Description Schema</h3>
<div class="paragraph">
<p>The common XML elements and attributes are defined in <a href="#fmi-description-schema">Section 2.4</a>.
Additional elements and attributes are defined subsequently.
If the FMU implements the Co-Simulation interface type, the element <code>&lt;CoSimulation&gt;</code> must be present.
It is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/CoSimulation.png" alt="CoSimulation" width="80%">
</div>
</div>
<div class="paragraph">
<p>The attributes in the following table are defined on top of the <a href="#common-capability-flags">common attributes</a> and have the following meaning (all attributes are optional with exception of <code>modelIdentifier</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>modelIdentifier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short class name according to C syntax, for example, <code>A_B_C</code>.
Used as prefix for FMI functions if the functions are provided in C source code or in static libraries, but not if the functions are provided by a DLL/SharedObject.
<code>modelIdentifier</code> is also used as name of the static library or DLL/SharedObject.
See also <a href="#header-files-and-naming-of-functions">Section 2.2.1</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="canHandleVariableCommunicationStepSize"></a><code>canHandleVariableCommunicationStepSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The FMU can handle variable communication step size.
The communication step size (argument <a href="#communicationStepSize"><code>communicationStepSize</code></a> of <a href="#fmi3DoStep"><code>fmi3DoStep</code></a>) has not to be constant for each call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#canReturnEarlyAfterIntermediateUpdate"><code>canReturnEarlyAfterIntermediateUpdate</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, the FMU is able to return early from <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> if the co-simulation algorithm returns <a href="#earlyReturnRequested"><code>earlyReturnRequested == fmi3True</code></a> from the callback <a href="#intermediateUpdate"><code>intermediateUpdate</code></a> and <a href="#canReturnEarly"><code>canReturnEarly == fmi3True</code></a>.
<em>[If set to <code>true</code>, a Co-Simulation FMU supports ending <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> before the planned next communication point.</em>
<em>This can be used by the co-simulation algorithm to avoid unnecessary computations and roll backs of the FMU due to input clock activations known to the co-simulation algorithm.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fixedInternalStepSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fixed internal step size of the FMU (optional).
<em>[This information can be used by the co-simulation algorithm to synchronize the communication interval with the internal step size of the FMU.</em>
<em>The co-simulation algorithm should calculate the communication points by multiplying (<code>number_of_steps * step_size</code>) instead of repeatedly incrementing (<code>time += step_size</code>) to avoid the accumulation of numerical errors.]</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hasEventMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code> the FMU supports <strong>Event Mode</strong>.
Even if this flag is <code>true</code>, the co-simulation algorithm can chose to delegate event handling to the FMU by calling <a href="#fmi3InstantiateCoSimulation"><code>fmi3InstantiateCoSimulation</code></a> with <code>eventModeUsed == fmi3False</code>.
If <code>eventModeUsed == fmi3True</code>, the co-simulation algorithm will have to actively trigger event handling in the FMU using <a href="#fmi3EnterEventMode"><code>fmi3EnterEventMode</code></a>.
<a href="#fmi3InstantiateCoSimulation"><code>fmi3InstantiateCoSimulation</code></a> must only be called with <code>eventModeUsed == fmi3True</code> if <code>hasEventMode == true</code>.
If the FMU has synchronous clocks, then <code>eventModeUsed == fmi3True</code> and the importer must call <a href="#fmi3InstantiateCoSimulation"><code>fmi3InstantiateCoSimulation</code></a> with <code>eventModeUsed == fmi3True</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that if <code>needsExecutionTool = true</code>, then it is required that the original tool is available to be executed during co-simulation.
If <code>needsExecutionTool = false</code>, the FMU is completely contained inside the FMU in source code or binary format (DLL/SharedObject).</p>
</div>
<div class="sect3">
<h4 id="clocks-in-co-simulation">4.3.1. Clocks in Co-Simulation</h4>
<div class="paragraph">
<p>The co-simulation algorithm collects the information about the number and properties of <a href="#clock"><code>clocks</code></a> supported by the FMU by analyzing the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>, see <a href="#clock-type-definition">Section 2.4.4.1</a>.</p>
</div>
<div class="paragraph">
<p>The definition of <a href="#clock"><code>clocks</code></a> is optional.</p>
</div>
<div class="paragraph">
<p>Each <a href="#inputClock"><code>inputClock</code></a> that ticks outside of the FMU, is activated for an FMU based on their <a href="#valueReference"><code>valueReference</code></a>.
<a href="#outputClock"><code>Output clocks</code></a> inside of an FMU signal their activation based on their <a href="#valueReference"><code>valueReference</code></a>.</p>
</div>
<div class="paragraph">
<p><em>[If <a href="#dependencies"><code>dependencies</code></a> (<code>fmi3Unknown</code>) are defined in the <code>&lt;ModelStructure&gt;</code> section of the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>, it is recommended to define such <a href="#dependencies"><code>dependencies</code></a> only within a model partition of a model (i.e. between variables that are assigned to the same <a href="#clock"><code>clock</code></a>).]</em></p>
</div>
<div class="paragraph">
<p>If <a href="#dependencies"><code>dependencies</code></a> are defined for variables across model partitions, such variables can not be assigned to a <a href="#clock"><code>clock</code></a> via <a href="#clockReference"><code>clockReference</code></a>.</p>
</div>
<div class="paragraph">
<p>For FMI for Co-Simulation, variables that are assigned to a model partition of the model based on <a href="#clockReference"><code>clockReference</code></a> are not necessarily <code>clocked</code>.
Such variables can be continuous-time or discrete-time variables if the <a href="#clock"><code>clock</code></a> is of <code>clockType = communicationPoint</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_xml_description_file">4.3.2. Example XML Description File</h4>
<div class="sect4">
<h5 id="xml-example-co-simulation">4.3.2.1. Example XML Description File with Early Return</h5>
<div class="paragraph">
<p>The <a href="#xml-example-fmimodeldescription-cosimulation">Example fmiModelDescription</a> below is the same as shown in <a href="#xml-example-model-exchange">Section 3.3.1</a> for a Model Exchange FMU.
The only differences are the replacement of the element <code>&lt;ModelExchange&gt;</code> with the element <code>&lt;CoSimulation&gt;</code> (with additional attributes),  and the removal of <a href="#local"><code>local</code></a> variables, which are associated with continuous <a href="#state"><code>states</code></a> and their <a href="#derivative"><code>derivatives</code></a> and presence of the capability flags <a href="#canHandleVariableCommunicationStepSize"><code>canHandleVariableCommunicationStepSize</code></a> and <a href="#canReturnEarlyAfterIntermediateUpdate"><code>canReturnEarlyAfterIntermediateUpdate</code></a> with value <code>true</code>.</p>
</div>
<div id="xml-example-fmimodeldescription-cosimulation" class="listingblock">
<div class="title">Example fmiModelDescription</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;fmiModelDescription
  fmiVersion="3.0-alpha.5"
  modelName="MyLibrary.SpringMassDamper_Early_Return_example"
  instantiationToken="{8c4e810f-3df3-4a00-8276-176fa3c9f9e0}"
  description="Rotational Spring Mass Damper System"
  version="1.0"
  generationDateAndTime="2011-09-23T16:57:33Z"
  variableNamingConvention="structured"&gt;
  &lt;CoSimulation
    modelIdentifier="MyLibrary_SpringMassDamper"
    canHandleVariableCommunicationStepSize="true"
    canReturnEarlyAfterIntermediateUpdate="true"
    hasEventMode="true"/&gt;
  &lt;UnitDefinitions&gt;
    &lt;Unit name="rad"&gt;
      &lt;BaseUnit rad="1"/&gt;
      &lt;DisplayUnit name="deg" factor="57.2957795130823"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="rad/s"&gt;
      &lt;BaseUnit s="-1" rad="1"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="kg.m2"&gt;
      &lt;BaseUnit kg="1" m="2"/&gt;
    &lt;/Unit&gt;
    &lt;Unit name="N.m"&gt;
      &lt;BaseUnit kg="1" m="2" s="-2"/&gt;
    &lt;/Unit&gt;
  &lt;/UnitDefinitions&gt;
  &lt;TypeDefinitions&gt;
    &lt;Float64Type name="Modelica.Units.SI.Inertia" quantity="MomentOfInertia" unit="kg.m2" min="0.0"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.Torque" quantity="Torque" unit="N.m"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.AngularVelocity" quantity="AngularVelocity" unit="rad/s"/&gt;
    &lt;Float64Type name="Modelica.Units.SI.Angle" quantity="Angle" unit="rad"/&gt;
  &lt;/TypeDefinitions&gt;
  &lt;DefaultExperiment startTime="0.0" stopTime="3.0" tolerance="0.0001"/&gt;
  &lt;ModelVariables&gt;
    &lt;Float64 name="inertia1.J" valueReference="1073741824"
      description="Moment of load inertia" causality="parameter" variability="fixed"
      declaredType="Modelica.Units.SI.Inertia" start="1"/&gt;
    &lt;Float64 name="torque.tau" valueReference="536870912"
      description="Accelerating torque acting at flange (= -flange.tau)" causality="input"
      declaredType="Modelica.Units.SI.Torque" start="0"/&gt;
    &lt;Float64 name="inertia1.phi" valueReference="805306368"
      description="Absolute rotation angle of component" causality="output"
      declaredType="Modelica.Units.SI.Angle"/&gt;
    &lt;Float64 name="inertia1.w" valueReference="805306369"
      description="Absolute angular velocity of component (= der(phi))" causality="output"
      declaredType="Modelica.Units.SI.AngularVelocity"/&gt;
  &lt;/ModelVariables&gt;
  &lt;ModelStructure&gt;
    &lt;Output valueReference="805306368"/&gt;
    &lt;Output valueReference="805306369"/&gt;
    &lt;InitialUnknown valueReference="805306368"/&gt;
    &lt;InitialUnknown valueReference="805306369"/&gt;
  &lt;/ModelStructure&gt;
&lt;/fmiModelDescription&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xml-example-clocked-co-simulation">4.3.2.2. Example XML Description File with Clocks</h5>
<div class="paragraph">
<p>The example below is the same one as shown in <a href="#xml-example-co-simulation">Section 4.3.2.1</a> for a Co-Simulation FMU.
The only differences are, that the element <code>&lt;fmiModelDescription&gt;&lt;CoSimulation&gt;</code> is present and <a href="#clock"><code>clocks</code></a> are defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.
The XML file may have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">//include::examples/co_simulation_clocked_cosimulation.xml[]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fmi-for-scheduled-execution">5. FMI for Scheduled Execution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="#co-simulation-api">Co-Simulation</a> interface provides an indirect control over the computation of model partitions.
With <a href="#scheduled-execution-api">Scheduled Execution</a> a simulation algorithm can directly control the time of computation (i.e. scheduling) for such model partitions.</p>
</div>
<div class="paragraph">
<p>The Scheduled Execution interface addresses simulation use cases with the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At any time (even for unpredictable events), an event can be signaled to an FMU;</p>
</li>
<li>
<p>If multiple FMUs share resources (e.g. control tasks), the time requirements (e.g. execution time, communication deadlines) of all model partitions have to be observed and respected;</p>
<div class="ulist">
<ul>
<li>
<p>Time requirements may exist due to communication constraints (that are not apparent at FMU simulation level) which have to be fulfilled by the simulation algorithm;</p>
</li>
<li>
<p>That requires a global evaluation order and preemption policy for all model partitions of the multiple FMUs</p>
</li>
<li>
<p>Priority information provided by the FMUs has to be evaluated and merged to an overall priority for available model partitions</p>
</li>
</ul>
</div>
</li>
<li>
<p>Data shall move between the different FMU model partitions for the same or next activation time.</p>
<div class="ulist">
<ul>
<li>
<p>Get/set operations must also be possible for the same activation time for different model partitions between the computation of these model partitions.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The Co-Simulation interface provides support for concurrent computation of model partitions (i.e. a support of multiple rates) on a single computational resource (e.g. CPU-core) of an FMU.
For that a preemptive multitasking regime is intended (cooperative multitasking is not covered by this description).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[A parallel computation of model partitions is not part of the FMI 3.0 API.</em>
<em>An FMU may still internally use parallel computation on multiple cores, but handling this is (currently) not part of the FMI standard. Such an internal parallel computation is not visible to the simulation algorithm.</em>
<em>It is a tool vendor specific solution that has ties to the used OS and the co-simulation environment.]</em></p>
</div>
<div class="sect2">
<h3 id="math-scheduled-execution">5.1. Mathematical Description</h3>
<div class="paragraph">
<p>The Scheduled Execution interface has a different timing concept compared to FMI for Co-Simulation.
This is required to cover <a href="#clock"><code>clock</code></a> ticks for <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>input clocks</code></a> which may tick at time instances that are not predictable in advance for the simulation algorithm.
Typically, hardware I/O or virtual ECU software events belong to this category.</p>
</div>
<div class="paragraph">
<p>A simulation algorithm&#8217;s call for computing a model partition will compute the results of the model partition defined by an <a href="#inputClock"><code>inputClock</code></a> for the current <a href="#clock"><code>clock</code></a> tick time \(t_i\).</p>
</div>
<div class="paragraph">
<p>The result values will be computed for the current <a href="#clock"><code>clock</code></a> tick time (activation time) \(t_i\) from the assigned <a href="#inputClock"><code>inputClock</code></a> (which is known to the simulation algorithm).
Refer to the <a href="#clock"><code>clock</code></a> time progress definition (<a href="#CommunicationPointClocks">Section 2.2.7.2</a>) for <a href="#periodic"><code>periodic</code></a> <a href="#clock"><code>clocks</code></a>.</p>
</div>
<div class="paragraph">
<p>If required, the FMU can internally derive the <a href="#clock"><code>clock</code></a> interval \(\Delta T_i\) based on the last <a href="#clock"><code>clock</code></a> tick time \(t_{i-1}\) i.e. last activation time for this model partition.</p>
</div>
<div class="paragraph">
<p>A model partition can only be activated once per activation time point \(t_i\).</p>
</div>
<div class="paragraph">
<p>Model partitions that are associated to <a href="#outputClock"><code>output clocks</code></a> will accordingly provide the result values of the model partition&#8217;s variables for the current <a href="#outputClock"><code>outputClock</code></a> tick time \(t_i\) of the active <a href="#outputClock"><code>outputClock</code></a>.
The activation of such an <a href="#outputClock"><code>outputClock</code></a> is not controlled by the simulation algorithm but internally by the FMU.</p>
</div>
<div class="paragraph">
<p>More details can be found in <a href="#operation-on-clocks">Section 2.2.7</a>, specifically <a href="#CommunicationPointClocks">Section 2.2.7.2</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="scheduled-execution-api">5.2. Application Programming Interface</h3>
<div class="paragraph">
<p>This section contains the description of the Scheduled Execution interface for a C program.</p>
</div>
<div class="paragraph">
<p>The direct scheduling of model partitions based on <a href="#clock"><code>clock</code></a> ticks requires an additional handling mode for FMUs.
The FMU signals its support for direct model partition scheduling in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> via the element <code>&lt;fmiModelDescription&gt;&lt;ScheduledExecution&gt;</code>.
The simulation algorithm signals to the FMU that it supports and has recognized the <a href="#clock"><code>clock</code></a> and model partition scheduling capabilities of the FMU by instantiating it as Scheduled Execution.</p>
</div>
<div class="paragraph">
<p>Error, reset or terminate information is a global state of the FMU.
If e.g. an function returns <a href="#fmi3Discard"><code>fmi3Discard</code></a> or <a href="#fmi3Error"><code>fmi3Error</code></a> this is also assumed for all active or preempted model partitions.
In case of <a href="#fmi3Discard"><code>fmi3Discard</code></a> or <a href="#fmi3Error"><code>fmi3Error</code></a> no repetition of the step is possible, the only possible way to go forward is to enter the <strong>Terminated</strong> state and to end or to reset the simulation or - if supported - to set the FMU back to a former state.</p>
</div>
<div class="sect3">
<h4 id="state-machine-scheduled-execution">5.2.1. State Machine for Scheduled Execution</h4>
<div class="paragraph">
<p>This section summarizes the available states and the allowed function calls in the respective states.</p>
</div>
<div id="figure-scheduled-execution-state-machine" class="imageblock text-center">
<div class="content">
<img src="images/state-machine-scheduled-execution.svg" alt="state machine scheduled execution" width="80%">
</div>
<div class="title">Figure 32. Calling sequence of Scheduled Execution C functions.</div>
</div>
<div class="paragraph">
<p>If the simulation algorithm intends to enter the state <strong>Terminated</strong> it must ensure that all tasks related to model partitions of the FMU have ended.
Hence if in states <strong>Clock Activation Mode</strong>, <strong>Intermediate Update Mode</strong>, or <strong>Reconfiguration Mode</strong> a function returns <a href="#fmi3Fatal"><code>fmi3Fatal</code></a> the simulation algorithm may prematurely end all tasks related to the computation of model partitions of this FMU.
If in these states a function returns <a href="#fmi3Discard"><code>fmi3Discard</code></a> or <a href="#fmi3Error"><code>fmi3Error</code></a> the simulation algorithm may wait until all other tasks of the model partitions of this FMU have ended, but new tasks must not be started.</p>
</div>
<div class="paragraph">
<p>Each state of the state machine corresponds to a certain phase of a simulation.
Common states are defined in <a href="#common-state-machine">Section 2.3</a>, such as super states <a href="#FMUStateSetable"><strong>FMU State Setable</strong></a> and  <a href="#Initialized"><strong>Initialized</strong></a>, states <a href="#Instantiated"><strong>Instantiated</strong></a>, <a href="#ConfigurationMode"><strong>Configuration Mode</strong></a>, <a href="#ReconfigurationMode"><strong>Reconfiguration Mode</strong></a>, <a href="#InitializationMode"><strong>Initialization Mode</strong></a>, <a href="#Terminated"><strong>Terminated</strong></a> and <a href="#IntermediateUpdateMode"><strong>Intermediate Update Mode</strong></a>.</p>
</div>
<div class="sect4">
<h5 id="Initialized-SE">5.2.1.1. Super State: Initialized</h5>
<div class="paragraph">
<p>Special to Scheduled Execution, the following additional constrains apply to the state <strong>Initialized</strong> (see <a href="#Initialized">Section 2.3.2</a>).
The FMU enters state <strong>Terminated</strong> only after all other tasks related to the computation of model partitions of this FMU have ended.
After <a href="#fmi3Terminate"><code>fmi3Terminate</code></a> has been called no new tasks can be started (e.g. related to <a href="#outputClock"><code>outputClock</code></a> ticks) and all other function calls for this FMU must return <a href="#fmi3Error"><code>fmi3Error</code></a> until the state <strong>Terminated</strong> is reached.</p>
</div>
</div>
<div class="sect4">
<h5 id="_state_clock_activation_mode">5.2.1.2. State: Clock Activation Mode</h5>
<div class="paragraph">
<p>The FMU enters this state when the simulation algorithm calls <a href="#fmi3ExitInitializationMode"><code>fmi3ExitInitializationMode</code></a> in state <strong>Initialization Mode</strong> or <a href="#fmi3ExitConfigurationMode"><code>fmi3ExitConfigurationMode</code></a> in state <strong>Reconfiguration Mode</strong>.</p>
</div>
<div class="paragraph">
<p>In this state the simulation algorithm can create multiple concurrent tasks related to an FMU and in each task the simulation algorithm can activate one or multiple <a href="#inputClock"><code>input clocks</code></a> of an FMU based on the defined <a href="#clock"><code>clock</code></a> properties via a <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> call for each <a href="#clock"><code>clock</code></a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
</dl>
</div>
<div id="fmi3ActivateModelPartition" class="dlist">
<dl>
<dt class="hdlist1"><a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a></dt>
<dd>
<p>Each <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> call is now associated to the computation of a (publicly disclosed, externally controlled) model partition of the model and therefore to a single defined <a href="#inputClock"><code>inputClock</code></a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef fmi3Status fmi3ActivateModelPartitionTYPE(fmi3Instance instance,
                                                  fmi3ValueReference clockReference,
                                                  size_t clockElementIndex,
                                                  fmi3Float64 activationTime);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> function has the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fmi3Instance instance</code>: same meaning as for other <code>fmi3*</code> functions</p>
</li>
<li>
<p><code>fmi3ValueReference</code> <a href="#clockReference"><code>clockReference</code></a>: <a href="#valueReference"><code>valueReference</code></a> of an <a href="#inputClock"><code>inputClock</code></a> variable defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> which shall be activated</p>
</li>
<li>
<p><code>size_t</code> <a href="#clockElementIndex"><code>clockElementIndex</code></a>:: The element index of the <a href="#inputClock"><code>inputClock</code></a> variable which shall be activated.
For a scalar <a href="#clock"><code>clock</code></a> variable this must be 0; for array <a href="#clock"><code>clock</code></a> variables the element clock to activate is specified using the 1-based element index.
Using the element index 0 means all elements of the <a href="#clock"><code>clock</code></a> variable.
(Note: If an array has more than one dimension the indices are serialized in the same order as defined for values).</p>
</li>
</ul>
</div>
<div id="activationTime" class="ulist">
<ul>
<li>
<p><code>fmi3Float64 activationTime</code>: value of the <a href="#independent"><code>independent</code></a> variable of the assigned <a href="#inputClock"><code>inputClock</code></a> tick time \(t_i\) <em>[typically: simulation (i.e. virtual) time]</em> (which is known to the simulation algorithm).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Scheduling of <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> calls for each FMU is done by the simulation algorithm.
Calls are based on ticks of <a href="#periodic"><code>periodic</code></a> or <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>input clocks</code></a>.
These <a href="#inputClock"><code>input clock</code></a> ticks can be based on <a href="#clock"><code>clock</code></a> ticks from FMU external sources (e.g. <a href="#outputClock"><code>output clocks</code></a> of other FMUs).
The <a href="#inputClock"><code>inputClock</code></a> ticks can also be based on <a href="#outputClock"><code>output clock</code></a> ticks of the same FMU.
Refer to <a href="#math-scheduled-execution">Section 5.1</a> and <a href="#CommunicationPointClocks">Section 2.2.7.2</a>.
The <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> function is not called for <a href="#outputClock"><code>output clocks</code></a> of an FMU.</p>
</div>
<div class="paragraph">
<p>Note that this is a different timing concept compared to <a href="#fmi3DoStep"><code>fmi3DoStep</code></a> calls for Co-Simulation FMUs or the <a href="#fmi3SetTime"><code>fmi3SetTime</code></a> for Model Exchange FMUs.
A <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> call will compute the results of the model partition defined by <a href="#clockReference"><code>clockReference</code></a> and <a href="#clockElementIndex"><code>clockElementIndex</code></a> (i.e. <a href="#valueReference"><code>valueReference</code></a> of the variable that defines a <a href="#clock"><code>clock</code></a> and an element index into that for arrays) for the current <a href="#clock"><code>clock</code></a> tick \(t_i\).</p>
</div>
<div class="paragraph">
<p>If required, the FMU can internally derive the <a href="#clock"><code>clock</code></a> interval \(\Delta T_i\) based on the last <a href="#clock"><code>clock</code></a> tick time \(t_{i-1}\) i.e. last <code>activationTime</code> for this <a href="#clockReference"><code>clockReference</code></a> and <a href="#clockElementIndex"><code>clockElementIndex</code></a> (based on last <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> call).</p>
</div>
<div class="paragraph">
<p>Consecutive calls to <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> for a <a href="#clockReference"><code>clockReference</code></a> and <a href="#clockElementIndex"><code>clockElementIndex</code></a> (i.e. <a href="#valueReference"><code>valueReference</code></a> of <a href="#clock"><code>clock</code></a> variable and element index into that for arrays) must have strictly monotonically increasing <code>activationTime</code> \(t_i\).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#get-and-set-variable-values"><code>fmi3Set{VariableType}</code></a></dt>
<dd>
<p>This function can be called before scheduling a model partition for variables assigned to that model partition via its associated <a href="#clock"><code>clock</code></a> and all variables not associated to a <a href="#clock"><code>clock</code></a> (global variables).</p>
</dd>
<dt class="hdlist1">Function <a href="#get-and-set-variable-values"><code>fmi3Get{VariableType}</a></code>, <code>fmi3GetOutputDerivatives</code>, <a href="#fmi3GetDirectionalDerivative"><code>fmi3GetDirectionalDerivative</code></a></dt>
<dd>
<p>These functions can be called after the computation of a model partition for variables assigned to that model partition via its associated <a href="#clock"><code>clock</code></a> and all variables not associated to a <a href="#clock"><code>clock</code></a> (global variables).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Set/get operations must be atomic for a single variable.</p>
</div>
<div class="paragraph">
<p><em>[Because of real-time constraints, the computational effort has to be predictable for all operations in Scheduled Execution.</em>
<em>Therefore, all computationally expensive operations to compute a model partition have to be contained within the <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> function.</em>
<em>The simulation algorithm can assume that <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code> operations are not computationally expensive.</em>
<em>It is recommended, to call <code>fmi3Set{VariableType}</code> and <code>fmi3Get{VariableType}</code> in the same task as <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>.]</em></p>
</div>
<div class="paragraph">
<p>The restrictions related to variable <a href="#causality"><code>causality</code></a> and <a href="#variability"><code>variability</code></a> defined for <strong>Step Mode</strong> in <a href="#fmi-for-co-simulation"><code>Co-Simulation</code></a> apply.</p>
</div>
<div class="paragraph">
<p>It is not allowed to call <code>fmi3Get{VariableType}</code> functions after <code>fmi3Set{VariableType}</code> functions without an <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> call in between.</p>
</div>
<div class="paragraph">
<p><em>[The reason is to avoid different interpretations of the caching, since contrary to <a href="#fmi-for-model-exchange"><code>FMI for Model Exchange</code></a>, <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> will perform the actual calculation instead of <code>fmi3Get{VariableType}</code>, and therefore, dummy algebraic loops at communication points cannot be handled by an appropriate sequence of <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code> calls as for Model Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Example:</em></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><em>Correct calling sequence for a model partition</em></th>
<th class="tableblock halign-left valign-top"><em>Illegal calling sequence</em></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>fmi3Set{VariableType} on inputs</em><br>
fmi3ActivateModelPartition<br>
<em>fmi3Get{VariableType} on outputs</em><br>
<em>fmi3Set{VariableType} on inputs</em><br>
fmi3ActivateModelPartition<br>
<em>fmi3Get{VariableType} on outputs</em><br></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>fmi3Set{VariableType} on inputs</em><br>
fmi3ActivateModelPartition<br>
<em>fmi3Get{VariableType} on outputs</em><br>
<em>fmi3Set{VariableType} on inputs</em><br>
<em>fmi3Get{VariableType} on outputs // not allowed</em><br>
fmi3ActivateModelPartition<br>
<em>fmi3Get{VariableType} on outputs</em><br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>]</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Function <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a></dt>
<dd>
<p>Only in this state the FMU is allowed to call the callback <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.
The callback may be called from concurrent tasks within <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>.
The function must not return <a href="#fmi3Discard"><code>fmi3Discard</code></a>.</p>
</dd>
<dt class="hdlist1">Functions <a href="#fmi3GetFMUState"><code>fmi3GetFMUState</code></a>, <a href="#fmi3SetFMUState"><code>fmi3SetFMUState</code></a>, <a href="#fmi3FreeFMUState"><code>fmi3FreeFMUState</code></a>, <a href="#fmi3SerializedFMUStateSize"><code>fmi3SerializedFMUStateSize</code></a>, <a href="#fmi3SerializeFMUState"><code>fmi3SerializeFMUState</code></a>, <a href="#fmi3DeSerializeFMUState"><code>fmi3DeSerializeFMUState</code></a></dt>
<dd>
<p>These functions must not be called if any model partition is currently active or preempted.
<em>[This is because these functions apply to the whole FMU and not only to a specific model partition.]</em></p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="IntermediateUpdateModeSE">5.2.1.3. State: Intermediate Update Mode</h5>
<div class="paragraph">
<p>Here only special remarks w.r.t. <strong>Intermediate Update Mode</strong> in Scheduled Execution are made.
For the general mechanism see <a href="#IntermediateUpdateMode">Section 2.3.3</a>.
The arguments <code>canReturnEarly</code>, <code>earlyReturnRequested</code>, <code>earlyReturnTime</code> are ignored by FMU and importer.</p>
</div>
<div class="paragraph">
<p>A model partition of an SE FMU calls <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> to signal clock activations with <code>clocksTicked == fmi3True</code>.
The scheduling algorithm then uses <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> to determine which clock ticked.
If an <a href="#outputClock"><code>output clock</code></a> with an attribute <a href="#triggeredBy"><code>triggeredBy</code></a> ticked, the scheduling algorithm schedules the model partition associated with the corresponding <a href="#inputClock"><code>input clock</code></a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Allowed Function Calls</dt>
<dd>
<p>Additionally to the functions listed in <a href="#IntermediateUpdateMode">Section 2.3.3</a>, SE allows calling the following functions (in ME and CS, the following functions can be called in <strong>Event Mode</strong>):</p>
</dd>
<dt class="hdlist1"><a href="#fmi3GetClock"><code>fmi3GetClock</code></a></dt>
<dd>
<p>For an <a href="#outputClock"><code>outputClock</code></a> only the first call of <code>fmi3GetClock</code> for a specific activation of this <a href="#clock"><code>clock</code></a> signals <code>fmi3ClockActive</code>.
The FMU sets the reported activation state immediately back to <code>fmi3ClockInactive</code> for the following <code>fmi3GetClock</code> calls for that <a href="#clock"><code>clock</code></a> (in the same or other model partitions of the FMU) until this <a href="#outputClock"><code>outputClock</code></a> is internally activated again.
The simulation algorithm can call <code>fmi3Set{VariableType}</code> and <code>fmi3Get{VariableType}</code> during the callback for variables associated to an <a href="#outputClock"><code>outputClock</code></a> that is active during this callback.</p>
</dd>
<dt class="hdlist1"><a href="#fmi3GetIntervalDecimal"><code>fmi3GetIntervalDecimal</code></a> &amp; <a href="#fmi3GetIntervalFraction"><code>fmi3GetIntervalFraction</code></a></dt>
<dd>
<p>For <a href="#outputClock"><code>output clocks</code></a> and <a href="#localClock"><code>local clocks</code></a> it is allowed to call these functions during <strong>Intermediate Update Mode</strong>.
These functions can be called only at the first activation of <a href="#periodic"><code>periodic</code></a> <a href="#outputClock"><code>output clocks</code></a>.
For <a href="#periodic"><code>aperiodic</code></a> <a href="#outputClock"><code>output clocks</code></a>, these functions must be called at every activation <em>[to inquire when triggered <a href="#inputClock"><code>input clocks</code></a> must tick]</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><em>[Based on the FMI standard it cannot be determined which part of the code of an FMU has called the callback function <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.</em>
<em>This is especially the case for Scheduled Execution where multiple model partitions can be active at the same time.</em>
<em>This causes no issues since all function call prerequisites are connected to the activation state of <a href="#clock"><code>clocks</code></a>, <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> information and additionally available information from <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>]</em></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="preemption-support">5.2.2. Preemption Support</h4>
<div class="paragraph">
<p>For real-time applications the simulation time equals the real wall <a href="#clock"><code>clock</code></a> time, thus each <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> computation step has to be finished in real-time within its current period time length (computation time is not only defined by the runtime of <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> but also by the time for setting and getting variables and related operations).
Usually a preemptive scheduling of the <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>, <code>fmi3Get{VariableType}</code>, <code>fmi3Set{VariableType}</code> calls is required for respecting this constraint.</p>
</div>
<div class="paragraph">
<p>The FMU&#8217;s code has to be prepared for being able to correctly handle preemptive calls of <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>, <code>fmi3Get{VariableType}</code>, <code>fmi3Set{VariableType}</code>.
That requires a secured internal and external access to global states and variable values.
Thus in Scheduled Execution a support for a correct handling of the preemption of model partition computations is required.
That also requires that the FMU reports the active state of a <a href="#outputClock"><code>outputClock</code></a> only with the first call of <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> for a specific activation of this <a href="#clock"><code>clock</code></a> and sets the reported activation state immediately back to <code>false</code> for the following <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> calls for that <a href="#clock"><code>clock</code></a> until this <a href="#outputClock"><code>outputClock</code></a> is internally activated again.</p>
</div>
<div class="paragraph">
<p>If a preemptive multitasking regime is intended an individual task (or thread&#8201;&#8212;&#8201;task and thread are used synonymously here) for each model partition (associated to an <a href="#inputClock"><code>inputClock</code></a>) has to be created.
The task for computing each <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> is created and controlled by the simulation algorithm, not by the FMU.
So the FMU exporting tool does not need to take care for that (except for preparing its code to support preemption).</p>
</div>
<div class="paragraph">
<p><em>[If only one single model partition (<a href="#inputClock"><code>inputClock</code></a>) is available via the interface of an FMU, preemptive calls of the related <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> function are possible by default since there are no external cross dependencies within one model partition between communication points.]</em></p>
</div>
<div class="paragraph">
<p>Based on the <a href="#inputClock"><code>inputClock</code></a> settings defined in the XML the simulation algorithm calls <code>fmi3Set{VariableType}</code>, <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a>, <code>fmi3Get{VariableType}</code> calls.
Set/get calls for each task are only allowed for variables that are associated to the <a href="#inputClock"><code>inputClock</code></a> associated to that task or - here preemption issues become important - to variables that are associated to no <a href="#clock"><code>clocks</code></a> (global variables), based on the XML information (see <a href="#clock-type-definition">Section 2.4.4.1</a>).</p>
</div>
<div class="paragraph">
<p><em>[The recommendation is to avoid global variable associations as much as possible in the XML.</em>
<em>It is also recommended to reduce dependencies (defined in XML model structure) between variables located in different model partitions of one FMU, since this also requires in most cases that the related variables have to be global variables.]</em></p>
</div>
<div class="paragraph">
<p>The simulation algorithm has no knowledge about the FMU internal communication between the model partitions of a single FMU and does not handle it.</p>
</div>
<div class="paragraph">
<p>The simulation algorithm schedules the <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> (as well as related <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code>) calls based on given priorities for <a href="#inputClock"><code>input clocks</code></a> defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.</p>
</div>
<div class="paragraph">
<p>Priority (see <a href="#clock-type-definition">Section 2.4.4.1</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Same priority: Model partitions (e.g. tasks) cannot preempt each other.
Arbitrary evaluation order is possible for model partitions of the same priority.</p>
</li>
<li>
<p>Different priorities: Model partitions of a higher priority preempt partitions of a lower priority as soon as the higher priority partition needs to be computed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>[If multiple tasks are needed to be scheduled for computation at a certain time instant a simulation algorithm must schedule a task of a higher priority always before a task of a lower priority]</em></p>
</div>
<div class="paragraph">
<p><a href="#input"><code>Input</code></a> <a href="#clock"><code>clock</code></a> ticks (see <a href="#inputClockVariant">Section 2.2.7.4</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(<a href="#strict"><code>strict</code></a>) <a href="#periodic"><code>periodic</code></a> (period can be predefined by FMU or be defined by simulation algorithm, depending on XML information)</p>
</li>
<li>
<p><a href="#periodic">aperiodic</a> (based on external possibly unpredictable events or on an <a href="#outputClock"><code>outputClock</code></a> of the same FMU)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Based on the period and priority definitions the exporting tool can restrict the code evaluation order.
It nevertheless has to secure its code against concurrent evaluation <em>[not against parallel evaluation, as this is not supported for model partitions of an FMU in the interface description of this mode]</em> along the defined priority restrictions.
Mostly this is required for internal inter-model-partition communication and in general for the joint use of global variables within the FMU.
The exporting tool has to consider the effect of <a href="#input"><code>input</code></a> <a href="#periodic">aperiodic</a> <a href="#clock"><code>clocks</code></a> and the influences of computing speed, so the exact preemption occurrence points cannot be foreseen (within the given priority and period restrictions).</p>
</div>
<div class="paragraph">
<p>To guard certain code parts against preemption they must be enclosed with the callback functions <code>lockPreemption</code> and <code>unlockPreemption</code>.</p>
</div>
<div class="paragraph">
<p><em>[Such locks should be used with care and only for securing very short code parts that cannot be secured otherwise.]</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">typedef void       (*fmi3CallbackLockPreemption)   ();
typedef void       (*fmi3CallbackUnlockPreemption) ();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even if the scheduler does not support preemption, at least an empty implementation of these callback functions must be provided to allow the reuse of code for different modes together with an efficient preemption.
<em>[This avoids checks for null function pointers.</em>
<em>A function call to a void-void function with an immediate return is hardly any overhead.]</em></p>
</div>
<div class="paragraph">
<p>Example for the use of <code>fmi3CallbackLockPreemption</code> and <code>fmi3CallbackUnlockPreemption</code> callback functions in the FMU code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">Int16 DataBuffer[3];   // global buffer

void Task1(void) //low priority
{
   ...
   // write data to DataBuffer
   fmi3CallbackLockPreemption();
   DataBuffer[0] = internal_out_RootSys1_1;
   DataBuffer[1] = internal_out_RootSys1_2;
   DataBuffer[2] = internal_out_RootSys1_3;
   fmi3CallbackUnlockPreemption();
   ...
 }

...
void Task2(void) //high priority
{
   ...
   // read data from DataBuffer
   fmi3CallbackLockPreemption();
   internal_in_RootSys2_1 = DataBuffer[0];
   internal_in_RootSys2_2 = DataBuffer[1];
   internal_in_RootSys2_3 = DataBuffer[2];
   fmi3CallbackUnlockPreemption();
   ...
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-scheduled-execution">5.2.3. Example for Scheduled Execution</h4>
<div class="paragraph">
<p>The FMU ThreeInputClocks sketches the usage of the FMI functions.
The example is given in a mix of pseudo-code and C, in order to keep it small and understandable.
We consider one FMU with three model partitions.
Two model partitions associated to two <a href="#periodic"><code>periodic</code></a> <a href="#inputClock"><code>input clocks</code></a> 10msClock and 50msClock (<a href="#clock"><code>clock</code></a> periods 10 ms and 50 ms) and one <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>inputClock</code></a> AperiodicClock.</p>
</div>
<div class="paragraph">
<p>During the execution of the model partition of <a href="#inputClock"><code>input clock</code></a> 10msClock the <a href="#outputClock"><code>output clock</code></a> OutClock may tick and invoke the execution of model partition of <a href="#periodic">aperiodic</a> <a href="#inputClock"><code>inputClock</code></a> AperiodicClock.</p>
</div>
<div class="paragraph">
<p>The function calls <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> are executed in the context of preemptable tasks whose priorities are derived from the respective <a href="#inputClock"><code>inputClock</code></a> configurations of the FMU.
In this example the execution of the task of <a href="#inputClock"><code>inputClock</code></a> AperiodicClock is waiting for the task of <a href="#inputClock"><code>inputClock</code></a> 10msClock to finish.
Likewise the task of AperiodicClock is suspended when the task of higher priority is scheduled again.</p>
</div>
<div class="paragraph">
<p>The example also depicts how a task associated to an even lower prior <a href="#inputClock"><code>inputClock</code></a> 50msClock is delayed several times by tasks of higher priority.
Note that the point of time when the task was scheduled is the <code>activationTime</code> of <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> (&#8230;&#8203;Activate&#8230;&#8203;(<code>input clock</code>, <code>activationTime</code>)).</p>
</div>
<div id="figure-scs_example" class="imageblock text-center">
<div class="content">
<img src="images/se_example.png" alt="se example" width="90%">
</div>
<div class="title">Figure 33. Scheduled Execution Example ThreeInputClocks</div>
</div>
<div class="sect4">
<h5 id="_description_schema">5.2.3.1. Description Schema</h5>
<div class="paragraph">
<p>The simulation algorithm collects the information about the number and properties of <a href="#clock"><code>clocks</code></a> supported by the FMU via analyzing the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> as defined in <a href="#fmi-description-schema">Section 2.4</a>.
For every <a href="#inputClock"><code>input clock</code></a> the simulation algorithm defines a task.
The properties <code>period</code> and <code>priority</code> are defined based on the <a href="#inputClock"><code>input clocks'</code></a> <code>period</code> and <code>priority</code> defined in the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>.
The simulation algorithm can read from the <a href="#modelDescription.xml"><code>modelDescription.xml</code></a> that <a href="#outputClock"><code>output clock</code></a> OutClock may tick triggered by <a href="#inputClock"><code>inputClock</code></a> 10msClock and that <a href="#inputClock"><code>inputClock</code></a> AperiodicClock is triggered by OutClock.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;fmiModelDescription fmiVersion="3.0" modelName="ThreeInputClocks"&gt;
	&lt;ScheduledExecution modelIdentifier="ThreeInputClocks" canBeInstantiatedOnlyOncePerProcess="true"/&gt;
	&lt;LogCategories&gt;
		&lt;Category name="logStatusError" description="Log error messages"/&gt;
	&lt;/LogCategories&gt;
	&lt;DefaultExperiment startTime="0" stopTime="6" stepSize="0.001"/&gt;
	&lt;ModelVariables&gt;
		&lt;!-- Variables related to input clock 10msClock  --&gt;
		&lt;Float64 name="AIn1" valueReference="0" causality="input"  clockReference="5"	start="0"/&gt;
		&lt;Float64 name="AIn2" valueReference="1" causality="input"  clockReference="5"	start="0"/&gt;
		&lt;Float64 name="AOut" valueReference="2" causality="output" clockReference="5"/&gt;

		&lt;!-- Variables related to input clock AperiodicClock  --&gt;
		&lt;Float64 name="BIn"  valueReference="3" causality="input"  clockReference="6"	start="0"/&gt;
		&lt;Float64 name="BOut" valueReference="4" causality="output" clockReference="6"/&gt;

		&lt;!-- Clock variables --&gt;
		&lt;!-- Periodic input clock --&gt;
		&lt;Clock name="10msClock" valueReference="5" causality="input" clockType="communicationPoint"
		priority="1" periodic="true" strict="true" intervalCounter="10" resolution="1000"/&gt;
		&lt;!-- Input clock that must be triggered by OutClock --&gt;
		&lt;Clock name="AperiodicClock" valueReference="6" causality="input" clockType="communicationPoint"
		priority="2" triggeredBy="7" /&gt;
		&lt;!-- Output clock activated in model partition associated to 10msClock   --&gt;
		&lt;Clock name="OutClock" valueReference="7" causality="output" clockType="communicationPoint"
		priority="2" clockReference="5" /&gt;
		&lt;!-- Periodic input clock --&gt;
		&lt;Clock name="50msClock" valueReference="8" causality="input" clockType="communicationPoint"
		priority="3" periodic="true" strict="true" intervalCounter="50" resolution="1000"/&gt;
	&lt;/ModelVariables&gt;
	&lt;ModelStructure&gt;
		&lt;Output valueReference="2"/&gt;
		&lt;Output valueReference="4"/&gt;
	&lt;/ModelStructure&gt;
&lt;/fmiModelDescription&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_simulation_algorithm_implementation">5.2.3.2. Simulation Algorithm Implementation</h5>
<div class="paragraph">
<p>To enable the computation of a Scheduled Execution FMU a simulation algorithm has to provide a task scheduler.
Depending on the particular configuration the simulation algorithm sets up tasks for every <a href="#inputClock"><code>input clock</code></a>.
When executed each task calls <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> for its respective <a href="#inputClock"><code>input clock</code></a>.
The <code>activationTime</code> is provided by the simulation algorithm.
Periodic tasks can be scheduled on initialization of the simulation application.
Aperiodic tasks are scheduled explicitly during the execution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">Task10ms.Execute()
{
   // Set inputs with valueReference 0 and 1 associated to clockIndex 5
   fmi3SetFloat64(s, {0,1}, &amp;AIn);
   // call for 10msClock tick (clockIndex 5)
   fmi3ActivateModelPartition(s, 5, 0, Task10ms.ActivationTime);
   // Get output with valueReference 2 associated to clockIndex 0
   fmi3GetFloat64(s, {2}, &amp;AOut);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>As specified in the XML file, <a href="#inputClock"><code>input clock</code></a> AperiodicClock is triggered by <a href="#outputClock"><code>output clock</code></a> OutClock thus the simulation algorithm ensures the task associated to AperiodicClock is scheduled when <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a> is called by the FMU and OutClock has ticked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">void CallbackIntermediateUpdate(..., fmi3Boolean clocksTicked, ...)
{
   fmi3ValueReference outputClockReferences = {7};
   fmi3Boolean[] clocksActivationState = {fmi3ClockInactive};
   if (clocksTicked)
   {
      // ask FMU if output clock has ticked
      fmi3GetClocks(... outputClockReferences, &amp;clocksActivationState, ...);
   }
   if (clocksActivationState[0])
   {
      // schedule task for AperiodicClock
      Scheduler-&gt;ScheduleTask(TaskAperiodic);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fmu_implementation">5.2.3.3. FMU Implementation</h5>
<div class="paragraph">
<p>The FMU implements <a href="#fmi3ActivateModelPartition"><code>fmi3ActivateModelPartition</code></a> dispatching for every <a href="#inputClock"><code>input clock</code></a> so the code might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">fmi3Status fmi3ActivateModelPartition(fmi3Instance *instance,
   fmi3ValueReference clockReference, fmi3Float64 activationTime)
{
   switch (clockReference)
   {
      case 5:
         // Input clock 10msClock
         activateModelPartition10ms(instance, activationTime);
      case 6:
         // Input clock AperiodicClock
         activateModelPartitionAperiodic(instance, activationTime);
      case 8:
         // Input clock AperiodicClock
         activateModelPartition50ms(instance, activationTime);
      ...
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the context of the task being executed every 10 ms, the FMU lets <a href="#outputClock"><code>output clock</code></a> OutClock tick and calls <a href="#fmi3CallbackIntermediateUpdate"><code>fmi3CallbackIntermediateUpdate</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">void activateModelPartition10ms(fmi3Instance *instance, ...)
{
   ...
   if (...)
   {
      // outputClock ticks
      fmi3SetClock({7});
      // inform simulation algorithm that output clock has ticked
      fmi3Boolean clocksTicked = fmi3True;
      instance-&gt;fmi3CallbackIntermediateUpdate(..., clocksTicked, ...);
   }
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="#fmi3GetClock"><code>fmi3GetClock</code></a> is called for a certain <a href="#outputClock"><code>output clock</code></a> the <a href="#outputClock"><code>output clock</code></a> is reset.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="C" class="language-C hljs">fmi3Status fmi3GetClock(..., fmi3ValueReference outputClockReferences,
   fmi3Clock *clocksActivationState, ...)
{
   if (outputClockReferences[0] == 7)
   {
      clocksActivationState[0] = outClockActivationState;
      outClockActivationState = fmi3ClockInactive;
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scheduled-execution-schema">5.3. Description Schema</h3>
<div class="paragraph">
<p>The common XML elements and attributes are defined in <a href="#fmi-description-schema">Section 2.4</a>.
Additional elements and attributes are defined subsequently.
If the FMU implements the Scheduled Execution interface type, the element <code>&lt;ScheduledExecution&gt;</code> must be present.
It is defined as:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/schema/ScheduledExecution.png" alt="ScheduledExecution" width="80%">
</div>
</div>
<div class="paragraph">
<p>The attribute in the following table is defined on top of the <a href="#common-capability-flags">common attributes</a> and have the following meaning (all attributes are optional with exception of <code>modelIdentifier</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>modelIdentifier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short class name according to C syntax, for example, <code>A_B_C</code>.
Used as prefix for FMI functions if the functions are provided in C source code or in static libraries, but not if the functions are provided by a DLL/SharedObject.
<code>modelIdentifier</code> is also used as name of the static library or DLL/SharedObject.
See also <a href="#header-files-and-naming-of-functions">Section 2.2.1</a>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="ABL12"></a>[ABL12] &#197;kesson J., Braun W., Lindholm P., and Bachmann B. (2012): <strong>Generation of Sparse Jacobians for the Functional Mockup Interface 2.0</strong>. 9th International Modelica Conference, Munich, 2012. <a href="http://www.ep.liu.se/ecp/076/018/ecp12076018.pdf" class="bare">http://www.ep.liu.se/ecp/076/018/ecp12076018.pdf</a></p>
</li>
<li>
<p><a id="BPRS15"></a>[BPRS15] Atilim Gunes Baydin, Barak A. Pearlmutter, Alexey Andreyevich Radul, Jeffrey Mark Siskind (2015): <strong>Automatic differentiation in machine learning: a survey</strong>. <a href="https://arxiv.org/abs/1502.05767" class="bare">https://arxiv.org/abs/1502.05767</a></p>
</li>
<li>
<p><a id="BCP10"></a>[BCP10] Benveniste A., Caillaud B., Pouzet M. (2010): <strong>The Fundamentals of Hybrid Systems Modelers</strong>. In 49th IEEE International Conference on Decision and Control (CDC), Atlanta, Georgia, USA, December 15-17. <a href="http://www.di.ens.fr/~pouzet/bib/cdc10.pdf" class="bare">http://www.di.ens.fr/~pouzet/bib/cdc10.pdf</a></p>
</li>
<li>
<p><a id="BOA11"></a>[BOA11] Blochwitz T., Otter M., Arnold M., Bausch C., Clau&#223; C., Elmqvist H., Junghanns A., Mauss J., Monteiro M., Neidhold T., Neumerkel D., Olsson H., Peetz J.-V., Wolf S. (2011): <strong>The Functional Mockup Interface for Tool independent Exchange of Simulation Models</strong>. 8th International Modelica Conference, Dresden 2011. <a href="http://www.ep.liu.se/ecp/063/013/ecp11063013.pdf" class="bare">http://www.ep.liu.se/ecp/063/013/ecp11063013.pdf</a></p>
</li>
<li>
<p><a id="BKF17"></a>[BKF17] Braun W., Kulshreshtha K., Franke R., Walther A., Bachmann B., Towards Adjoint and Directional Derivatives in FMI utilizing ADOL-C within OpenModelica, 12th International Modelica Conference, Prague, 2017. <a href="https://2017.international.conference.modelica.org/proceedings/html/submissions/ecp17132363_BraunKulshreshthaFrankeBachmannWalther.pdf" class="bare">https://2017.international.conference.modelica.org/proceedings/html/submissions/ecp17132363_BraunKulshreshthaFrankeBachmannWalther.pdf</a></p>
</li>
<li>
<p><a id="BOA12"></a>[BOA12] Blochwitz T., Otter M., &#197;kesson J., Arnold M., Clau&#223; C., Elmqvist H., Friedrich M., Junghanns A., Mauss J., Neumerkel D., Olsson H., Viel A. (2012): <strong>Functional Mockup Interface 2.0: The Standard for Tool independent Exchange of Simulation Models</strong>. 9th International Modelica Conference, Munich, 2012. <a href="http://www.ep.liu.se/ecp/076/017/ecp12076017.pdf" class="bare">http://www.ep.liu.se/ecp/076/017/ecp12076017.pdf</a></p>
</li>
<li>
<p><a id="KS00"></a>[KS00] K&#252;bler R., Schiehlen W. (2000): <strong>Two methods of simulator coupling</strong>. Mathematical and Computer Modeling of Dynamical Systems 6 pp. 93-113.</p>
</li>
<li>
<p><a id="LZ07"></a>[LZ07] Lee E.A., Zheng H. (2007): <strong>Leveraging Synchronous Language Principles for Heterogeneous Modeling and Design of Embedded Systems</strong>. EMSOFT'07, September 30-October 3, Salzburg, Austria. <a href="https://ptolemy.berkeley.edu/publications/papers/07/unifying/LeeZheng_SRUnifying.pdf" class="bare">https://ptolemy.berkeley.edu/publications/papers/07/unifying/LeeZheng_SRUnifying.pdf</a></p>
</li>
<li>
<p><a id="MLS12"></a>[MLS12] Modelica (2012): <strong>Modelica, A Unified Object-Oriented Language for Systems Modeling</strong>. Language Specification, Version 3.3, May 9, 2012. <a href="https://www.modelica.org/documents/ModelicaSpec33.pdf" class="bare">https://www.modelica.org/documents/ModelicaSpec33.pdf</a></p>
</li>
<li>
<p><a id="MG09"></a>[MG09] MODELISAR Glossary (2009): <strong>MODELISAR WP2 Glossary and Abbreviations</strong>. Version 1.0, June 9, 2009.</p>
</li>
<li>
<p><a id="PZ06"></a>[PZ06] Pouzet M. (2006): <strong>Lucid Synchrone</strong>. Version 3.0, Tutorial and Reference Manual. <a href="http://www.di.ens.fr/~pouzet/lucid-synchrone/" class="bare">http://www.di.ens.fr/~pouzet/lucid-synchrone/</a></p>
</li>
<li>
<p><a id="CGM84"></a>[CGM84] Coleman, Garbow, Mor&#233; (1984): <strong>Software for estimating sparse Jacobian matrices, ACM Transactions on Mathematical Software</strong>. TOMS , vol. 10, no. 3, pp. 346-347</p>
</li>
<li>
<p><a id="PW13"></a>[PW13] Preston-Werner, T. (2013): <strong>Semantic Versioning 2.0.0</strong>.  <a href="https://semver.org/spec/v2.0.0.html" class="bare">https://semver.org/spec/v2.0.0.html</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="glossary">Appendix A: Glossary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This glossary is a subset of (<em>MODELISAR Glossary, 2009</em>) with some extensions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Term</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>argument</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refers to a function parameter.
Not to be confused with <em>parameter</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>capability flag</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capability flags are used to indicate to the importer what optional functionality the FMU supports.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>clock</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A signal to report events or trigger events or model partitions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>clock tick</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the <a href="#clock"><code>clock</code></a> ticks an event is present otherwise the event is absent.
For FMI for Co-Simulation the ticking of a <a href="#clock"><code>clock</code></a> is interpreted as an activity of the associated model partition.
The ticking of a <a href="#outputClock"><code>outputClock</code></a> may lead to an <a href="#inputClock"><code>inputClock</code></a> tick for another FMU (has to be defined via simulation algorithm) or for a model partition of the same FMU (is defined in <a href="#modelDescription.xml"><code>modelDescription.xml</code></a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>communication points</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time grid for data exchange between importer and FMU(s) in a (co-)simulation environment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>communication step size</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distance between two subsequent <em>communication points</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>co-simulation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Coupling of several <em>simulation programs</em> in order to compute the global behavior of a system that consists of several subsystems.
The subsystems are coupled in the sense that the behavior of each subsystem depends on the behavior of the remaining subsystems, so that the co-simulation must be computed in a step-by-step fashion.
Each simulation program is responsible for computing the behavior of a subsystem, using the outputs produced by the other simulation programs.
Synonyms: dynamic mutual-exchange, simulator coupling, and coupled simulation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>direct feedthrough</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct feedthrough describes that values of output variables depend directly on values of input variables.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ECU</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Electronic Control Unit (Microprocessor that is used to control a technical system).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>event</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Something that occurs instantaneously at a specific time or when a specific condition occurs.
At an event, numerical integration is suspended and variables may change their values discontinuously.
Internal events occur inside the FMU and should be signaled to the environment without any delay and can cause event handling and/or the activation of an output clock.
Input clocks are activated by the environment to inform the FMU about the exact moment an event across FMUs has to be handled.
See <a href="#state-event">state event</a>, <a href="#step-event">step event</a> and <a href="#time-event">time event</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>event indicator</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A variable that changes sign exactly at an event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>exporter</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A program that creates an FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>external scheduler</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <em>scheduler</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>feedthrough</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <em>direct feedthrough</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMI</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functional Mock-up Interface:<br>
Interface of a functional mock-up in form of a model.
In analogy to the term digital mock-up (see <em>mock-up</em>), functional mock-up describes a computer-based representation of the functional behaviour of a system for all kinds of analyses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMI functions</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The function of the FMI C-API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMI for co-simulation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functional Mock-up Interface for Co-Simulation:<br>
One of the MODELISAR <em>functional mock-up interface types.</em> It connects the <em>importer</em> with one or more <em>FMU</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMI for model exchange</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functional Mock-up Interface for Model Exchange:<br>
One of the MODELISAR <em>functional mock-up interface types.</em> It consists of the <em>model description</em> and the <em>C API</em>.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMU</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functional Mock-up Unit:<br>
A "model class" following the interface type FMI for Model Exchange, or a model following the interface types FMI for Co-Simulation or FMI for Scheduled Execution).
An FMU is one ZIP file as defined in <a href="#fmu-distribution">Section 2.5</a>.
The zip file comprises essentially an XML file that defines the model variables, and a set of C function implementations (see <a href="#general-mechanisms">Section 2.2</a>).
The implementations can be in source or binary form.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>FMU clock</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#clock"><code>clock</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>importer</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The tool that imports or loads one or more FMUs.
Also called simulation environment, environment, calling environment, (co-)simulation algorithm, target platform, target environment, integrator (in ME).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>independent variable</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All variables are a function of this <a href="#independent"><code>independent</code></a> variable, typically time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="input-event"></a><em>input event</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An input event occurs when a discrete input variable changes or a continuous input variable has a discontinuity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>integration algorithm</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The numerical algorithm to solve differential equations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>integrator</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <em>software component</em>, which implements an <em>integration algorithm</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An abstraction of a <em>software component</em> that describes its behavior without dealing with the internal implementation.
<em>Software components</em> communicate with each other via interfaces.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>interrupt</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Event</em> connected to the tick of an <a href="#inputClock"><code>inputClock</code></a> of an FMU that is caused by an external potentially random process, i.e. hardware interrupt, software interrupt.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>machine epsilon</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smallest floating point value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>mock-up</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A full-sized structural, but not necessarily functional model built accurately to scale, used chiefly for study, testing, or display.
In the context of computer aided design (CAD), a digital mock-up (DMU) means a computer-based representation of the product geometry with its parts, usually in 3-D, for all kinds of geometrical and mechanical analyses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>model</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A model is a mathematical or logical representation of a system of entities, phenomena, or processes.
Basically a model is a simplified abstract view of the complex reality.<br>
It can be used to compute its expected behavior under specified conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>model description file</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The model description file is an XML file, which supplies a description of all properties of a <em>model</em> (for example, <a href="#input"><code>input</code></a> / <a href="#output"><code>output</code></a> variables).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>model description interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An interface description to write or retrieve information from the <em>model description file</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Model Description Schema</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <em>XML</em> schema that defines how all relevant, non-executable, information about a "model class" (<em>FMU)</em> is stored in a text file in <em>XML</em> format.
Most important, data for every variable is defined (variable name, handle, data type, variability, unit, etc.), see <a href="#fmi-description-schema">Section 2.4</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>model rate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse of time interval between two communication points associated to an exposed model partition within the FMU (i.e. <a href="#clock"><code>clock</code></a> is defined in interface).
In general multiple rates i.e. multiple model partitions can be defined for an Co-Simulation FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>model partition</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Model partitions can be associated to a discrete or (piecewise) continuous part of the FMU.
The computation of model partitions can be externally controlled based on <a href="#clock"><code>clock</code></a> ticks of associated <a href="#inputClock"><code>input clocks</code></a>.</p>
<p class="tableblock">Not all FMU internal model partitions have to be exposed in the Co-Simulation interface as <a href="#clock"><code>clock</code></a> and can also be handled FMU internally (e.g. internal subsampling).
Nevertheless, it is assumed that the activation of all exposed <a href="#inputClock"><code>input clocks</code></a> results in the computation of the complete FMU.</p>
<p class="tableblock">As stated above, continuous parts of the FMU are also associated to model partitions that define the communication points for the <a href="#continuous"><code>continuous</code></a> values.
Please note that this is only possible for <code>CommunicationPointClocks</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Newtonian time instant</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TODO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ODE</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <em>Ordinary Differential Equation</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Ordinary Differential Equation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Differential equation containing one or more functions of one independent variable (typically time) and the derivatives of those functions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>output points</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tool internal time grid for saving output data to file (in some tools also known as "<em>communication points</em>" - but this term is used in a different way in FMI for Co-Simulation, see above).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>output step size</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distance between two subsequent <em>output points</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>parameter</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A quantity within a <em>model</em>, which remains constant during <em>simulation (<a href="#fixed"><code>fixed</code></a> <a href="#parameter"><code>parameter</code></a>) or may change at event instances (<a href="#tunable"><code>tunable</code></a> <a href="#parameter"><code>parameter</code></a>)</em>.
Examples are a mass, stiffness, etc.
These parameters are different from <a href="#calculatedParameter">calculated parameters</a>, because they can be changed independently (according to their <a href="#variability"><code>variability</code></a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>run-time environment</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See co-simulation environment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>scheduled execution</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FMI type that externalizes the scheduler to run <em>model partitions</em>, potentially synchronized between more than one FMU and exchanging input and output variables accordingly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute the behavior of one or several <em>models</em> under specified conditions.<br>
(see also <em>co-simulation</em>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulation model</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <em>model</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulation program</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Software to develop and/or solve simulation <em>models</em>.
The software includes a <em>solver</em>, may include a user interface and methods for post processing (see also: <em>simulation tool</em>, <em>simulation environment</em>).<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulation tool</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <em>simulation program</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulator</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A simulator can include one or more <em>simulation programs</em>, which solve a common simulation task.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>simulator coupling</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <em>tool coupling</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>solver</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Software component,</em> which includes algorithms to solve <em>models</em>, for example, <em>integration algorithms</em> and <em>event handling</em> methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>state</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The continuous <a href="#state"><code>states</code></a> of a model are all variables that appear differentiated in the model and are independent from each other.<br>
The discrete-time states of a model are time-discrete variables that have two values in a model: The value of the variable from the previous <em>event</em> instant, and the value of the variable at the actual event instant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="state-event"></a><em>state event</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Event</em> that is defined by the time instant where the domain \(z &gt; 0\) of an event indicator variable <code>z</code> is changed to \(z \leq 0\), or vice versa.<br>
This definition is slightly different from the usual standard definition of state events: "\(z(t)*z(t_{i-1}) \leq 0\)" which has the severe drawback that the value of the event indicator at the previous event instant, \(z(t_{i-1}) \neq 0\), must be non-zero and this condition cannot be guaranteed.
The often used term "zero crossing function" for <code>z</code> is misleading (and is therefore not used in this document), since a state event is defined by a change of a domain and not by a zero crossing of a variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="step-event"></a><em>step event</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Event</em> that might occur at a completed integrator step.
Since this event type is not defined by a precise time or condition, it is usually not defined by a user.
A program may use it, for example, to dynamically switch between different states.
A step event is handled much more efficiently than a <em>state event</em>, because the event is just triggered after performing a check at a completed integrator step, whereas a search procedure is needed for a state event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>structural parameter</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A parameter influencing the size and/or dimensionality of an array variable of an FMU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>synchronous clock theory</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TODO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>super-dense time</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A precise definition of time taking into account iterations at an event.
For an <em>FMU</em>, the <a href="#independent"><code>independent</code></a> variable time \(t \in \mathbb{T}\) is a tuple \(t = (t_R, t_I)\) where \(t_R \in  \mathbb{R}, t_I \in \mathbb{N} = \{0,1,2,\ldots\}\).
The real part \(t_R\) of this tuple is the <a href="#independent"><code>independent</code></a> variable of the FMU for describing the continuous-time behavior of the model between events.
During continuous-time integration \(t_I = 0\).
The integer part \(t_I\) of this tuple is a counter to enumerate (and therefore distinguish) the events at the same continuous-time instant \(t_R\).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>task</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special kind of <em>model partition</em> that is used in control code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="time-event"></a><em>time event</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Event</em> that is defined by a predefined time instant.
Since the time instant is known in advance, the integrator can select its step size so that the event point is directly reached.
Therefore, this event can be handled efficiently.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>tick relationshipt</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Event</em> that is defined by a predefined time instant.
Since the time instant is known in advance, the integrator can select its step size so that the event point is directly reached.
Therefore, this event can be handled efficiently.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>see Transmission Line Method</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transmission Line Method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A mathematical method which uses physically motivated time delays to decouple an equation system into independent parts during a specified time frame without compromising numerical stability.
Also known as the <em>bi-lateral delay line</em> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>user interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The part of the simulation program that gives the user control over the simulation and allows watching results.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>XML</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eXtensible Markup Language (<a href="http://www.w3.org/XML/">www.w3.org/XML</a>, <a href="http://en.wikipedia.org/wiki/Xml">en.wikipedia.org/wiki/XML</a>) - An open standard to store information in text files in a structured form.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgements">Appendix B: Acknowledgements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until Dec. 2011, this work was carried out within the ITEA2 MODELISAR project (project number: ITEA2-07006, <a href="https://itea3.org/project/modelisar.html" class="bare">https://itea3.org/project/modelisar.html</a>).</p>
</div>
<div class="paragraph">
<p>Daimler AG, DLR, ITI GmbH, Martin Luther University Halle-Wittenberg, QTronic GmbH and SIMPACK AG thank BMBF for partial funding of this work within MODELISAR (BMBF F&#246;rderkennzeichen: 01lS0800x).</p>
</div>
<div class="paragraph">
<p>Dassault Syst&#232;mes (Sweden) thanks the Swedish funding agency VINNOVA (2008-02291) for partial funding of this work within MODELISAR.</p>
</div>
<div class="paragraph">
<p>LMS Imagine and IFPEN thank DGCIS for partial funding of this work within MODELISAR.</p>
</div>
<div class="paragraph">
<p>Since Sept. 2012 until Nov. 2015, this work is partially carried out within the ITEA2 MODRIO project (project number: ITEA 2-11004, <a href="https://itea3.org/project/modrio.html" class="bare">https://itea3.org/project/modrio.html</a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DLR, ITI GmbH, QTronic GmbH and SIMPACK AG thank BMBF for partial funding of this work within MODRIO (BMBF F&#246;rderkennzeichen: 01IS12022E).</p>
</li>
<li>
<p>Dassault Syst&#232;mes (Sweden), Link&#246;ping University and Modelon AB thank the Swedish funding agency VINNOVA (2012&#8212;&#8203;01157) for partial funding of this work within MODRIO.</p>
</li>
<li>
<p>Siemens PLM Software (France) and IFPEN thank DGCIS for partial funding of this work within MODRIO.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>